

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Kernel Connection Multiplexor &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Networking Documentation" href="index.html"/>
        <link rel="next" title="L2TP" href="l2tp.html"/>
        <link rel="prev" title="IPvs-sysctl" href="ipvs-sysctl.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Networking Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="bareudp.html">Bare UDP Tunnelling Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="batman-adv.html">batman-adv</a></li>
<li class="toctree-l2"><a class="reference internal" href="can.html">SocketCAN - Controller Area Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="can_ucan_protocol.html">The UCAN Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_drivers/index.html">Hardware Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsa/index.html">Distributed Switch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devlink/index.html">Linux Devlink Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="caif/index.html">CAIF</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool-netlink.html">Netlink interface for ethtool</a></li>
<li class="toctree-l2"><a class="reference internal" href="ieee802154.html">IEEE 802.15.4 Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="j1939.html">J1939 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="kapi.html">Linux Networking and Network Devices APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="msg_zerocopy.html">MSG_ZEROCOPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="failover.html">FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_dim.html">Net DIM - Generic Network Dynamic Interrupt Moderation</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_failover.html">NET_FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_pool.html">Page Pool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">PHY Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp-phylink.html">phylink</a></li>
<li class="toctree-l2"><a class="reference internal" href="alias.html">IP-Aliasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="bridge.html">Ethernet Bridging</a></li>
<li class="toctree-l2"><a class="reference internal" href="snmp_counter.html">SNMP counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="checksum-offloads.html">Checksum Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="segmentation-offloads.html">Segmentation Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="scaling.html">Scaling in the Linux Networking Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">Kernel TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls-offload.html">Kernel TLS offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="nfc.html">Linux NFC subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="6lowpan.html">Netdev private dataroom for 6lowpan interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="6pack.html">6pack Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet-hardware.html">ARCnet Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet.html">ARCnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="atm.html">ATM</a></li>
<li class="toctree-l2"><a class="reference internal" href="ax25.html">AX.25</a></li>
<li class="toctree-l2"><a class="reference internal" href="bonding.html">Linux Ethernet Bonding Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc_mbim.html">cdc_mbim - Driver for CDC MBIM Mobile Broadband modems</a></li>
<li class="toctree-l2"><a class="reference internal" href="dccp.html">DCCP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="dctcp.html">DCTCP (DataCenter TCP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="decnet.html">Linux DECnet Networking Layer Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="dns_resolver.html">DNS Resolver Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="driver.html">Softnet Driver Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="eql.html">EQL Driver: Serial IP Load Balancing HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="fib_trie.html">LC-trie implementation notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter.html">Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic-hdlc.html">Generic HDLC layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic_netlink.html">Generic Netlink</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_stats.html">Generic networking statistics for netlink users</a></li>
<li class="toctree-l2"><a class="reference internal" href="gtp.html">The Linux kernel GTP tunneling module</a></li>
<li class="toctree-l2"><a class="reference internal" href="ila.html">Identifier Locator Addressing (ILA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam6-sysctl.html">IOAM6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipddp.html">AppleTalk-IP Decapsulation and AppleTalk-IP Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_dynaddr.html">IP dynamic address hack-port v0.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipsec.html">IPsec</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip-sysctl.html">IP Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvlan.html">IPVLAN Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvs-sysctl.html">IPvs-sysctl</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Kernel Connection Multiplexor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#kcm-sockets">KCM sockets</a></li>
<li class="toctree-l3"><a class="reference internal" href="#multiplexor">Multiplexor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tcp-sockets-psocks">TCP sockets &amp; Psocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connected-mode-semantics">Connected mode semantics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#socket-types">Socket types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#message-delineation">Message delineation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tcp-socket-management">TCP socket management</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#user-interface">User interface</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#creating-a-multiplexor">Creating a multiplexor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cloning-kcm-sockets">Cloning KCM sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#attach-transport-sockets">Attach transport sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unattach-transport-sockets">Unattach transport sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disabling-receive-on-kcm-socket">Disabling receive on KCM socket</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bfp-programs-for-message-delineation">BFP programs for message delineation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#use-in-applications">Use in applications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#configurations">Configurations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#message-batching">Message batching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#error-handling">Error handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tcp-connection-monitoring">TCP connection monitoring</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="l2tp.html">L2TP</a></li>
<li class="toctree-l2"><a class="reference internal" href="lapb-module.html">The Linux LAPB Module Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="mac80211-injection.html">How to use packet injection with mac80211</a></li>
<li class="toctree-l2"><a class="reference internal" href="mctp.html">Management Component Transport Protocol (MCTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpls-sysctl.html">MPLS Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="mptcp-sysctl.html">MPTCP Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiqueue.html">HOWTO for multiqueue network device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="netconsole.html">Netconsole</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdev-features.html">Netdev features mess and how to get out from it alive</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdevices.html">Network Devices, the Kernel, and You!</a></li>
<li class="toctree-l2"><a class="reference internal" href="netfilter-sysctl.html">Netfilter Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="netif-msg.html">NETIF Msg Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="nexthop-group-resilient.html">Resilient Next-hop Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_conntrack-sysctl.html">Netfilter Conntrack Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_flowtable.html">Netfilter’s flowtable infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="openvswitch.html">Open vSwitch datapath developer documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="operstates.html">Operational States</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_mmap.html">Packet MMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="phonet.html">Linux Phonet protocol family</a></li>
<li class="toctree-l2"><a class="reference internal" href="pktgen.html">HOWTO for the linux packet generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="plip.html">PLIP: The Parallel Line Internet Protocol Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppp_generic.html">PPP Generic Driver and Channel Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_net_tcp.html">The proc/net/tcp and proc/net/tcp6 variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="radiotap-headers.html">How to use radiotap headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="rds.html">RDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulatory.html">Linux wireless regulatory documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html">RxRPC Network Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#socket-options">SOCKET OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#security">SECURITY</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#example-client-usage">EXAMPLE CLIENT USAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="sctp.html">Linux Kernel SCTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="secid.html">LSM/SeLinux secid</a></li>
<li class="toctree-l2"><a class="reference internal" href="seg6-sysctl.html">Seg6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc-sysctl.html">SMC Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html">Interface statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="strparser.html">Stream Parser (strparser)</a></li>
<li class="toctree-l2"><a class="reference internal" href="switchdev.html">Ethernet switch device driver model (switchdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-tagging.html">Sysfs tagging</a></li>
<li class="toctree-l2"><a class="reference internal" href="tc-actions-env-rules.html">TC Actions - Environmental Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="tcp-thin.html">Thin-streams and TCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="team.html">Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamping.html">Timestamping</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipc.html">Linux Kernel TIPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="tproxy.html">Transparent proxy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuntap.html">Universal TUN/TAP device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="udplite.html">The UDP-Lite protocol (RFC 3828)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vrf.html">Virtual Routing and Forwarding (VRF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vxlan.html">Virtual eXtensible Local Area Networking documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html">Packet Layer to Device Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#device-driver-to-packet-layer">Device Driver to Packet Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#requirements-for-the-device-driver">Requirements for the device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25.html">Linux X.25 Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_device.html">XFRM device - offloading the IPsec computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_proc.html">XFRM proc - /proc/net/xfrm_* files</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sync.html">XFRM</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sysctl.html">XFRM Syscall</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Networking Documentation</a> &raquo;</li>
        
      <li>Kernel Connection Multiplexor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/kcm.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="kernel-connection-multiplexor">
<h1>Kernel Connection Multiplexor<a class="headerlink" href="#kernel-connection-multiplexor" title="Permalink to this headline">¶</a></h1>
<p>Kernel Connection Multiplexor (KCM) is a mechanism that provides a message based
interface over TCP for generic application protocols. With KCM an application
can efficiently send and receive application protocol messages over TCP using
datagram sockets.</p>
<p>KCM implements an NxM multiplexor in the kernel as diagrammed below:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>+------------+   +------------+   +------------+   +------------+
| KCM socket |   | KCM socket |   | KCM socket |   | KCM socket |
+------------+   +------------+   +------------+   +------------+
    |                 |               |                |
    +-----------+     |               |     +----------+
                |     |               |     |
            +----------------------------------+
            |           Multiplexor            |
            +----------------------------------+
                |   |           |           |  |
    +---------+   |           |           |  ------------+
    |             |           |           |              |
+----------+  +----------+  +----------+  +----------+ +----------+
|  Psock   |  |  Psock   |  |  Psock   |  |  Psock   | |  Psock   |
+----------+  +----------+  +----------+  +----------+ +----------+
    |              |           |            |             |
+----------+  +----------+  +----------+  +----------+ +----------+
| TCP sock |  | TCP sock |  | TCP sock |  | TCP sock | | TCP sock |
+----------+  +----------+  +----------+  +----------+ +----------+
</pre></div>
</div>
<div class="section" id="kcm-sockets">
<h2>KCM sockets<a class="headerlink" href="#kcm-sockets" title="Permalink to this headline">¶</a></h2>
<p>The KCM sockets provide the user interface to the multiplexor. All the KCM sockets
bound to a multiplexor are considered to have equivalent function, and I/O
operations in different sockets may be done in parallel without the need for
synchronization between threads in userspace.</p>
</div>
<div class="section" id="multiplexor">
<h2>Multiplexor<a class="headerlink" href="#multiplexor" title="Permalink to this headline">¶</a></h2>
<p>The multiplexor provides the message steering. In the transmit path, messages
written on a KCM socket are sent atomically on an appropriate TCP socket.
Similarly, in the receive path, messages are constructed on each TCP socket
(Psock) and complete messages are steered to a KCM socket.</p>
</div>
<div class="section" id="tcp-sockets-psocks">
<h2>TCP sockets &amp; Psocks<a class="headerlink" href="#tcp-sockets-psocks" title="Permalink to this headline">¶</a></h2>
<p>TCP sockets may be bound to a KCM multiplexor. A Psock structure is allocated
for each bound TCP socket, this structure holds the state for constructing
messages on receive as well as other connection specific information for KCM.</p>
</div>
<div class="section" id="connected-mode-semantics">
<h2>Connected mode semantics<a class="headerlink" href="#connected-mode-semantics" title="Permalink to this headline">¶</a></h2>
<p>Each multiplexor assumes that all attached TCP connections are to the same
destination and can use the different connections for load balancing when
transmitting. The normal send and recv calls (include sendmmsg and recvmmsg)
can be used to send and receive messages from the KCM socket.</p>
</div>
<div class="section" id="socket-types">
<h2>Socket types<a class="headerlink" href="#socket-types" title="Permalink to this headline">¶</a></h2>
<p>KCM supports SOCK_DGRAM and SOCK_SEQPACKET socket types.</p>
<div class="section" id="message-delineation">
<h3>Message delineation<a class="headerlink" href="#message-delineation" title="Permalink to this headline">¶</a></h3>
<p>Messages are sent over a TCP stream with some application protocol message
format that typically includes a header which frames the messages. The length
of a received message can be deduced from the application protocol header
(often just a simple length field).</p>
<p>A TCP stream must be parsed to determine message boundaries. Berkeley Packet
Filter (BPF) is used for this. When attaching a TCP socket to a multiplexor a
BPF program must be specified. The program is called at the start of receiving
a new message and is given an skbuff that contains the bytes received so far.
It parses the message header and returns the length of the message. Given this
information, KCM will construct the message of the stated length and deliver it
to a KCM socket.</p>
</div>
<div class="section" id="tcp-socket-management">
<h3>TCP socket management<a class="headerlink" href="#tcp-socket-management" title="Permalink to this headline">¶</a></h3>
<p>When a TCP socket is attached to a KCM multiplexor data ready (POLLIN) and
write space available (POLLOUT) events are handled by the multiplexor. If there
is a state change (disconnection) or other error on a TCP socket, an error is
posted on the TCP socket so that a POLLERR event happens and KCM discontinues
using the socket. When the application gets the error notification for a
TCP socket, it should unattach the socket from KCM and then handle the error
condition (the typical response is to close the socket and create a new
connection if necessary).</p>
<p>KCM limits the maximum receive message size to be the size of the receive
socket buffer on the attached TCP socket (the socket buffer size can be set by
SO_RCVBUF). If the length of a new message reported by the BPF program is
greater than this limit a corresponding error (EMSGSIZE) is posted on the TCP
socket. The BPF program may also enforce a maximum messages size and report an
error when it is exceeded.</p>
<p>A timeout may be set for assembling messages on a receive socket. The timeout
value is taken from the receive timeout of the attached TCP socket (this is set
by SO_RCVTIMEO). If the timer expires before assembly is complete an error
(ETIMEDOUT) is posted on the socket.</p>
</div>
</div>
<div class="section" id="user-interface">
<h2>User interface<a class="headerlink" href="#user-interface" title="Permalink to this headline">¶</a></h2>
<div class="section" id="creating-a-multiplexor">
<h3>Creating a multiplexor<a class="headerlink" href="#creating-a-multiplexor" title="Permalink to this headline">¶</a></h3>
<p>A new multiplexor and initial KCM socket is created by a socket call:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>socket(AF_KCM, type, protocol)
</pre></div>
</div>
<ul class="simple">
<li>type is either SOCK_DGRAM or SOCK_SEQPACKET</li>
<li>protocol is KCMPROTO_CONNECTED</li>
</ul>
</div>
<div class="section" id="cloning-kcm-sockets">
<h3>Cloning KCM sockets<a class="headerlink" href="#cloning-kcm-sockets" title="Permalink to this headline">¶</a></h3>
<p>After the first KCM socket is created using the socket call as described
above, additional sockets for the multiplexor can be created by cloning
a KCM socket. This is accomplished by an ioctl on a KCM socket:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* From linux/kcm.h */
struct kcm_clone {
      int fd;
};

struct kcm_clone info;

memset(&amp;info, 0, sizeof(info));

err = ioctl(kcmfd, SIOCKCMCLONE, &amp;info);

if (!err)
  newkcmfd = info.fd;
</pre></div>
</div>
</div>
<div class="section" id="attach-transport-sockets">
<h3>Attach transport sockets<a class="headerlink" href="#attach-transport-sockets" title="Permalink to this headline">¶</a></h3>
<p>Attaching of transport sockets to a multiplexor is performed by calling an
ioctl on a KCM socket for the multiplexor. e.g.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* From linux/kcm.h */
struct kcm_attach {
      int fd;
      int bpf_fd;
};

struct kcm_attach info;

memset(&amp;info, 0, sizeof(info));

info.fd = tcpfd;
info.bpf_fd = bpf_prog_fd;

ioctl(kcmfd, SIOCKCMATTACH, &amp;info);
</pre></div>
</div>
<p>The kcm_attach structure contains:</p>
<blockquote>
<div><ul class="simple">
<li>fd: file descriptor for TCP socket being attached</li>
<li>bpf_prog_fd: file descriptor for compiled BPF program downloaded</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="unattach-transport-sockets">
<h3>Unattach transport sockets<a class="headerlink" href="#unattach-transport-sockets" title="Permalink to this headline">¶</a></h3>
<p>Unattaching a transport socket from a multiplexor is straightforward. An
“unattach” ioctl is done with the kcm_unattach structure as the argument:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* From linux/kcm.h */
struct kcm_unattach {
      int fd;
};

struct kcm_unattach info;

memset(&amp;info, 0, sizeof(info));

info.fd = cfd;

ioctl(fd, SIOCKCMUNATTACH, &amp;info);
</pre></div>
</div>
</div>
<div class="section" id="disabling-receive-on-kcm-socket">
<h3>Disabling receive on KCM socket<a class="headerlink" href="#disabling-receive-on-kcm-socket" title="Permalink to this headline">¶</a></h3>
<p>A setsockopt is used to disable or enable receiving on a KCM socket.
When receive is disabled, any pending messages in the socket’s
receive buffer are moved to other sockets. This feature is useful
if an application thread knows that it will be doing a lot of
work on a request and won’t be able to service new messages for a
while. Example use:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int val = 1;

setsockopt(kcmfd, SOL_KCM, KCM_RECV_DISABLE, &amp;val, sizeof(val))
</pre></div>
</div>
</div>
<div class="section" id="bfp-programs-for-message-delineation">
<h3>BFP programs for message delineation<a class="headerlink" href="#bfp-programs-for-message-delineation" title="Permalink to this headline">¶</a></h3>
<p>BPF programs can be compiled using the BPF LLVM backend. For example,
the BPF program for parsing Thrift is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &quot;bpf.h&quot; /* for __sk_buff */
#include &quot;bpf_helpers.h&quot; /* for load_word intrinsic */

SEC(&quot;socket_kcm&quot;)
int bpf_prog1(struct __sk_buff *skb)
{
     return load_word(skb, 0) + 4;
}

char _license[] SEC(&quot;license&quot;) = &quot;GPL&quot;;
</pre></div>
</div>
</div>
</div>
<div class="section" id="use-in-applications">
<h2>Use in applications<a class="headerlink" href="#use-in-applications" title="Permalink to this headline">¶</a></h2>
<p>KCM accelerates application layer protocols. Specifically, it allows
applications to use a message based interface for sending and receiving
messages. The kernel provides necessary assurances that messages are sent
and received atomically. This relieves much of the burden applications have
in mapping a message based protocol onto the TCP stream. KCM also make
application layer messages a unit of work in the kernel for the purposes of
steering and scheduling, which in turn allows a simpler networking model in
multithreaded applications.</p>
<div class="section" id="configurations">
<h3>Configurations<a class="headerlink" href="#configurations" title="Permalink to this headline">¶</a></h3>
<p>In an Nx1 configuration, KCM logically provides multiple socket handles
to the same TCP connection. This allows parallelism between in I/O
operations on the TCP socket (for instance copyin and copyout of data is
parallelized). In an application, a KCM socket can be opened for each
processing thread and inserted into the epoll (similar to how SO_REUSEPORT
is used to allow multiple listener sockets on the same port).</p>
<p>In a MxN configuration, multiple connections are established to the
same destination. These are used for simple load balancing.</p>
</div>
<div class="section" id="message-batching">
<h3>Message batching<a class="headerlink" href="#message-batching" title="Permalink to this headline">¶</a></h3>
<p>The primary purpose of KCM is load balancing between KCM sockets and hence
threads in a nominal use case. Perfect load balancing, that is steering
each received message to a different KCM socket or steering each sent
message to a different TCP socket, can negatively impact performance
since this doesn’t allow for affinities to be established. Balancing
based on groups, or batches of messages, can be beneficial for performance.</p>
<p>On transmit, there are three ways an application can batch (pipeline)
messages on a KCM socket.</p>
<blockquote>
<div><ol class="arabic simple">
<li>Send multiple messages in a single sendmmsg.</li>
<li>Send a group of messages each with a sendmsg call, where all messages
except the last have MSG_BATCH in the flags of sendmsg call.</li>
<li>Create “super message” composed of multiple messages and send this
with a single sendmsg.</li>
</ol>
</div></blockquote>
<p>On receive, the KCM module attempts to queue messages received on the
same KCM socket during each TCP ready callback. The targeted KCM socket
changes at each receive ready callback on the KCM socket. The application
does not need to configure this.</p>
</div>
<div class="section" id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<p>An application should include a thread to monitor errors raised on
the TCP connection. Normally, this will be done by placing each
TCP socket attached to a KCM multiplexor in epoll set for POLLERR
event. If an error occurs on an attached TCP socket, KCM sets an EPIPE
on the socket thus waking up the application thread. When the application
sees the error (which may just be a disconnect) it should unattach the
socket from KCM and then close it. It is assumed that once an error is
posted on the TCP socket the data stream is unrecoverable (i.e. an error
may have occurred in the middle of receiving a message).</p>
</div>
<div class="section" id="tcp-connection-monitoring">
<h3>TCP connection monitoring<a class="headerlink" href="#tcp-connection-monitoring" title="Permalink to this headline">¶</a></h3>
<p>In KCM there is no means to correlate a message to the TCP socket that
was used to send or receive the message (except in the case there is
only one attached TCP socket). However, the application does retain
an open file descriptor to the socket so it will be able to get statistics
from the socket which can be used in detecting issues (such as high
retransmissions on the socket).</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="l2tp.html" class="btn btn-neutral float-right" title="L2TP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ipvs-sysctl.html" class="btn btn-neutral" title="IPvs-sysctl" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>