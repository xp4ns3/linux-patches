

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>L2TP &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Networking Documentation" href="index.html"/>
        <link rel="next" title="The Linux LAPB Module Interface" href="lapb-module.html"/>
        <link rel="prev" title="Kernel Connection Multiplexor" href="kcm.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Networking Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="bareudp.html">Bare UDP Tunnelling Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="batman-adv.html">batman-adv</a></li>
<li class="toctree-l2"><a class="reference internal" href="can.html">SocketCAN - Controller Area Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="can_ucan_protocol.html">The UCAN Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_drivers/index.html">Hardware Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsa/index.html">Distributed Switch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devlink/index.html">Linux Devlink Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="caif/index.html">CAIF</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool-netlink.html">Netlink interface for ethtool</a></li>
<li class="toctree-l2"><a class="reference internal" href="ieee802154.html">IEEE 802.15.4 Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="j1939.html">J1939 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="kapi.html">Linux Networking and Network Devices APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="msg_zerocopy.html">MSG_ZEROCOPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="failover.html">FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_dim.html">Net DIM - Generic Network Dynamic Interrupt Moderation</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_failover.html">NET_FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_pool.html">Page Pool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">PHY Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp-phylink.html">phylink</a></li>
<li class="toctree-l2"><a class="reference internal" href="alias.html">IP-Aliasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="bridge.html">Ethernet Bridging</a></li>
<li class="toctree-l2"><a class="reference internal" href="snmp_counter.html">SNMP counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="checksum-offloads.html">Checksum Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="segmentation-offloads.html">Segmentation Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="scaling.html">Scaling in the Linux Networking Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">Kernel TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls-offload.html">Kernel TLS offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="nfc.html">Linux NFC subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="6lowpan.html">Netdev private dataroom for 6lowpan interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="6pack.html">6pack Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet-hardware.html">ARCnet Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet.html">ARCnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="atm.html">ATM</a></li>
<li class="toctree-l2"><a class="reference internal" href="ax25.html">AX.25</a></li>
<li class="toctree-l2"><a class="reference internal" href="bonding.html">Linux Ethernet Bonding Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc_mbim.html">cdc_mbim - Driver for CDC MBIM Mobile Broadband modems</a></li>
<li class="toctree-l2"><a class="reference internal" href="dccp.html">DCCP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="dctcp.html">DCTCP (DataCenter TCP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="decnet.html">Linux DECnet Networking Layer Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="dns_resolver.html">DNS Resolver Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="driver.html">Softnet Driver Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="eql.html">EQL Driver: Serial IP Load Balancing HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="fib_trie.html">LC-trie implementation notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="filter.html">Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic-hdlc.html">Generic HDLC layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic_netlink.html">Generic Netlink</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_stats.html">Generic networking statistics for netlink users</a></li>
<li class="toctree-l2"><a class="reference internal" href="gtp.html">The Linux kernel GTP tunneling module</a></li>
<li class="toctree-l2"><a class="reference internal" href="ila.html">Identifier Locator Addressing (ILA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam6-sysctl.html">IOAM6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipddp.html">AppleTalk-IP Decapsulation and AppleTalk-IP Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_dynaddr.html">IP dynamic address hack-port v0.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipsec.html">IPsec</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip-sysctl.html">IP Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvlan.html">IPVLAN Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvs-sysctl.html">IPvs-sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="kcm.html">Kernel Connection Multiplexor</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">L2TP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#l2tp-apis">L2TP APIs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#tunnel-sockets">Tunnel Sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#netlink-api">Netlink API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pppol2tp-session-socket-api">PPPoL2TP Session Socket API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#old-l2tpv2-only-api">Old L2TPv2-only API</a></li>
<li class="toctree-l4"><a class="reference internal" href="#unmanaged-l2tpv3-tunnels">Unmanaged L2TPv3 tunnels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#debugging">Debugging</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#internal-implementation">Internal Implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sockets">Sockets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tunnels">Tunnels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sessions">Sessions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ppp">PPP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ethernet">Ethernet</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#miscellaneous">Miscellaneous</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#rfcs">RFCs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#implementations">Implementations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#limitations">Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing">Testing</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lapb-module.html">The Linux LAPB Module Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="mac80211-injection.html">How to use packet injection with mac80211</a></li>
<li class="toctree-l2"><a class="reference internal" href="mctp.html">Management Component Transport Protocol (MCTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpls-sysctl.html">MPLS Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="mptcp-sysctl.html">MPTCP Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiqueue.html">HOWTO for multiqueue network device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="netconsole.html">Netconsole</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdev-features.html">Netdev features mess and how to get out from it alive</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdevices.html">Network Devices, the Kernel, and You!</a></li>
<li class="toctree-l2"><a class="reference internal" href="netfilter-sysctl.html">Netfilter Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="netif-msg.html">NETIF Msg Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="nexthop-group-resilient.html">Resilient Next-hop Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_conntrack-sysctl.html">Netfilter Conntrack Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_flowtable.html">Netfilter’s flowtable infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="openvswitch.html">Open vSwitch datapath developer documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="operstates.html">Operational States</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_mmap.html">Packet MMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="phonet.html">Linux Phonet protocol family</a></li>
<li class="toctree-l2"><a class="reference internal" href="pktgen.html">HOWTO for the linux packet generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="plip.html">PLIP: The Parallel Line Internet Protocol Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppp_generic.html">PPP Generic Driver and Channel Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_net_tcp.html">The proc/net/tcp and proc/net/tcp6 variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="radiotap-headers.html">How to use radiotap headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="rds.html">RDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulatory.html">Linux wireless regulatory documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html">RxRPC Network Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#socket-options">SOCKET OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#security">SECURITY</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#example-client-usage">EXAMPLE CLIENT USAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="sctp.html">Linux Kernel SCTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="secid.html">LSM/SeLinux secid</a></li>
<li class="toctree-l2"><a class="reference internal" href="seg6-sysctl.html">Seg6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc-sysctl.html">SMC Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html">Interface statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="strparser.html">Stream Parser (strparser)</a></li>
<li class="toctree-l2"><a class="reference internal" href="switchdev.html">Ethernet switch device driver model (switchdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-tagging.html">Sysfs tagging</a></li>
<li class="toctree-l2"><a class="reference internal" href="tc-actions-env-rules.html">TC Actions - Environmental Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="tcp-thin.html">Thin-streams and TCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="team.html">Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamping.html">Timestamping</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipc.html">Linux Kernel TIPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="tproxy.html">Transparent proxy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuntap.html">Universal TUN/TAP device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="udplite.html">The UDP-Lite protocol (RFC 3828)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vrf.html">Virtual Routing and Forwarding (VRF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vxlan.html">Virtual eXtensible Local Area Networking documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html">Packet Layer to Device Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#device-driver-to-packet-layer">Device Driver to Packet Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#requirements-for-the-device-driver">Requirements for the device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25.html">Linux X.25 Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_device.html">XFRM device - offloading the IPsec computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_proc.html">XFRM proc - /proc/net/xfrm_* files</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sync.html">XFRM</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sysctl.html">XFRM Syscall</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Networking Documentation</a> &raquo;</li>
        
      <li>L2TP</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/l2tp.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="l2tp">
<h1>L2TP<a class="headerlink" href="#l2tp" title="Permalink to this headline">¶</a></h1>
<p>Layer 2 Tunneling Protocol (L2TP) allows L2 frames to be tunneled over
an IP network.</p>
<p>This document covers the kernel’s L2TP subsystem. It documents kernel
APIs for application developers who want to use the L2TP subsystem and
it provides some technical details about the internal implementation
which may be useful to kernel developers and maintainers.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>The kernel’s L2TP subsystem implements the datapath for L2TPv2 and
L2TPv3. L2TPv2 is carried over UDP. L2TPv3 is carried over UDP or
directly over IP (protocol 115).</p>
<p>The L2TP RFCs define two basic kinds of L2TP packets: control packets
(the “control plane”), and data packets (the “data plane”). The kernel
deals only with data packets. The more complex control packets are
handled by user space.</p>
<p>An L2TP tunnel carries one or more L2TP sessions. Each tunnel is
associated with a socket. Each session is associated with a virtual
netdevice, e.g. <code class="docutils literal notranslate"><span class="pre">pppN</span></code>, <code class="docutils literal notranslate"><span class="pre">l2tpethN</span></code>, through which data frames pass
to/from L2TP. Fields in the L2TP header identify the tunnel or session
and whether it is a control or data packet. When tunnels and sessions
are set up using the Linux kernel API, we’re just setting up the L2TP
data path. All aspects of the control protocol are to be handled by
user space.</p>
<p>This split in responsibilities leads to a natural sequence of
operations when establishing tunnels and sessions. The procedure looks
like this:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Create a tunnel socket. Exchange L2TP control protocol messages
with the peer over that socket in order to establish a tunnel.</li>
<li>Create a tunnel context in the kernel, using information
obtained from the peer using the control protocol messages.</li>
<li>Exchange L2TP control protocol messages with the peer over the
tunnel socket in order to establish a session.</li>
<li>Create a session context in the kernel using information
obtained from the peer using the control protocol messages.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="l2tp-apis">
<h2>L2TP APIs<a class="headerlink" href="#l2tp-apis" title="Permalink to this headline">¶</a></h2>
<p>This section documents each userspace API of the L2TP subsystem.</p>
<div class="section" id="tunnel-sockets">
<h3>Tunnel Sockets<a class="headerlink" href="#tunnel-sockets" title="Permalink to this headline">¶</a></h3>
<p>L2TPv2 always uses UDP. L2TPv3 may use UDP or IP encapsulation.</p>
<p>To create a tunnel socket for use by L2TP, the standard POSIX
socket API is used.</p>
<p>For example, for a tunnel using IPv4 addresses and UDP encapsulation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int sockfd = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
</pre></div>
</div>
<p>Or for a tunnel using IPv6 addresses and IP encapsulation:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>int sockfd = socket(AF_INET6, SOCK_DGRAM, IPPROTO_L2TP);
</pre></div>
</div>
<p>UDP socket programming doesn’t need to be covered here.</p>
<p>IPPROTO_L2TP is an IP protocol type implemented by the kernel’s L2TP
subsystem. The L2TPIP socket address is defined in struct
sockaddr_l2tpip and struct sockaddr_l2tpip6 at
<a class="reference external" href="../../../include/uapi/linux/l2tp.h">include/uapi/linux/l2tp.h</a>. The address includes the L2TP tunnel
(connection) id. To use L2TP IP encapsulation, an L2TPv3 application
should bind the L2TPIP socket using the locally assigned
tunnel id. When the peer’s tunnel id and IP address is known, a
connect must be done.</p>
<p>If the L2TP application needs to handle L2TPv3 tunnel setup requests
from peers using L2TPIP, it must open a dedicated L2TPIP
socket to listen for those requests and bind the socket using tunnel
id 0 since tunnel setup requests are addressed to tunnel id 0.</p>
<p>An L2TP tunnel and all of its sessions are automatically closed when
its tunnel socket is closed.</p>
</div>
<div class="section" id="netlink-api">
<h3>Netlink API<a class="headerlink" href="#netlink-api" title="Permalink to this headline">¶</a></h3>
<p>L2TP applications use netlink to manage L2TP tunnel and session
instances in the kernel. The L2TP netlink API is defined in
<a class="reference external" href="../../../include/uapi/linux/l2tp.h">include/uapi/linux/l2tp.h</a>.</p>
<p>L2TP uses <a class="reference external" href="generic_netlink.html">Generic Netlink</a> (GENL). Several commands are defined:
Create, Delete, Modify and Get for tunnel and session
instances, e.g. <code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_CREATE</span></code>. The API header lists the
netlink attribute types that can be used with each command.</p>
<p>Tunnel and session instances are identified by a locally unique
32-bit id.  L2TP tunnel ids are given by <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_CONN_ID</span></code> and
<code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_PEER_CONN_ID</span></code> attributes and L2TP session ids are given
by <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_SESSION_ID</span></code> and <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_PEER_SESSION_ID</span></code>
attributes. If netlink is used to manage L2TPv2 tunnel and session
instances, the L2TPv2 16-bit tunnel/session id is cast to a 32-bit
value in these attributes.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_CREATE</span></code> command, <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_FD</span></code> tells the
kernel the tunnel socket fd being used. If not specified, the kernel
creates a kernel socket for the tunnel, using IP parameters set in
<code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_IP[6]_SADDR</span></code>, <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_IP[6]_DADDR</span></code>,
<code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_UDP_SPORT</span></code>, <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_UDP_DPORT</span></code> attributes. Kernel
sockets are used to implement unmanaged L2TPv3 tunnels (iproute2’s “ip
l2tp” commands). If <code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_FD</span></code> is given, it must be a socket fd
that is already bound and connected. There is more information about
unmanaged tunnels later in this document.</p>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_CREATE</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="11%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>Sets the tunnel (connection) id.</td>
</tr>
<tr class="row-odd"><td>PEER_CONN_ID</td>
<td>Y</td>
<td>Sets the peer tunnel (connection) id.</td>
</tr>
<tr class="row-even"><td>PROTO_VERSION</td>
<td>Y</td>
<td>Protocol version. 2 or 3.</td>
</tr>
<tr class="row-odd"><td>ENCAP_TYPE</td>
<td>Y</td>
<td>Encapsulation type: UDP or IP.</td>
</tr>
<tr class="row-even"><td>FD</td>
<td>N</td>
<td>Tunnel socket file descriptor.</td>
</tr>
<tr class="row-odd"><td>UDP_CSUM</td>
<td>N</td>
<td>Enable IPv4 UDP checksums. Used only if FD is
not set.</td>
</tr>
<tr class="row-even"><td>UDP_ZERO_CSUM6_TX</td>
<td>N</td>
<td>Zero IPv6 UDP checksum on transmit. Used only
if FD is not set.</td>
</tr>
<tr class="row-odd"><td>UDP_ZERO_CSUM6_RX</td>
<td>N</td>
<td>Zero IPv6 UDP checksum on receive. Used only if
FD is not set.</td>
</tr>
<tr class="row-even"><td>IP_SADDR</td>
<td>N</td>
<td>IPv4 source address. Used only if FD is not
set.</td>
</tr>
<tr class="row-odd"><td>IP_DADDR</td>
<td>N</td>
<td>IPv4 destination address. Used only if FD is
not set.</td>
</tr>
<tr class="row-even"><td>UDP_SPORT</td>
<td>N</td>
<td>UDP source port. Used only if FD is not set.</td>
</tr>
<tr class="row-odd"><td>UDP_DPORT</td>
<td>N</td>
<td>UDP destination port. Used only if FD is not
set.</td>
</tr>
<tr class="row-even"><td>IP6_SADDR</td>
<td>N</td>
<td>IPv6 source address. Used only if FD is not
set.</td>
</tr>
<tr class="row-odd"><td>IP6_DADDR</td>
<td>N</td>
<td>IPv6 destination address. Used only if FD is
not set.</td>
</tr>
<tr class="row-even"><td>DEBUG</td>
<td>N</td>
<td>Debug flags.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_DESTROY</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="12%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>Identifies the tunnel id to be destroyed.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_MODIFY</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="12%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>Identifies the tunnel id to be modified.</td>
</tr>
<tr class="row-odd"><td>DEBUG</td>
<td>N</td>
<td>Debug flags.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_GET</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="28%" />
<col width="12%" />
<col width="60%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>N</td>
<td>Identifies the tunnel id to be queried.
Ignored in DUMP requests.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_SESSION_CREATE</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="26%" />
<col width="12%" />
<col width="62%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>The parent tunnel id.</td>
</tr>
<tr class="row-odd"><td>SESSION_ID</td>
<td>Y</td>
<td>Sets the session id.</td>
</tr>
<tr class="row-even"><td>PEER_SESSION_ID</td>
<td>Y</td>
<td>Sets the parent session id.</td>
</tr>
<tr class="row-odd"><td>PW_TYPE</td>
<td>Y</td>
<td>Sets the pseudowire type.</td>
</tr>
<tr class="row-even"><td>DEBUG</td>
<td>N</td>
<td>Debug flags.</td>
</tr>
<tr class="row-odd"><td>RECV_SEQ</td>
<td>N</td>
<td>Enable rx data sequence numbers.</td>
</tr>
<tr class="row-even"><td>SEND_SEQ</td>
<td>N</td>
<td>Enable tx data sequence numbers.</td>
</tr>
<tr class="row-odd"><td>LNS_MODE</td>
<td>N</td>
<td>Enable LNS mode (auto-enable data sequence
numbers).</td>
</tr>
<tr class="row-even"><td>RECV_TIMEOUT</td>
<td>N</td>
<td>Timeout to wait when reordering received
packets.</td>
</tr>
<tr class="row-odd"><td>L2SPEC_TYPE</td>
<td>N</td>
<td>Sets layer2-specific-sublayer type (L2TPv3
only).</td>
</tr>
<tr class="row-even"><td>COOKIE</td>
<td>N</td>
<td>Sets optional cookie (L2TPv3 only).</td>
</tr>
<tr class="row-odd"><td>PEER_COOKIE</td>
<td>N</td>
<td>Sets optional peer cookie (L2TPv3 only).</td>
</tr>
<tr class="row-even"><td>IFNAME</td>
<td>N</td>
<td>Sets interface name (L2TPv3 only).</td>
</tr>
</tbody>
</table>
<p>For Ethernet session types, this will create an l2tpeth virtual
interface which can then be configured as required. For PPP session
types, a PPPoL2TP socket must also be opened and connected, mapping it
onto the new session. This is covered in “PPPoL2TP Sockets” later.</p>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_SESSION_DESTROY</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="11%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>Identifies the parent tunnel id of the session
to be destroyed.</td>
</tr>
<tr class="row-odd"><td>SESSION_ID</td>
<td>Y</td>
<td>Identifies the session id to be destroyed.</td>
</tr>
<tr class="row-even"><td>IFNAME</td>
<td>N</td>
<td>Identifies the session by interface name. If
set, this overrides any CONN_ID and SESSION_ID
attributes. Currently supported for L2TPv3
Ethernet sessions only.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_SESSION_MODIFY</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="11%" />
<col width="64%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>Y</td>
<td>Identifies the parent tunnel id of the session
to be modified.</td>
</tr>
<tr class="row-odd"><td>SESSION_ID</td>
<td>Y</td>
<td>Identifies the session id to be modified.</td>
</tr>
<tr class="row-even"><td>IFNAME</td>
<td>N</td>
<td>Identifies the session by interface name. If
set, this overrides any CONN_ID and SESSION_ID
attributes. Currently supported for L2TPv3
Ethernet sessions only.</td>
</tr>
<tr class="row-odd"><td>DEBUG</td>
<td>N</td>
<td>Debug flags.</td>
</tr>
<tr class="row-even"><td>RECV_SEQ</td>
<td>N</td>
<td>Enable rx data sequence numbers.</td>
</tr>
<tr class="row-odd"><td>SEND_SEQ</td>
<td>N</td>
<td>Enable tx data sequence numbers.</td>
</tr>
<tr class="row-even"><td>LNS_MODE</td>
<td>N</td>
<td>Enable LNS mode (auto-enable data sequence
numbers).</td>
</tr>
<tr class="row-odd"><td>RECV_TIMEOUT</td>
<td>N</td>
<td>Timeout to wait when reordering received
packets.</td>
</tr>
</tbody>
</table>
<p><code class="docutils literal notranslate"><span class="pre">L2TP_CMD_SESSION_GET</span></code> attributes:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="27%" />
<col width="12%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Attribute</th>
<th class="head">Required</th>
<th class="head">Use</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CONN_ID</td>
<td>N</td>
<td>Identifies the tunnel id to be queried.
Ignored for DUMP requests.</td>
</tr>
<tr class="row-odd"><td>SESSION_ID</td>
<td>N</td>
<td>Identifies the session id to be queried.
Ignored for DUMP requests.</td>
</tr>
<tr class="row-even"><td>IFNAME</td>
<td>N</td>
<td>Identifies the session by interface name.
If set, this overrides any CONN_ID and
SESSION_ID attributes. Ignored for DUMP
requests. Currently supported for L2TPv3
Ethernet sessions only.</td>
</tr>
</tbody>
</table>
<p>Application developers should refer to <a class="reference external" href="../../../include/uapi/linux/l2tp.h">include/uapi/linux/l2tp.h</a> for
netlink command and attribute definitions.</p>
<p>Sample userspace code using <a class="reference external" href="https://www.netfilter.org/projects/libmnl">libmnl</a>:</p>
<blockquote>
<div><ul>
<li><p class="first">Open L2TP netlink socket:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct nl_sock *nl_sock;
int l2tp_nl_family_id;

nl_sock = nl_socket_alloc();
genl_connect(nl_sock);
genl_id = genl_ctrl_resolve(nl_sock, L2TP_GENL_NAME);
</pre></div>
</div>
</li>
<li><p class="first">Create a tunnel:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct nlmsghdr *nlh;
struct genlmsghdr *gnlh;

nlh = mnl_nlmsg_put_header(buf);
nlh-&gt;nlmsg_type = genl_id; /* assigned to genl socket */
nlh-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ACK;
nlh-&gt;nlmsg_seq = seq;

gnlh = mnl_nlmsg_put_extra_header(nlh, sizeof(*gnlh));
gnlh-&gt;cmd = L2TP_CMD_TUNNEL_CREATE;
gnlh-&gt;version = L2TP_GENL_VERSION;
gnlh-&gt;reserved = 0;

mnl_attr_put_u32(nlh, L2TP_ATTR_FD, tunl_sock_fd);
mnl_attr_put_u32(nlh, L2TP_ATTR_CONN_ID, tid);
mnl_attr_put_u32(nlh, L2TP_ATTR_PEER_CONN_ID, peer_tid);
mnl_attr_put_u8(nlh, L2TP_ATTR_PROTO_VERSION, protocol_version);
mnl_attr_put_u16(nlh, L2TP_ATTR_ENCAP_TYPE, encap);
</pre></div>
</div>
</li>
<li><p class="first">Create a session:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct nlmsghdr *nlh;
struct genlmsghdr *gnlh;

nlh = mnl_nlmsg_put_header(buf);
nlh-&gt;nlmsg_type = genl_id; /* assigned to genl socket */
nlh-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ACK;
nlh-&gt;nlmsg_seq = seq;

gnlh = mnl_nlmsg_put_extra_header(nlh, sizeof(*gnlh));
gnlh-&gt;cmd = L2TP_CMD_SESSION_CREATE;
gnlh-&gt;version = L2TP_GENL_VERSION;
gnlh-&gt;reserved = 0;

mnl_attr_put_u32(nlh, L2TP_ATTR_CONN_ID, tid);
mnl_attr_put_u32(nlh, L2TP_ATTR_PEER_CONN_ID, peer_tid);
mnl_attr_put_u32(nlh, L2TP_ATTR_SESSION_ID, sid);
mnl_attr_put_u32(nlh, L2TP_ATTR_PEER_SESSION_ID, peer_sid);
mnl_attr_put_u16(nlh, L2TP_ATTR_PW_TYPE, pwtype);
/* there are other session options which can be set using netlink
 * attributes during session creation -- see l2tp.h
 */
</pre></div>
</div>
</li>
<li><p class="first">Delete a session:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct nlmsghdr *nlh;
struct genlmsghdr *gnlh;

nlh = mnl_nlmsg_put_header(buf);
nlh-&gt;nlmsg_type = genl_id; /* assigned to genl socket */
nlh-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ACK;
nlh-&gt;nlmsg_seq = seq;

gnlh = mnl_nlmsg_put_extra_header(nlh, sizeof(*gnlh));
gnlh-&gt;cmd = L2TP_CMD_SESSION_DELETE;
gnlh-&gt;version = L2TP_GENL_VERSION;
gnlh-&gt;reserved = 0;

mnl_attr_put_u32(nlh, L2TP_ATTR_CONN_ID, tid);
mnl_attr_put_u32(nlh, L2TP_ATTR_SESSION_ID, sid);
</pre></div>
</div>
</li>
<li><p class="first">Delete a tunnel and all of its sessions (if any):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct nlmsghdr *nlh;
struct genlmsghdr *gnlh;

nlh = mnl_nlmsg_put_header(buf);
nlh-&gt;nlmsg_type = genl_id; /* assigned to genl socket */
nlh-&gt;nlmsg_flags = NLM_F_REQUEST | NLM_F_ACK;
nlh-&gt;nlmsg_seq = seq;

gnlh = mnl_nlmsg_put_extra_header(nlh, sizeof(*gnlh));
gnlh-&gt;cmd = L2TP_CMD_TUNNEL_DELETE;
gnlh-&gt;version = L2TP_GENL_VERSION;
gnlh-&gt;reserved = 0;

mnl_attr_put_u32(nlh, L2TP_ATTR_CONN_ID, tid);
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="pppol2tp-session-socket-api">
<h3>PPPoL2TP Session Socket API<a class="headerlink" href="#pppol2tp-session-socket-api" title="Permalink to this headline">¶</a></h3>
<p>For PPP session types, a PPPoL2TP socket must be opened and connected
to the L2TP session.</p>
<p>When creating PPPoL2TP sockets, the application provides information
to the kernel about the tunnel and session in a socket connect()
call. Source and destination tunnel and session ids are provided, as
well as the file descriptor of a UDP or L2TPIP socket. See struct
pppol2tp_addr in <a class="reference external" href="../../../include/linux/if_pppol2tp.h">include/linux/if_pppol2tp.h</a>. For historical reasons,
there are unfortunately slightly different address structures for
L2TPv2/L2TPv3 IPv4/IPv6 tunnels and userspace must use the appropriate
structure that matches the tunnel socket type.</p>
<p>Userspace may control behavior of the tunnel or session using
setsockopt and ioctl on the PPPoX socket. The following socket
options are supported:-</p>
<table border="1" class="docutils">
<colgroup>
<col width="13%" />
<col width="87%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>DEBUG</td>
<td>bitmask of debug message categories. See below.</td>
</tr>
<tr class="row-even"><td>SENDSEQ</td>
<td><ul class="first last simple">
<li>0 =&gt; don’t send packets with sequence numbers</li>
<li>1 =&gt; send packets with sequence numbers</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>RECVSEQ</td>
<td><ul class="first last simple">
<li>0 =&gt; receive packet sequence numbers are optional</li>
<li>1 =&gt; drop receive packets without sequence numbers</li>
</ul>
</td>
</tr>
<tr class="row-even"><td>LNSMODE</td>
<td><ul class="first last simple">
<li>0 =&gt; act as LAC.</li>
<li>1 =&gt; act as LNS.</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>REORDERTO</td>
<td>reorder timeout (in millisecs). If 0, don’t try to reorder.</td>
</tr>
</tbody>
</table>
<p>In addition to the standard PPP ioctls, a PPPIOCGL2TPSTATS is provided
to retrieve tunnel and session statistics from the kernel using the
PPPoX socket of the appropriate tunnel or session.</p>
<p>Sample userspace code:</p>
<blockquote>
<div><ul>
<li><p class="first">Create session PPPoX data socket:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sockaddr_pppol2tp sax;
int fd;

/* Note, the tunnel socket must be bound already, else it
 * will not be ready
 */
sax.sa_family = AF_PPPOX;
sax.sa_protocol = PX_PROTO_OL2TP;
sax.pppol2tp.fd = tunnel_fd;
sax.pppol2tp.addr.sin_addr.s_addr = addr-&gt;sin_addr.s_addr;
sax.pppol2tp.addr.sin_port = addr-&gt;sin_port;
sax.pppol2tp.addr.sin_family = AF_INET;
sax.pppol2tp.s_tunnel  = tunnel_id;
sax.pppol2tp.s_session = session_id;
sax.pppol2tp.d_tunnel  = peer_tunnel_id;
sax.pppol2tp.d_session = peer_session_id;

/* session_fd is the fd of the session&#39;s PPPoL2TP socket.
 * tunnel_fd is the fd of the tunnel UDP / L2TPIP socket.
 */
fd = connect(session_fd, (struct sockaddr *)&amp;sax, sizeof(sax));
if (fd &lt; 0 ) {
        return -errno;
}
return 0;
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="old-l2tpv2-only-api">
<h3>Old L2TPv2-only API<a class="headerlink" href="#old-l2tpv2-only-api" title="Permalink to this headline">¶</a></h3>
<p>When L2TP was first added to the Linux kernel in 2.6.23, it
implemented only L2TPv2 and did not include a netlink API. Instead,
tunnel and session instances in the kernel were managed directly using
only PPPoL2TP sockets. The PPPoL2TP socket is used as described in
section “PPPoL2TP Session Socket API” but tunnel and session instances
are automatically created on a connect() of the socket instead of
being created by a separate netlink request:</p>
<blockquote>
<div><ul class="simple">
<li>Tunnels are managed using a tunnel management socket which is a
dedicated PPPoL2TP socket, connected to (invalid) session
id 0. The L2TP tunnel instance is created when the PPPoL2TP
tunnel management socket is connected and is destroyed when the
socket is closed.</li>
<li>Session instances are created in the kernel when a PPPoL2TP
socket is connected to a non-zero session id. Session parameters
are set using setsockopt. The L2TP session instance is destroyed
when the socket is closed.</li>
</ul>
</div></blockquote>
<p>This API is still supported but its use is discouraged. Instead, new
L2TPv2 applications should use netlink to first create the tunnel and
session, then create a PPPoL2TP socket for the session.</p>
</div>
<div class="section" id="unmanaged-l2tpv3-tunnels">
<h3>Unmanaged L2TPv3 tunnels<a class="headerlink" href="#unmanaged-l2tpv3-tunnels" title="Permalink to this headline">¶</a></h3>
<p>The kernel L2TP subsystem also supports static (unmanaged) L2TPv3
tunnels. Unmanaged tunnels have no userspace tunnel socket, and
exchange no control messages with the peer to set up the tunnel; the
tunnel is configured manually at each end of the tunnel. All
configuration is done using netlink. There is no need for an L2TP
userspace application in this case – the tunnel socket is created by
the kernel and configured using parameters sent in the
<code class="docutils literal notranslate"><span class="pre">L2TP_CMD_TUNNEL_CREATE</span></code> netlink request. The <code class="docutils literal notranslate"><span class="pre">ip</span></code> utility of
<code class="docutils literal notranslate"><span class="pre">iproute2</span></code> has commands for managing static L2TPv3 tunnels; do <code class="docutils literal notranslate"><span class="pre">ip</span>
<span class="pre">l2tp</span> <span class="pre">help</span></code> for more information.</p>
</div>
<div class="section" id="debugging">
<h3>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h3>
<p>The L2TP subsystem offers a range of debugging interfaces through the
debugfs filesystem.</p>
<p>To access these interfaces, the debugfs filesystem must first be mounted:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mount -t debugfs debugfs /debug
</pre></div>
</div>
<p>Files under the l2tp directory can then be accessed, providing a summary
of the current population of tunnel and session contexts existing in the
kernel:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># cat /debug/l2tp/tunnels
</pre></div>
</div>
<p>The debugfs files should not be used by applications to obtain L2TP
state information because the file format is subject to change. It is
implemented to provide extra debug information to help diagnose
problems. Applications should instead use the netlink API.</p>
<p>In addition the L2TP subsystem implements tracepoints using the standard
kernel event tracing API.  The available L2TP events can be reviewed as
follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># find /debug/tracing/events/l2tp
</pre></div>
</div>
<p>Finally, /proc/net/pppol2tp is also provided for backwards compatibility
with the original pppol2tp code. It lists information about L2TPv2
tunnels and sessions only. Its use is discouraged.</p>
</div>
</div>
<div class="section" id="internal-implementation">
<h2>Internal Implementation<a class="headerlink" href="#internal-implementation" title="Permalink to this headline">¶</a></h2>
<p>This section is for kernel developers and maintainers.</p>
<div class="section" id="sockets">
<h3>Sockets<a class="headerlink" href="#sockets" title="Permalink to this headline">¶</a></h3>
<p>UDP sockets are implemented by the networking core. When an L2TP
tunnel is created using a UDP socket, the socket is set up as an
encapsulated UDP socket by setting encap_rcv and encap_destroy
callbacks on the UDP socket. l2tp_udp_encap_recv is called when
packets are received on the socket. l2tp_udp_encap_destroy is called
when userspace closes the socket.</p>
<p>L2TPIP sockets are implemented in <a class="reference external" href="../../../net/l2tp/l2tp_ip.c">net/l2tp/l2tp_ip.c</a> and
<a class="reference external" href="../../../net/l2tp/l2tp_ip6.c">net/l2tp/l2tp_ip6.c</a>.</p>
</div>
<div class="section" id="tunnels">
<h3>Tunnels<a class="headerlink" href="#tunnels" title="Permalink to this headline">¶</a></h3>
<p>The kernel keeps a struct l2tp_tunnel context per L2TP tunnel. The
l2tp_tunnel is always associated with a UDP or L2TP/IP socket and
keeps a list of sessions in the tunnel. When a tunnel is first
registered with L2TP core, the reference count on the socket is
increased. This ensures that the socket cannot be removed while L2TP’s
data structures reference it.</p>
<p>Tunnels are identified by a unique tunnel id. The id is 16-bit for
L2TPv2 and 32-bit for L2TPv3. Internally, the id is stored as a 32-bit
value.</p>
<p>Tunnels are kept in a per-net list, indexed by tunnel id. The tunnel
id namespace is shared by L2TPv2 and L2TPv3. The tunnel context can be
derived from the socket’s sk_user_data.</p>
<p>Handling tunnel socket close is perhaps the most tricky part of the
L2TP implementation. If userspace closes a tunnel socket, the L2TP
tunnel and all of its sessions must be closed and destroyed. Since the
tunnel context holds a ref on the tunnel socket, the socket’s
sk_destruct won’t be called until the tunnel sock_put’s its
socket. For UDP sockets, when userspace closes the tunnel socket, the
socket’s encap_destroy handler is invoked, which L2TP uses to initiate
its tunnel close actions. For L2TPIP sockets, the socket’s close
handler initiates the same tunnel close actions. All sessions are
first closed. Each session drops its tunnel ref. When the tunnel ref
reaches zero, the tunnel puts its socket ref. When the socket is
eventually destroyed, it’s sk_destruct finally frees the L2TP tunnel
context.</p>
</div>
<div class="section" id="sessions">
<h3>Sessions<a class="headerlink" href="#sessions" title="Permalink to this headline">¶</a></h3>
<p>The kernel keeps a struct l2tp_session context for each session.  Each
session has private data which is used for data specific to the
session type. With L2TPv2, the session always carries PPP
traffic. With L2TPv3, the session can carry Ethernet frames (Ethernet
pseudowire) or other data types such as PPP, ATM, HDLC or Frame
Relay. Linux currently implements only Ethernet and PPP session types.</p>
<p>Some L2TP session types also have a socket (PPP pseudowires) while
others do not (Ethernet pseudowires). We can’t therefore use the
socket reference count as the reference count for session
contexts. The L2TP implementation therefore has its own internal
reference counts on the session contexts.</p>
<p>Like tunnels, L2TP sessions are identified by a unique
session id. Just as with tunnel ids, the session id is 16-bit for
L2TPv2 and 32-bit for L2TPv3. Internally, the id is stored as a 32-bit
value.</p>
<p>Sessions hold a ref on their parent tunnel to ensure that the tunnel
stays extant while one or more sessions references it.</p>
<p>Sessions are kept in a per-tunnel list, indexed by session id. L2TPv3
sessions are also kept in a per-net list indexed by session id,
because L2TPv3 session ids are unique across all tunnels and L2TPv3
data packets do not contain a tunnel id in the header. This list is
therefore needed to find the session context associated with a
received data packet when the tunnel context cannot be derived from
the tunnel socket.</p>
<p>Although the L2TPv3 RFC specifies that L2TPv3 session ids are not
scoped by the tunnel, the kernel does not police this for L2TPv3 UDP
tunnels and does not add sessions of L2TPv3 UDP tunnels into the
per-net session list. In the UDP receive code, we must trust that the
tunnel can be identified using the tunnel socket’s sk_user_data and
lookup the session in the tunnel’s session list instead of the per-net
session list.</p>
</div>
<div class="section" id="ppp">
<h3>PPP<a class="headerlink" href="#ppp" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="../../../net/l2tp/l2tp_ppp.c">net/l2tp/l2tp_ppp.c</a> implements the PPPoL2TP socket family. Each PPP
session has a PPPoL2TP socket.</p>
<p>The PPPoL2TP socket’s sk_user_data references the l2tp_session.</p>
<p>Userspace sends and receives PPP packets over L2TP using a PPPoL2TP
socket. Only PPP control frames pass over this socket: PPP data
packets are handled entirely by the kernel, passing between the L2TP
session and its associated <code class="docutils literal notranslate"><span class="pre">pppN</span></code> netdev through the PPP channel
interface of the kernel PPP subsystem.</p>
<p>The L2TP PPP implementation handles the closing of a PPPoL2TP socket
by closing its corresponding L2TP session. This is complicated because
it must consider racing with netlink session create/destroy requests
and pppol2tp_connect trying to reconnect with a session that is in the
process of being closed. Unlike tunnels, PPP sessions do not hold a
ref on their associated socket, so code must be careful to sock_hold
the socket where necessary. For all the details, see commit
3d609342cc04129ff7568e19316ce3d7451a27e8.</p>
</div>
<div class="section" id="ethernet">
<h3>Ethernet<a class="headerlink" href="#ethernet" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="../../../net/l2tp/l2tp_eth.c">net/l2tp/l2tp_eth.c</a> implements L2TPv3 Ethernet pseudowires. It
manages a netdev for each session.</p>
<p>L2TP Ethernet sessions are created and destroyed by netlink request,
or are destroyed when the tunnel is destroyed. Unlike PPP sessions,
Ethernet sessions do not have an associated socket.</p>
</div>
</div>
<div class="section" id="miscellaneous">
<h2>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rfcs">
<h3>RFCs<a class="headerlink" href="#rfcs" title="Permalink to this headline">¶</a></h3>
<p>The kernel code implements the datapath features specified in the
following RFCs:</p>
<table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="26%" />
<col width="61%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>RFC2661</td>
<td>L2TPv2</td>
<td><a class="reference external" href="https://tools.ietf.org/html/rfc2661">https://tools.ietf.org/html/rfc2661</a></td>
</tr>
<tr class="row-even"><td>RFC3931</td>
<td>L2TPv3</td>
<td><a class="reference external" href="https://tools.ietf.org/html/rfc3931">https://tools.ietf.org/html/rfc3931</a></td>
</tr>
<tr class="row-odd"><td>RFC4719</td>
<td>L2TPv3 Ethernet</td>
<td><a class="reference external" href="https://tools.ietf.org/html/rfc4719">https://tools.ietf.org/html/rfc4719</a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="implementations">
<h3>Implementations<a class="headerlink" href="#implementations" title="Permalink to this headline">¶</a></h3>
<p>A number of open source applications use the L2TP kernel subsystem:</p>
<table border="1" class="docutils">
<colgroup>
<col width="21%" />
<col width="79%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>iproute2</td>
<td><a class="reference external" href="https://github.com/shemminger/iproute2">https://github.com/shemminger/iproute2</a></td>
</tr>
<tr class="row-even"><td>go-l2tp</td>
<td><a class="reference external" href="https://github.com/katalix/go-l2tp">https://github.com/katalix/go-l2tp</a></td>
</tr>
<tr class="row-odd"><td>tunneldigger</td>
<td><a class="reference external" href="https://github.com/wlanslovenija/tunneldigger">https://github.com/wlanslovenija/tunneldigger</a></td>
</tr>
<tr class="row-even"><td>xl2tpd</td>
<td><a class="reference external" href="https://github.com/xelerance/xl2tpd">https://github.com/xelerance/xl2tpd</a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="limitations">
<h3>Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h3>
<p>The current implementation has a number of limitations:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Multiple UDP sockets with the same 5-tuple address cannot be
used. The kernel’s tunnel context is identified using private
data associated with the socket so it is important that each
socket is uniquely identified by its address.</li>
<li>Interfacing with openvswitch is not yet implemented. It may be
useful to map OVS Ethernet and VLAN ports into L2TPv3 tunnels.</li>
<li>VLAN pseudowires are implemented using an <code class="docutils literal notranslate"><span class="pre">l2tpethN</span></code> interface
configured with a VLAN sub-interface. Since L2TPv3 VLAN
pseudowires carry one and only one VLAN, it may be better to use
a single netdevice rather than an <code class="docutils literal notranslate"><span class="pre">l2tpethN</span></code> and <code class="docutils literal notranslate"><span class="pre">l2tpethN</span></code>:M
pair per VLAN session. The netlink attribute
<code class="docutils literal notranslate"><span class="pre">L2TP_ATTR_VLAN_ID</span></code> was added for this, but it was never
implemented.</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="testing">
<h3>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h3>
<p>Unmanaged L2TPv3 Ethernet features are tested by the kernel’s built-in
selftests. See <a class="reference external" href="../../../tools/testing/selftests/net/l2tp.sh">tools/testing/selftests/net/l2tp.sh</a>.</p>
<p>Another test suite, <a class="reference external" href="https://github.com/katalix/l2tp-ktest">l2tp-ktest</a>, covers all
of the L2TP APIs and tunnel/session types. This may be integrated into
the kernel’s built-in L2TP selftests in the future.</p>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lapb-module.html" class="btn btn-neutral float-right" title="The Linux LAPB Module Interface" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="kcm.html" class="btn btn-neutral" title="Kernel Connection Multiplexor" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>