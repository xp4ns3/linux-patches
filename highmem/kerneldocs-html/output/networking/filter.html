

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Linux Socket Filtering aka Berkeley Packet Filter (BPF) &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Networking Documentation" href="index.html"/>
        <link rel="next" title="Generic HDLC layer" href="generic-hdlc.html"/>
        <link rel="prev" title="LC-trie implementation notes" href="fib_trie.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Networking Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="af_xdp.html">AF_XDP</a></li>
<li class="toctree-l2"><a class="reference internal" href="bareudp.html">Bare UDP Tunnelling Module Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="batman-adv.html">batman-adv</a></li>
<li class="toctree-l2"><a class="reference internal" href="can.html">SocketCAN - Controller Area Network</a></li>
<li class="toctree-l2"><a class="reference internal" href="can_ucan_protocol.html">The UCAN Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="device_drivers/index.html">Hardware Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsa/index.html">Distributed Switch Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="devlink/index.html">Linux Devlink Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="caif/index.html">CAIF</a></li>
<li class="toctree-l2"><a class="reference internal" href="ethtool-netlink.html">Netlink interface for ethtool</a></li>
<li class="toctree-l2"><a class="reference internal" href="ieee802154.html">IEEE 802.15.4 Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="j1939.html">J1939 Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="kapi.html">Linux Networking and Network Devices APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="msg_zerocopy.html">MSG_ZEROCOPY</a></li>
<li class="toctree-l2"><a class="reference internal" href="failover.html">FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_dim.html">Net DIM - Generic Network Dynamic Interrupt Moderation</a></li>
<li class="toctree-l2"><a class="reference internal" href="net_failover.html">NET_FAILOVER</a></li>
<li class="toctree-l2"><a class="reference internal" href="page_pool.html">Page Pool API</a></li>
<li class="toctree-l2"><a class="reference internal" href="phy.html">PHY Abstraction Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="sfp-phylink.html">phylink</a></li>
<li class="toctree-l2"><a class="reference internal" href="alias.html">IP-Aliasing</a></li>
<li class="toctree-l2"><a class="reference internal" href="bridge.html">Ethernet Bridging</a></li>
<li class="toctree-l2"><a class="reference internal" href="snmp_counter.html">SNMP counter</a></li>
<li class="toctree-l2"><a class="reference internal" href="checksum-offloads.html">Checksum Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="segmentation-offloads.html">Segmentation Offloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="scaling.html">Scaling in the Linux Networking Stack</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls.html">Kernel TLS</a></li>
<li class="toctree-l2"><a class="reference internal" href="tls-offload.html">Kernel TLS offload</a></li>
<li class="toctree-l2"><a class="reference internal" href="nfc.html">Linux NFC subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="6lowpan.html">Netdev private dataroom for 6lowpan interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="6pack.html">6pack Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet-hardware.html">ARCnet Hardware</a></li>
<li class="toctree-l2"><a class="reference internal" href="arcnet.html">ARCnet</a></li>
<li class="toctree-l2"><a class="reference internal" href="atm.html">ATM</a></li>
<li class="toctree-l2"><a class="reference internal" href="ax25.html">AX.25</a></li>
<li class="toctree-l2"><a class="reference internal" href="bonding.html">Linux Ethernet Bonding Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc_mbim.html">cdc_mbim - Driver for CDC MBIM Mobile Broadband modems</a></li>
<li class="toctree-l2"><a class="reference internal" href="dccp.html">DCCP protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="dctcp.html">DCTCP (DataCenter TCP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="decnet.html">Linux DECnet Networking Layer Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="dns_resolver.html">DNS Resolver Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="driver.html">Softnet Driver Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="eql.html">EQL Driver: Serial IP Load Balancing HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="fib_trie.html">LC-trie implementation notes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Linux Socket Filtering aka Berkeley Packet Filter (BPF)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#notice">Notice</a></li>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bpf-engine-and-instruction-set">BPF engine and instruction set</a></li>
<li class="toctree-l3"><a class="reference internal" href="#jit-compiler">JIT compiler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bpf-kernel-internals">BPF kernel internals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l3"><a class="reference internal" href="#misc">Misc</a></li>
<li class="toctree-l3"><a class="reference internal" href="#written-by">Written by</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="generic-hdlc.html">Generic HDLC layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="generic_netlink.html">Generic Netlink</a></li>
<li class="toctree-l2"><a class="reference internal" href="gen_stats.html">Generic networking statistics for netlink users</a></li>
<li class="toctree-l2"><a class="reference internal" href="gtp.html">The Linux kernel GTP tunneling module</a></li>
<li class="toctree-l2"><a class="reference internal" href="ila.html">Identifier Locator Addressing (ILA)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioam6-sysctl.html">IOAM6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipddp.html">AppleTalk-IP Decapsulation and AppleTalk-IP Encapsulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip_dynaddr.html">IP dynamic address hack-port v0.03</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipsec.html">IPsec</a></li>
<li class="toctree-l2"><a class="reference internal" href="ip-sysctl.html">IP Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipv6.html">IPv6</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvlan.html">IPVLAN Driver HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipvs-sysctl.html">IPvs-sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="kcm.html">Kernel Connection Multiplexor</a></li>
<li class="toctree-l2"><a class="reference internal" href="l2tp.html">L2TP</a></li>
<li class="toctree-l2"><a class="reference internal" href="lapb-module.html">The Linux LAPB Module Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="mac80211-injection.html">How to use packet injection with mac80211</a></li>
<li class="toctree-l2"><a class="reference internal" href="mctp.html">Management Component Transport Protocol (MCTP)</a></li>
<li class="toctree-l2"><a class="reference internal" href="mpls-sysctl.html">MPLS Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="mptcp-sysctl.html">MPTCP Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="multiqueue.html">HOWTO for multiqueue network device support</a></li>
<li class="toctree-l2"><a class="reference internal" href="netconsole.html">Netconsole</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdev-features.html">Netdev features mess and how to get out from it alive</a></li>
<li class="toctree-l2"><a class="reference internal" href="netdevices.html">Network Devices, the Kernel, and You!</a></li>
<li class="toctree-l2"><a class="reference internal" href="netfilter-sysctl.html">Netfilter Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="netif-msg.html">NETIF Msg Level</a></li>
<li class="toctree-l2"><a class="reference internal" href="nexthop-group-resilient.html">Resilient Next-hop Groups</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_conntrack-sysctl.html">Netfilter Conntrack Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="nf_flowtable.html">Netfilter’s flowtable infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="openvswitch.html">Open vSwitch datapath developer documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="operstates.html">Operational States</a></li>
<li class="toctree-l2"><a class="reference internal" href="packet_mmap.html">Packet MMAP</a></li>
<li class="toctree-l2"><a class="reference internal" href="phonet.html">Linux Phonet protocol family</a></li>
<li class="toctree-l2"><a class="reference internal" href="pktgen.html">HOWTO for the linux packet generator</a></li>
<li class="toctree-l2"><a class="reference internal" href="plip.html">PLIP: The Parallel Line Internet Protocol Device</a></li>
<li class="toctree-l2"><a class="reference internal" href="ppp_generic.html">PPP Generic Driver and Channel Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="proc_net_tcp.html">The proc/net/tcp and proc/net/tcp6 variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="radiotap-headers.html">How to use radiotap headers</a></li>
<li class="toctree-l2"><a class="reference internal" href="rds.html">RDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="regulatory.html">Linux wireless regulatory documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html">RxRPC Network Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#socket-options">SOCKET OPTIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#security">SECURITY</a></li>
<li class="toctree-l2"><a class="reference internal" href="rxrpc.html#example-client-usage">EXAMPLE CLIENT USAGE</a></li>
<li class="toctree-l2"><a class="reference internal" href="sctp.html">Linux Kernel SCTP</a></li>
<li class="toctree-l2"><a class="reference internal" href="secid.html">LSM/SeLinux secid</a></li>
<li class="toctree-l2"><a class="reference internal" href="seg6-sysctl.html">Seg6 Sysfs variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="smc-sysctl.html">SMC Sysctl</a></li>
<li class="toctree-l2"><a class="reference internal" href="statistics.html">Interface statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="strparser.html">Stream Parser (strparser)</a></li>
<li class="toctree-l2"><a class="reference internal" href="switchdev.html">Ethernet switch device driver model (switchdev)</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-tagging.html">Sysfs tagging</a></li>
<li class="toctree-l2"><a class="reference internal" href="tc-actions-env-rules.html">TC Actions - Environmental Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="tcp-thin.html">Thin-streams and TCP</a></li>
<li class="toctree-l2"><a class="reference internal" href="team.html">Team</a></li>
<li class="toctree-l2"><a class="reference internal" href="timestamping.html">Timestamping</a></li>
<li class="toctree-l2"><a class="reference internal" href="tipc.html">Linux Kernel TIPC</a></li>
<li class="toctree-l2"><a class="reference internal" href="tproxy.html">Transparent proxy support</a></li>
<li class="toctree-l2"><a class="reference internal" href="tuntap.html">Universal TUN/TAP device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="udplite.html">The UDP-Lite protocol (RFC 3828)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vrf.html">Virtual Routing and Forwarding (VRF)</a></li>
<li class="toctree-l2"><a class="reference internal" href="vxlan.html">Virtual eXtensible Local Area Networking documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html">Packet Layer to Device Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#device-driver-to-packet-layer">Device Driver to Packet Layer</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25-iface.html#requirements-for-the-device-driver">Requirements for the device driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="x25.html">Linux X.25 Project</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_device.html">XFRM device - offloading the IPsec computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_proc.html">XFRM proc - /proc/net/xfrm_* files</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sync.html">XFRM</a></li>
<li class="toctree-l2"><a class="reference internal" href="xfrm_sysctl.html">XFRM Syscall</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Networking Documentation</a> &raquo;</li>
        
      <li>Linux Socket Filtering aka Berkeley Packet Filter (BPF)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/networking/filter.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="linux-socket-filtering-aka-berkeley-packet-filter-bpf">
<span id="networking-filter"></span><h1>Linux Socket Filtering aka Berkeley Packet Filter (BPF)<a class="headerlink" href="#linux-socket-filtering-aka-berkeley-packet-filter-bpf" title="Permalink to this headline">¶</a></h1>
<div class="section" id="notice">
<h2>Notice<a class="headerlink" href="#notice" title="Permalink to this headline">¶</a></h2>
<p>This file used to document the eBPF format and mechanisms even when not
related to socket filtering.  The <a class="reference internal" href="../bpf/index.html"><span class="doc">BPF Documentation</span></a> has more details
on eBPF.</p>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Linux Socket Filtering (LSF) is derived from the Berkeley Packet Filter.
Though there are some distinct differences between the BSD and Linux
Kernel filtering, but when we speak of BPF or LSF in Linux context, we
mean the very same mechanism of filtering in the Linux kernel.</p>
<p>BPF allows a user-space program to attach a filter onto any socket and
allow or disallow certain types of data to come through the socket. LSF
follows exactly the same filter code structure as BSD’s BPF, so referring
to the BSD bpf.4 manpage is very helpful in creating filters.</p>
<p>On Linux, BPF is much simpler than on BSD. One does not have to worry
about devices or anything like that. You simply create your filter code,
send it to the kernel via the SO_ATTACH_FILTER option and if your filter
code passes the kernel check on it, you then immediately begin filtering
data on that socket.</p>
<p>You can also detach filters from your socket via the SO_DETACH_FILTER
option. This will probably not be used much since when you close a socket
that has a filter on it the filter is automagically removed. The other
less common case may be adding a different filter on the same socket where
you had another filter that is still running: the kernel takes care of
removing the old one and placing your new one in its place, assuming your
filter has passed the checks, otherwise if it fails the old filter will
remain on that socket.</p>
<p>SO_LOCK_FILTER option allows to lock the filter attached to a socket. Once
set, a filter cannot be removed or changed. This allows one process to
setup a socket, attach a filter, lock it then drop privileges and be
assured that the filter will be kept until the socket is closed.</p>
<p>The biggest user of this construct might be libpcap. Issuing a high-level
filter command like <cite>tcpdump -i em1 port 22</cite> passes through the libpcap
internal compiler that generates a structure that can eventually be loaded
via SO_ATTACH_FILTER to the kernel. <cite>tcpdump -i em1 port 22 -ddd</cite>
displays what is being placed into this structure.</p>
<p>Although we were only speaking about sockets here, BPF in Linux is used
in many more places. There’s xt_bpf for netfilter, cls_bpf in the kernel
qdisc layer, SECCOMP-BPF (SECure COMPuting <a class="footnote-reference" href="#id2" id="id1">[1]</a>), and lots of other places
such as team driver, PTP code, etc where BPF is being used.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td><a class="reference internal" href="../userspace-api/seccomp_filter.html"><span class="doc">Seccomp BPF (SECure COMPuting with filters)</span></a></td></tr>
</tbody>
</table>
<p>Original BPF paper:</p>
<p>Steven McCanne and Van Jacobson. 1993. The BSD packet filter: a new
architecture for user-level packet capture. In Proceedings of the
USENIX Winter 1993 Conference Proceedings on USENIX Winter 1993
Conference Proceedings (USENIX‘93). USENIX Association, Berkeley,
CA, USA, 2-2. [<a class="reference external" href="http://www.tcpdump.org/papers/bpf-usenix93.pdf">http://www.tcpdump.org/papers/bpf-usenix93.pdf</a>]</p>
</div>
<div class="section" id="structure">
<h2>Structure<a class="headerlink" href="#structure" title="Permalink to this headline">¶</a></h2>
<p>User space applications include &lt;linux/filter.h&gt; which contains the
following relevant structures:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sock_filter {    /* Filter block */
        __u16   code;   /* Actual filter code */
        __u8    jt;     /* Jump true */
        __u8    jf;     /* Jump false */
        __u32   k;      /* Generic multiuse field */
};
</pre></div>
</div>
<p>Such a structure is assembled as an array of 4-tuples, that contains
a code, jt, jf and k value. jt and jf are jump offsets and k a generic
value to be used for a provided code:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sock_fprog {                     /* Required for SO_ATTACH_FILTER. */
        unsigned short             len; /* Number of filter blocks */
        struct sock_filter __user *filter;
};
</pre></div>
</div>
<p>For socket filtering, a pointer to this structure (as shown in
follow-up example) is being passed to the kernel through setsockopt(2).</p>
</div>
<div class="section" id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h2>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;arpa/inet.h&gt;
#include &lt;linux/if_ether.h&gt;
/* ... */

/* From the example above: tcpdump -i em1 port 22 -dd */
struct sock_filter code[] = {
        { 0x28,  0,  0, 0x0000000c },
        { 0x15,  0,  8, 0x000086dd },
        { 0x30,  0,  0, 0x00000014 },
        { 0x15,  2,  0, 0x00000084 },
        { 0x15,  1,  0, 0x00000006 },
        { 0x15,  0, 17, 0x00000011 },
        { 0x28,  0,  0, 0x00000036 },
        { 0x15, 14,  0, 0x00000016 },
        { 0x28,  0,  0, 0x00000038 },
        { 0x15, 12, 13, 0x00000016 },
        { 0x15,  0, 12, 0x00000800 },
        { 0x30,  0,  0, 0x00000017 },
        { 0x15,  2,  0, 0x00000084 },
        { 0x15,  1,  0, 0x00000006 },
        { 0x15,  0,  8, 0x00000011 },
        { 0x28,  0,  0, 0x00000014 },
        { 0x45,  6,  0, 0x00001fff },
        { 0xb1,  0,  0, 0x0000000e },
        { 0x48,  0,  0, 0x0000000e },
        { 0x15,  2,  0, 0x00000016 },
        { 0x48,  0,  0, 0x00000010 },
        { 0x15,  0,  1, 0x00000016 },
        { 0x06,  0,  0, 0x0000ffff },
        { 0x06,  0,  0, 0x00000000 },
};

struct sock_fprog bpf = {
        .len = ARRAY_SIZE(code),
        .filter = code,
};

sock = socket(PF_PACKET, SOCK_RAW, htons(ETH_P_ALL));
if (sock &lt; 0)
        /* ... bail out ... */

ret = setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER, &amp;bpf, sizeof(bpf));
if (ret &lt; 0)
        /* ... bail out ... */

/* ... */
close(sock);
</pre></div>
</div>
<p>The above example code attaches a socket filter for a PF_PACKET socket
in order to let all IPv4/IPv6 packets with port 22 pass. The rest will
be dropped for this socket.</p>
<p>The setsockopt(2) call to SO_DETACH_FILTER doesn’t need any arguments
and SO_LOCK_FILTER for preventing the filter to be detached, takes an
integer value with 0 or 1.</p>
<p>Note that socket filters are not restricted to PF_PACKET sockets only,
but can also be used on other socket families.</p>
<p>Summary of system calls:</p>
<blockquote>
<div><ul class="simple">
<li>setsockopt(sockfd, SOL_SOCKET, SO_ATTACH_FILTER, &amp;val, sizeof(val));</li>
<li>setsockopt(sockfd, SOL_SOCKET, SO_DETACH_FILTER, &amp;val, sizeof(val));</li>
<li>setsockopt(sockfd, SOL_SOCKET, SO_LOCK_FILTER,   &amp;val, sizeof(val));</li>
</ul>
</div></blockquote>
<p>Normally, most use cases for socket filtering on packet sockets will be
covered by libpcap in high-level syntax, so as an application developer
you should stick to that. libpcap wraps its own layer around all that.</p>
<p>Unless i) using/linking to libpcap is not an option, ii) the required BPF
filters use Linux extensions that are not supported by libpcap’s compiler,
iii) a filter might be more complex and not cleanly implementable with
libpcap’s compiler, or iv) particular filter codes should be optimized
differently than libpcap’s internal compiler does; then in such cases
writing such a filter “by hand” can be of an alternative. For example,
xt_bpf and cls_bpf users might have requirements that could result in
more complex filter code, or one that cannot be expressed with libpcap
(e.g. different return codes for various code paths). Moreover, BPF JIT
implementors may wish to manually write test cases and thus need low-level
access to BPF code as well.</p>
</div>
<div class="section" id="bpf-engine-and-instruction-set">
<h2>BPF engine and instruction set<a class="headerlink" href="#bpf-engine-and-instruction-set" title="Permalink to this headline">¶</a></h2>
<p>Under tools/bpf/ there’s a small helper tool called bpf_asm which can
be used to write low-level filters for example scenarios mentioned in the
previous section. Asm-like syntax mentioned here has been implemented in
bpf_asm and will be used for further explanations (instead of dealing with
less readable opcodes directly, principles are the same). The syntax is
closely modelled after Steven McCanne’s and Van Jacobson’s BPF paper.</p>
<p>The BPF architecture consists of the following basic elements:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Element</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>A</td>
<td>32 bit wide accumulator</td>
</tr>
<tr class="row-odd"><td>X</td>
<td>32 bit wide X register</td>
</tr>
<tr class="row-even"><td>M[]</td>
<td>16 x 32 bit wide misc registers aka “scratch memory
store”, addressable from 0 to 15</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>A program, that is translated by bpf_asm into “opcodes” is an array that
consists of the following elements (as already mentioned):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>op:16, jt:8, jf:8, k:32
</pre></div>
</div>
<p>The element op is a 16 bit wide opcode that has a particular instruction
encoded. jt and jf are two 8 bit wide jump targets, one for condition
“jump if true”, the other one “jump if false”. Eventually, element k
contains a miscellaneous argument that can be interpreted in different
ways depending on the given instruction in op.</p>
<p>The instruction set consists of load, store, branch, alu, miscellaneous
and return instructions that are also represented in bpf_asm syntax. This
table lists all bpf_asm instructions available resp. what their underlying
opcodes as defined in linux/filter.h stand for:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="22%" />
<col width="37%" />
<col width="41%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Instruction</th>
<th class="head">Addressing mode</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>ld</td>
<td>1, 2, 3, 4, 12</td>
<td>Load word into A</td>
</tr>
<tr class="row-odd"><td>ldi</td>
<td>4</td>
<td>Load word into A</td>
</tr>
<tr class="row-even"><td>ldh</td>
<td>1, 2</td>
<td>Load half-word into A</td>
</tr>
<tr class="row-odd"><td>ldb</td>
<td>1, 2</td>
<td>Load byte into A</td>
</tr>
<tr class="row-even"><td>ldx</td>
<td>3, 4, 5, 12</td>
<td>Load word into X</td>
</tr>
<tr class="row-odd"><td>ldxi</td>
<td>4</td>
<td>Load word into X</td>
</tr>
<tr class="row-even"><td>ldxb</td>
<td>5</td>
<td>Load byte into X</td>
</tr>
<tr class="row-odd"><td>st</td>
<td>3</td>
<td>Store A into M[]</td>
</tr>
<tr class="row-even"><td>stx</td>
<td>3</td>
<td>Store X into M[]</td>
</tr>
<tr class="row-odd"><td>jmp</td>
<td>6</td>
<td>Jump to label</td>
</tr>
<tr class="row-even"><td>ja</td>
<td>6</td>
<td>Jump to label</td>
</tr>
<tr class="row-odd"><td>jeq</td>
<td>7, 8, 9, 10</td>
<td>Jump on A == &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>jneq</td>
<td>9, 10</td>
<td>Jump on A != &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>jne</td>
<td>9, 10</td>
<td>Jump on A != &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>jlt</td>
<td>9, 10</td>
<td>Jump on A &lt;  &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>jle</td>
<td>9, 10</td>
<td>Jump on A &lt;= &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>jgt</td>
<td>7, 8, 9, 10</td>
<td>Jump on A &gt;  &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>jge</td>
<td>7, 8, 9, 10</td>
<td>Jump on A &gt;= &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>jset</td>
<td>7, 8, 9, 10</td>
<td>Jump on A &amp;  &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>add</td>
<td>0, 4</td>
<td>A + &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>sub</td>
<td>0, 4</td>
<td>A - &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>mul</td>
<td>0, 4</td>
<td>A * &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>div</td>
<td>0, 4</td>
<td>A / &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>mod</td>
<td>0, 4</td>
<td>A % &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>neg</td>
<td>&#160;</td>
<td>!A</td>
</tr>
<tr class="row-odd"><td>and</td>
<td>0, 4</td>
<td>A &amp; &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>or</td>
<td>0, 4</td>
<td>A | &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>xor</td>
<td>0, 4</td>
<td>A ^ &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>lsh</td>
<td>0, 4</td>
<td>A &lt;&lt; &lt;x&gt;</td>
</tr>
<tr class="row-odd"><td>rsh</td>
<td>0, 4</td>
<td>A &gt;&gt; &lt;x&gt;</td>
</tr>
<tr class="row-even"><td>tax</td>
<td>&#160;</td>
<td>Copy A into X</td>
</tr>
<tr class="row-odd"><td>txa</td>
<td>&#160;</td>
<td>Copy X into A</td>
</tr>
<tr class="row-even"><td>ret</td>
<td>4, 11</td>
<td>Return</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The next table shows addressing formats from the 2nd column:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="19%" />
<col width="23%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Addressing mode</th>
<th class="head">Syntax</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>x/%x</td>
<td>Register X</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>[k]</td>
<td>BHW at byte offset k in the packet</td>
</tr>
<tr class="row-even"><td>2</td>
<td>[x + k]</td>
<td>BHW at the offset X + k in the packet</td>
</tr>
<tr class="row-odd"><td>3</td>
<td>M[k]</td>
<td>Word at offset k in M[]</td>
</tr>
<tr class="row-even"><td>4</td>
<td>#k</td>
<td>Literal value stored in k</td>
</tr>
<tr class="row-odd"><td>5</td>
<td>4*([k]&amp;0xf)</td>
<td>Lower nibble * 4 at byte offset k in the packet</td>
</tr>
<tr class="row-even"><td>6</td>
<td>L</td>
<td>Jump label L</td>
</tr>
<tr class="row-odd"><td>7</td>
<td>#k,Lt,Lf</td>
<td>Jump to Lt if true, otherwise jump to Lf</td>
</tr>
<tr class="row-even"><td>8</td>
<td>x/%x,Lt,Lf</td>
<td>Jump to Lt if true, otherwise jump to Lf</td>
</tr>
<tr class="row-odd"><td>9</td>
<td>#k,Lt</td>
<td>Jump to Lt if predicate is true</td>
</tr>
<tr class="row-even"><td>10</td>
<td>x/%x,Lt</td>
<td>Jump to Lt if predicate is true</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>a/%a</td>
<td>Accumulator A</td>
</tr>
<tr class="row-even"><td>12</td>
<td>extension</td>
<td>BPF extension</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The Linux kernel also has a couple of BPF extensions that are used along
with the class of load instructions by “overloading” the k argument with
a negative offset + a particular extension offset. The result of such BPF
extensions are loaded into A.</p>
<p>Possible BPF extensions are shown in the following table:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="42%" />
<col width="58%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Extension</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>len</td>
<td>skb-&gt;len</td>
</tr>
<tr class="row-odd"><td>proto</td>
<td>skb-&gt;protocol</td>
</tr>
<tr class="row-even"><td>type</td>
<td>skb-&gt;pkt_type</td>
</tr>
<tr class="row-odd"><td>poff</td>
<td>Payload start offset</td>
</tr>
<tr class="row-even"><td>ifidx</td>
<td>skb-&gt;dev-&gt;ifindex</td>
</tr>
<tr class="row-odd"><td>nla</td>
<td>Netlink attribute of type X with offset A</td>
</tr>
<tr class="row-even"><td>nlan</td>
<td>Nested Netlink attribute of type X with offset A</td>
</tr>
<tr class="row-odd"><td>mark</td>
<td>skb-&gt;mark</td>
</tr>
<tr class="row-even"><td>queue</td>
<td>skb-&gt;queue_mapping</td>
</tr>
<tr class="row-odd"><td>hatype</td>
<td>skb-&gt;dev-&gt;type</td>
</tr>
<tr class="row-even"><td>rxhash</td>
<td>skb-&gt;hash</td>
</tr>
<tr class="row-odd"><td>cpu</td>
<td>raw_smp_processor_id()</td>
</tr>
<tr class="row-even"><td>vlan_tci</td>
<td>skb_vlan_tag_get(skb)</td>
</tr>
<tr class="row-odd"><td>vlan_avail</td>
<td>skb_vlan_tag_present(skb)</td>
</tr>
<tr class="row-even"><td>vlan_tpid</td>
<td>skb-&gt;vlan_proto</td>
</tr>
<tr class="row-odd"><td>rand</td>
<td>prandom_u32()</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>These extensions can also be prefixed with ‘#’.
Examples for low-level BPF:</p>
<p><strong>ARP packets</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ldh [12]
jne #0x806, drop
ret #-1
drop: ret #0
</pre></div>
</div>
<p><strong>IPv4 TCP packets</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ldh [12]
jne #0x800, drop
ldb [23]
jneq #6, drop
ret #-1
drop: ret #0
</pre></div>
</div>
<p><strong>icmp random packet sampling, 1 in 4</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ldh [12]
jne #0x800, drop
ldb [23]
jneq #1, drop
# get a random uint32 number
ld rand
mod #4
jneq #1, drop
ret #-1
drop: ret #0
</pre></div>
</div>
<p><strong>SECCOMP filter example</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ld [4]                  /* offsetof(struct seccomp_data, arch) */
jne #0xc000003e, bad    /* AUDIT_ARCH_X86_64 */
ld [0]                  /* offsetof(struct seccomp_data, nr) */
jeq #15, good           /* __NR_rt_sigreturn */
jeq #231, good          /* __NR_exit_group */
jeq #60, good           /* __NR_exit */
jeq #0, good            /* __NR_read */
jeq #1, good            /* __NR_write */
jeq #5, good            /* __NR_fstat */
jeq #9, good            /* __NR_mmap */
jeq #14, good           /* __NR_rt_sigprocmask */
jeq #13, good           /* __NR_rt_sigaction */
jeq #35, good           /* __NR_nanosleep */
bad: ret #0             /* SECCOMP_RET_KILL_THREAD */
good: ret #0x7fff0000   /* SECCOMP_RET_ALLOW */
</pre></div>
</div>
<p>Examples for low-level BPF extension:</p>
<p><strong>Packet for interface index 13</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ld ifidx
jneq #13, drop
ret #-1
drop: ret #0
</pre></div>
</div>
<p><strong>(Accelerated) VLAN w/ id 10</strong>:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ld vlan_tci
jneq #10, drop
ret #-1
drop: ret #0
</pre></div>
</div>
<p>The above example code can be placed into a file (here called “foo”), and
then be passed to the bpf_asm tool for generating opcodes, output that xt_bpf
and cls_bpf understands and can directly be loaded with. Example with above
ARP code:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./bpf_asm foo
4,40 0 0 12,21 0 1 2054,6 0 0 4294967295,6 0 0 0,
</pre></div>
</div>
<p>In copy and paste C-like output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ ./bpf_asm -c foo
{ 0x28,  0,  0, 0x0000000c },
{ 0x15,  0,  1, 0x00000806 },
{ 0x06,  0,  0, 0xffffffff },
{ 0x06,  0,  0, 0000000000 },
</pre></div>
</div>
<p>In particular, as usage with xt_bpf or cls_bpf can result in more complex BPF
filters that might not be obvious at first, it’s good to test filters before
attaching to a live system. For that purpose, there’s a small tool called
bpf_dbg under tools/bpf/ in the kernel source directory. This debugger allows
for testing BPF filters against given pcap files, single stepping through the
BPF code on the pcap’s packets and to do BPF machine register dumps.</p>
<p>Starting bpf_dbg is trivial and just requires issuing:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ./bpf_dbg
</pre></div>
</div>
<p>In case input and output do not equal stdin/stdout, bpf_dbg takes an
alternative stdin source as a first argument, and an alternative stdout
sink as a second one, e.g. <cite>./bpf_dbg test_in.txt test_out.txt</cite>.</p>
<p>Other than that, a particular libreadline configuration can be set via
file “~/.bpf_dbg_init” and the command history is stored in the file
“~/.bpf_dbg_history”.</p>
<p>Interaction in bpf_dbg happens through a shell that also has auto-completion
support (follow-up example commands starting with ‘&gt;’ denote bpf_dbg shell).
The usual workflow would be to …</p>
<ul>
<li><p class="first">load bpf 6,40 0 0 12,21 0 3 2048,48 0 0 23,21 0 1 1,6 0 0 65535,6 0 0 0
Loads a BPF filter from standard output of bpf_asm, or transformed via
e.g. <code class="docutils literal notranslate"><span class="pre">tcpdump</span> <span class="pre">-iem1</span> <span class="pre">-ddd</span> <span class="pre">port</span> <span class="pre">22</span> <span class="pre">|</span> <span class="pre">tr</span> <span class="pre">'\n'</span> <span class="pre">','</span></code>. Note that for JIT
debugging (next section), this command creates a temporary socket and
loads the BPF code into the kernel. Thus, this will also be useful for
JIT developers.</p>
</li>
<li><p class="first">load pcap foo.pcap</p>
<p>Loads standard tcpdump pcap file.</p>
</li>
<li><p class="first">run [&lt;n&gt;]</p>
</li>
</ul>
<dl class="docutils">
<dt>bpf passes:1 fails:9</dt>
<dd>Runs through all packets from a pcap to account how many passes and fails
the filter will generate. A limit of packets to traverse can be given.</dd>
</dl>
<ul>
<li><p class="first">disassemble:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>l0:     ldh [12]
l1:     jeq #0x800, l2, l5
l2:     ldb [23]
l3:     jeq #0x1, l4, l5
l4:     ret #0xffff
l5:     ret #0
</pre></div>
</div>
<p>Prints out BPF code disassembly.</p>
</li>
<li><p class="first">dump:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/* { op, jt, jf, k }, */
{ 0x28,  0,  0, 0x0000000c },
{ 0x15,  0,  3, 0x00000800 },
{ 0x30,  0,  0, 0x00000017 },
{ 0x15,  0,  1, 0x00000001 },
{ 0x06,  0,  0, 0x0000ffff },
{ 0x06,  0,  0, 0000000000 },
</pre></div>
</div>
<p>Prints out C-style BPF code dump.</p>
</li>
<li><p class="first">breakpoint 0:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>breakpoint at: l0:      ldh [12]
</pre></div>
</div>
</li>
<li><p class="first">breakpoint 1:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>breakpoint at: l1:      jeq #0x800, l2, l5
</pre></div>
</div>
<p>…</p>
<p>Sets breakpoints at particular BPF instructions. Issuing a <cite>run</cite> command
will walk through the pcap file continuing from the current packet and
break when a breakpoint is being hit (another <cite>run</cite> will continue from
the currently active breakpoint executing next instructions):</p>
<ul>
<li><p class="first">run:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>-- register dump --
pc:       [0]                       &lt;-- program counter
code:     [40] jt[0] jf[0] k[12]    &lt;-- plain BPF code of current instruction
curr:     l0:   ldh [12]              &lt;-- disassembly of current instruction
A:        [00000000][0]             &lt;-- content of A (hex, decimal)
X:        [00000000][0]             &lt;-- content of X (hex, decimal)
M[0,15]:  [00000000][0]             &lt;-- folded content of M (hex, decimal)
-- packet dump --                   &lt;-- Current packet from pcap (hex)
len: 42
    0: 00 19 cb 55 55 a4 00 14 a4 43 78 69 08 06 00 01
16: 08 00 06 04 00 01 00 14 a4 43 78 69 0a 3b 01 26
32: 00 00 00 00 00 00 0a 3b 01 01
(breakpoint)
&gt;
</pre></div>
</div>
</li>
<li><p class="first">breakpoint:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>breakpoints: 0 1
</pre></div>
</div>
<p>Prints currently set breakpoints.</p>
</li>
</ul>
</li>
<li><p class="first">step [-&lt;n&gt;, +&lt;n&gt;]</p>
<p>Performs single stepping through the BPF program from the current pc
offset. Thus, on each step invocation, above register dump is issued.
This can go forwards and backwards in time, a plain <cite>step</cite> will break
on the next BPF instruction, thus +1. (No <cite>run</cite> needs to be issued here.)</p>
</li>
<li><p class="first">select &lt;n&gt;</p>
<p>Selects a given packet from the pcap file to continue from. Thus, on
the next <cite>run</cite> or <cite>step</cite>, the BPF program is being evaluated against
the user pre-selected packet. Numbering starts just as in Wireshark
with index 1.</p>
</li>
<li><p class="first">quit</p>
<p>Exits bpf_dbg.</p>
</li>
</ul>
</div>
<div class="section" id="jit-compiler">
<h2>JIT compiler<a class="headerlink" href="#jit-compiler" title="Permalink to this headline">¶</a></h2>
<p>The Linux kernel has a built-in BPF JIT compiler for x86_64, SPARC,
PowerPC, ARM, ARM64, MIPS, RISC-V and s390 and can be enabled through
CONFIG_BPF_JIT. The JIT compiler is transparently invoked for each
attached filter from user space or for internal kernel users if it has
been previously enabled by root:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 1 &gt; /proc/sys/net/core/bpf_jit_enable
</pre></div>
</div>
<p>For JIT developers, doing audits etc, each compile run can output the generated
opcode image into the kernel log via:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo 2 &gt; /proc/sys/net/core/bpf_jit_enable
</pre></div>
</div>
<p>Example output from dmesg:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[ 3389.935842] flen=6 proglen=70 pass=3 image=ffffffffa0069c8f
[ 3389.935847] JIT code: 00000000: 55 48 89 e5 48 83 ec 60 48 89 5d f8 44 8b 4f 68
[ 3389.935849] JIT code: 00000010: 44 2b 4f 6c 4c 8b 87 d8 00 00 00 be 0c 00 00 00
[ 3389.935850] JIT code: 00000020: e8 1d 94 ff e0 3d 00 08 00 00 75 16 be 17 00 00
[ 3389.935851] JIT code: 00000030: 00 e8 28 94 ff e0 83 f8 01 75 07 b8 ff ff 00 00
[ 3389.935852] JIT code: 00000040: eb 02 31 c0 c9 c3
</pre></div>
</div>
<p>When CONFIG_BPF_JIT_ALWAYS_ON is enabled, bpf_jit_enable is permanently set to 1 and
setting any other value than that will return in failure. This is even the case for
setting bpf_jit_enable to 2, since dumping the final JIT image into the kernel log
is discouraged and introspection through bpftool (under tools/bpf/bpftool/) is the
generally recommended approach instead.</p>
<p>In the kernel source tree under tools/bpf/, there’s bpf_jit_disasm for
generating disassembly out of the kernel log’s hexdump:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># ./bpf_jit_disasm
70 bytes emitted from JIT compiler (pass:3, flen:6)
ffffffffa0069c8f + &lt;x&gt;:
0:      push   %rbp
1:      mov    %rsp,%rbp
4:      sub    $0x60,%rsp
8:      mov    %rbx,-0x8(%rbp)
c:      mov    0x68(%rdi),%r9d
10:     sub    0x6c(%rdi),%r9d
14:     mov    0xd8(%rdi),%r8
1b:     mov    $0xc,%esi
20:     callq  0xffffffffe0ff9442
25:     cmp    $0x800,%eax
2a:     jne    0x0000000000000042
2c:     mov    $0x17,%esi
31:     callq  0xffffffffe0ff945e
36:     cmp    $0x1,%eax
39:     jne    0x0000000000000042
3b:     mov    $0xffff,%eax
40:     jmp    0x0000000000000044
42:     xor    %eax,%eax
44:     leaveq
45:     retq

Issuing option `-o` will &quot;annotate&quot; opcodes to resulting assembler
instructions, which can be very useful for JIT developers:

# ./bpf_jit_disasm -o
70 bytes emitted from JIT compiler (pass:3, flen:6)
ffffffffa0069c8f + &lt;x&gt;:
0:      push   %rbp
        55
1:      mov    %rsp,%rbp
        48 89 e5
4:      sub    $0x60,%rsp
        48 83 ec 60
8:      mov    %rbx,-0x8(%rbp)
        48 89 5d f8
c:      mov    0x68(%rdi),%r9d
        44 8b 4f 68
10:     sub    0x6c(%rdi),%r9d
        44 2b 4f 6c
14:     mov    0xd8(%rdi),%r8
        4c 8b 87 d8 00 00 00
1b:     mov    $0xc,%esi
        be 0c 00 00 00
20:     callq  0xffffffffe0ff9442
        e8 1d 94 ff e0
25:     cmp    $0x800,%eax
        3d 00 08 00 00
2a:     jne    0x0000000000000042
        75 16
2c:     mov    $0x17,%esi
        be 17 00 00 00
31:     callq  0xffffffffe0ff945e
        e8 28 94 ff e0
36:     cmp    $0x1,%eax
        83 f8 01
39:     jne    0x0000000000000042
        75 07
3b:     mov    $0xffff,%eax
        b8 ff ff 00 00
40:     jmp    0x0000000000000044
        eb 02
42:     xor    %eax,%eax
        31 c0
44:     leaveq
        c9
45:     retq
        c3
</pre></div>
</div>
<p>For BPF JIT developers, bpf_jit_disasm, bpf_asm and bpf_dbg provides a useful
toolchain for developing and testing the kernel’s JIT compiler.</p>
</div>
<div class="section" id="bpf-kernel-internals">
<h2>BPF kernel internals<a class="headerlink" href="#bpf-kernel-internals" title="Permalink to this headline">¶</a></h2>
<p>Internally, for the kernel interpreter, a different instruction set
format with similar underlying principles from BPF described in previous
paragraphs is being used. However, the instruction set format is modelled
closer to the underlying architecture to mimic native instruction sets, so
that a better performance can be achieved (more details later). This new
ISA is called eBPF.  See the <a class="reference internal" href="../bpf/index.html"><span class="doc">BPF Documentation</span></a> for details.  (Note: eBPF which
originates from [e]xtended BPF is not the same as BPF extensions! While
eBPF is an ISA, BPF extensions date back to classic BPF’s ‘overloading’
of BPF_LD | BPF_{B,H,W} | BPF_ABS instruction.)</p>
<p>The new instruction set was originally designed with the possible goal in
mind to write programs in “restricted C” and compile into eBPF with a optional
GCC/LLVM backend, so that it can just-in-time map to modern 64-bit CPUs with
minimal performance overhead over two steps, that is, C -&gt; eBPF -&gt; native code.</p>
<p>Currently, the new format is being used for running user BPF programs, which
includes seccomp BPF, classic socket filters, cls_bpf traffic classifier,
team driver’s classifier for its load-balancing mode, netfilter’s xt_bpf
extension, PTP dissector/classifier, and much more. They are all internally
converted by the kernel into the new instruction set representation and run
in the eBPF interpreter. For in-kernel handlers, this all works transparently
by using <a class="reference internal" href="kapi.html#c.bpf_prog_create" title="bpf_prog_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">bpf_prog_create()</span></code></a> for setting up the filter, resp.
bpf_prog_destroy() for destroying it. The function
bpf_prog_run(filter, ctx) transparently invokes eBPF interpreter or JITed
code to run the filter. ‘filter’ is a pointer to struct bpf_prog that we
got from <a class="reference internal" href="kapi.html#c.bpf_prog_create" title="bpf_prog_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">bpf_prog_create()</span></code></a>, and ‘ctx’ the given context (e.g.
skb pointer). All constraints and restrictions from bpf_check_classic() apply
before a conversion to the new layout is being done behind the scenes!</p>
<p>Currently, the classic BPF format is being used for JITing on most
32-bit architectures, whereas x86-64, aarch64, s390x, powerpc64,
sparc64, arm32, riscv64, riscv32 perform JIT compilation from eBPF
instruction set.</p>
</div>
<div class="section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<p>Next to the BPF toolchain, the kernel also ships a test module that contains
various test cases for classic and eBPF that can be executed against
the BPF interpreter and JIT compiler. It can be found in lib/test_bpf.c and
enabled via Kconfig:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_TEST_BPF=m
</pre></div>
</div>
<p>After the module has been built and installed, the test suite can be executed
via insmod or modprobe against ‘test_bpf’ module. Results of the test cases
including timings in nsec can be found in the kernel log (dmesg).</p>
</div>
<div class="section" id="misc">
<h2>Misc<a class="headerlink" href="#misc" title="Permalink to this headline">¶</a></h2>
<p>Also trinity, the Linux syscall fuzzer, has built-in support for BPF and
SECCOMP-BPF kernel fuzzing.</p>
</div>
<div class="section" id="written-by">
<h2>Written by<a class="headerlink" href="#written-by" title="Permalink to this headline">¶</a></h2>
<p>The document was written in the hope that it is found useful and in order
to give potential BPF hackers or security auditors a better overview of
the underlying architecture.</p>
<ul class="simple">
<li>Jay Schulist &lt;<a class="reference external" href="mailto:jschlst&#37;&#52;&#48;samba&#46;org">jschlst<span>&#64;</span>samba<span>&#46;</span>org</a>&gt;</li>
<li>Daniel Borkmann &lt;<a class="reference external" href="mailto:daniel&#37;&#52;&#48;iogearbox&#46;net">daniel<span>&#64;</span>iogearbox<span>&#46;</span>net</a>&gt;</li>
<li>Alexei Starovoitov &lt;<a class="reference external" href="mailto:ast&#37;&#52;&#48;kernel&#46;org">ast<span>&#64;</span>kernel<span>&#46;</span>org</a>&gt;</li>
</ul>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="generic-hdlc.html" class="btn btn-neutral float-right" title="Generic HDLC layer" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fib_trie.html" class="btn btn-neutral" title="LC-trie implementation notes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>