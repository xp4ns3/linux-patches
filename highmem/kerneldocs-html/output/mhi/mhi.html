

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>MHI (Modem Host Interface) &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="MHI" href="index.html"/>
        <link rel="next" title="MHI Topology" href="topology.html"/>
        <link rel="prev" title="MHI" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">MHI</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">MHI (Modem Host Interface)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mhi-internals">MHI Internals</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mmio">MMIO</a></li>
<li class="toctree-l4"><a class="reference internal" href="#data-structures">Data structures</a></li>
<li class="toctree-l4"><a class="reference internal" href="#channels">Channels</a></li>
<li class="toctree-l4"><a class="reference internal" href="#transfer-rings">Transfer rings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#event-rings">Event rings</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ring-element">Ring Element</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mhi-operations">MHI Operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#mhi-states">MHI States</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mhi-initialization">MHI Initialization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mhi-data-transfer">MHI Data Transfer</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="topology.html">MHI Topology</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">MHI</a> &raquo;</li>
        
      <li>MHI (Modem Host Interface)</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/mhi/mhi.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="mhi-modem-host-interface">
<h1>MHI (Modem Host Interface)<a class="headerlink" href="#mhi-modem-host-interface" title="Permalink to this headline">¶</a></h1>
<p>This document provides information about the MHI protocol.</p>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>MHI is a protocol developed by Qualcomm Innovation Center, Inc. It is used
by the host processors to control and communicate with modem devices over high
speed peripheral buses or shared memory. Even though MHI can be easily adapted
to any peripheral buses, it is primarily used with PCIe based devices. MHI
provides logical channels over the physical buses and allows transporting the
modem protocols, such as IP data packets, modem control messages, and
diagnostics over at least one of those logical channels. Also, the MHI
protocol provides data acknowledgment feature and manages the power state of the
modems via one or more logical channels.</p>
</div>
<div class="section" id="mhi-internals">
<h2>MHI Internals<a class="headerlink" href="#mhi-internals" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mmio">
<h3>MMIO<a class="headerlink" href="#mmio" title="Permalink to this headline">¶</a></h3>
<p>MMIO (Memory mapped IO) consists of a set of registers in the device hardware,
which are mapped to the host memory space by the peripheral buses like PCIe.
Following are the major components of MMIO register space:</p>
<p>MHI control registers: Access to MHI configurations registers</p>
<p>MHI BHI registers: BHI (Boot Host Interface) registers are used by the host
for downloading the firmware to the device before MHI initialization.</p>
<p>Channel Doorbell array: Channel Doorbell (DB) registers used by the host to
notify the device when there is new work to do.</p>
<p>Event Doorbell array: Associated with event context array, the Event Doorbell
(DB) registers are used by the host to notify the device when new events are
available.</p>
<p>Debug registers: A set of registers and counters used by the device to expose
debugging information like performance, functional, and stability to the host.</p>
</div>
<div class="section" id="data-structures">
<h3>Data structures<a class="headerlink" href="#data-structures" title="Permalink to this headline">¶</a></h3>
<p>All data structures used by MHI are in the host system memory. Using the
physical interface, the device accesses those data structures. MHI data
structures and data buffers in the host system memory regions are mapped for
the device.</p>
<p>Channel context array: All channel configurations are organized in channel
context data array.</p>
<p>Transfer rings: Used by the host to schedule work items for a channel. The
transfer rings are organized as a circular queue of Transfer Descriptors (TD).</p>
<p>Event context array: All event configurations are organized in the event context
data array.</p>
<p>Event rings: Used by the device to send completion and state transition messages
to the host</p>
<p>Command context array: All command configurations are organized in command
context data array.</p>
<p>Command rings: Used by the host to send MHI commands to the device. The command
rings are organized as a circular queue of Command Descriptors (CD).</p>
</div>
<div class="section" id="channels">
<h3>Channels<a class="headerlink" href="#channels" title="Permalink to this headline">¶</a></h3>
<p>MHI channels are logical, unidirectional data pipes between a host and a device.
The concept of channels in MHI is similar to endpoints in USB. MHI supports up
to 256 channels. However, specific device implementations may support less than
the maximum number of channels allowed.</p>
<p>Two unidirectional channels with their associated transfer rings form a
bidirectional data pipe, which can be used by the upper-layer protocols to
transport application data packets (such as IP packets, modem control messages,
diagnostics messages, and so on). Each channel is associated with a single
transfer ring.</p>
</div>
<div class="section" id="transfer-rings">
<h3>Transfer rings<a class="headerlink" href="#transfer-rings" title="Permalink to this headline">¶</a></h3>
<p>Transfers between the host and device are organized by channels and defined by
Transfer Descriptors (TD). TDs are managed through transfer rings, which are
defined for each channel between the device and host and reside in the host
memory. TDs consist of one or more ring elements (or transfer blocks):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Read Pointer (RP)] -----------&gt;[Ring Element] } TD
[Write Pointer (WP)]-           [Ring Element]
                     -          [Ring Element]
                      ---------&gt;[Ring Element]
                                [Ring Element]
</pre></div>
</div>
<p>Below is the basic usage of transfer rings:</p>
<ul class="simple">
<li>Host allocates memory for transfer ring.</li>
<li>Host sets the base pointer, read pointer, and write pointer in corresponding
channel context.</li>
<li>Ring is considered empty when RP == WP.</li>
<li>Ring is considered full when WP + 1 == RP.</li>
<li>RP indicates the next element to be serviced by the device.</li>
<li>When the host has a new buffer to send, it updates the ring element with
buffer information, increments the WP to the next element and rings the
associated channel DB.</li>
</ul>
</div>
<div class="section" id="event-rings">
<h3>Event rings<a class="headerlink" href="#event-rings" title="Permalink to this headline">¶</a></h3>
<p>Events from the device to host are organized in event rings and defined by Event
Descriptors (ED). Event rings are used by the device to report events such as
data transfer completion status, command completion status, and state changes
to the host. Event rings are the array of EDs that resides in the host
memory. EDs consist of one or more ring elements (or transfer blocks):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[Read Pointer (RP)] -----------&gt;[Ring Element] } ED
[Write Pointer (WP)]-           [Ring Element]
                     -          [Ring Element]
                      ---------&gt;[Ring Element]
                                [Ring Element]
</pre></div>
</div>
<p>Below is the basic usage of event rings:</p>
<ul class="simple">
<li>Host allocates memory for event ring.</li>
<li>Host sets the base pointer, read pointer, and write pointer in corresponding
channel context.</li>
<li>Both host and device has a local copy of RP, WP.</li>
<li>Ring is considered empty (no events to service) when WP + 1 == RP.</li>
<li>Ring is considered full of events when RP == WP.</li>
<li>When there is a new event the device needs to send, the device updates ED
pointed by RP, increments the RP to the next element and triggers the
interrupt.</li>
</ul>
</div>
<div class="section" id="ring-element">
<h3>Ring Element<a class="headerlink" href="#ring-element" title="Permalink to this headline">¶</a></h3>
<p>A Ring Element is a data structure used to transfer a single block
of data between the host and the device. Transfer ring element types contain a
single buffer pointer, the size of the buffer, and additional control
information. Other ring element types may only contain control and status
information. For single buffer operations, a ring descriptor is composed of a
single element. For large multi-buffer operations (such as scatter and gather),
elements can be chained to form a longer descriptor.</p>
</div>
</div>
<div class="section" id="mhi-operations">
<h2>MHI Operations<a class="headerlink" href="#mhi-operations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mhi-states">
<h3>MHI States<a class="headerlink" href="#mhi-states" title="Permalink to this headline">¶</a></h3>
<div class="section" id="mhi-state-reset">
<h4>MHI_STATE_RESET<a class="headerlink" href="#mhi-state-reset" title="Permalink to this headline">¶</a></h4>
<p>MHI is in reset state after power-up or hardware reset. The host is not allowed
to access device MMIO register space.</p>
</div>
<div class="section" id="mhi-state-ready">
<h4>MHI_STATE_READY<a class="headerlink" href="#mhi-state-ready" title="Permalink to this headline">¶</a></h4>
<p>MHI is ready for initialization. The host can start MHI initialization by
programming MMIO registers.</p>
</div>
<div class="section" id="mhi-state-m0">
<h4>MHI_STATE_M0<a class="headerlink" href="#mhi-state-m0" title="Permalink to this headline">¶</a></h4>
<p>MHI is running and operational in the device. The host can start channels by
issuing channel start command.</p>
</div>
<div class="section" id="mhi-state-m1">
<h4>MHI_STATE_M1<a class="headerlink" href="#mhi-state-m1" title="Permalink to this headline">¶</a></h4>
<p>MHI operation is suspended by the device. This state is entered when the
device detects inactivity at the physical interface within a preset time.</p>
</div>
<div class="section" id="mhi-state-m2">
<h4>MHI_STATE_M2<a class="headerlink" href="#mhi-state-m2" title="Permalink to this headline">¶</a></h4>
<p>MHI is in low power state. MHI operation is suspended and the device may
enter lower power mode.</p>
</div>
<div class="section" id="mhi-state-m3">
<h4>MHI_STATE_M3<a class="headerlink" href="#mhi-state-m3" title="Permalink to this headline">¶</a></h4>
<p>MHI operation stopped by the host. This state is entered when the host suspends
MHI operation.</p>
</div>
</div>
<div class="section" id="mhi-initialization">
<h3>MHI Initialization<a class="headerlink" href="#mhi-initialization" title="Permalink to this headline">¶</a></h3>
<p>After system boots, the device is enumerated over the physical interface.
In the case of PCIe, the device is enumerated and assigned BAR-0 for
the device’s MMIO register space. To initialize the MHI in a device,
the host performs the following operations:</p>
<ul class="simple">
<li>Allocates the MHI context for event, channel and command arrays.</li>
<li>Initializes the context array, and prepares interrupts.</li>
<li>Waits until the device enters READY state.</li>
<li>Programs MHI MMIO registers and sets device into MHI_M0 state.</li>
<li>Waits for the device to enter M0 state.</li>
</ul>
</div>
<div class="section" id="mhi-data-transfer">
<h3>MHI Data Transfer<a class="headerlink" href="#mhi-data-transfer" title="Permalink to this headline">¶</a></h3>
<p>MHI data transfer is initiated by the host to transfer data to the device.
Following are the sequence of operations performed by the host to transfer
data to device:</p>
<ul class="simple">
<li>Host prepares TD with buffer information.</li>
<li>Host increments the WP of the corresponding channel transfer ring.</li>
<li>Host rings the channel DB register.</li>
<li>Device wakes up to process the TD.</li>
<li>Device generates a completion event for the processed TD by updating ED.</li>
<li>Device increments the RP of the corresponding event ring.</li>
<li>Device triggers IRQ to wake up the host.</li>
<li>Host wakes up and checks the event ring for completion event.</li>
<li>Host updates the WP of the corresponding event ring to indicate that the
data transfer has been completed successfully.</li>
</ul>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="topology.html" class="btn btn-neutral float-right" title="MHI Topology" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="MHI" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>