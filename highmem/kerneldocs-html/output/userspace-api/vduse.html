

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>VDUSE - “vDPA Device in Userspace” &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="The Linux kernel user-space API guide" href="index.html"/>
        <link rel="next" title="futex2" href="futex2.html"/>
        <link rel="prev" title="Platform Profile Selection (e.g. /sys/firmware/acpi/platform_profile)" href="sysfs-platform_profile.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">The Linux kernel user-space API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="no_new_privs.html">No New Privileges Flag</a></li>
<li class="toctree-l2"><a class="reference internal" href="seccomp_filter.html">Seccomp BPF (SECure COMPuting with filters)</a></li>
<li class="toctree-l2"><a class="reference internal" href="landlock.html">Landlock: unprivileged access control</a></li>
<li class="toctree-l2"><a class="reference internal" href="unshare.html">unshare system call</a></li>
<li class="toctree-l2"><a class="reference internal" href="spec_ctrl.html">Speculation Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="accelerators/ocxl.html">OpenCAPI (Open Coherent Accelerator Processor Interface)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ebpf/index.html">eBPF Userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="ioctl/index.html">IOCTLs</a></li>
<li class="toctree-l2"><a class="reference internal" href="iommu.html">IOMMU Userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="media/index.html">Linux Media Infrastructure userspace API</a></li>
<li class="toctree-l2"><a class="reference internal" href="sysfs-platform_profile.html">Platform Profile Selection (e.g. /sys/firmware/acpi/platform_profile)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">VDUSE - “vDPA Device in Userspace”</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#create-destroy-vduse-devices">Create/Destroy VDUSE devices</a></li>
<li class="toctree-l3"><a class="reference internal" href="#how-vduse-works">How VDUSE works</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="futex2.html">futex2</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">The Linux kernel user-space API guide</a> &raquo;</li>
        
      <li>VDUSE - “vDPA Device in Userspace”</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/userspace-api/vduse.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="vduse-vdpa-device-in-userspace">
<h1>VDUSE - “vDPA Device in Userspace”<a class="headerlink" href="#vduse-vdpa-device-in-userspace" title="Permalink to this headline">¶</a></h1>
<p>vDPA (virtio data path acceleration) device is a device that uses a
datapath which complies with the virtio specifications with vendor
specific control path. vDPA devices can be both physically located on
the hardware or emulated by software. VDUSE is a framework that makes it
possible to implement software-emulated vDPA devices in userspace. And
to make the device emulation more secure, the emulated vDPA device’s
control path is handled in the kernel and only the data path is
implemented in the userspace.</p>
<p>Note that only virtio block device is supported by VDUSE framework now,
which can reduce security risks when the userspace process that implements
the data path is run by an unprivileged user. The support for other device
types can be added after the security issue of corresponding device driver
is clarified or fixed in the future.</p>
<div class="section" id="create-destroy-vduse-devices">
<h2>Create/Destroy VDUSE devices<a class="headerlink" href="#create-destroy-vduse-devices" title="Permalink to this headline">¶</a></h2>
<p>VDUSE devices are created as follows:</p>
<ol class="arabic simple">
<li>Create a new VDUSE instance with ioctl(VDUSE_CREATE_DEV) on
/dev/vduse/control.</li>
<li>Setup each virtqueue with ioctl(VDUSE_VQ_SETUP) on /dev/vduse/$NAME.</li>
<li>Begin processing VDUSE messages from /dev/vduse/$NAME. The first
messages will arrive while attaching the VDUSE instance to vDPA bus.</li>
<li>Send the VDPA_CMD_DEV_NEW netlink message to attach the VDUSE
instance to vDPA bus.</li>
</ol>
<p>VDUSE devices are destroyed as follows:</p>
<ol class="arabic simple">
<li>Send the VDPA_CMD_DEV_DEL netlink message to detach the VDUSE
instance from vDPA bus.</li>
<li>Close the file descriptor referring to /dev/vduse/$NAME.</li>
<li>Destroy the VDUSE instance with ioctl(VDUSE_DESTROY_DEV) on
/dev/vduse/control.</li>
</ol>
<p>The netlink messages can be sent via vdpa tool in iproute2 or use the
below sample codes:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">netlink_add_vduse</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">enum</span> <span class="n">vdpa_command</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">nl_sock</span> <span class="o">*</span><span class="n">nlsock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">nl_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">famid</span><span class="p">;</span>

        <span class="n">nlsock</span> <span class="o">=</span> <span class="n">nl_socket_alloc</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nlsock</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">genl_connect</span><span class="p">(</span><span class="n">nlsock</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">free_sock</span><span class="p">;</span>

        <span class="n">famid</span> <span class="o">=</span> <span class="n">genl_ctrl_resolve</span><span class="p">(</span><span class="n">nlsock</span><span class="p">,</span> <span class="n">VDPA_GENL_NAME</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">famid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">close_sock</span><span class="p">;</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">nlmsg_alloc</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">close_sock</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">genlmsg_put</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">NL_AUTO_PORT</span><span class="p">,</span> <span class="n">NL_AUTO_SEQ</span><span class="p">,</span> <span class="n">famid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">nla_put_failure</span><span class="p">;</span>

        <span class="n">NLA_PUT_STRING</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">VDPA_ATTR_DEV_NAME</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">VDPA_CMD_DEV_NEW</span><span class="p">)</span>
                <span class="n">NLA_PUT_STRING</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">VDPA_ATTR_MGMTDEV_DEV_NAME</span><span class="p">,</span> <span class="s">&quot;vduse&quot;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nl_send_sync</span><span class="p">(</span><span class="n">nlsock</span><span class="p">,</span> <span class="n">msg</span><span class="p">))</span>
                <span class="k">goto</span> <span class="n">close_sock</span><span class="p">;</span>

        <span class="n">nl_close</span><span class="p">(</span><span class="n">nlsock</span><span class="p">);</span>
        <span class="n">nl_socket_free</span><span class="p">(</span><span class="n">nlsock</span><span class="p">);</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">nla_put_failure</span><span class="p">:</span>
        <span class="n">nlmsg_free</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="nl">close_sock</span><span class="p">:</span>
        <span class="n">nl_close</span><span class="p">(</span><span class="n">nlsock</span><span class="p">);</span>
<span class="nl">free_sock</span><span class="p">:</span>
        <span class="n">nl_socket_free</span><span class="p">(</span><span class="n">nlsock</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="how-vduse-works">
<h2>How VDUSE works<a class="headerlink" href="#how-vduse-works" title="Permalink to this headline">¶</a></h2>
<p>As mentioned above, a VDUSE device is created by ioctl(VDUSE_CREATE_DEV) on
/dev/vduse/control. With this ioctl, userspace can specify some basic configuration
such as device name (uniquely identify a VDUSE device), virtio features, virtio
configuration space, the number of virtqueues and so on for this emulated device.
Then a char device interface (/dev/vduse/$NAME) is exported to userspace for device
emulation. Userspace can use the VDUSE_VQ_SETUP ioctl on /dev/vduse/$NAME to
add per-virtqueue configuration such as the max size of virtqueue to the device.</p>
<p>After the initialization, the VDUSE device can be attached to vDPA bus via
the VDPA_CMD_DEV_NEW netlink message. Userspace needs to read()/write() on
/dev/vduse/$NAME to receive/reply some control messages from/to VDUSE kernel
module as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">vduse_message_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_fd</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">vduse_dev_request</span> <span class="n">req</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">vduse_dev_response</span> <span class="n">resp</span><span class="p">;</span>

        <span class="n">len</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">dev_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="n">resp</span><span class="p">.</span><span class="n">request_id</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">request_id</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>

        <span class="cm">/* handle different types of messages */</span>

        <span class="p">}</span>

        <span class="n">len</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">dev_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">resp</span><span class="p">))</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are now three types of messages introduced by VDUSE framework:</p>
<ul class="simple">
<li>VDUSE_GET_VQ_STATE: Get the state for virtqueue, userspace should return
avail index for split virtqueue or the device/driver ring wrap counters and
the avail and used index for packed virtqueue.</li>
<li>VDUSE_SET_STATUS: Set the device status, userspace should follow
the virtio spec: <a class="reference external" href="https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html">https://docs.oasis-open.org/virtio/virtio/v1.1/virtio-v1.1.html</a>
to process this message. For example, fail to set the FEATURES_OK device
status bit if the device can not accept the negotiated virtio features
get from the VDUSE_DEV_GET_FEATURES ioctl.</li>
<li>VDUSE_UPDATE_IOTLB: Notify userspace to update the memory mapping for specified
IOVA range, userspace should firstly remove the old mapping, then setup the new
mapping via the VDUSE_IOTLB_GET_FD ioctl.</li>
</ul>
<p>After DRIVER_OK status bit is set via the VDUSE_SET_STATUS message, userspace is
able to start the dataplane processing as follows:</p>
<ol class="arabic simple">
<li>Get the specified virtqueue’s information with the VDUSE_VQ_GET_INFO ioctl,
including the size, the IOVAs of descriptor table, available ring and used ring,
the state and the ready status.</li>
<li>Pass the above IOVAs to the VDUSE_IOTLB_GET_FD ioctl so that those IOVA regions
can be mapped into userspace. Some sample codes is shown below:</li>
</ol>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">perm_to_prot</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">perm</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">prot</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">switch</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">VDUSE_ACCESS_WO</span><span class="p">:</span>
                <span class="n">prot</span> <span class="o">|=</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">VDUSE_ACCESS_RO</span><span class="p">:</span>
                <span class="n">prot</span> <span class="o">|=</span> <span class="n">PROT_READ</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nl">VDUSE_ACCESS_RW</span><span class="p">:</span>
                <span class="n">prot</span> <span class="o">|=</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">prot</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">iova_to_va</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_fd</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">iova</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
        <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
        <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">vduse_iotlb_entry</span> <span class="n">entry</span><span class="p">;</span>

        <span class="n">entry</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">iova</span><span class="p">;</span>
        <span class="n">entry</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">iova</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * Find the first IOVA region that overlaps with the specified</span>
<span class="cm">         * range [start, last] and return the corresponding file descriptor.</span>
<span class="cm">         */</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">dev_fd</span><span class="p">,</span> <span class="n">VDUSE_IOTLB_GET_FD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="n">size</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">last</span> <span class="o">-</span> <span class="n">entry</span><span class="p">.</span><span class="n">start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">entry</span><span class="p">.</span><span class="n">last</span> <span class="o">-</span> <span class="n">iova</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">perm_to_prot</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">perm</span><span class="p">),</span> <span class="n">MAP_SHARED</span><span class="p">,</span>
                    <span class="n">fd</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">offset</span><span class="p">);</span>
        <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

        <span class="cm">/*</span>
<span class="cm">         * Using some data structures such as linked list to store</span>
<span class="cm">         * the iotlb mapping. The munmap(2) should be called for the</span>
<span class="cm">         * cached mapping when the corresponding VDUSE_UPDATE_IOTLB</span>
<span class="cm">         * message is received or the device is reset.</span>
<span class="cm">         */</span>

        <span class="k">return</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">iova</span> <span class="o">-</span> <span class="n">entry</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li>Setup the kick eventfd for the specified virtqueues with the VDUSE_VQ_SETUP_KICKFD
ioctl. The kick eventfd is used by VDUSE kernel module to notify userspace to
consume the available ring. This is optional since userspace can choose to poll the
available ring instead.</li>
<li>Listen to the kick eventfd (optional) and consume the available ring. The buffer
described by the descriptors in the descriptor table should be also mapped into
userspace via the VDUSE_IOTLB_GET_FD ioctl before accessing.</li>
<li>Inject an interrupt for specific virtqueue with the VDUSE_INJECT_VQ_IRQ ioctl
after the used ring is filled.</li>
</ol>
<p>For more details on the uAPI, please see include/uapi/linux/vduse.h.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="futex2.html" class="btn btn-neutral float-right" title="futex2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sysfs-platform_profile.html" class="btn btn-neutral" title="Platform Profile Selection (e.g. /sys/firmware/acpi/platform_profile)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>