

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Cache on Already Mounted Filesystem &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../../index.html"/>
        <link rel="up" title="Filesystem Caching" href="index.html"/>
        <link rel="next" title="Changes since 2.5.0:" href="../porting.html"/>
        <link rel="prev" title="Cache Backend API" href="backend-api.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Filesystems in the Linux kernel</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#core-vfs-documentation">Core VFS documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../vfs.html">Overview of the Linux Virtual File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="../path-lookup.html">Pathname lookup</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-summary.html">Linux Filesystems API summary</a></li>
<li class="toctree-l3"><a class="reference internal" href="../splice.html">splice and pipes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking.html">Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../directory-locking.html">Directory Locking</a></li>
<li class="toctree-l3"><a class="reference internal" href="../devpts.html">The Devpts Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../dnotify.html">Linux Directory Notification</a></li>
<li class="toctree-l3"><a class="reference internal" href="../fiemap.html">Fiemap Ioctl</a></li>
<li class="toctree-l3"><a class="reference internal" href="../files.html">File management in the Linux kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locks.html">File Locking Release Notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mount_api.html">Filesystem Mount API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../quota.html">Quota subsystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="../seq_file.html">The seq_file Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../sharedsubtree.html">Shared Subtrees</a></li>
<li class="toctree-l3"><a class="reference internal" href="../idmappings.html">Idmappings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../automount-support.html">Automount Support</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Filesystem Caching</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="fscache.html">General Filesystem Caching</a></li>
<li class="toctree-l4"><a class="reference internal" href="netfs-api.html">Network Filesystem Caching API</a></li>
<li class="toctree-l4"><a class="reference internal" href="backend-api.html">Cache Backend API</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Cache on Already Mounted Filesystem</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../porting.html">Changes since 2.5.0:</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#filesystem-support-layers">Filesystem support layers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#filesystems">Filesystems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Filesystems in the Linux kernel</a> &raquo;</li>
        
          <li><a href="index.html">Filesystem Caching</a> &raquo;</li>
        
      <li>Cache on Already Mounted Filesystem</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/filesystems/caching/cachefiles.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="cache-on-already-mounted-filesystem">
<h1>Cache on Already Mounted Filesystem<a class="headerlink" href="#cache-on-already-mounted-filesystem" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>CacheFiles is a caching backend that’s meant to use as a cache a directory on
an already mounted filesystem of a local type (such as Ext3).</p>
<p>CacheFiles uses a userspace daemon to do some of the cache management - such as
reaping stale nodes and culling.  This is called cachefilesd and lives in
/sbin.</p>
<p>The filesystem and data integrity of the cache are only as good as those of the
filesystem providing the backing services.  Note that CacheFiles does not
attempt to journal anything since the journalling interfaces of the various
filesystems are very specific in nature.</p>
<p>CacheFiles creates a misc character device - “/dev/cachefiles” - that is used
to communication with the daemon.  Only one thing may have this open at once,
and while it is open, a cache is at least partially in existence.  The daemon
opens this and sends commands down it to control the cache.</p>
<p>CacheFiles is currently limited to a single cache.</p>
<p>CacheFiles attempts to maintain at least a certain percentage of free space on
the filesystem, shrinking the cache by culling the objects it contains to make
space if necessary - see the “Cache Culling” section.  This means it can be
placed on the same medium as a live set of data, and will expand to make use of
spare space and automatically contract when the set of data requires more
space.</p>
</div>
<div class="section" id="requirements">
<h2>Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<p>The use of CacheFiles and its daemon requires the following features to be
available in the system and in the cache filesystem:</p>
<blockquote>
<div><ul class="simple">
<li>dnotify.</li>
<li>extended attributes (xattrs).</li>
<li>openat() and friends.</li>
<li><a class="reference internal" href="../api-summary.html#c.bmap" title="bmap"><code class="xref c c-func docutils literal notranslate"><span class="pre">bmap()</span></code></a> support on files in the filesystem (FIBMAP ioctl).</li>
<li>The use of <a class="reference internal" href="../api-summary.html#c.bmap" title="bmap"><code class="xref c c-func docutils literal notranslate"><span class="pre">bmap()</span></code></a> to detect a partial page at the end of the file.</li>
</ul>
</div></blockquote>
<p>It is strongly recommended that the “dir_index” option is enabled on Ext3
filesystems being used as a cache.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>The cache is configured by a script in /etc/cachefilesd.conf.  These commands
set up cache ready for use.  The following script commands are available:</p>
<blockquote>
<div><dl class="docutils">
<dt>brun &lt;N&gt;%, bcull &lt;N&gt;%, bstop &lt;N&gt;%, frun &lt;N&gt;%, fcull &lt;N&gt;%, fstop &lt;N&gt;%</dt>
<dd><p class="first">Configure the culling limits.  Optional.  See the section on culling
The defaults are 7% (run), 5% (cull) and 1% (stop) respectively.</p>
<p class="last">The commands beginning with a ‘b’ are file space (block) limits, those
beginning with an ‘f’ are file count limits.</p>
</dd>
<dt>dir &lt;path&gt;</dt>
<dd>Specify the directory containing the root of the cache.  Mandatory.</dd>
<dt>tag &lt;name&gt;</dt>
<dd>Specify a tag to FS-Cache to use in distinguishing multiple caches.
Optional.  The default is “CacheFiles”.</dd>
<dt>debug &lt;mask&gt;</dt>
<dd><p class="first">Specify a numeric bitmask to control debugging in the kernel module.
Optional.  The default is zero (all off).  The following values can be
OR’d into the mask to collect various information:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="4%" />
<col width="96%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>1</td>
<td>Turn on trace of function entry (_enter() macros)</td>
</tr>
<tr class="row-even"><td>2</td>
<td>Turn on trace of function exit (_leave() macros)</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Turn on trace of internal debug points (_debug())</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>This mask can also be set through sysfs, eg:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>echo 5 &gt;/sys/modules/cachefiles/parameters/debug
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="starting-the-cache">
<h2>Starting the Cache<a class="headerlink" href="#starting-the-cache" title="Permalink to this headline">¶</a></h2>
<p>The cache is started by running the daemon.  The daemon opens the cache device,
configures the cache and tells it to begin caching.  At that point the cache
binds to fscache and the cache becomes live.</p>
<p>The daemon is run as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sbin/cachefilesd [-d]* [-s] [-n] [-f &lt;configfile&gt;]
</pre></div>
</div>
<p>The flags are:</p>
<blockquote>
<div><dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">-d</span></code></dt>
<dd>Increase the debugging level.  This can be specified multiple times and
is cumulative with itself.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-s</span></code></dt>
<dd>Send messages to stderr instead of syslog.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-n</span></code></dt>
<dd>Don’t daemonise and go into background.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">-f</span> <span class="pre">&lt;configfile&gt;</span></code></dt>
<dd>Use an alternative configuration file rather than the default one.</dd>
</dl>
</div></blockquote>
</div>
<div class="section" id="things-to-avoid">
<h2>Things to Avoid<a class="headerlink" href="#things-to-avoid" title="Permalink to this headline">¶</a></h2>
<p>Do not mount other things within the cache as this will cause problems.  The
kernel module contains its own very cut-down path walking facility that ignores
mountpoints, but the daemon can’t avoid them.</p>
<p>Do not create, rename or unlink files and directories in the cache while the
cache is active, as this may cause the state to become uncertain.</p>
<p>Renaming files in the cache might make objects appear to be other objects (the
filename is part of the lookup key).</p>
<p>Do not change or remove the extended attributes attached to cache files by the
cache as this will cause the cache state management to get confused.</p>
<p>Do not create files or directories in the cache, lest the cache get confused or
serve incorrect data.</p>
<p>Do not chmod files in the cache.  The module creates things with minimal
permissions to prevent random users being able to access them directly.</p>
</div>
<div class="section" id="cache-culling">
<h2>Cache Culling<a class="headerlink" href="#cache-culling" title="Permalink to this headline">¶</a></h2>
<p>The cache may need culling occasionally to make space.  This involves
discarding objects from the cache that have been used less recently than
anything else.  Culling is based on the access time of data objects.  Empty
directories are culled if not in use.</p>
<p>Cache culling is done on the basis of the percentage of blocks and the
percentage of files available in the underlying filesystem.  There are six
“limits”:</p>
<blockquote>
<div><dl class="docutils">
<dt>brun, frun</dt>
<dd>If the amount of free space and the number of available files in the cache
rises above both these limits, then culling is turned off.</dd>
<dt>bcull, fcull</dt>
<dd>If the amount of available space or the number of available files in the
cache falls below either of these limits, then culling is started.</dd>
<dt>bstop, fstop</dt>
<dd>If the amount of available space or the number of available files in the
cache falls below either of these limits, then no further allocation of
disk space or files is permitted until culling has raised things above
these limits again.</dd>
</dl>
</div></blockquote>
<p>These must be configured thusly:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0 &lt;= bstop &lt; bcull &lt; brun &lt; 100
0 &lt;= fstop &lt; fcull &lt; frun &lt; 100
</pre></div>
</div>
<p>Note that these are percentages of available space and available files, and do
_not_ appear as 100 minus the percentage displayed by the “df” program.</p>
<p>The userspace daemon scans the cache to build up a table of cullable objects.
These are then culled in least recently used order.  A new scan of the cache is
started as soon as space is made in the table.  Objects will be skipped if
their atimes have changed or if the kernel module says it is still using them.</p>
</div>
<div class="section" id="cache-structure">
<h2>Cache Structure<a class="headerlink" href="#cache-structure" title="Permalink to this headline">¶</a></h2>
<p>The CacheFiles module will create two directories in the directory it was
given:</p>
<blockquote>
<div><ul class="simple">
<li>cache/</li>
<li>graveyard/</li>
</ul>
</div></blockquote>
<p>The active cache objects all reside in the first directory.  The CacheFiles
kernel module moves any retired or culled objects that it can’t simply unlink
to the graveyard from which the daemon will actually delete them.</p>
<p>The daemon uses dnotify to monitor the graveyard directory, and will delete
anything that appears therein.</p>
<p>The module represents index objects as directories with the filename “I…” or
“J…”.  Note that the “cache/” directory is itself a special index.</p>
<p>Data objects are represented as files if they have no children, or directories
if they do.  Their filenames all begin “D…” or “E…”.  If represented as a
directory, data objects will have a file in the directory called “data” that
actually holds the data.</p>
<p>Special objects are similar to data objects, except their filenames begin
“S…” or “T…”.</p>
<p>If an object has children, then it will be represented as a directory.
Immediately in the representative directory are a collection of directories
named for hash values of the child object keys with an ‘&#64;’ prepended.  Into
this directory, if possible, will be placed the representations of the child
objects:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> /INDEX    /INDEX     /INDEX                            /DATA FILES
/=========/==========/=================================/================
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...DB1ry
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...N22ry
cache/@4a/I03nfs/@30/Ji000000000000000--fHg8hi8400/@75/Es0g000w...FP1ry
</pre></div>
</div>
<p>If the key is so long that it exceeds NAME_MAX with the decorations added on to
it, then it will be cut into pieces, the first few of which will be used to
make a nest of directories, and the last one of which will be the objects
inside the last directory.  The names of the intermediate directories will have
‘+’ prepended:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>J1223/@23/+xy...z/+kl...m/Epqr
</pre></div>
</div>
<p>Note that keys are raw data, and not only may they exceed NAME_MAX in size,
they may also contain things like ‘/’ and NUL characters, and so they may not
be suitable for turning directly into a filename.</p>
<p>To handle this, CacheFiles will use a suitably printable filename directly and
“base-64” encode ones that aren’t directly suitable.  The two versions of
object filenames indicate the encoding:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="33%" />
<col width="33%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">OBJECT TYPE</th>
<th class="head">PRINTABLE</th>
<th class="head">ENCODED</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Index</td>
<td>“I…”</td>
<td>“J…”</td>
</tr>
<tr class="row-odd"><td>Data</td>
<td>“D…”</td>
<td>“E…”</td>
</tr>
<tr class="row-even"><td>Special</td>
<td>“S…”</td>
<td>“T…”</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Intermediate directories are always “&#64;” or “+” as appropriate.</p>
<p>Each object in the cache has an extended attribute label that holds the object
type ID (required to distinguish special objects) and the auxiliary data from
the netfs.  The latter is used to detect stale objects in the cache and update
or retire them.</p>
<p>Note that CacheFiles will erase from the cache any file it doesn’t recognise or
any file of an incorrect type (such as a FIFO file or a device file).</p>
</div>
<div class="section" id="security-model-and-selinux">
<h2>Security Model and SELinux<a class="headerlink" href="#security-model-and-selinux" title="Permalink to this headline">¶</a></h2>
<p>CacheFiles is implemented to deal properly with the LSM security features of
the Linux kernel and the SELinux facility.</p>
<p>One of the problems that CacheFiles faces is that it is generally acting on
behalf of a process, and running in that process’s context, and that includes a
security context that is not appropriate for accessing the cache - either
because the files in the cache are inaccessible to that process, or because if
the process creates a file in the cache, that file may be inaccessible to other
processes.</p>
<p>The way CacheFiles works is to temporarily change the security context (fsuid,
fsgid and actor security label) that the process acts as - without changing the
security context of the process when it the target of an operation performed by
some other process (so signalling and suchlike still work correctly).</p>
<p>When the CacheFiles module is asked to bind to its cache, it:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">Finds the security label attached to the root cache directory and uses
that as the security label with which it will create files.  By default,
this is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cachefiles_var_t
</pre></div>
</div>
</li>
<li><p class="first">Finds the security label of the process which issued the bind request
(presumed to be the cachefilesd daemon), which by default will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cachefilesd_t
</pre></div>
</div>
<p>and asks LSM to supply a security ID as which it should act given the
daemon’s label.  By default, this will be:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cachefiles_kernel_t
</pre></div>
</div>
<p>SELinux transitions the daemon’s security ID to the module’s security ID
based on a rule of this form in the policy:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type_transition &lt;daemon&#39;s-ID&gt; kernel_t : process &lt;module&#39;s-ID&gt;;
</pre></div>
</div>
<p>For instance:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>type_transition cachefilesd_t kernel_t : process cachefiles_kernel_t;
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
<p>The module’s security ID gives it permission to create, move and remove files
and directories in the cache, to find and access directories and files in the
cache, to set and access extended attributes on cache objects, and to read and
write files in the cache.</p>
<p>The daemon’s security ID gives it only a very restricted set of permissions: it
may scan directories, stat files and erase files and directories.  It may
not read or write files in the cache, and so it is precluded from accessing the
data cached therein; nor is it permitted to create new files in the cache.</p>
<p>There are policy source files available in:</p>
<blockquote>
<div><a class="reference external" href="https://people.redhat.com/~dhowells/fscache/cachefilesd-0.8.tar.bz2">https://people.redhat.com/~dhowells/fscache/cachefilesd-0.8.tar.bz2</a></div></blockquote>
<p>and later versions.  In that tarball, see the files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cachefilesd.te
cachefilesd.fc
cachefilesd.if
</pre></div>
</div>
<p>They are built and installed directly by the RPM.</p>
<p>If a non-RPM based system is being used, then copy the above files to their own
directory and run:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>make -f /usr/share/selinux/devel/Makefile
semodule -i cachefilesd.pp
</pre></div>
</div>
<p>You will need checkpolicy and selinux-policy-devel installed prior to the
build.</p>
<p>By default, the cache is located in /var/fscache, but if it is desirable that
it should be elsewhere, than either the above policy files must be altered, or
an auxiliary policy must be installed to label the alternate location of the
cache.</p>
<p>For instructions on how to add an auxiliary policy to enable the cache to be
located elsewhere when SELinux is in enforcing mode, please see:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/usr/share/doc/cachefilesd-*/move-cache.txt
</pre></div>
</div>
<p>When the cachefilesd rpm is installed; alternatively, the document can be found
in the sources.</p>
</div>
<div class="section" id="a-note-on-security">
<h2>A Note on Security<a class="headerlink" href="#a-note-on-security" title="Permalink to this headline">¶</a></h2>
<p>CacheFiles makes use of the split security in the task_struct.  It allocates
its own task_security structure, and redirects current-&gt;cred to point to it
when it acts on behalf of another process, in that process’s context.</p>
<p>The reason it does this is that it calls <a class="reference internal" href="../api-summary.html#c.vfs_mkdir" title="vfs_mkdir"><code class="xref c c-func docutils literal notranslate"><span class="pre">vfs_mkdir()</span></code></a> and suchlike rather than
bypassing security and calling inode ops directly.  Therefore the VFS and LSM
may deny the CacheFiles access to the cache data because under some
circumstances the caching code is running in the security context of whatever
process issued the original syscall on the netfs.</p>
<p>Furthermore, should CacheFiles create a file or directory, the security
parameters with that object is created (UID, GID, security label) would be
derived from that process that issued the system call, thus potentially
preventing other processes from accessing the cache - including CacheFiles’s
cache management daemon (cachefilesd).</p>
<p>What is required is to temporarily override the security of the process that
issued the system call.  We can’t, however, just do an in-place change of the
security data as that affects the process as an object, not just as a subject.
This means it may lose signals or ptrace events for example, and affects what
the process looks like in /proc.</p>
<p>So CacheFiles makes use of a logical split in the security between the
objective security (task-&gt;real_cred) and the subjective security (task-&gt;cred).
The objective security holds the intrinsic security properties of a process and
is never overridden.  This is what appears in /proc, and is what is used when a
process is the target of an operation by some other process (SIGKILL for
example).</p>
<p>The subjective security holds the active security properties of a process, and
may be overridden.  This is not seen externally, and is used whan a process
acts upon another object, for example SIGKILLing another process or opening a
file.</p>
<p>LSM hooks exist that allow SELinux (or Smack or whatever) to reject a request
for CacheFiles to run in a context of a specific security label, or to create
files and directories with another security label.</p>
</div>
<div class="section" id="statistical-information">
<h2>Statistical Information<a class="headerlink" href="#statistical-information" title="Permalink to this headline">¶</a></h2>
<p>If FS-Cache is compiled with the following option enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CONFIG_CACHEFILES_HISTOGRAM=y
</pre></div>
</div>
<p>then it will gather certain statistics and display them through a proc file.</p>
<blockquote>
<div><p>/proc/fs/cachefiles/histogram</p>
<blockquote>
<div><div class="highlight-none notranslate"><div class="highlight"><pre><span></span>cat /proc/fs/cachefiles/histogram
JIFS  SECS  LOOKUPS   MKDIRS    CREATES
===== ===== ========= ========= =========
</pre></div>
</div>
<p>This shows the breakdown of the number of times each amount of time
between 0 jiffies and HZ-1 jiffies a variety of tasks took to run.  The
columns are as follows:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">COLUMN</th>
<th class="head">TIME MEASUREMENT</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>LOOKUPS</td>
<td>Length of time to perform a lookup on the backing fs</td>
</tr>
<tr class="row-odd"><td>MKDIRS</td>
<td>Length of time to perform a mkdir on the backing fs</td>
</tr>
<tr class="row-even"><td>CREATES</td>
<td>Length of time to perform a create on the backing fs</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Each row shows the number of events that took a particular range of times.
Each step is 1 jiffy in size.  The JIFS column indicates the particular
jiffy range covered, and the SECS field the equivalent number of seconds.</p>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="debugging">
<h2>Debugging<a class="headerlink" href="#debugging" title="Permalink to this headline">¶</a></h2>
<p>If CONFIG_CACHEFILES_DEBUG is enabled, the CacheFiles facility can have runtime
debugging enabled by adjusting the value in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>/sys/module/cachefiles/parameters/debug
</pre></div>
</div>
<p>This is a bitmask of debugging streams to enable:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="46%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">BIT</th>
<th class="head">VALUE</th>
<th class="head">STREAM</th>
<th class="head">POINT</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>0</td>
<td>1</td>
<td>General</td>
<td>Function entry trace</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>2</td>
<td>&#160;</td>
<td>Function exit trace</td>
</tr>
<tr class="row-even"><td>2</td>
<td>4</td>
<td>&#160;</td>
<td>General</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>The appropriate set of values should be OR’d together and the result written to
the control file.  For example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>echo $((1|4|8)) &gt;/sys/module/cachefiles/parameters/debug
</pre></div>
</div>
<p>will turn on all function entry debugging.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../porting.html" class="btn btn-neutral float-right" title="Changes since 2.5.0:" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="backend-api.html" class="btn btn-neutral" title="Cache Backend API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>