

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>NILFS2 &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Filesystems in the Linux kernel" href="index.html"/>
        <link rel="next" title="NFS" href="nfs/index.html"/>
        <link rel="prev" title="ISO9660 Filesystem" href="isofs.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Filesystems in the Linux kernel</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#core-vfs-documentation">Core VFS documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#filesystem-support-layers">Filesystem support layers</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#filesystems">Filesystems</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="9p.html">v9fs: Plan 9 Resource Sharing for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="adfs.html">Acorn Disc Filing System - ADFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="affs.html">Overview of Amiga Filesystems</a></li>
<li class="toctree-l3"><a class="reference internal" href="afs.html">kAFS: AFS FILESYSTEM</a></li>
<li class="toctree-l3"><a class="reference internal" href="autofs.html">autofs - how it works</a></li>
<li class="toctree-l3"><a class="reference internal" href="autofs-mount-control.html">Miscellaneous Device control operations for the autofs kernel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="befs.html">BeOS filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="bfs.html">BFS Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="btrfs.html">BTRFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="cifs/index.html">CIFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="ceph.html">Ceph Distributed File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="coda.html">Coda Kernel-Venus Interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="configfs.html">Configfs - Userspace-driven Kernel Object Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="cramfs.html">Cramfs - cram a filesystem onto a small ROM</a></li>
<li class="toctree-l3"><a class="reference internal" href="dax.html">Direct Access for files</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugfs.html">DebugFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="dlmfs.html">DLMFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="ecryptfs.html">eCryptfs: A stacked cryptographic filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="efivarfs.html">efivarfs - a (U)EFI variable filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="erofs.html">Enhanced Read-Only File System - EROFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext2.html">The Second Extended Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext3.html">Ext3 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="ext4/index.html">ext4 Data Structures and Algorithms</a></li>
<li class="toctree-l3"><a class="reference internal" href="f2fs.html">WHAT IS Flash-Friendly File System (F2FS)?</a></li>
<li class="toctree-l3"><a class="reference internal" href="gfs2.html">Global File System 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="gfs2-uevents.html">uevents and GFS2</a></li>
<li class="toctree-l3"><a class="reference internal" href="gfs2-glocks.html">Glock internal locking rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="hfs.html">Macintosh HFS Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="hfsplus.html">Macintosh HFSPlus Filesystem for Linux</a></li>
<li class="toctree-l3"><a class="reference internal" href="hpfs.html">Read/Write HPFS 2.09</a></li>
<li class="toctree-l3"><a class="reference internal" href="fuse.html">FUSE</a></li>
<li class="toctree-l3"><a class="reference internal" href="fuse-io.html">Fuse I/O Modes</a></li>
<li class="toctree-l3"><a class="reference internal" href="inotify.html">Inotify - A Powerful yet Simple File Change Notification System</a></li>
<li class="toctree-l3"><a class="reference internal" href="isofs.html">ISO9660 Filesystem</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">NILFS2</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#caveats">Caveats</a></li>
<li class="toctree-l4"><a class="reference internal" href="#mount-options">Mount options</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ioctls">Ioctls</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nilfs2-usage">NILFS2 usage</a></li>
<li class="toctree-l4"><a class="reference internal" href="#disk-format">Disk format</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="nfs/index.html">NFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="ntfs.html">The Linux NTFS filesystem driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="ntfs3.html">NTFS3</a></li>
<li class="toctree-l3"><a class="reference internal" href="ocfs2.html">OCFS2 filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="ocfs2-online-filecheck.html">OCFS2 file system - online file check</a></li>
<li class="toctree-l3"><a class="reference internal" href="omfs.html">Optimized MPEG Filesystem (OMFS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="orangefs.html">ORANGEFS</a></li>
<li class="toctree-l3"><a class="reference internal" href="overlayfs.html">Overlay Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="proc.html">The /proc Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="qnx6.html">The QNX6 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="ramfs-rootfs-initramfs.html">Ramfs, rootfs and initramfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="relay.html">relay interface (formerly relayfs)</a></li>
<li class="toctree-l3"><a class="reference internal" href="romfs.html">ROMFS - ROM File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="spufs/index.html">SPU Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="squashfs.html">Squashfs 4.0 Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="sysfs.html">sysfs - _The_ filesystem for exporting kernel objects</a></li>
<li class="toctree-l3"><a class="reference internal" href="sysv-fs.html">SystemV Filesystem</a></li>
<li class="toctree-l3"><a class="reference internal" href="tmpfs.html">Tmpfs</a></li>
<li class="toctree-l3"><a class="reference internal" href="ubifs.html">UBI File System</a></li>
<li class="toctree-l3"><a class="reference internal" href="ubifs-authentication.html">UBIFS Authentication Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="udf.html">UDF file system</a></li>
<li class="toctree-l3"><a class="reference internal" href="virtiofs.html">virtiofs: virtio-fs host&lt;-&gt;guest shared file system</a></li>
<li class="toctree-l3"><a class="reference internal" href="vfat.html">VFAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="xfs-delayed-logging-design.html">XFS Delayed Logging Design</a></li>
<li class="toctree-l3"><a class="reference internal" href="xfs-self-describing-metadata.html">XFS Self Describing Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="zonefs.html">ZoneFS - Zone filesystem for Zoned block devices</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Filesystems in the Linux kernel</a> &raquo;</li>
        
      <li>NILFS2</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/filesystems/nilfs2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="nilfs2">
<h1>NILFS2<a class="headerlink" href="#nilfs2" title="Permalink to this headline">¶</a></h1>
<p>NILFS2 is a log-structured file system (LFS) supporting continuous
snapshotting.  In addition to versioning capability of the entire file
system, users can even restore files mistakenly overwritten or
destroyed just a few seconds ago.  Since NILFS2 can keep consistency
like conventional LFS, it achieves quick recovery after system
crashes.</p>
<p>NILFS2 creates a number of checkpoints every few seconds or per
synchronous write basis (unless there is no change).  Users can select
significant versions among continuously created checkpoints, and can
change them into snapshots which will be preserved until they are
changed back to checkpoints.</p>
<p>There is no limit on the number of snapshots until the volume gets
full.  Each snapshot is mountable as a read-only file system
concurrently with its writable mount, and this feature is convenient
for online backup.</p>
<p>The userland tools are included in nilfs-utils package, which is
available from the following download page.  At least “mkfs.nilfs2”,
“mount.nilfs2”, “umount.nilfs2”, and “nilfs_cleanerd” (so called
cleaner or garbage collector) are required.  Details on the tools are
described in the man pages included in the package.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name" colspan="2">Project web page:</th></tr>
<tr class="field-odd field"><td>&#160;</td><td class="field-body"><a class="reference external" href="https://nilfs.sourceforge.io/">https://nilfs.sourceforge.io/</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Download page:</th><td class="field-body"><a class="reference external" href="https://nilfs.sourceforge.io/en/download.html">https://nilfs.sourceforge.io/en/download.html</a></td>
</tr>
<tr class="field-odd field"><th class="field-name">List info:</th><td class="field-body"><a class="reference external" href="http://vger.kernel.org/vger-lists.html#linux-nilfs">http://vger.kernel.org/vger-lists.html#linux-nilfs</a></td>
</tr>
</tbody>
</table>
<div class="section" id="caveats">
<h2>Caveats<a class="headerlink" href="#caveats" title="Permalink to this headline">¶</a></h2>
<p>Features which NILFS2 does not support yet:</p>
<blockquote>
<div><ul class="simple">
<li>atime</li>
<li>extended attributes</li>
<li>POSIX ACLs</li>
<li>quotas</li>
<li>fsck</li>
<li>defragmentation</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="mount-options">
<h2>Mount options<a class="headerlink" href="#mount-options" title="Permalink to this headline">¶</a></h2>
<p>NILFS2 supports the following mount options:
(*) == default</p>
<table border="1" class="docutils">
<colgroup>
<col width="29%" />
<col width="71%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>barrier(*)</td>
<td>This enables/disables the use of write barriers.  This</td>
</tr>
<tr class="row-even"><td>nobarrier</td>
<td>requires an IO stack which can support barriers, and
if nilfs gets an error on a barrier write, it will
disable again with a warning.</td>
</tr>
<tr class="row-odd"><td>errors=continue</td>
<td>Keep going on a filesystem error.</td>
</tr>
<tr class="row-even"><td>errors=remount-ro(*)</td>
<td>Remount the filesystem read-only on an error.</td>
</tr>
<tr class="row-odd"><td>errors=panic</td>
<td>Panic and halt the machine if an error occurs.</td>
</tr>
<tr class="row-even"><td>cp=n</td>
<td>Specify the checkpoint-number of the snapshot to be
mounted.  Checkpoints and snapshots are listed by lscp
user command.  Only the checkpoints marked as snapshot
are mountable with this option.  Snapshot is read-only,
so a read-only mount option must be specified together.</td>
</tr>
<tr class="row-odd"><td>order=relaxed(*)</td>
<td>Apply relaxed order semantics that allows modified data
blocks to be written to disk without making a
checkpoint if no metadata update is going.  This mode
is equivalent to the ordered data mode of the ext3
filesystem except for the updates on data blocks still
conserve atomicity.  This will improve synchronous
write performance for overwriting.</td>
</tr>
<tr class="row-even"><td>order=strict</td>
<td>Apply strict in-order semantics that preserves sequence
of all file operations including overwriting of data
blocks.  That means, it is guaranteed that no
overtaking of events occurs in the recovered file
system after a crash.</td>
</tr>
<tr class="row-odd"><td>norecovery</td>
<td>Disable recovery of the filesystem on mount.
This disables every write access on the device for
read-only mounts or snapshots.  This option will fail
for r/w mounts on an unclean volume.</td>
</tr>
<tr class="row-even"><td>discard</td>
<td>This enables/disables the use of discard/TRIM commands.</td>
</tr>
<tr class="row-odd"><td>nodiscard(*)</td>
<td>The discard/TRIM commands are sent to the underlying
block device when blocks are freed.  This is useful
for SSD devices and sparse/thinly-provisioned LUNs.</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="ioctls">
<h2>Ioctls<a class="headerlink" href="#ioctls" title="Permalink to this headline">¶</a></h2>
<p>There is some NILFS2 specific functionality which can be accessed by applications
through the system call interfaces. The list of all NILFS2 specific ioctls are
shown in the table below.</p>
<p>Table of NILFS2 specific ioctls:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="39%" />
<col width="61%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Ioctl</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>NILFS_IOCTL_CHANGE_CPMODE</td>
<td>Change mode of given checkpoint between
checkpoint and snapshot state. This ioctl is
used in chcp and mkcp utilities.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_DELETE_CHECKPOINT</td>
<td>Remove checkpoint from NILFS2 file system.
This ioctl is used in rmcp utility.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_GET_CPINFO</td>
<td>Return info about requested checkpoints. This
ioctl is used in lscp utility and by
nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_GET_CPSTAT</td>
<td>Return checkpoints statistics. This ioctl is
used by lscp, rmcp utilities and by
nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_GET_SUINFO</td>
<td>Return segment usage info about requested
segments. This ioctl is used in lssu,
nilfs_resize utilities and by nilfs_cleanerd
daemon.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_SET_SUINFO</td>
<td>Modify segment usage info of requested
segments. This ioctl is used by
nilfs_cleanerd daemon to skip unnecessary
cleaning operation of segments and reduce
performance penalty or wear of flash device
due to redundant move of in-use blocks.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_GET_SUSTAT</td>
<td>Return segment usage statistics. This ioctl
is used in lssu, nilfs_resize utilities and
by nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_GET_VINFO</td>
<td>Return information on virtual block addresses.
This ioctl is used by nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_GET_BDESCS</td>
<td>Return information about descriptors of disk
block numbers. This ioctl is used by
nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_CLEAN_SEGMENTS</td>
<td>Do garbage collection operation in the
environment of requested parameters from
userspace. This ioctl is used by
nilfs_cleanerd daemon.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_SYNC</td>
<td>Make a checkpoint. This ioctl is used in
mkcp utility.</td>
</tr>
<tr class="row-odd"><td>NILFS_IOCTL_RESIZE</td>
<td>Resize NILFS2 volume. This ioctl is used
by nilfs_resize utility.</td>
</tr>
<tr class="row-even"><td>NILFS_IOCTL_SET_ALLOC_RANGE</td>
<td>Define lower limit of segments in bytes and
upper limit of segments in bytes. This ioctl
is used by nilfs_resize utility.</td>
</tr>
</tbody>
</table>
</div></blockquote>
</div>
<div class="section" id="nilfs2-usage">
<h2>NILFS2 usage<a class="headerlink" href="#nilfs2-usage" title="Permalink to this headline">¶</a></h2>
<p>To use nilfs2 as a local file system, simply:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mkfs -t nilfs2 /dev/block_device
# mount -t nilfs2 /dev/block_device /dir
</pre></div>
</div>
<p>This will also invoke the cleaner through the mount helper program
(mount.nilfs2).</p>
<p>Checkpoints and snapshots are managed by the following commands.
Their manpages are included in the nilfs-utils package above.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="6%" />
<col width="94%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>lscp</td>
<td>list checkpoints or snapshots.</td>
</tr>
<tr class="row-even"><td>mkcp</td>
<td>make a checkpoint or a snapshot.</td>
</tr>
<tr class="row-odd"><td>chcp</td>
<td>change an existing checkpoint to a snapshot or vice versa.</td>
</tr>
<tr class="row-even"><td>rmcp</td>
<td>invalidate specified checkpoint(s).</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>To mount a snapshot:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># mount -t nilfs2 -r -o cp=&lt;cno&gt; /dev/block_device /snap_dir
</pre></div>
</div>
<p>where &lt;cno&gt; is the checkpoint number of the snapshot.</p>
<p>To unmount the NILFS2 mount point or snapshot, simply:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span># umount /dir
</pre></div>
</div>
<p>Then, the cleaner daemon is automatically shut down by the umount
helper program (umount.nilfs2).</p>
</div>
<div class="section" id="disk-format">
<h2>Disk format<a class="headerlink" href="#disk-format" title="Permalink to this headline">¶</a></h2>
<p>A nilfs2 volume is equally divided into a number of segments except
for the super block (SB) and segment #0.  A segment is the container
of logs.  Each log is composed of summary information blocks, payload
blocks, and an optional super root block (SR):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> ______________________________________________________
| |SB| | Segment | Segment | Segment | ... | Segment | |
|_|__|_|____0____|____1____|____2____|_____|____N____|_|
0 +1K +4K       +8M       +16M      +24M  +(8MB x N)
     .             .            (Typical offsets for 4KB-block)
  .                  .
.______________________.
| log | log |... | log |
|__1__|__2__|____|__m__|
      .       .
    .               .
  .                       .
.______________________________.
| Summary | Payload blocks  |SR|
|_blocks__|_________________|__|
</pre></div>
</div>
<p>The payload blocks are organized per file, and each file consists of
data blocks and B-tree node blocks:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> |&lt;---       File-A        ---&gt;|&lt;---       File-B        ---&gt;|
_______________________________________________________________
 | Data blocks | B-tree blocks | Data blocks | B-tree blocks | ...
_|_____________|_______________|_____________|_______________|_
</pre></div>
</div>
<p>Since only the modified blocks are written in the log, it may have
files without data blocks or B-tree node blocks.</p>
<p>The organization of the blocks is recorded in the summary information
blocks, which contains a header structure (nilfs_segment_summary), per
file structures (nilfs_finfo), and per block structures (nilfs_binfo):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> _________________________________________________________________________
| Summary | finfo | binfo | ... | binfo | finfo | binfo | ... | binfo |...
|_blocks__|___A___|_(A,1)_|_____|(A,Na)_|___B___|_(B,1)_|_____|(B,Nb)_|___
</pre></div>
</div>
<p>The logs include regular files, directory files, symbolic link files
and several meta data files.  The mata data files are the files used
to maintain file system meta data.  The current version of NILFS2 uses
the following meta data files:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1) Inode file (ifile)             -- Stores on-disk inodes
2) Checkpoint file (cpfile)       -- Stores checkpoints
3) Segment usage file (sufile)    -- Stores allocation state of segments
4) Data address translation file  -- Maps virtual block numbers to usual
   (DAT)                             block numbers.  This file serves to
                                     make on-disk blocks relocatable.
</pre></div>
</div>
<p>The following figure shows a typical organization of the logs:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span> _________________________________________________________________________
| Summary | regular file | file  | ... | ifile | cpfile | sufile | DAT |SR|
|_blocks__|_or_directory_|_______|_____|_______|________|________|_____|__|
</pre></div>
</div>
<p>To stride over segment boundaries, this sequence of files may be split
into multiple logs.  The sequence of logs that should be treated as
logically one log, is delimited with flags marked in the segment
summary.  The recovery code of nilfs2 looks this boundary information
to ensure atomicity of updates.</p>
<p>The super root block is inserted for every checkpoints.  It includes
three special inodes, inodes for the DAT, cpfile, and sufile.  Inodes
of regular files, directories, symlinks and other special files, are
included in the ifile.  The inode of ifile itself is included in the
corresponding checkpoint entry in the cpfile.  Thus, the hierarchy
among NILFS2 files can be depicted as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Super block (SB)
     |
     v
Super root block (the latest cno=xx)
     |-- DAT
     |-- sufile
     `-- cpfile
            |-- ifile (cno=c1)
            |-- ifile (cno=c2) ---- file (ino=i1)
            :        :          |-- file (ino=i2)
            `-- ifile (cno=xx)  |-- file (ino=i3)
                                :        :
                                `-- file (ino=yy)
                                  ( regular file, directory, or symlink )
</pre></div>
</div>
<p>For detail on the format of each file, please see nilfs2_ondisk.h
located at include/uapi/linux directory.</p>
<p>There are no patents or other intellectual property that we protect
with regard to the design of NILFS2.  It is allowed to replicate the
design in hopes that other operating systems could share (mount, read,
write, etc.) data stored in this format.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="nfs/index.html" class="btn btn-neutral float-right" title="NFS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="isofs.html" class="btn btn-neutral" title="ISO9660 Filesystem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>