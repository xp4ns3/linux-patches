

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fprobe - Function entry/exit probe &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Tracing Technologies" href="index.html"/>
        <link rel="next" title="Kernel Probes (Kprobes)" href="kprobes.html"/>
        <link rel="prev" title="Using ftrace to hook to functions" href="ftrace-uses.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Tracing Technologies</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ftrace-design.html">Function Tracer Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracepoint-analysis.html">Notes on Analysing Behaviour Using Events and Tracepoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="ftrace.html">ftrace - Function Tracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="ftrace-uses.html">Using ftrace to hook to functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fprobe - Function entry/exit probe</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-usage-of-fprobe">The usage of fprobe</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-fprobe-entry-exit-handler">The fprobe entry/exit handler</a></li>
<li class="toctree-l3"><a class="reference internal" href="#share-the-callbacks-with-kprobes">Share the callbacks with kprobes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-missed-counter">The missed counter</a></li>
<li class="toctree-l3"><a class="reference internal" href="#functions-and-structures">Functions and structures</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="kprobes.html">Kernel Probes (Kprobes)</a></li>
<li class="toctree-l2"><a class="reference internal" href="kprobetrace.html">Kprobe-based Event Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="uprobetracer.html">Uprobe-tracer: Uprobe-based Event Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="tracepoints.html">Using the Linux Kernel Tracepoints</a></li>
<li class="toctree-l2"><a class="reference internal" href="events.html">Event Tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="events-kmem.html">Subsystem Trace Points: kmem</a></li>
<li class="toctree-l2"><a class="reference internal" href="events-power.html">Subsystem Trace Points: power</a></li>
<li class="toctree-l2"><a class="reference internal" href="events-nmi.html">NMI Trace Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="events-msr.html">MSR Trace Events</a></li>
<li class="toctree-l2"><a class="reference internal" href="mmiotrace.html">In-kernel memory-mapped I/O tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="histogram.html">Event Histograms</a></li>
<li class="toctree-l2"><a class="reference internal" href="histogram-design.html">Histogram Design Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="boottime-trace.html">Boot-time tracing</a></li>
<li class="toctree-l2"><a class="reference internal" href="hwlat_detector.html">Hardware Latency Detector</a></li>
<li class="toctree-l2"><a class="reference internal" href="osnoise-tracer.html">OSNOISE Tracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="timerlat-tracer.html">Timerlat tracer</a></li>
<li class="toctree-l2"><a class="reference internal" href="intel_th.html">Intel(R) Trace Hub (TH)</a></li>
<li class="toctree-l2"><a class="reference internal" href="ring-buffer-design.html">Lockless Ring Buffer Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="stm.html">System Trace Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="sys-t.html">MIPI SyS-T over STP</a></li>
<li class="toctree-l2"><a class="reference internal" href="coresight/index.html">CoreSight - ARM Hardware Trace</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_events.html">user_events: User-based Event Tracing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Tracing Technologies</a> &raquo;</li>
        
      <li>Fprobe - Function entry/exit probe</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/trace/fprobe.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fprobe-function-entry-exit-probe">
<h1>Fprobe - Function entry/exit probe<a class="headerlink" href="#fprobe-function-entry-exit-probe" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Fprobe is a function entry/exit probe mechanism based on ftrace.
Instead of using ftrace full feature, if you only want to attach callbacks
on function entry and exit, similar to the kprobes and kretprobes, you can
use fprobe. Compared with kprobes and kretprobes, fprobe gives faster
instrumentation for multiple functions with single handler. This document
describes how to use fprobe.</p>
</div>
<div class="section" id="the-usage-of-fprobe">
<h2>The usage of fprobe<a class="headerlink" href="#the-usage-of-fprobe" title="Permalink to this headline">¶</a></h2>
<p>The fprobe is a wrapper of ftrace (+ kretprobe-like return callback) to
attach callbacks to multiple function entry and exit. User needs to set up
the <cite><a class="reference internal" href="#c.fprobe" title="fprobe"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span></code></a></cite> and pass it to <cite><a class="reference internal" href="#c.register_fprobe" title="register_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe()</span></code></a></cite>.</p>
<p>Typically, <cite>fprobe</cite> data structure is initialized with the <cite>entry_handler</cite>
and/or <cite>exit_handler</cite> as below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">fprobe</span> <span class="n">fp</span> <span class="o">=</span> <span class="p">{</span>
       <span class="p">.</span><span class="n">entry_handler</span>  <span class="o">=</span> <span class="n">my_entry_callback</span><span class="p">,</span>
       <span class="p">.</span><span class="n">exit_handler</span>   <span class="o">=</span> <span class="n">my_exit_callback</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>To enable the fprobe, call one of <a class="reference internal" href="#c.register_fprobe" title="register_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe()</span></code></a>, <a class="reference internal" href="#c.register_fprobe_ips" title="register_fprobe_ips"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe_ips()</span></code></a>, and
<a class="reference internal" href="#c.register_fprobe_syms" title="register_fprobe_syms"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe_syms()</span></code></a>. These functions register the fprobe with different types
of parameters.</p>
<p>The <a class="reference internal" href="#c.register_fprobe" title="register_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe()</span></code></a> enables a fprobe by function-name filters.
E.g. this enables &#64;fp on “func*()” function except “func2()”.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>register_fprobe(&amp;fp, &quot;func*&quot;, &quot;func2&quot;);
</pre></div>
</div>
<p>The <a class="reference internal" href="#c.register_fprobe_ips" title="register_fprobe_ips"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe_ips()</span></code></a> enables a fprobe by ftrace-location addresses.
E.g.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ips</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="n">x</span><span class="p">....</span> <span class="p">};</span>

<span class="n">register_fprobe_ips</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="p">,</span> <span class="n">ips</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ips</span><span class="p">));</span>
</pre></div>
</div>
<p>And the <a class="reference internal" href="#c.register_fprobe_syms" title="register_fprobe_syms"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe_syms()</span></code></a> enables a fprobe by symbol names.
E.g.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span> <span class="n">syms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;func1&quot;</span><span class="p">,</span> <span class="s">&quot;func2&quot;</span><span class="p">,</span> <span class="s">&quot;func3&quot;</span><span class="p">};</span>

<span class="n">register_fprobe_syms</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fp</span><span class="p">,</span> <span class="n">syms</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">syms</span><span class="p">));</span>
</pre></div>
</div>
<p>To disable (remove from functions) this fprobe, call:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>unregister_fprobe(&amp;fp);
</pre></div>
</div>
<p>You can temporally (soft) disable the fprobe by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>disable_fprobe(&amp;fp);
</pre></div>
</div>
<p>and resume by:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>enable_fprobe(&amp;fp);
</pre></div>
</div>
<p>The above is defined by including the header:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>#include &lt;linux/fprobe.h&gt;
</pre></div>
</div>
<p>Same as ftrace, the registered callbacks will start being called some time
after the <a class="reference internal" href="#c.register_fprobe" title="register_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">register_fprobe()</span></code></a> is called and before it returns. See
<code class="file docutils literal notranslate"><span class="pre">Documentation/trace/ftrace.rst</span></code>.</p>
<p>Also, the <a class="reference internal" href="#c.unregister_fprobe" title="unregister_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">unregister_fprobe()</span></code></a> will guarantee that the both enter and exit
handlers are no longer being called by functions after <a class="reference internal" href="#c.unregister_fprobe" title="unregister_fprobe"><code class="xref c c-func docutils literal notranslate"><span class="pre">unregister_fprobe()</span></code></a>
returns as same as unregister_ftrace_function().</p>
</div>
<div class="section" id="the-fprobe-entry-exit-handler">
<h2>The fprobe entry/exit handler<a class="headerlink" href="#the-fprobe-entry-exit-handler" title="Permalink to this headline">¶</a></h2>
<p>The prototype of the entry/exit callback function is as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">callback_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">fprobe</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">entry_ip</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">);</span>
</pre></div>
</div>
<p>Note that both entry and exit callbacks have same ptototype. The &#64;entry_ip is
saved at function entry and passed to exit handler.</p>
<dl class="docutils">
<dt>&#64;fp</dt>
<dd>This is the address of <cite>fprobe</cite> data structure related to this handler.
You can embed the <cite>fprobe</cite> to your data structure and get it by
container_of() macro from &#64;fp. The &#64;fp must not be NULL.</dd>
<dt>&#64;entry_ip</dt>
<dd>This is the ftrace address of the traced function (both entry and exit).
Note that this may not be the actual entry address of the function but
the address where the ftrace is instrumented.</dd>
<dt>&#64;regs</dt>
<dd>This is the <cite>pt_regs</cite> data structure at the entry and exit. Note that
the instruction pointer of &#64;regs may be different from the &#64;entry_ip
in the entry_handler. If you need traced instruction pointer, you need
to use &#64;entry_ip. On the other hand, in the exit_handler, the instruction
pointer of &#64;regs is set to the currect return address.</dd>
</dl>
</div>
<div class="section" id="share-the-callbacks-with-kprobes">
<h2>Share the callbacks with kprobes<a class="headerlink" href="#share-the-callbacks-with-kprobes" title="Permalink to this headline">¶</a></h2>
<p>Since the recursion safeness of the fprobe (and ftrace) is a bit different
from the kprobes, this may cause an issue if user wants to run the same
code from the fprobe and the kprobes.</p>
<p>Kprobes has per-cpu ‘current_kprobe’ variable which protects the kprobe
handler from recursion in all cases. On the other hand, fprobe uses
only ftrace_test_recursion_trylock(). This allows interrupt context to
call another (or same) fprobe while the fprobe user handler is running.</p>
<p>This is not a matter if the common callback code has its own recursion
detection, or it can handle the recursion in the different contexts
(normal/interrupt/NMI.)
But if it relies on the ‘current_kprobe’ recursion lock, it has to check
kprobe_running() and use kprobe_busy_*() APIs.</p>
<p>Fprobe has FPROBE_FL_KPROBE_SHARED flag to do this. If your common callback
code will be shared with kprobes, please set FPROBE_FL_KPROBE_SHARED
<em>before</em> registering the fprobe, like:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">fprobe</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FPROBE_FL_KPROBE_SHARED</span><span class="p">;</span>

<span class="n">register_fprobe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fprobe</span><span class="p">,</span> <span class="s">&quot;func*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</pre></div>
</div>
<p>This will protect your common callback from the nested call.</p>
</div>
<div class="section" id="the-missed-counter">
<h2>The missed counter<a class="headerlink" href="#the-missed-counter" title="Permalink to this headline">¶</a></h2>
<p>The <cite>fprobe</cite> data structure has <cite>fprobe::nmissed</cite> counter field as same as
kprobes.
This counter counts up when;</p>
<blockquote>
<div><ul class="simple">
<li>fprobe fails to take ftrace_recursion lock. This usually means that a function
which is traced by other ftrace users is called from the entry_handler.</li>
<li>fprobe fails to setup the function exit because of the shortage of rethook
(the shadow stack for hooking the function return.)</li>
</ul>
</div></blockquote>
<p>The <cite>fprobe::nmissed</cite> field counts up in both cases. Therefore, the former
skips both of entry and exit callback and the latter skips the exit
callback, but in both case the counter will increase by 1.</p>
<p>Note that if you set the FTRACE_OPS_FL_RECURSION and/or FTRACE_OPS_FL_RCU to
<cite>fprobe::ops::flags</cite> (ftrace_ops::flags) when registering the fprobe, this
counter may not work correctly, because ftrace skips the fprobe function which
increase the counter.</p>
</div>
<div class="section" id="functions-and-structures">
<h2>Functions and structures<a class="headerlink" href="#functions-and-structures" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.fprobe">
struct <code class="descname">fprobe</code><a class="headerlink" href="#c.fprobe" title="Permalink to this definition">¶</a></dt>
<dd><p>ftrace based probe.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct fprobe {
#ifdef CONFIG_FUNCTION_TRACER;
  struct ftrace_ops       ops;
#endif;
  unsigned long           nmissed;
  unsigned int            flags;
  struct rethook          *rethook;
  void (*entry_handler)(struct fprobe *fp, unsigned long entry_ip, struct pt_regs *regs);
  void (*exit_handler)(struct fprobe *fp, unsigned long entry_ip, struct pt_regs *regs);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">ops</span></code></dt>
<dd>The ftrace_ops.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">nmissed</span></code></dt>
<dd>The counter for missing events.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt>
<dd>The status flag.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rethook</span></code></dt>
<dd>The rethook data structure. (internal data)</dd>
<dt><code class="docutils literal notranslate"><span class="pre">entry_handler</span></code></dt>
<dd>The callback function for function entry.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">exit_handler</span></code></dt>
<dd>The callback function for function exit.</dd>
</dl>
<dl class="function">
<dt id="c.disable_fprobe">
void <code class="descname">disable_fprobe</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em><span class="sig-paren">)</span><a class="headerlink" href="#c.disable_fprobe" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable fprobe</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>The fprobe to be disabled.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This will soft-disable <strong>fp</strong>. Note that this doesn’t remove the ftrace
hooks from the function entry.</p>
<dl class="function">
<dt id="c.enable_fprobe">
void <code class="descname">enable_fprobe</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em><span class="sig-paren">)</span><a class="headerlink" href="#c.enable_fprobe" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable fprobe</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>The fprobe to be enabled.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This will soft-enable <strong>fp</strong>.</p>
<dl class="function">
<dt id="c.register_fprobe">
int <code class="descname">register_fprobe</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em>, const char<em>&nbsp;*filter</em>, const char<em>&nbsp;*notfilter</em><span class="sig-paren">)</span><a class="headerlink" href="#c.register_fprobe" title="Permalink to this definition">¶</a></dt>
<dd><p>Register fprobe to ftrace by pattern.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>A fprobe data structure to be registered.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*filter</span></code></dt>
<dd>A wildcard pattern of probed symbols.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">*notfilter</span></code></dt>
<dd>A wildcard pattern of NOT probed symbols.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Register <strong>fp</strong> to ftrace for enabling the probe on the symbols matched to <strong>filter</strong>.
If <strong>notfilter</strong> is not NULL, the symbols matched the <strong>notfilter</strong> are not probed.</p>
<p>Return 0 if <strong>fp</strong> is registered successfully, -errno if not.</p>
<dl class="function">
<dt id="c.register_fprobe_ips">
int <code class="descname">register_fprobe_ips</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em>, unsigned long<em>&nbsp;*addrs</em>, int<em>&nbsp;num</em><span class="sig-paren">)</span><a class="headerlink" href="#c.register_fprobe_ips" title="Permalink to this definition">¶</a></dt>
<dd><p>Register fprobe to ftrace by address.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>A fprobe data structure to be registered.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">*addrs</span></code></dt>
<dd>An array of target ftrace location addresses.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">num</span></code></dt>
<dd>The number of entries of <strong>addrs</strong>.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Register <strong>fp</strong> to ftrace for enabling the probe on the address given by <strong>addrs</strong>.
The <strong>addrs</strong> must be the addresses of ftrace location address, which may be
the symbol address + arch-dependent offset.
If you unsure what this mean, please use other registration functions.</p>
<p>Return 0 if <strong>fp</strong> is registered successfully, -errno if not.</p>
<dl class="function">
<dt id="c.register_fprobe_syms">
int <code class="descname">register_fprobe_syms</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em>, const char<em>&nbsp;**syms</em>, int<em>&nbsp;num</em><span class="sig-paren">)</span><a class="headerlink" href="#c.register_fprobe_syms" title="Permalink to this definition">¶</a></dt>
<dd><p>Register fprobe to ftrace by symbols.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>A fprobe data structure to be registered.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">char</span> <span class="pre">**syms</span></code></dt>
<dd>An array of target symbols.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">num</span></code></dt>
<dd>The number of entries of <strong>syms</strong>.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Register <strong>fp</strong> to the symbols given by <strong>syms</strong> array. This will be useful if
you are sure the symbols exist in the kernel.</p>
<p>Return 0 if <strong>fp</strong> is registered successfully, -errno if not.</p>
<dl class="function">
<dt id="c.unregister_fprobe">
int <code class="descname">unregister_fprobe</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.fprobe" title="fprobe">fprobe</a><em>&nbsp;*fp</em><span class="sig-paren">)</span><a class="headerlink" href="#c.unregister_fprobe" title="Permalink to this definition">¶</a></dt>
<dd><p>Unregister fprobe from ftrace</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">fprobe</span> <span class="pre">*fp</span></code></dt>
<dd>A fprobe data structure to be unregistered.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Unregister fprobe (and remove ftrace hooks from the function entries).</p>
<p>Return 0 if <strong>fp</strong> is unregistered successfully, -errno if not.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="kprobes.html" class="btn btn-neutral float-right" title="Kernel Probes (Kprobes)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="ftrace-uses.html" class="btn btn-neutral" title="Using ftrace to hook to functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>