

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Fast &amp; Portable DES encryption &amp; decryption &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Kernel Crypto API" href="index.html"/>
        <link rel="next" title="Filesystems in the Linux kernel" href="../filesystems/index.html"/>
        <link rel="prev" title="Code Examples" href="api-samples.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Kernel Crypto API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="intro.html">Kernel Crypto API Interface Specification</a></li>
<li class="toctree-l2"><a class="reference internal" href="api-intro.html">Scatterlist Cryptographic API</a></li>
<li class="toctree-l2"><a class="reference internal" href="architecture.html">Kernel Crypto API Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="async-tx-api.html">Asynchronous Transfers/Transforms API</a></li>
<li class="toctree-l2"><a class="reference internal" href="asymmetric-keys.html">Asymmetric / Public-key Cryptography Key Type</a></li>
<li class="toctree-l2"><a class="reference internal" href="devel-algos.html">Developing Cipher Algorithms</a></li>
<li class="toctree-l2"><a class="reference internal" href="userspace-if.html">User Space Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="crypto_engine.html">Crypto Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="api.html">Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="api-samples.html">Code Examples</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Fast &amp; Portable DES encryption &amp; decryption</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#motivation-and-history">motivation and history</a></li>
<li class="toctree-l3"><a class="reference internal" href="#porting-notes">porting notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optional-performance-optimizations">OPTIONAL performance optimizations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#coding-notes">coding notes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#special-efficient-data-format">special efficient data format</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-it-to-compile-on-your-machine">Getting it to compile on your machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#speeding-up-kerberos-and-or-its-des-library">Speeding up kerberos (and/or its des library)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#other-uses">Other uses</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Kernel Crypto API</a> &raquo;</li>
        
      <li>Fast &amp; Portable DES encryption &amp; decryption</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/crypto/descore-readme.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="fast-portable-des-encryption-decryption">
<h1>Fast &amp; Portable DES encryption &amp; decryption<a class="headerlink" href="#fast-portable-des-encryption-decryption" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Below is the original README file from the descore.shar package,
converted to ReST format.</p>
</div>
<hr class="docutils" />
<p>des - fast &amp; portable DES encryption &amp; decryption.</p>
<p>Copyright © 1992  Dana L. How</p>
<p>This program is free software; you can redistribute it and/or modify
it under the terms of the GNU Library General Public License as published by
the Free Software Foundation; either version 2 of the License, or
(at your option) any later version.</p>
<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Library General Public License for more details.</p>
<p>You should have received a copy of the GNU Library General Public License
along with this program; if not, write to the Free Software
Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</p>
<p>Author’s address: <a class="reference external" href="mailto:how&#37;&#52;&#48;isl&#46;stanford&#46;edu">how<span>&#64;</span>isl<span>&#46;</span>stanford<span>&#46;</span>edu</a></p>
<p>==&gt;&gt; To compile after untarring/unsharring, just <code class="docutils literal notranslate"><span class="pre">make</span></code> &lt;&lt;==</p>
<p>This package was designed with the following goals:</p>
<ol class="arabic simple">
<li>Highest possible encryption/decryption PERFORMANCE.</li>
<li>PORTABILITY to any byte-addressable host with a 32bit unsigned C type</li>
<li>Plug-compatible replacement for KERBEROS’s low-level routines.</li>
</ol>
<p>This second release includes a number of performance enhancements for
register-starved machines.  My discussions with Richard Outerbridge,
<a class="reference external" href="mailto:71755&#46;204&#37;&#52;&#48;compuserve&#46;com">71755<span>&#46;</span>204<span>&#64;</span>compuserve<span>&#46;</span>com</a>, sparked a number of these enhancements.</p>
<p>To more rapidly understand the code in this package, inspect desSmallFips.i
(created by typing <code class="docutils literal notranslate"><span class="pre">make</span></code>) BEFORE you tackle desCode.h.  The latter is set
up in a parameterized fashion so it can easily be modified by speed-daemon
hackers in pursuit of that last microsecond.  You will find it more
illuminating to inspect one specific implementation,
and then move on to the common abstract skeleton with this one in mind.</p>
<p>performance comparison to other available des code which i could
compile on a SPARCStation 1 (cc -O4, gcc -O2):</p>
<p>this code (byte-order independent):</p>
<blockquote>
<div><ul>
<li><p class="first">30us per encryption (options: 64k tables, no IP/FP)</p>
</li>
<li><p class="first">33us per encryption (options: 64k tables, FIPS standard bit ordering)</p>
</li>
<li><p class="first">45us per encryption (options:  2k tables, no IP/FP)</p>
</li>
<li><p class="first">48us per encryption (options:  2k tables, FIPS standard bit ordering)</p>
</li>
<li><p class="first">275us to set a new key (uses 1k of key tables)</p>
<blockquote>
<div><p>this has the quickest encryption/decryption routines i’ve seen.
since i was interested in fast des filters rather than crypt(3)
and password cracking, i haven’t really bothered yet to speed up
the key setting routine. also, i have no interest in re-implementing
all the other junk in the mit kerberos des library, so i’ve just
provided my routines with little stub interfaces so they can be
used as drop-in replacements with mit’s code or any of the mit-
compatible packages below. (note that the first two timings above
are highly variable because of cache effects).</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>kerberos des replacement from australia (version 1.95):</p>
<blockquote>
<div><ul>
<li><p class="first">53us per encryption (uses 2k of tables)</p>
</li>
<li><p class="first">96us to set a new key (uses 2.25k of key tables)</p>
<blockquote>
<div><p>so despite the author’s inclusion of some of the performance
improvements i had suggested to him, this package’s
encryption/decryption is still slower on the sparc and 68000.
more specifically, 19-40% slower on the 68020 and 11-35% slower
on the sparc,  depending on the compiler;
in full gory detail (ALT_ECB is a libdes variant):</p>
<table border="1" class="docutils">
<colgroup>
<col width="25%" />
<col width="23%" />
<col width="25%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">compiler</th>
<th class="head">machine</th>
<th class="head">desCore libdes</th>
<th class="head">ALT_ECB slower by</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>gcc 2.1 -O2</td>
<td>Sun 3/110</td>
<td>304  uS 369.5uS</td>
<td>461.8uS  22%</td>
</tr>
<tr class="row-odd"><td>cc      -O1</td>
<td>Sun 3/110</td>
<td>336  uS 436.6uS</td>
<td>399.3uS  19%</td>
</tr>
<tr class="row-even"><td>cc      -O2</td>
<td>Sun 3/110</td>
<td>360  uS 532.4uS</td>
<td>505.1uS  40%</td>
</tr>
<tr class="row-odd"><td>cc      -O4</td>
<td>Sun 3/110</td>
<td>365  uS 532.3uS</td>
<td>505.3uS  38%</td>
</tr>
<tr class="row-even"><td>gcc 2.1 -O2</td>
<td>Sun 4/50</td>
<td>48  uS  53.4uS</td>
<td>57.5uS  11%</td>
</tr>
<tr class="row-odd"><td>cc      -O2</td>
<td>Sun 4/50</td>
<td>48  uS  64.6uS</td>
<td>64.7uS  35%</td>
</tr>
<tr class="row-even"><td>cc      -O4</td>
<td>Sun 4/50</td>
<td>48  uS  64.7uS</td>
<td>64.9uS  35%</td>
</tr>
</tbody>
</table>
<p>(my time measurements are not as accurate as his).</p>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><p>the comments in my first release of desCore on version 1.92:</p>
<ul>
<li><p class="first">68us per encryption (uses 2k of tables)</p>
</li>
<li><p class="first">96us to set a new key (uses 2.25k of key tables)</p>
<blockquote>
<div><p>this is a very nice package which implements the most important
of the optimizations which i did in my encryption routines.
it’s a bit weak on common low-level optimizations which is why
it’s 39%-106% slower.  because he was interested in fast crypt(3) and
password-cracking applications,  he also used the same ideas to
speed up the key-setting routines with impressive results.
(at some point i may do the same in my package).  he also implements
the rest of the mit des library.</p>
<p>(code from <a class="reference external" href="mailto:eay&#37;&#52;&#48;psych&#46;psy&#46;uq&#46;oz&#46;au">eay<span>&#64;</span>psych<span>&#46;</span>psy<span>&#46;</span>uq<span>&#46;</span>oz<span>&#46;</span>au</a> via comp.sources.misc)</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</div></blockquote>
<p>fast crypt(3) package from denmark:</p>
<blockquote>
<div><p>the des routine here is buried inside a loop to do the
crypt function and i didn’t feel like ripping it out and measuring
performance. his code takes 26 sparc instructions to compute one
des iteration; above, Quick (64k) takes 21 and Small (2k) takes 37.
he claims to use 280k of tables but the iteration calculation seems
to use only 128k.  his tables and code are machine independent.</p>
<p>(code from <a class="reference external" href="mailto:glad&#37;&#52;&#48;daimi&#46;aau&#46;dk">glad<span>&#64;</span>daimi<span>&#46;</span>aau<span>&#46;</span>dk</a> via alt.sources or comp.sources.misc)</p>
</div></blockquote>
<p>swedish reimplementation of Kerberos des library</p>
<blockquote>
<div><ul>
<li><p class="first">108us per encryption (uses 34k worth of tables)</p>
</li>
<li><p class="first">134us to set a new key (uses 32k of key tables to get this speed!)</p>
<blockquote>
<div><p>the tables used seem to be machine-independent;
he seems to have included a lot of special case code
so that, e.g., <code class="docutils literal notranslate"><span class="pre">long</span></code> loads can be used instead of 4 <code class="docutils literal notranslate"><span class="pre">char</span></code> loads
when the machine’s architecture allows it.</p>
<p>(code obtained from chalmers.se:pub/des)</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>crack 3.3c package from england:</p>
<blockquote>
<div><p>as in crypt above, the des routine is buried in a loop. it’s
also very modified for crypt.  his iteration code uses 16k
of tables and appears to be slow.</p>
<p>(code obtained from <a class="reference external" href="mailto:aem&#37;&#52;&#48;aber&#46;ac&#46;uk">aem<span>&#64;</span>aber<span>&#46;</span>ac<span>&#46;</span>uk</a> via alt.sources or comp.sources.misc)</p>
</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">highly</span> <span class="pre">optimized</span></code> and tweaked Kerberos/Athena code (byte-order dependent):</p>
<blockquote>
<div><ul>
<li><p class="first">165us per encryption (uses 6k worth of tables)</p>
</li>
<li><p class="first">478us to set a new key (uses &lt;1k of key tables)</p>
<blockquote>
<div><p>so despite the comments in this code, it was possible to get
faster code AND smaller tables, as well as making the tables
machine-independent.
(code obtained from prep.ai.mit.edu)</p>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<dl class="docutils">
<dt>UC Berkeley code (depends on machine-endedness):</dt>
<dd><ul class="first last">
<li><p class="first">226us per encryption</p>
</li>
<li><p class="first">10848us to set a new key</p>
<blockquote>
<div><p>table sizes are unclear, but they don’t look very small
(code obtained from wuarchive.wustl.edu)</p>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
<div class="section" id="motivation-and-history">
<h2>motivation and history<a class="headerlink" href="#motivation-and-history" title="Permalink to this headline">¶</a></h2>
<p>a while ago i wanted some des routines and the routines documented on sun’s
man pages either didn’t exist or dumped core.  i had heard of kerberos,
and knew that it used des,  so i figured i’d use its routines.  but once
i got it and looked at the code,  it really set off a lot of pet peeves -
it was too convoluted, the code had been written without taking
advantage of the regular structure of operations such as IP, E, and FP
(i.e. the author didn’t sit down and think before coding),
it was excessively slow,  the author had attempted to clarify the code
by adding MORE statements to make the data movement more <code class="docutils literal notranslate"><span class="pre">consistent</span></code>
instead of simplifying his implementation and cutting down on all data
movement (in particular, his use of L1, R1, L2, R2), and it was full of
idiotic <code class="docutils literal notranslate"><span class="pre">tweaks</span></code> for particular machines which failed to deliver significant
speedups but which did obfuscate everything.  so i took the test data
from his verification program and rewrote everything else.</p>
<p>a while later i ran across the great crypt(3) package mentioned above.
the fact that this guy was computing 2 sboxes per table lookup rather
than one (and using a MUCH larger table in the process) emboldened me to
do the same - it was a trivial change from which i had been scared away
by the larger table size.  in his case he didn’t realize you don’t need to keep
the working data in TWO forms, one for easy use of half the sboxes in
indexing, the other for easy use of the other half; instead you can keep
it in the form for the first half and use a simple rotate to get the other
half.  this means i have (almost) half the data manipulation and half
the table size.  in fairness though he might be encoding something particular
to crypt(3) in his tables - i didn’t check.</p>
<p>i’m glad that i implemented it the way i did, because this C version is
portable (the ifdef’s are performance enhancements) and it is faster
than versions hand-written in assembly for the sparc!</p>
</div>
<div class="section" id="porting-notes">
<h2>porting notes<a class="headerlink" href="#porting-notes" title="Permalink to this headline">¶</a></h2>
<p>one thing i did not want to do was write an enormous mess
which depended on endedness and other machine quirks,
and which necessarily produced different code and different lookup tables
for different machines.  see the kerberos code for an example
of what i didn’t want to do; all their endedness-specific <code class="docutils literal notranslate"><span class="pre">optimizations</span></code>
obfuscate the code and in the end were slower than a simpler machine
independent approach.  however, there are always some portability
considerations of some kind, and i have included some options
for varying numbers of register variables.
perhaps some will still regard the result as a mess!</p>
<ol class="arabic simple">
<li>i assume everything is byte addressable, although i don’t actually
depend on the byte order, and that bytes are 8 bits.
i assume word pointers can be freely cast to and from char pointers.
note that 99% of C programs make these assumptions.
i always use unsigned char’s if the high bit could be set.</li>
<li>the typedef <code class="docutils literal notranslate"><span class="pre">word</span></code> means a 32 bit unsigned integral type.
if <code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span></code> is not 32 bits, change the typedef in desCore.h.
i assume sizeof(word) == 4 EVERYWHERE.</li>
</ol>
<p>the (worst-case) cost of my NOT doing endedness-specific optimizations
in the data loading and storing code surrounding the key iterations
is less than 12%.  also, there is the added benefit that
the input and output work areas do not need to be word-aligned.</p>
</div>
<div class="section" id="optional-performance-optimizations">
<h2>OPTIONAL performance optimizations<a class="headerlink" href="#optional-performance-optimizations" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">you should define one of <code class="docutils literal notranslate"><span class="pre">i386,</span></code> <code class="docutils literal notranslate"><span class="pre">vax,</span></code> <code class="docutils literal notranslate"><span class="pre">mc68000,</span></code> or <code class="docutils literal notranslate"><span class="pre">sparc,</span></code>
whichever one is closest to the capabilities of your machine.
see the start of desCode.h to see exactly what this selection implies.
note that if you select the wrong one, the des code will still work;
these are just performance tweaks.</p>
</li>
<li><p class="first">for those with functional <code class="docutils literal notranslate"><span class="pre">asm</span></code> keywords: you should change the
ROR and ROL macros to use machine rotate instructions if you have them.
this will save 2 instructions and a temporary per use,
or about 32 to 40 instructions per en/decryption.</p>
<p>note that gcc is smart enough to translate the ROL/R macros into
machine rotates!</p>
</li>
</ol>
<p>these optimizations are all rather persnickety, yet with them you should
be able to get performance equal to assembly-coding, except that:</p>
<ol class="arabic">
<li><p class="first">with the lack of a bit rotate operator in C, rotates have to be synthesized
from shifts.  so access to <code class="docutils literal notranslate"><span class="pre">asm</span></code> will speed things up if your machine
has rotates, as explained above in (3) (not necessary if you use gcc).</p>
</li>
<li><p class="first">if your machine has less than 12 32-bit registers i doubt your compiler will
generate good code.</p>
<p><code class="docutils literal notranslate"><span class="pre">i386</span></code> tries to configure the code for a 386 by only declaring 3 registers
(it appears that gcc can use ebx, esi and edi to hold register variables).
however, if you like assembly coding, the 386 does have 7 32-bit registers,
and if you use ALL of them, use <code class="docutils literal notranslate"><span class="pre">scaled</span> <span class="pre">by</span> <span class="pre">8</span></code> address modes with displacement
and other tricks, you can get reasonable routines for DesQuickCore… with
about 250 instructions apiece.  For DesSmall… it will help to rearrange
des_keymap, i.e., now the sbox # is the high part of the index and
the 6 bits of data is the low part; it helps to exchange these.</p>
<p>since i have no way to conveniently test it i have not provided my
shoehorned 386 version.  note that with this release of desCore, gcc is able
to put everything in registers(!), and generate about 370 instructions apiece
for the DesQuickCore… routines!</p>
</li>
</ol>
</div>
<div class="section" id="coding-notes">
<h2>coding notes<a class="headerlink" href="#coding-notes" title="Permalink to this headline">¶</a></h2>
<p>the en/decryption routines each use 6 necessary register variables,
with 4 being actively used at once during the inner iterations.
if you don’t have 4 register variables get a new machine.
up to 8 more registers are used to hold constants in some configurations.</p>
<p>i assume that the use of a constant is more expensive than using a register:</p>
<ol class="loweralpha">
<li><p class="first">additionally, i have tried to put the larger constants in registers.
registering priority was by the following:</p>
<blockquote>
<div><ul class="simple">
<li>anything more than 12 bits (bad for RISC and CISC)</li>
<li>greater than 127 in value (can’t use movq or byte immediate on CISC)</li>
<li>9-127 (may not be able to use CISC shift immediate or add/sub quick),</li>
<li>1-8 were never registered, being the cheapest constants.</li>
</ul>
</div></blockquote>
</li>
<li><p class="first">the compiler may be too stupid to realize table and table+256 should
be assigned to different constant registers and instead repetitively
do the arithmetic, so i assign these to explicit <code class="docutils literal notranslate"><span class="pre">m</span></code> register variables
when possible and helpful.</p>
</li>
</ol>
<p>i assume that indexing is cheaper or equivalent to auto increment/decrement,
where the index is 7 bits unsigned or smaller.
this assumption is reversed for 68k and vax.</p>
<p>i assume that addresses can be cheaply formed from two registers,
or from a register and a small constant.
for the 68000, the <code class="docutils literal notranslate"><span class="pre">two</span> <span class="pre">registers</span> <span class="pre">and</span> <span class="pre">small</span> <span class="pre">offset</span></code> form is used sparingly.
all index scaling is done explicitly - no hidden shifts by log2(sizeof).</p>
<p>the code is written so that even a dumb compiler
should never need more than one hidden temporary,
increasing the chance that everything will fit in the registers.
KEEP THIS MORE SUBTLE POINT IN MIND IF YOU REWRITE ANYTHING.</p>
<p>(actually, there are some code fragments now which do require two temps,
but fixing it would either break the structure of the macros or
require declaring another temporary).</p>
</div>
<div class="section" id="special-efficient-data-format">
<h2>special efficient data format<a class="headerlink" href="#special-efficient-data-format" title="Permalink to this headline">¶</a></h2>
<p>bits are manipulated in this arrangement most of the time (S7 S5 S3 S1):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>003130292827xxxx242322212019xxxx161514131211xxxx080706050403xxxx
</pre></div>
</div>
<p>(the x bits are still there, i’m just emphasizing where the S boxes are).
bits are rotated left 4 when computing S6 S4 S2 S0:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>282726252423xxxx201918171615xxxx121110090807xxxx040302010031xxxx
</pre></div>
</div>
<p>the rightmost two bits are usually cleared so the lower byte can be used
as an index into an sbox mapping table. the next two x’d bits are set
to various values to access different parts of the tables.</p>
<p>how to use the routines</p>
<dl class="docutils">
<dt>datatypes:</dt>
<dd><p class="first">pointer to 8 byte area of type DesData
used to hold keys and input/output blocks to des.</p>
<p class="last">pointer to 128 byte area of type DesKeys
used to hold full 768-bit key.
must be long-aligned.</p>
</dd>
<dt>DesQuickInit()</dt>
<dd>call this before using any other routine with <code class="docutils literal notranslate"><span class="pre">Quick</span></code> in its name.
it generates the special 64k table these routines need.</dd>
<dt>DesQuickDone()</dt>
<dd>frees this table</dd>
<dt>DesMethod(m, k)</dt>
<dd><p class="first">m points to a 128byte block, k points to an 8 byte des key
which must have odd parity (or -1 is returned) and which must
not be a (semi-)weak key (or -2 is returned).
normally DesMethod() returns 0.</p>
<p>m is filled in from k so that when one of the routines below
is called with m, the routine will act like standard des
en/decryption with the key k. if you use DesMethod,
you supply a standard 56bit key; however, if you fill in
m yourself, you will get a 768bit key - but then it won’t
be standard.  it’s 768bits not 1024 because the least significant
two bits of each byte are not used.  note that these two bits
will be set to magic constants which speed up the encryption/decryption
on some machines.  and yes, each byte controls
a specific sbox during a specific iteration.</p>
<p class="last">you really shouldn’t use the 768bit format directly;  i should
provide a routine that converts 128 6-bit bytes (specified in
S-box mapping order or something) into the right format for you.
this would entail some byte concatenation and rotation.</p>
</dd>
<dt>Des{Small|Quick}{Fips|Core}{Encrypt|Decrypt}(d, m, s)</dt>
<dd><p class="first">performs des on the 8 bytes at s into the 8 bytes at
<code class="docutils literal notranslate"><span class="pre">d.</span> <span class="pre">(d,s:</span> <span class="pre">char</span> <span class="pre">*)</span></code>.</p>
<p>uses m as a 768bit key as explained above.</p>
<p>the Encrypt|Decrypt choice is obvious.</p>
<p>Fips|Core determines whether a completely standard FIPS initial
and final permutation is done; if not, then the data is loaded
and stored in a nonstandard bit order (FIPS w/o IP/FP).</p>
<p>Fips slows down Quick by 10%, Small by 9%.</p>
<p class="last">Small|Quick determines whether you use the normal routine
or the crazy quick one which gobbles up 64k more of memory.
Small is 50% slower then Quick, but Quick needs 32 times as much
memory.  Quick is included for programs that do nothing but DES,
e.g., encryption filters, etc.</p>
</dd>
</dl>
</div>
<div class="section" id="getting-it-to-compile-on-your-machine">
<h2>Getting it to compile on your machine<a class="headerlink" href="#getting-it-to-compile-on-your-machine" title="Permalink to this headline">¶</a></h2>
<p>there are no machine-dependencies in the code (see porting),
except perhaps the <code class="docutils literal notranslate"><span class="pre">now()</span></code> macro in desTest.c.
ALL generated tables are machine independent.
you should edit the Makefile with the appropriate optimization flags
for your compiler (MAX optimization).</p>
</div>
<div class="section" id="speeding-up-kerberos-and-or-its-des-library">
<h2>Speeding up kerberos (and/or its des library)<a class="headerlink" href="#speeding-up-kerberos-and-or-its-des-library" title="Permalink to this headline">¶</a></h2>
<p>note that i have included a kerberos-compatible interface in desUtil.c
through the functions des_key_sched() and des_ecb_encrypt().
to use these with kerberos or kerberos-compatible code put desCore.a
ahead of the kerberos-compatible library on your linker’s command line.
you should not need to #include desCore.h;  just include the header
file provided with the kerberos library.</p>
</div>
<div class="section" id="other-uses">
<h2>Other uses<a class="headerlink" href="#other-uses" title="Permalink to this headline">¶</a></h2>
<p>the macros in desCode.h would be very useful for putting inline des
functions in more complicated encryption routines.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../filesystems/index.html" class="btn btn-neutral float-right" title="Filesystems in the Linux kernel" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="api-samples.html" class="btn btn-neutral" title="Code Examples" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>