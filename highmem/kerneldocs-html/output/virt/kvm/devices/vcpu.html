

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Generic vcpu interface &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../../../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../../../index.html"/>
        <link rel="up" title="Devices" href="index.html"/>
        <link rel="next" title="VFIO virtual device" href="vfio.html"/>
        <link rel="prev" title="FLIC (floating interrupt controller)" href="s390_flic.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../index.html">Linux Virtualization Support</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../index.html">KVM</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../api.html">The Definitive KVM (Kernel-based Virtual Machine) API Documentation</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Devices</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="arm-vgic-its.html">ARM Virtual Interrupt Translation Service (ITS)</a></li>
<li class="toctree-l4"><a class="reference internal" href="arm-vgic.html">ARM Virtual Generic Interrupt Controller v2 (VGIC)</a></li>
<li class="toctree-l4"><a class="reference internal" href="arm-vgic-v3.html">ARM Virtual Generic Interrupt Controller v3 and later (VGICv3)</a></li>
<li class="toctree-l4"><a class="reference internal" href="mpic.html">MPIC interrupt controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="s390_flic.html">FLIC (floating interrupt controller)</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Generic vcpu interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="vfio.html">VFIO virtual device</a></li>
<li class="toctree-l4"><a class="reference internal" href="vm.html">Generic vm interface</a></li>
<li class="toctree-l4"><a class="reference internal" href="xics.html">XICS interrupt controller</a></li>
<li class="toctree-l4"><a class="reference internal" href="xive.html">POWER9 eXternal Interrupt Virtualization Engine (XIVE Gen1)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../arm/index.html">ARM</a></li>
<li class="toctree-l3"><a class="reference internal" href="../s390/index.html">KVM for s390 systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../ppc-pv.html">The PPC KVM paravirtual interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../x86/index.html">KVM for x86 systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../locking.html">KVM Lock Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="../vcpu-requests.html">KVM VCPU Requests</a></li>
<li class="toctree-l3"><a class="reference internal" href="../review-checklist.html">Review checklist for kvm patches</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../uml/user_mode_linux_howto_v2.html">UML HowTo</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../paravirt_ops.html">Paravirt_ops</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../guest-halt-polling.html">Guest halt polling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../ne_overview.html">Nitro Enclaves</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../acrn/index.html">ACRN Hypervisor</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Linux Virtualization Support</a> &raquo;</li>
        
          <li><a href="../index.html">KVM</a> &raquo;</li>
        
          <li><a href="index.html">Devices</a> &raquo;</li>
        
      <li>Generic vcpu interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../../_sources/virt/kvm/devices/vcpu.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="generic-vcpu-interface">
<h1>Generic vcpu interface<a class="headerlink" href="#generic-vcpu-interface" title="Permalink to this headline">¶</a></h1>
<p>The virtual cpu “device” also accepts the ioctls KVM_SET_DEVICE_ATTR,
KVM_GET_DEVICE_ATTR, and KVM_HAS_DEVICE_ATTR. The interface uses the same struct
kvm_device_attr as other devices, but targets VCPU-wide settings and controls.</p>
<p>The groups and attributes per virtual cpu, if any, are architecture specific.</p>
<div class="section" id="group-kvm-arm-vcpu-pmu-v3-ctrl">
<h2>1. GROUP: KVM_ARM_VCPU_PMU_V3_CTRL<a class="headerlink" href="#group-kvm-arm-vcpu-pmu-v3-ctrl" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Architectures:</th><td class="field-body">ARM64</td>
</tr>
</tbody>
</table>
<div class="section" id="attribute-kvm-arm-vcpu-pmu-v3-irq">
<h3>1.1. ATTRIBUTE: KVM_ARM_VCPU_PMU_V3_IRQ<a class="headerlink" href="#attribute-kvm-arm-vcpu-pmu-v3-irq" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body">in kvm_device_attr.addr the address for PMU overflow interrupt is a
pointer to an int</td>
</tr>
</tbody>
</table>
<p>Returns:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EBUSY</td>
<td>The PMU overflow interrupt is already set</td>
</tr>
<tr class="row-even"><td>-EFAULT</td>
<td>Error reading interrupt number</td>
</tr>
<tr class="row-odd"><td>-ENXIO</td>
<td>PMUv3 not supported or the overflow interrupt not set
when attempting to get it</td>
</tr>
<tr class="row-even"><td>-ENODEV</td>
<td>KVM_ARM_VCPU_PMU_V3 feature missing from VCPU</td>
</tr>
<tr class="row-odd"><td>-EINVAL</td>
<td>Invalid PMU overflow interrupt number supplied or
trying to set the IRQ number without using an in-kernel
irqchip.</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>A value describing the PMUv3 (Performance Monitor Unit v3) overflow interrupt
number for this vcpu. This interrupt could be a PPI or SPI, but the interrupt
type must be same for each vcpu. As a PPI, the interrupt number is the same for
all vcpus, while as an SPI it must be a separate number per vcpu.</p>
</div>
<div class="section" id="attribute-kvm-arm-vcpu-pmu-v3-init">
<h3>1.2 ATTRIBUTE: KVM_ARM_VCPU_PMU_V3_INIT<a class="headerlink" href="#attribute-kvm-arm-vcpu-pmu-v3-init" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body">no additional parameter in kvm_device_attr.addr</td>
</tr>
</tbody>
</table>
<p>Returns:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EEXIST</td>
<td>Interrupt number already used</td>
</tr>
<tr class="row-even"><td>-ENODEV</td>
<td>PMUv3 not supported or GIC not initialized</td>
</tr>
<tr class="row-odd"><td>-ENXIO</td>
<td>PMUv3 not supported, missing VCPU feature or interrupt
number not set</td>
</tr>
<tr class="row-even"><td>-EBUSY</td>
<td>PMUv3 already initialized</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Request the initialization of the PMUv3.  If using the PMUv3 with an in-kernel
virtual GIC implementation, this must be done after initializing the in-kernel
irqchip.</p>
</div>
<div class="section" id="attribute-kvm-arm-vcpu-pmu-v3-filter">
<h3>1.3 ATTRIBUTE: KVM_ARM_VCPU_PMU_V3_FILTER<a class="headerlink" href="#attribute-kvm-arm-vcpu-pmu-v3-filter" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first">in kvm_device_attr.addr the address for a PMU event filter is a
pointer to a struct kvm_pmu_event_filter</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><table border="1" class="first last docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-ENODEV</td>
<td>PMUv3 not supported or GIC not initialized</td>
</tr>
<tr class="row-even"><td>-ENXIO</td>
<td>PMUv3 not properly configured or in-kernel irqchip not
configured as required prior to calling this attribute</td>
</tr>
<tr class="row-odd"><td>-EBUSY</td>
<td>PMUv3 already initialized or a VCPU has already run</td>
</tr>
<tr class="row-even"><td>-EINVAL</td>
<td>Invalid filter range</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p>Request the installation of a PMU event filter described as follows:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct kvm_pmu_event_filter {
        __u16       base_event;
        __u16       nevents;

#define KVM_PMU_EVENT_ALLOW 0
#define KVM_PMU_EVENT_DENY  1

        __u8        action;
        __u8        pad[3];
};
</pre></div>
</div>
<p>A filter range is defined as the range [&#64;base_event, &#64;base_event + &#64;nevents),
together with an &#64;action (KVM_PMU_EVENT_ALLOW or KVM_PMU_EVENT_DENY). The
first registered range defines the global policy (global ALLOW if the first
&#64;action is DENY, global DENY if the first &#64;action is ALLOW). Multiple ranges
can be programmed, and must fit within the event space defined by the PMU
architecture (10 bits on ARMv8.0, 16 bits from ARMv8.1 onwards).</p>
<p>Note: “Cancelling” a filter by registering the opposite action for the same
range doesn’t change the default action. For example, installing an ALLOW
filter for event range [0:10) as the first filter and then applying a DENY
action for the same range will leave the whole range as disabled.</p>
<p>Restrictions: Event 0 (SW_INCR) is never filtered, as it doesn’t count a
hardware event. Filtering event 0x1E (CHAIN) has no effect either, as it
isn’t strictly speaking an event. Filtering the cycle counter is possible
using event 0x11 (CPU_CYCLES).</p>
</div>
<div class="section" id="attribute-kvm-arm-vcpu-pmu-v3-set-pmu">
<h3>1.4 ATTRIBUTE: KVM_ARM_VCPU_PMU_V3_SET_PMU<a class="headerlink" href="#attribute-kvm-arm-vcpu-pmu-v3-set-pmu" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><p class="first">in kvm_device_attr.addr the address to an int representing the PMU
identifier.</p>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><table border="1" class="first last docutils">
<colgroup>
<col width="12%" />
<col width="88%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EBUSY</td>
<td>PMUv3 already initialized, a VCPU has already run or
an event filter has already been set</td>
</tr>
<tr class="row-even"><td>-EFAULT</td>
<td>Error accessing the PMU identifier</td>
</tr>
<tr class="row-odd"><td>-ENXIO</td>
<td>PMU not found</td>
</tr>
<tr class="row-even"><td>-ENODEV</td>
<td>PMUv3 not supported or GIC not initialized</td>
</tr>
<tr class="row-odd"><td>-ENOMEM</td>
<td>Could not allocate memory</td>
</tr>
</tbody>
</table>
</td>
</tr>
</tbody>
</table>
<p>Request that the VCPU uses the specified hardware PMU when creating guest events
for the purpose of PMU emulation. The PMU identifier can be read from the “type”
file for the desired PMU instance under /sys/devices (or, equivalent,
/sys/bus/even_source). This attribute is particularly useful on heterogeneous
systems where there are at least two CPU PMUs on the system. The PMU that is set
for one VCPU will be used by all the other VCPUs. It isn’t possible to set a PMU
if a PMU event filter is already present.</p>
<p>Note that KVM will not make any attempts to run the VCPU on the physical CPUs
associated with the PMU specified by this attribute. This is entirely left to
userspace. However, attempting to run the VCPU on a physical CPU not supported
by the PMU will fail and KVM_RUN will return with
exit_reason = KVM_EXIT_FAIL_ENTRY and populate the fail_entry struct by setting
hardare_entry_failure_reason field to KVM_EXIT_FAIL_ENTRY_CPU_UNSUPPORTED and
the cpu field to the processor id.</p>
</div>
</div>
<div class="section" id="group-kvm-arm-vcpu-timer-ctrl">
<h2>2. GROUP: KVM_ARM_VCPU_TIMER_CTRL<a class="headerlink" href="#group-kvm-arm-vcpu-timer-ctrl" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Architectures:</th><td class="field-body">ARM64</td>
</tr>
</tbody>
</table>
<div class="section" id="attributes-kvm-arm-vcpu-timer-irq-vtimer-kvm-arm-vcpu-timer-irq-ptimer">
<h3>2.1. ATTRIBUTES: KVM_ARM_VCPU_TIMER_IRQ_VTIMER, KVM_ARM_VCPU_TIMER_IRQ_PTIMER<a class="headerlink" href="#attributes-kvm-arm-vcpu-timer-irq-vtimer-kvm-arm-vcpu-timer-irq-ptimer" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body">in kvm_device_attr.addr the address for the timer interrupt is a
pointer to an int</td>
</tr>
</tbody>
</table>
<p>Returns:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="18%" />
<col width="83%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EINVAL</td>
<td>Invalid timer interrupt number</td>
</tr>
<tr class="row-even"><td>-EBUSY</td>
<td>One or more VCPUs has already run</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>A value describing the architected timer interrupt number when connected to an
in-kernel virtual GIC.  These must be a PPI (16 &lt;= intid &lt; 32).  Setting the
attribute overrides the default values (see below).</p>
<table border="1" class="docutils">
<colgroup>
<col width="41%" />
<col width="59%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>KVM_ARM_VCPU_TIMER_IRQ_VTIMER</td>
<td>The EL1 virtual timer intid (default: 27)</td>
</tr>
<tr class="row-even"><td>KVM_ARM_VCPU_TIMER_IRQ_PTIMER</td>
<td>The EL1 physical timer intid (default: 30)</td>
</tr>
</tbody>
</table>
<p>Setting the same PPI for different timers will prevent the VCPUs from running.
Setting the interrupt number on a VCPU configures all VCPUs created at that
time to use the number provided for a given timer, overwriting any previously
configured values on other VCPUs.  Userspace should configure the interrupt
numbers on at least one VCPU after creating all VCPUs and before running any
VCPUs.</p>
</div>
</div>
<div class="section" id="group-kvm-arm-vcpu-pvtime-ctrl">
<h2>3. GROUP: KVM_ARM_VCPU_PVTIME_CTRL<a class="headerlink" href="#group-kvm-arm-vcpu-pvtime-ctrl" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Architectures:</th><td class="field-body">ARM64</td>
</tr>
</tbody>
</table>
<div class="section" id="attribute-kvm-arm-vcpu-pvtime-ipa">
<h3>3.1 ATTRIBUTE: KVM_ARM_VCPU_PVTIME_IPA<a class="headerlink" href="#attribute-kvm-arm-vcpu-pvtime-ipa" title="Permalink to this headline">¶</a></h3>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body">64-bit base address</td>
</tr>
</tbody>
</table>
<p>Returns:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-ENXIO</td>
<td>Stolen time not implemented</td>
</tr>
<tr class="row-even"><td>-EEXIST</td>
<td>Base address already set for this VCPU</td>
</tr>
<tr class="row-odd"><td>-EINVAL</td>
<td>Base address not 64 byte aligned</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Specifies the base address of the stolen time structure for this VCPU. The
base address must be 64 byte aligned and exist within a valid guest memory
region. See <a class="reference internal" href="../arm/pvtime.html"><span class="doc">Paravirtualized time support for arm64</span></a> for more information
including the layout of the stolen time structure.</p>
</div>
</div>
<div class="section" id="group-kvm-vcpu-tsc-ctrl">
<h2>4. GROUP: KVM_VCPU_TSC_CTRL<a class="headerlink" href="#group-kvm-vcpu-tsc-ctrl" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Architectures:</th><td class="field-body">x86</td>
</tr>
</tbody>
</table>
<p>4.1 ATTRIBUTE: KVM_VCPU_TSC_OFFSET</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body">64-bit unsigned TSC offset</td>
</tr>
</tbody>
</table>
<p>Returns:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="16%" />
<col width="84%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>-EFAULT</td>
<td>Error reading/writing the provided
parameter address.</td>
</tr>
<tr class="row-even"><td>-ENXIO</td>
<td>Attribute not supported</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Specifies the guest’s TSC offset relative to the host’s TSC. The guest’s
TSC is then derived by the following equation:</p>
<blockquote>
<div>guest_tsc = host_tsc + KVM_VCPU_TSC_OFFSET</div></blockquote>
<p>This attribute is useful to adjust the guest’s TSC on live migration,
so that the TSC counts the time during which the VM was paused. The
following describes a possible algorithm to use for this purpose.</p>
<p>From the source VMM process:</p>
<ol class="arabic simple">
<li>Invoke the KVM_GET_CLOCK ioctl to record the host TSC (tsc_src),
kvmclock nanoseconds (guest_src), and host CLOCK_REALTIME nanoseconds
(host_src).</li>
<li>Read the KVM_VCPU_TSC_OFFSET attribute for every vCPU to record the
guest TSC offset (ofs_src[i]).</li>
<li>Invoke the KVM_GET_TSC_KHZ ioctl to record the frequency of the
guest’s TSC (freq).</li>
</ol>
<p>From the destination VMM process:</p>
<ol class="arabic" start="4">
<li><p class="first">Invoke the KVM_SET_CLOCK ioctl, providing the source nanoseconds from
kvmclock (guest_src) and CLOCK_REALTIME (host_src) in their respective
fields.  Ensure that the KVM_CLOCK_REALTIME flag is set in the provided
structure.</p>
<p>KVM will advance the VM’s kvmclock to account for elapsed time since
recording the clock values.  Note that this will cause problems in
the guest (e.g., timeouts) unless CLOCK_REALTIME is synchronized
between the source and destination, and a reasonably short time passes
between the source pausing the VMs and the destination executing
steps 4-7.</p>
</li>
<li><p class="first">Invoke the KVM_GET_CLOCK ioctl to record the host TSC (tsc_dest) and
kvmclock nanoseconds (guest_dest).</p>
</li>
<li><p class="first">Adjust the guest TSC offsets for every vCPU to account for (1) time
elapsed since recording state and (2) difference in TSCs between the
source and destination machine:</p>
<dl class="docutils">
<dt>ofs_dst[i] = ofs_src[i] -</dt>
<dd><p class="first last">(guest_src - guest_dest) * freq +
(tsc_src - tsc_dest)</p>
</dd>
</dl>
<p>(“ofs[i] + tsc - guest * freq” is the guest TSC value corresponding to
a time of 0 in kvmclock.  The above formula ensures that it is the
same on the destination as it was on the source).</p>
</li>
<li><p class="first">Write the KVM_VCPU_TSC_OFFSET attribute for every vCPU with the
respective value derived in the previous step.</p>
</li>
</ol>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="vfio.html" class="btn btn-neutral float-right" title="VFIO virtual device" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="s390_flic.html" class="btn btn-neutral" title="FLIC (floating interrupt controller)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>