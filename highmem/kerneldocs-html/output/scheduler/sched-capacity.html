

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Capacity Aware Scheduling &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux Scheduler" href="index.html"/>
        <link rel="next" title="Energy Aware Scheduling" href="sched-energy.html"/>
        <link rel="prev" title="Scheduler Domains" href="sched-domains.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux Scheduler</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="completion.html">Completions - “wait for completion” barrier APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-arch.html">CPU Scheduler implementation hints for architecture specific code</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-bwc.html">CFS Bandwidth Control</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-deadline.html">Deadline Task Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-design-CFS.html">CFS Scheduler</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-domains.html">Scheduler Domains</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Capacity Aware Scheduling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cpu-capacity">1. CPU Capacity</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introduction">1.1 Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#scheduler-terms">1.2 Scheduler terms</a></li>
<li class="toctree-l4"><a class="reference internal" href="#platform-examples">1.3 Platform examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="#representation-caveat">1.4 Representation caveat</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#task-utilization">2. Task utilization</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">2.1 Introduction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#frequency-invariance">2.2 Frequency invariance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#cpu-invariance">2.3 CPU invariance</a></li>
<li class="toctree-l4"><a class="reference internal" href="#invariant-task-utilization">2.4 Invariant task utilization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#utilization-estimation">2.5 Utilization estimation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#capacity-aware-scheduling-requirements">3. Capacity aware scheduling requirements</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id2">3.1 CPU capacity</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">3.2 Frequency invariance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#scheduler-topology">4. Scheduler topology</a></li>
<li class="toctree-l3"><a class="reference internal" href="#capacity-aware-scheduling-implementation">5. Capacity aware scheduling implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#cfs">5.1 CFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rt">5.2 RT</a></li>
<li class="toctree-l4"><a class="reference internal" href="#dl">5.3 DL</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sched-energy.html">Energy Aware Scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="schedutil.html">Schedutil</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-nice-design.html">Scheduler Nice Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-rt-group.html">Real-Time group scheduling</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-stats.html">Scheduler Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="sched-debug.html">Scheduler debugfs</a></li>
<li class="toctree-l2"><a class="reference internal" href="text_files.html">Scheduler pelt c program</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux Scheduler</a> &raquo;</li>
        
      <li>Capacity Aware Scheduling</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/scheduler/sched-capacity.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="capacity-aware-scheduling">
<h1>Capacity Aware Scheduling<a class="headerlink" href="#capacity-aware-scheduling" title="Permalink to this headline">¶</a></h1>
<div class="section" id="cpu-capacity">
<h2>1. CPU Capacity<a class="headerlink" href="#cpu-capacity" title="Permalink to this headline">¶</a></h2>
<div class="section" id="introduction">
<h3>1.1 Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>Conventional, homogeneous SMP platforms are composed of purely identical
CPUs. Heterogeneous platforms on the other hand are composed of CPUs with
different performance characteristics - on such platforms, not all CPUs can be
considered equal.</p>
<p>CPU capacity is a measure of the performance a CPU can reach, normalized against
the most performant CPU in the system. Heterogeneous systems are also called
asymmetric CPU capacity systems, as they contain CPUs of different capacities.</p>
<p>Disparity in maximum attainable performance (IOW in maximum CPU capacity) stems
from two factors:</p>
<ul class="simple">
<li>not all CPUs may have the same microarchitecture (µarch).</li>
<li>with Dynamic Voltage and Frequency Scaling (DVFS), not all CPUs may be
physically able to attain the higher Operating Performance Points (OPP).</li>
</ul>
<p>Arm big.LITTLE systems are an example of both. The big CPUs are more
performance-oriented than the LITTLE ones (more pipeline stages, bigger caches,
smarter predictors, etc), and can usually reach higher OPPs than the LITTLE ones
can.</p>
<p>CPU performance is usually expressed in Millions of Instructions Per Second
(MIPS), which can also be expressed as a given amount of instructions attainable
per Hz, leading to:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>capacity(cpu) = work_per_hz(cpu) * max_freq(cpu)
</pre></div>
</div>
</div>
<div class="section" id="scheduler-terms">
<h3>1.2 Scheduler terms<a class="headerlink" href="#scheduler-terms" title="Permalink to this headline">¶</a></h3>
<p>Two different capacity values are used within the scheduler. A CPU’s
<code class="docutils literal notranslate"><span class="pre">capacity_orig</span></code> is its maximum attainable capacity, i.e. its maximum
attainable performance level. A CPU’s <code class="docutils literal notranslate"><span class="pre">capacity</span></code> is its <code class="docutils literal notranslate"><span class="pre">capacity_orig</span></code> to
which some loss of available performance (e.g. time spent handling IRQs) is
subtracted.</p>
<p>Note that a CPU’s <code class="docutils literal notranslate"><span class="pre">capacity</span></code> is solely intended to be used by the CFS class,
while <code class="docutils literal notranslate"><span class="pre">capacity_orig</span></code> is class-agnostic. The rest of this document will use
the term <code class="docutils literal notranslate"><span class="pre">capacity</span></code> interchangeably with <code class="docutils literal notranslate"><span class="pre">capacity_orig</span></code> for the sake of
brevity.</p>
</div>
<div class="section" id="platform-examples">
<h3>1.3 Platform examples<a class="headerlink" href="#platform-examples" title="Permalink to this headline">¶</a></h3>
<div class="section" id="identical-opps">
<h4>1.3.1 Identical OPPs<a class="headerlink" href="#identical-opps" title="Permalink to this headline">¶</a></h4>
<p>Consider an hypothetical dual-core asymmetric CPU capacity system where</p>
<ul class="simple">
<li>work_per_hz(CPU0) = W</li>
<li>work_per_hz(CPU1) = W/2</li>
<li>all CPUs are running at the same fixed frequency</li>
</ul>
<p>By the above definition of capacity:</p>
<ul class="simple">
<li>capacity(CPU0) = C</li>
<li>capacity(CPU1) = C/2</li>
</ul>
<p>To draw the parallel with Arm big.LITTLE, CPU0 would be a big while CPU1 would
be a LITTLE.</p>
<p>With a workload that periodically does a fixed amount of work, you will get an
execution trace like so:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU0 work ^
          |     ____                ____                ____
          |    |    |              |    |              |    |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time

CPU1 work ^
          |     _________           _________           ____
          |    |         |         |         |         |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time
</pre></div>
</div>
<p>CPU0 has the highest capacity in the system (C), and completes a fixed amount of
work W in T units of time. On the other hand, CPU1 has half the capacity of
CPU0, and thus only completes W/2 in T.</p>
</div>
<div class="section" id="different-max-opps">
<h4>1.3.2 Different max OPPs<a class="headerlink" href="#different-max-opps" title="Permalink to this headline">¶</a></h4>
<p>Usually, CPUs of different capacity values also have different maximum
OPPs. Consider the same CPUs as above (i.e. same work_per_hz()) with:</p>
<ul class="simple">
<li>max_freq(CPU0) = F</li>
<li>max_freq(CPU1) = 2/3 * F</li>
</ul>
<p>This yields:</p>
<ul class="simple">
<li>capacity(CPU0) = C</li>
<li>capacity(CPU1) = C/3</li>
</ul>
<p>Executing the same workload as described in 1.3.1, which each CPU running at its
maximum frequency results in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU0 work ^
          |     ____                ____                ____
          |    |    |              |    |              |    |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time

                           workload on CPU1
CPU1 work ^
          |     ______________      ______________      ____
          |    |              |    |              |    |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time
</pre></div>
</div>
</div>
</div>
<div class="section" id="representation-caveat">
<h3>1.4 Representation caveat<a class="headerlink" href="#representation-caveat" title="Permalink to this headline">¶</a></h3>
<p>It should be noted that having a <em>single</em> value to represent differences in CPU
performance is somewhat of a contentious point. The relative performance
difference between two different µarchs could be X% on integer operations, Y% on
floating point operations, Z% on branches, and so on. Still, results using this
simple approach have been satisfactory for now.</p>
</div>
</div>
<div class="section" id="task-utilization">
<h2>2. Task utilization<a class="headerlink" href="#task-utilization" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>2.1 Introduction<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Capacity aware scheduling requires an expression of a task’s requirements with
regards to CPU capacity. Each scheduler class can express this differently, and
while task utilization is specific to CFS, it is convenient to describe it here
in order to introduce more generic concepts.</p>
<p>Task utilization is a percentage meant to represent the throughput requirements
of a task. A simple approximation of it is the task’s duty cycle, i.e.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_util(p) = duty_cycle(p)
</pre></div>
</div>
<p>On an SMP system with fixed frequencies, 100% utilization suggests the task is a
busy loop. Conversely, 10% utilization hints it is a small periodic task that
spends more time sleeping than executing. Variable CPU frequencies and
asymmetric CPU capacities complexify this somewhat; the following sections will
expand on these.</p>
</div>
<div class="section" id="frequency-invariance">
<h3>2.2 Frequency invariance<a class="headerlink" href="#frequency-invariance" title="Permalink to this headline">¶</a></h3>
<p>One issue that needs to be taken into account is that a workload’s duty cycle is
directly impacted by the current OPP the CPU is running at. Consider running a
periodic workload at a given frequency F:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU work ^
         |     ____                ____                ____
         |    |    |              |    |              |    |
         +----+----+----+----+----+----+----+----+----+----+-&gt; time
</pre></div>
</div>
<p>This yields duty_cycle(p) == 25%.</p>
<p>Now, consider running the <em>same</em> workload at frequency F/2:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU work ^
         |     _________           _________           ____
         |    |         |         |         |         |
         +----+----+----+----+----+----+----+----+----+----+-&gt; time
</pre></div>
</div>
<p>This yields duty_cycle(p) == 50%, despite the task having the exact same
behaviour (i.e. executing the same amount of work) in both executions.</p>
<p>The task utilization signal can be made frequency invariant using the following
formula:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_util_freq_inv(p) = duty_cycle(p) * (curr_frequency(cpu) / max_frequency(cpu))
</pre></div>
</div>
<p>Applying this formula to the two examples above yields a frequency invariant
task utilization of 25%.</p>
</div>
<div class="section" id="cpu-invariance">
<h3>2.3 CPU invariance<a class="headerlink" href="#cpu-invariance" title="Permalink to this headline">¶</a></h3>
<p>CPU capacity has a similar effect on task utilization in that running an
identical workload on CPUs of different capacity values will yield different
duty cycles.</p>
<p>Consider the system described in 1.3.2., i.e.:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>- capacity(CPU0) = C
- capacity(CPU1) = C/3
</pre></div>
</div>
<p>Executing a given periodic workload on each CPU at their maximum frequency would
result in:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>CPU0 work ^
          |     ____                ____                ____
          |    |    |              |    |              |    |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time

CPU1 work ^
          |     ______________      ______________      ____
          |    |              |    |              |    |
          +----+----+----+----+----+----+----+----+----+----+-&gt; time
</pre></div>
</div>
<p>IOW,</p>
<ul class="simple">
<li>duty_cycle(p) == 25% if p runs on CPU0 at its maximum frequency</li>
<li>duty_cycle(p) == 75% if p runs on CPU1 at its maximum frequency</li>
</ul>
<p>The task utilization signal can be made CPU invariant using the following
formula:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_util_cpu_inv(p) = duty_cycle(p) * (capacity(cpu) / max_capacity)
</pre></div>
</div>
<p>with <code class="docutils literal notranslate"><span class="pre">max_capacity</span></code> being the highest CPU capacity value in the
system. Applying this formula to the above example above yields a CPU
invariant task utilization of 25%.</p>
</div>
<div class="section" id="invariant-task-utilization">
<h3>2.4 Invariant task utilization<a class="headerlink" href="#invariant-task-utilization" title="Permalink to this headline">¶</a></h3>
<p>Both frequency and CPU invariance need to be applied to task utilization in
order to obtain a truly invariant signal. The pseudo-formula for a task
utilization that is both CPU and frequency invariant is thus, for a given
task p:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>                                   curr_frequency(cpu)   capacity(cpu)
task_util_inv(p) = duty_cycle(p) * ------------------- * -------------
                                   max_frequency(cpu)    max_capacity
</pre></div>
</div>
<p>In other words, invariant task utilization describes the behaviour of a task as
if it were running on the highest-capacity CPU in the system, running at its
maximum frequency.</p>
<p>Any mention of task utilization in the following sections will imply its
invariant form.</p>
</div>
<div class="section" id="utilization-estimation">
<h3>2.5 Utilization estimation<a class="headerlink" href="#utilization-estimation" title="Permalink to this headline">¶</a></h3>
<p>Without a crystal ball, task behaviour (and thus task utilization) cannot
accurately be predicted the moment a task first becomes runnable. The CFS class
maintains a handful of CPU and task signals based on the Per-Entity Load
Tracking (PELT) mechanism, one of those yielding an <em>average</em> utilization (as
opposed to instantaneous).</p>
<p>This means that while the capacity aware scheduling criteria will be written
considering a “true” task utilization (using a crystal ball), the implementation
will only ever be able to use an estimator thereof.</p>
</div>
</div>
<div class="section" id="capacity-aware-scheduling-requirements">
<h2>3. Capacity aware scheduling requirements<a class="headerlink" href="#capacity-aware-scheduling-requirements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id2">
<h3>3.1 CPU capacity<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Linux cannot currently figure out CPU capacity on its own, this information thus
needs to be handed to it. Architectures must define arch_scale_cpu_capacity()
for that purpose.</p>
<p>The arm and arm64 architectures directly map this to the arch_topology driver
CPU scaling data, which is derived from the capacity-dmips-mhz CPU binding; see
Documentation/devicetree/bindings/arm/cpu-capacity.txt.</p>
</div>
<div class="section" id="id3">
<h3>3.2 Frequency invariance<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>As stated in 2.2, capacity-aware scheduling requires a frequency-invariant task
utilization. Architectures must define arch_scale_freq_capacity(cpu) for that
purpose.</p>
<p>Implementing this function requires figuring out at which frequency each CPU
have been running at. One way to implement this is to leverage hardware counters
whose increment rate scale with a CPU’s current frequency (APERF/MPERF on x86,
AMU on arm64). Another is to directly hook into cpufreq frequency transitions,
when the kernel is aware of the switched-to frequency (also employed by
arm/arm64).</p>
</div>
</div>
<div class="section" id="scheduler-topology">
<h2>4. Scheduler topology<a class="headerlink" href="#scheduler-topology" title="Permalink to this headline">¶</a></h2>
<p>During the construction of the sched domains, the scheduler will figure out
whether the system exhibits asymmetric CPU capacities. Should that be the
case:</p>
<ul class="simple">
<li>The sched_asym_cpucapacity static key will be enabled.</li>
<li>The SD_ASYM_CPUCAPACITY_FULL flag will be set at the lowest sched_domain
level that spans all unique CPU capacity values.</li>
<li>The SD_ASYM_CPUCAPACITY flag will be set for any sched_domain that spans
CPUs with any range of asymmetry.</li>
</ul>
<p>The sched_asym_cpucapacity static key is intended to guard sections of code that
cater to asymmetric CPU capacity systems. Do note however that said key is
<em>system-wide</em>. Imagine the following setup using cpusets:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>capacity    C/2          C
          ________    ________
         /        \  /        \
CPUs     0  1  2  3  4  5  6  7
         \__/  \______________/
cpusets   cs0         cs1
</pre></div>
</div>
<p>Which could be created via:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir /sys/fs/cgroup/cpuset/cs0
<span class="nb">echo</span> <span class="m">0</span>-1 &gt; /sys/fs/cgroup/cpuset/cs0/cpuset.cpus
<span class="nb">echo</span> <span class="m">0</span> &gt; /sys/fs/cgroup/cpuset/cs0/cpuset.mems

mkdir /sys/fs/cgroup/cpuset/cs1
<span class="nb">echo</span> <span class="m">2</span>-7 &gt; /sys/fs/cgroup/cpuset/cs1/cpuset.cpus
<span class="nb">echo</span> <span class="m">0</span> &gt; /sys/fs/cgroup/cpuset/cs1/cpuset.mems

<span class="nb">echo</span> <span class="m">0</span> &gt; /sys/fs/cgroup/cpuset/cpuset.sched_load_balance
</pre></div>
</div>
<p>Since there <em>is</em> CPU capacity asymmetry in the system, the
sched_asym_cpucapacity static key will be enabled. However, the sched_domain
hierarchy of CPUs 0-1 spans a single capacity value: SD_ASYM_CPUCAPACITY isn’t
set in that hierarchy, it describes an SMP island and should be treated as such.</p>
<p>Therefore, the ‘canonical’ pattern for protecting codepaths that cater to
asymmetric CPU capacities is to:</p>
<ul class="simple">
<li>Check the sched_asym_cpucapacity static key</li>
<li>If it is enabled, then also check for the presence of SD_ASYM_CPUCAPACITY in
the sched_domain hierarchy (if relevant, i.e. the codepath targets a specific
CPU or group thereof)</li>
</ul>
</div>
<div class="section" id="capacity-aware-scheduling-implementation">
<h2>5. Capacity aware scheduling implementation<a class="headerlink" href="#capacity-aware-scheduling-implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cfs">
<h3>5.1 CFS<a class="headerlink" href="#cfs" title="Permalink to this headline">¶</a></h3>
<div class="section" id="capacity-fitness">
<h4>5.1.1 Capacity fitness<a class="headerlink" href="#capacity-fitness" title="Permalink to this headline">¶</a></h4>
<p>The main capacity scheduling criterion of CFS is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_util(p) &lt; capacity(task_cpu(p))
</pre></div>
</div>
<p>This is commonly called the capacity fitness criterion, i.e. CFS must ensure a
task “fits” on its CPU. If it is violated, the task will need to achieve more
work than what its CPU can provide: it will be CPU-bound.</p>
<p>Furthermore, uclamp lets userspace specify a minimum and a maximum utilization
value for a task, either via sched_setattr() or via the cgroup interface (see
<a class="reference internal" href="../admin-guide/cgroup-v2.html"><span class="doc">Control Group v2</span></a>). As its name imply, this can be used to
clamp task_util() in the previous criterion.</p>
</div>
<div class="section" id="wakeup-cpu-selection">
<h4>5.1.2 Wakeup CPU selection<a class="headerlink" href="#wakeup-cpu-selection" title="Permalink to this headline">¶</a></h4>
<p>CFS task wakeup CPU selection follows the capacity fitness criterion described
above. On top of that, uclamp is used to clamp the task utilization values,
which lets userspace have more leverage over the CPU selection of CFS
tasks. IOW, CFS wakeup CPU selection searches for a CPU that satisfies:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>clamp(task_util(p), task_uclamp_min(p), task_uclamp_max(p)) &lt; capacity(cpu)
</pre></div>
</div>
<p>By using uclamp, userspace can e.g. allow a busy loop (100% utilization) to run
on any CPU by giving it a low uclamp.max value. Conversely, it can force a small
periodic task (e.g. 10% utilization) to run on the highest-performance CPUs by
giving it a high uclamp.min value.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Wakeup CPU selection in CFS can be eclipsed by Energy Aware Scheduling
(EAS), which is described in <a class="reference internal" href="sched-energy.html"><span class="doc">Energy Aware Scheduling</span></a>.</p>
</div>
</div>
<div class="section" id="load-balancing">
<h4>5.1.3 Load balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h4>
<p>A pathological case in the wakeup CPU selection occurs when a task rarely
sleeps, if at all - it thus rarely wakes up, if at all. Consider:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>w == wakeup event

capacity(CPU0) = C
capacity(CPU1) = C / 3

                         workload on CPU0
CPU work ^
         |     _________           _________           ____
         |    |         |         |         |         |
         +----+----+----+----+----+----+----+----+----+----+-&gt; time
              w                   w                   w

                         workload on CPU1
CPU work ^
         |     ____________________________________________
         |    |
         +----+----+----+----+----+----+----+----+----+----+-&gt;
              w
</pre></div>
</div>
<p>This workload should run on CPU0, but if the task either:</p>
<ul class="simple">
<li>was improperly scheduled from the start (inaccurate initial
utilization estimation)</li>
<li>was properly scheduled from the start, but suddenly needs more
processing power</li>
</ul>
<p>then it might become CPU-bound, IOW <code class="docutils literal notranslate"><span class="pre">task_util(p)</span> <span class="pre">&gt;</span> <span class="pre">capacity(task_cpu(p))</span></code>;
the CPU capacity scheduling criterion is violated, and there may not be any more
wakeup event to fix this up via wakeup CPU selection.</p>
<p>Tasks that are in this situation are dubbed “misfit” tasks, and the mechanism
put in place to handle this shares the same name. Misfit task migration
leverages the CFS load balancer, more specifically the active load balance part
(which caters to migrating currently running tasks). When load balance happens,
a misfit active load balance will be triggered if a misfit task can be migrated
to a CPU with more capacity than its current one.</p>
</div>
</div>
<div class="section" id="rt">
<h3>5.2 RT<a class="headerlink" href="#rt" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id4">
<h4>5.2.1 Wakeup CPU selection<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>RT task wakeup CPU selection searches for a CPU that satisfies:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_uclamp_min(p) &lt;= capacity(task_cpu(cpu))
</pre></div>
</div>
<p>while still following the usual priority constraints. If none of the candidate
CPUs can satisfy this capacity criterion, then strict priority based scheduling
is followed and CPU capacities are ignored.</p>
</div>
</div>
<div class="section" id="dl">
<h3>5.3 DL<a class="headerlink" href="#dl" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4>5.3.1 Wakeup CPU selection<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>DL task wakeup CPU selection searches for a CPU that satisfies:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>task_bandwidth(p) &lt; capacity(task_cpu(p))
</pre></div>
</div>
<p>while still respecting the usual bandwidth and deadline constraints. If
none of the candidate CPUs can satisfy this capacity criterion, then the
task will remain on its current CPU.</p>
</div>
</div>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="sched-energy.html" class="btn btn-neutral float-right" title="Energy Aware Scheduling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="sched-domains.html" class="btn btn-neutral" title="Scheduler Domains" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>