

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Internal API Documentation &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../../index.html"/>
        <link rel="up" title="Core Driver Internals" href="internal.html"/>
        <link rel="next" title="Linux Switchtec Support" href="../switchtec.html"/>
        <link rel="prev" title="Core Driver Internals" href="internal.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">The Linux driver implementer’s API guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../driver-model/index.html">Driver Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="../basics.html">Driver Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infrastructure.html">Device drivers infrastructure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ioctl.html">ioctl based interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../early-userspace/index.html">Early Userspace</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pm/index.html">CPU and Device Power Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clk.html">The Common Clk Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device-io.html">Bus-Independent Device Accesses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dma-buf.html">Buffer Sharing and Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../device_link.html">Device links</a></li>
<li class="toctree-l2"><a class="reference internal" href="../component.html">Component Helper for Aggregate Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../message-based.html">Message-based devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../infiniband.html">InfiniBand and Remote DMA (RDMA) Interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="../frame-buffer.html">Frame Buffer Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../regulator.html">Voltage and current regulator API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reset.html">Reset controller API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l2"><a class="reference internal" href="../input.html">Input Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usb/index.html">Linux USB API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firewire.html">Firewire (IEEE 1394) driver Interface Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pci/index.html">The Linux PCI driver implementer’s API guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cxl/index.html">Compute Express Link</a></li>
<li class="toctree-l2"><a class="reference internal" href="../spi.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i2c.html">I<sup>2</sup>C and SMBus Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmb.html">IPMB Driver for a Satellite MC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ipmi.html">The Linux IPMI Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../i3c/index.html">I3C subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../interconnect.html">Generic System Interconnect Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../devfreq.html">Device Frequency Scaling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../hsi.html">High Speed Synchronous Serial Interface (HSI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../edac.html">Error Detection And Correction (EDAC) Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scsi.html">SCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../libata.html">libATA Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../target.html">target and iSCSI Interfaces Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mailbox.html">The Common Mailbox Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtdnand.html">MTD NAND Driver Programming Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html">Parallel Port Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#x50-uart-driver">16x50 UART Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../miscellaneous.html#pulse-width-modulation-pwm">Pulse-Width Modulation (PWM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mei/index.html">Intel(R) Management Engine Interface (Intel(R) MEI)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mtd/index.html">Memory Technology Device (MTD)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../mmc/index.html">MMC/SD/SDIO card support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvdimm/index.html">Non-Volatile Memory Device (NVDIMM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../w1.html">W1: Dallas’ 1-wire bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rapidio/index.html">The Linux RapidIO Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../s390-drivers.html">Writing s390 channel device drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vme.html">VME Device Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../80211/index.html">Linux 802.11 Driver Developer’s Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../uio-howto.html">The Userspace I/O HOWTO</a></li>
<li class="toctree-l2"><a class="reference internal" href="../firmware/index.html">Linux Firmware API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pin-control.html">PINCTRL (PIN CONTROL) subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../gpio/index.html">General Purpose Input/Output (GPIO)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../md/index.html">RAID</a></li>
<li class="toctree-l2"><a class="reference internal" href="../media/index.html">Media subsystem kernel internal API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../misc_devices.html">Miscellaneous Devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nfc/index.html">Near Field Communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dmaengine/index.html">DMAEngine documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../slimbus.html">Linux kernel SLIMbus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../soundwire/index.html">SoundWire Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../thermal/index.html">Thermal</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fpga/index.html">FPGA Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../acpi/index.html">ACPI Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../auxiliary_bus.html">Auxiliary Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backlight/lp855x-driver.html">Kernel driver lp855x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../connector.html">Kernel Connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../console.html">Console Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dcdbas.html">Dell Systems Management Base Driver</a></li>
<li class="toctree-l2"><a class="reference internal" href="../eisa.html">EISA bus support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isa.html">ISA Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../isapnp.html">ISA Plug &amp; Play support by Jaroslav Kysela &lt;perex&#64;suse.cz&gt;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../io-mapping.html">The io_mapping functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../io_ordering.html">Ordering I/O writes to memory-mapped addresses</a></li>
<li class="toctree-l2"><a class="reference internal" href="../generic-counter.html">Generic Counter Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory-devices/index.html">Memory Controller drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../men-chameleon-bus.html">MEN Chameleon Bus</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ntb.html">NTB Drivers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../nvmem.html">NVMEM Subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../parport-lowlevel.html">PARPORT interface documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pps.html">PPS - Pulse Per Second</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ptp.html">PTP hardware clock infrastructure for Linux</a></li>
<li class="toctree-l2"><a class="reference internal" href="../phy/index.html">Generic PHY Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pwm.html">Pulse Width Modulation (PWM) interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pldmfw/index.html">PLDM Firmware Flash Update Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pldmfw/index.html#overview-of-the-pldmfw-library">Overview of the <code class="docutils literal notranslate"><span class="pre">pldmfw</span></code> library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../rfkill.html">rfkill - RF kill switch support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../serial/index.html">Support for Serial devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sm501.html">SM501 Driver</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Surface System Aggregator Module (SSAM)</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="client.html">Writing Client Drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="clients/index.html">Client Driver Documentation</a></li>
<li class="toctree-l3"><a class="reference internal" href="ssh.html">Surface Serial Hub Protocol</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="internal.html">Core Driver Internals</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Internal API Documentation</a></li>
<li class="toctree-l4"><a class="reference internal" href="internal.html#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="internal.html#packet-transport-layer">Packet Transport Layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="internal.html#request-transport-layer">Request Transport Layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="internal.html#controller-layer">Controller Layer</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../switchtec.html">Linux Switchtec Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../sync_file.html">Sync File API Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio-mediated-device.html">VFIO Mediated devices</a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio.html">VFIO - “Virtual Function I/O” </a></li>
<li class="toctree-l2"><a class="reference internal" href="../vfio-pci-device-specific-driver-acceptance.html">Acceptance criteria for vfio-pci device specific driver variants</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xilinx/index.html">Xilinx FPGA</a></li>
<li class="toctree-l2"><a class="reference internal" href="../xillybus.html">Xillybus driver for generic FPGA interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zorro.html">Writing Device Drivers for Zorro Devices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">The Linux driver implementer’s API guide</a> &raquo;</li>
        
          <li><a href="index.html">Surface System Aggregator Module (SSAM)</a> &raquo;</li>
        
          <li><a href="internal.html">Core Driver Internals</a> &raquo;</li>
        
      <li>Internal API Documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/driver-api/surface_aggregator/internal-api.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="internal-api-documentation">
<h1><a class="toc-backref" href="#id1">Internal API Documentation</a><a class="headerlink" href="#internal-api-documentation" title="Permalink to this headline">¶</a></h1>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#internal-api-documentation" id="id1">Internal API Documentation</a><ul>
<li><a class="reference internal" href="#packet-transport-layer" id="id2">Packet Transport Layer</a></li>
<li><a class="reference internal" href="#request-transport-layer" id="id3">Request Transport Layer</a></li>
<li><a class="reference internal" href="#controller" id="id4">Controller</a></li>
<li><a class="reference internal" href="#client-device-bus" id="id5">Client Device Bus</a></li>
<li><a class="reference internal" href="#core" id="id6">Core</a></li>
<li><a class="reference internal" href="#trace-helpers" id="id7">Trace Helpers</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="packet-transport-layer">
<h2><a class="toc-backref" href="#id2">Packet Transport Layer</a><a class="headerlink" href="#packet-transport-layer" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.sshp_buf">
struct <code class="descname">sshp_buf</code><a class="headerlink" href="#c.sshp_buf" title="Permalink to this definition">¶</a></dt>
<dd><p>Parser buffer for SSH messages.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct sshp_buf {
  u8 *ptr;
  size_t len;
  size_t cap;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">ptr</span></code></dt>
<dd>Pointer to the beginning of the buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">len</span></code></dt>
<dd>Number of bytes used in the buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cap</span></code></dt>
<dd>Maximum capacity of the buffer.</dd>
</dl>
<dl class="function">
<dt id="c.sshp_buf_init">
void <code class="descname">sshp_buf_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em>, u8<em>&nbsp;*ptr</em>, size_t<em>&nbsp;cap</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize a SSH parser buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*ptr</span></code></dt>
<dd>The memory backing the buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">cap</span></code></dt>
<dd>The length of the memory backing the buffer, i.e. its capacity.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the buffer with the given memory as backing and set its used
length to zero.</p>
<dl class="function">
<dt id="c.sshp_buf_alloc">
int <code class="descname">sshp_buf_alloc</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em>, size_t<em>&nbsp;cap</em>, <a class="reference internal" href="../../core-api/mm-api.html#c.gfp_t" title="gfp_t">gfp_t</a><em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_alloc" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocate and initialize a SSH parser buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to initialize/allocate to.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">cap</span></code></dt>
<dd>The desired capacity of the buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">flags</span></code></dt>
<dd>The flags used for allocating the memory.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Allocates <strong>cap</strong> bytes and initializes the provided buffer struct with the
allocated memory.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success and <code class="docutils literal notranslate"><span class="pre">-ENOMEM</span></code> if allocation failed.</p>
<dl class="function">
<dt id="c.sshp_buf_free">
void <code class="descname">sshp_buf_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Free a SSH parser buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to free.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Frees a SSH parser buffer by freeing the memory backing it and then
resetting its pointer to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> and length and capacity to zero. Intended to
free a buffer previously allocated with <a class="reference internal" href="#c.sshp_buf_alloc" title="sshp_buf_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">sshp_buf_alloc()</span></code></a>.</p>
<dl class="function">
<dt id="c.sshp_buf_drop">
void <code class="descname">sshp_buf_drop</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em>, size_t<em>&nbsp;n</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_drop" title="Permalink to this definition">¶</a></dt>
<dd><p>Drop data from the beginning of the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to drop data from.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">n</span></code></dt>
<dd>The number of bytes to drop.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Drops the first <strong>n</strong> bytes from the buffer. Re-aligns any remaining data to
the beginning of the buffer.</p>
<dl class="function">
<dt id="c.sshp_buf_read_from_fifo">
size_t <code class="descname">sshp_buf_read_from_fifo</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em>, struct kfifo<em>&nbsp;*fifo</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_read_from_fifo" title="Permalink to this definition">¶</a></dt>
<dd><p>Transfer data from a fifo to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to write the data into.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">kfifo</span> <span class="pre">*fifo</span></code></dt>
<dd>The fifo to read the data from.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Transfers the data contained in the fifo to the buffer, removing it from
the fifo. This function will try to transfer as much data as possible,
limited either by the remaining space in the buffer or by the number of
bytes available in the fifo.</p>
<p><strong>Return</strong></p>
<p>Returns the number of bytes transferred.</p>
<dl class="function">
<dt id="c.sshp_buf_span_from">
void <code class="descname">sshp_buf_span_from</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.sshp_buf" title="sshp_buf">sshp_buf</a><em>&nbsp;*buf</em>, size_t<em>&nbsp;offset</em>, struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*span</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_buf_span_from" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize a span from the given buffer and offset.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">sshp_buf</span> <span class="pre">*buf</span></code></dt>
<dd>The buffer to create the span from.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">offset</span></code></dt>
<dd>The offset in the buffer at which the span should start.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*span</span></code></dt>
<dd>The span to initialize (output).</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the provided span to point to the memory at the given offset in
the buffer, with the length of the span being capped by the number of bytes
used in the buffer after the offset (i.e. bytes remaining after the
offset).</p>
<p>Warning: This function does not validate that <strong>offset</strong> is less than or equal
to the number of bytes used in the buffer or the buffer capacity. This must
be guaranteed by the caller.</p>
<dl class="function">
<dt id="c.sshp_validate_crc">
bool <code class="descname">sshp_validate_crc</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*src</em>, const u8<em>&nbsp;*crc</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_validate_crc" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate a CRC in raw message data.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*src</span></code></dt>
<dd>The span of data over which the CRC should be computed.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*crc</span></code></dt>
<dd>The pointer to the expected u16 CRC value.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Computes the CRC of the provided data span (<strong>src</strong>), compares it to the CRC
stored at the given address (<strong>crc</strong>), and returns the result of this
comparison, i.e. <code class="docutils literal notranslate"><span class="pre">true</span></code> if equal. This function is intended to run on raw
input/message data.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the computed CRC matches the stored CRC, <code class="docutils literal notranslate"><span class="pre">false</span></code>
otherwise.</p>
<dl class="function">
<dt id="c.sshp_starts_with_syn">
bool <code class="descname">sshp_starts_with_syn</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*src</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_starts_with_syn" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if the given data starts with SSH SYN bytes.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*src</span></code></dt>
<dd>The data span to check the start of.</dd>
</dl>
<dl class="function">
<dt id="c.sshp_find_syn">
bool <code class="descname">sshp_find_syn</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*src</em>, struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*rem</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_find_syn" title="Permalink to this definition">¶</a></dt>
<dd><p>Find SSH SYN bytes in the given data span.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*src</span></code></dt>
<dd>The data span to search in.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*rem</span></code></dt>
<dd>The span (output) indicating the remaining data, starting with SSH
SYN bytes, if found.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Search for SSH SYN bytes in the given source span. If found, set the <strong>rem</strong>
span to the remaining data, starting with the first SYN bytes and capped by
the source span length, and return <code class="docutils literal notranslate"><span class="pre">true</span></code>. This function does not copy any
data, but rather only sets pointers to the respective start addresses and
length values.</p>
<p>If no SSH SYN bytes could be found, set the <strong>rem</strong> span to the zero-length
span at the end of the source span and return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>If partial SSH SYN bytes could be found at the end of the source span, set
the <strong>rem</strong> span to cover these partial SYN bytes, capped by the end of the
source span, and return <code class="docutils literal notranslate"><span class="pre">false</span></code>. This function should then be re-run once
more data is available.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if a complete SSH SYN sequence could be found,
<code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<dl class="function">
<dt id="c.sshp_parse_frame">
int <code class="descname">sshp_parse_frame</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a><em>&nbsp;*dev</em>, const struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*source</em>, struct <a class="reference internal" href="client-api.html#c.ssh_frame" title="ssh_frame">ssh_frame</a><em>&nbsp;**frame</em>, struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*payload</em>, size_t<em>&nbsp;maxlen</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_parse_frame" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse SSH frame.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code></dt>
<dd>The device used for logging.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*source</span></code></dt>
<dd>The source to parse from.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_frame</span> <span class="pre">**frame</span></code></dt>
<dd>The parsed frame (output).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*payload</span></code></dt>
<dd>The parsed payload (output).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">maxlen</span></code></dt>
<dd>The maximum supported message length.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Parses and validates a SSH frame, including its payload, from the given
source. Sets the provided <strong>frame</strong> pointer to the start of the frame and
writes the limits of the frame payload to the provided <strong>payload</strong> span
pointer.</p>
<p>This function does not copy any data, but rather only validates the message
data and sets pointers (and length values) to indicate the respective parts.</p>
<p>If no complete SSH frame could be found, the frame pointer will be set to
the <code class="docutils literal notranslate"><span class="pre">NULL</span></code> pointer and the payload span will be set to the null span (start
pointer <code class="docutils literal notranslate"><span class="pre">NULL</span></code>, size zero).</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or if the frame is incomplete, <code class="docutils literal notranslate"><span class="pre">-ENOMSG</span></code> if
the start of the message is invalid, <code class="docutils literal notranslate"><span class="pre">-EBADMSG</span></code> if any (frame-header or
payload) CRC is invalid, or <code class="docutils literal notranslate"><span class="pre">-EMSGSIZE</span></code> if the SSH message is bigger than
the maximum message length specified in the <strong>maxlen</strong> parameter.</p>
<dl class="function">
<dt id="c.sshp_parse_command">
int <code class="descname">sshp_parse_command</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a><em>&nbsp;*dev</em>, const struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*source</em>, struct <a class="reference internal" href="client-api.html#c.ssh_command" title="ssh_command">ssh_command</a><em>&nbsp;**command</em>, struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*command_data</em><span class="sig-paren">)</span><a class="headerlink" href="#c.sshp_parse_command" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse SSH command frame payload.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code></dt>
<dd>The device used for logging.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*source</span></code></dt>
<dd>The source to parse from.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_command</span> <span class="pre">**command</span></code></dt>
<dd>The parsed command (output).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*command_data</span></code></dt>
<dd>The parsed command data/payload (output).</dd>
</dl>
<p><strong>Description</strong></p>
<p>Parses and validates a SSH command frame payload. Sets the <strong>command</strong> pointer
to the command header and the <strong>command_data</strong> span to the command data (i.e.
payload of the command). This will result in a zero-length span if the
command does not have any associated data/payload. This function does not
check the frame-payload-type field, which should be checked by the caller
before calling this function.</p>
<p>The <strong>source</strong> parameter should be the complete frame payload, e.g. returned
by the <a class="reference internal" href="#c.sshp_parse_frame" title="sshp_parse_frame"><code class="xref c c-func docutils literal notranslate"><span class="pre">sshp_parse_frame()</span></code></a> command.</p>
<p>This function does not copy any data, but rather only validates the frame
payload data and sets pointers (and length values) to indicate the
respective parts.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or <code class="docutils literal notranslate"><span class="pre">-ENOMSG</span></code> if <strong>source</strong> does not represent a
valid command-type frame payload, i.e. is too short.</p>
<dl class="type">
<dt id="c.msgbuf">
struct <code class="descname">msgbuf</code><a class="headerlink" href="#c.msgbuf" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffer struct to construct SSH messages.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct msgbuf {
  u8 *begin;
  u8 *end;
  u8 *ptr;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">begin</span></code></dt>
<dd>Pointer to the beginning of the allocated buffer space.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">end</span></code></dt>
<dd>Pointer to the end (one past last element) of the allocated buffer
space.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ptr</span></code></dt>
<dd>Pointer to the first free element in the buffer.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_init">
void <code class="descname">msgb_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, u8<em>&nbsp;*ptr</em>, size_t<em>&nbsp;cap</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the given message buffer struct.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The buffer struct to initialize</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">*ptr</span></code></dt>
<dd>Pointer to the underlying memory by which the buffer will be backed.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">cap</span></code></dt>
<dd>Size of the underlying memory.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initialize the given message buffer struct using the provided memory as
backing.</p>
<dl class="function">
<dt id="c.msgb_bytes_used">
size_t <code class="descname">msgb_bytes_used</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_bytes_used" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the current number of bytes used in the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_u16">
void <code class="descname">msgb_push_u16</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, u16<em>&nbsp;value</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_u16" title="Permalink to this definition">¶</a></dt>
<dd><p>Push a u16 value to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">value</span></code></dt>
<dd>The value to push to the buffer.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_syn">
void <code class="descname">msgb_push_syn</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_syn" title="Permalink to this definition">¶</a></dt>
<dd><p>Push SSH SYN bytes to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_buf">
void <code class="descname">msgb_push_buf</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, const u8<em>&nbsp;*buf</em>, size_t<em>&nbsp;len</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_buf" title="Permalink to this definition">¶</a></dt>
<dd><p>Push raw data to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt>
<dd>The data to push to the buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">len</span></code></dt>
<dd>The length of the data to push to the buffer.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_crc">
void <code class="descname">msgb_push_crc</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, const u8<em>&nbsp;*buf</em>, size_t<em>&nbsp;len</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_crc" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute CRC and push it to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt>
<dd>The data for which the CRC should be computed.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">len</span></code></dt>
<dd>The length of the data for which the CRC should be computed.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_frame">
void <code class="descname">msgb_push_frame</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, u8<em>&nbsp;ty</em>, u16<em>&nbsp;len</em>, u8<em>&nbsp;seq</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_frame" title="Permalink to this definition">¶</a></dt>
<dd><p>Push a SSH message frame header to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">ty</span></code></dt>
<dd>The type of the frame.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">len</span></code></dt>
<dd>The length of the payload of the frame.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">seq</span></code></dt>
<dd>The sequence ID of the frame/packet.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_ack">
void <code class="descname">msgb_push_ack</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, u8<em>&nbsp;seq</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_ack" title="Permalink to this definition">¶</a></dt>
<dd><p>Push a SSH ACK frame to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">seq</span></code></dt>
<dd>The sequence ID of the frame/packet to be ACKed.</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_nak">
void <code class="descname">msgb_push_nak</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_nak" title="Permalink to this definition">¶</a></dt>
<dd><p>Push a SSH NAK frame to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer</dd>
</dl>
<dl class="function">
<dt id="c.msgb_push_cmd">
void <code class="descname">msgb_push_cmd</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.msgbuf" title="msgbuf">msgbuf</a><em>&nbsp;*msgb</em>, u8<em>&nbsp;seq</em>, u16<em>&nbsp;rqid</em>, const struct <a class="reference internal" href="client-api.html#c.ssam_request" title="ssam_request">ssam_request</a><em>&nbsp;*rqst</em><span class="sig-paren">)</span><a class="headerlink" href="#c.msgb_push_cmd" title="Permalink to this definition">¶</a></dt>
<dd><p>Push a SSH command frame with payload to the buffer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">msgbuf</span> <span class="pre">*msgb</span></code></dt>
<dd>The message buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">seq</span></code></dt>
<dd>The sequence ID (SEQ) of the frame/packet.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">rqid</span></code></dt>
<dd>The request ID (RQID) of the request contained in the frame.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_request</span> <span class="pre">*rqst</span></code></dt>
<dd>The request to wrap in the frame.</dd>
</dl>
<dl class="type">
<dt id="c.ssh_ptl_state_flags">
enum <code class="descname">ssh_ptl_state_flags</code><a class="headerlink" href="#c.ssh_ptl_state_flags" title="Permalink to this definition">¶</a></dt>
<dd><p>State-flags for <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span></code></a>.</p>
</dd></dl>

<p><strong>Constants</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">SSH_PTL_SF_SHUTDOWN_BIT</span></code></p>
<blockquote>
<div>Indicates that the packet transport layer has been shut down or is
being shut down and should not accept any new packets/data.</div></blockquote>
<dl class="type">
<dt id="c.ssh_ptl_ops">
struct <code class="descname">ssh_ptl_ops</code><a class="headerlink" href="#c.ssh_ptl_ops" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback operations for packet transport layer.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_ptl_ops {
  void (*data_received)(struct ssh_ptl *p, const struct ssam_span *data);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">data_received</span></code></dt>
<dd>Function called when a data-packet has been received. Both,
the packet layer on which the packet has been received and
the packet’s payload data are provided to this function.</dd>
</dl>
<dl class="type">
<dt id="c.ssh_ptl">
struct <code class="descname">ssh_ptl</code><a class="headerlink" href="#c.ssh_ptl" title="Permalink to this definition">¶</a></dt>
<dd><p>SSH packet transport layer.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_ptl {
  struct serdev_device *serdev;
  unsigned long state;
  struct {
    spinlock_t lock;
    struct list_head head;
  } queue;
  struct {
    spinlock_t lock;
    struct list_head head;
    atomic_t count;
  } pending;
  struct {
    atomic_t running;
    struct task_struct *thread;
    struct completion thread_cplt_tx;
    struct completion thread_cplt_pkt;
    struct wait_queue_head packet_wq;
  } tx;
  struct {
    struct task_struct *thread;
    struct wait_queue_head wq;
    struct kfifo fifo;
    struct sshp_buf buf;
    struct {
      u16 seqs[8];
      u16 offset;
    } blocked;
  } rx;
  struct {
    spinlock_t lock;
    ktime_t timeout;
    ktime_t expires;
    struct delayed_work reaper;
  } rtx_timeout;
  struct ssh_ptl_ops ops;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">serdev</span></code></dt>
<dd>Serial device providing the underlying data transport.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">state</span></code></dt>
<dd>State(-flags) of the transport layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue</span></code></dt>
<dd>Packet submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue.lock</span></code></dt>
<dd>Lock for modifying the packet submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue.head</span></code></dt>
<dd>List-head of the packet submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending</span></code></dt>
<dd>Set/list of pending packets.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.lock</span></code></dt>
<dd>Lock for modifying the pending set.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.head</span></code></dt>
<dd>List-head of the pending set/list.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.count</span></code></dt>
<dd>Number of currently pending packets.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx</span></code></dt>
<dd>Transmitter subsystem.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.running</span></code></dt>
<dd>Flag indicating (desired) transmitter thread state.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.thread</span></code></dt>
<dd>Transmitter thread.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.thread_cplt_tx</span></code></dt>
<dd>Completion for transmitter thread waiting on transfer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.thread_cplt_pkt</span></code></dt>
<dd>Completion for transmitter thread waiting on packets.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.packet_wq</span></code></dt>
<dd>Waitqueue-head for packet transmit completion.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx</span></code></dt>
<dd>Receiver subsystem.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.thread</span></code></dt>
<dd>Receiver thread.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.wq</span></code></dt>
<dd>Waitqueue-head for receiver thread.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.fifo</span></code></dt>
<dd>Buffer for receiving data/pushing data to receiver thread.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.buf</span></code></dt>
<dd>Buffer for evaluating data on receiver thread.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.blocked</span></code></dt>
<dd>List of recent/blocked sequence IDs to detect retransmission.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.blocked.seqs</span></code></dt>
<dd>Array of blocked sequence IDs.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rx.blocked.offset</span></code></dt>
<dd>Offset indicating where a new ID should be inserted.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout</span></code></dt>
<dd>Retransmission timeout subsystem.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.lock</span></code></dt>
<dd>Lock for modifying the retransmission timeout reaper.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.timeout</span></code></dt>
<dd>Timeout interval for retransmission.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.expires</span></code></dt>
<dd>Time specifying when the reaper work is next scheduled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.reaper</span></code></dt>
<dd>Work performing timeout checks and subsequent actions.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ops</span></code></dt>
<dd>Packet layer operations.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_ptl_get_device">
struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a> * <code class="descname">ssh_ptl_get_device</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_get_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Get device associated with packet transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the device on which the given packet transport layer builds
upon.</p>
<dl class="function">
<dt id="c.ssh_ptl_tx_wakeup_transfer">
void <code class="descname">ssh_ptl_tx_wakeup_transfer</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_tx_wakeup_transfer" title="Permalink to this definition">¶</a></dt>
<dd><p>Wake up packet transmitter thread for transfer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Wakes up the packet transmitter thread, notifying it that the underlying
transport has more space for data to be transmitted. If the packet
transport layer has been shut down, calls to this function will be ignored.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_drop_ack_packet">
bool <code class="descname">ssh_ptl_should_drop_ack_packet</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_drop_ack_packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to drop ACK packets.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Useful to test detection and handling of automated re-transmits by the EC.
Specifically of packets that the EC considers not-ACKed but the driver
already considers ACKed (due to dropped ACK). In this case, the EC
re-transmits the packet-to-be-ACKed and the driver should detect it as
duplicate/already handled. Note that the driver should still send an ACK
for the re-transmitted packet.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_drop_nak_packet">
bool <code class="descname">ssh_ptl_should_drop_nak_packet</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_drop_nak_packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to drop NAK packets.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Useful to test/force automated (timeout-based) re-transmit by the EC.
Specifically, packets that have not reached the driver completely/with valid
checksums. Only useful in combination with receival of (injected) bad data.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_drop_dsq_packet">
bool <code class="descname">ssh_ptl_should_drop_dsq_packet</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_drop_dsq_packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to drop sequenced data packet.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Useful to test re-transmit timeout of the driver. If the data packet has not
been ACKed after a certain time, the driver should re-transmit the packet up
to limited number of times defined in SSH_PTL_MAX_PACKET_TRIES.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_fail_write">
int <code class="descname">ssh_ptl_should_fail_write</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_fail_write" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to make serdev_device_write() fail.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Hook to simulate errors in serdev_device_write when transmitting packets.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_corrupt_tx_data">
bool <code class="descname">ssh_ptl_should_corrupt_tx_data</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_corrupt_tx_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to simulate invalid data being sent to the EC.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Hook to simulate corrupt/invalid data being sent from host (driver) to EC.
Causes the packet data to be actively corrupted by overwriting it with
pre-defined values, such that it becomes invalid, causing the EC to respond
with a NAK packet. Useful to test handling of NAK packets received by the
driver.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_corrupt_rx_syn">
bool <code class="descname">ssh_ptl_should_corrupt_rx_syn</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_corrupt_rx_syn" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to simulate invalid data being sent by the EC.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Hook to simulate invalid SYN bytes, i.e. an invalid start of messages and
test handling thereof in the driver.</p>
<dl class="function">
<dt id="c.ssh_ptl_should_corrupt_rx_data">
bool <code class="descname">ssh_ptl_should_corrupt_rx_data</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_should_corrupt_rx_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to simulate invalid data being sent by the EC.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Hook to simulate invalid data/checksum of the message frame and test handling
thereof in the driver.</p>
<dl class="function">
<dt id="c.ssh_packet_init">
void <code class="descname">ssh_packet_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*packet</em>, unsigned long<em>&nbsp;type</em>, u8<em>&nbsp;priority</em>, const struct <a class="reference internal" href="client-api.html#c.ssh_packet_ops" title="ssh_packet_ops">ssh_packet_ops</a><em>&nbsp;*ops</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_packet_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize SSH packet.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*packet</span></code></dt>
<dd>The packet to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">type</span></code></dt>
<dd>Type-flags of the packet.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">priority</span></code></dt>
<dd>Priority of the packet. See <a class="reference internal" href="client-api.html#c.SSH_PACKET_PRIORITY" title="SSH_PACKET_PRIORITY"><code class="xref c c-func docutils literal notranslate"><span class="pre">SSH_PACKET_PRIORITY()</span></code></a> for details.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_packet_ops</span> <span class="pre">*ops</span></code></dt>
<dd>Packet operations.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given SSH packet. Sets the transmission buffer pointer to
<code class="docutils literal notranslate"><span class="pre">NULL</span></code> and the transmission buffer length to zero. For data-type packets,
this buffer has to be set separately via <a class="reference internal" href="client-api.html#c.ssh_packet_set_data" title="ssh_packet_set_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_packet_set_data()</span></code></a> before
submission, and must contain a valid SSH message, i.e. frame with optional
payload of any type.</p>
<dl class="function">
<dt id="c.ssh_ctrl_packet_cache_init">
int <code class="descname">ssh_ctrl_packet_cache_init</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ctrl_packet_cache_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the control packet cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<dl class="function">
<dt id="c.ssh_ctrl_packet_cache_destroy">
void <code class="descname">ssh_ctrl_packet_cache_destroy</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ctrl_packet_cache_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize the control packet cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<dl class="function">
<dt id="c.ssh_ctrl_packet_alloc">
int <code class="descname">ssh_ctrl_packet_alloc</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;**packet</em>, struct <a class="reference internal" href="client-api.html#c.ssam_span" title="ssam_span">ssam_span</a><em>&nbsp;*buffer</em>, <a class="reference internal" href="../../core-api/mm-api.html#c.gfp_t" title="gfp_t">gfp_t</a><em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ctrl_packet_alloc" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocate packet from control packet cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">**packet</span></code></dt>
<dd>Where the pointer to the newly allocated packet should be stored.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_span</span> <span class="pre">*buffer</span></code></dt>
<dd>The buffer corresponding to this packet.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">flags</span></code></dt>
<dd>Flags used for allocation.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Allocates a packet and corresponding transport buffer from the control
packet cache. Sets the packet’s buffer reference to the allocated buffer.
The packet must be freed via <a class="reference internal" href="#c.ssh_ctrl_packet_free" title="ssh_ctrl_packet_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_ctrl_packet_free()</span></code></a>, which will also free
the corresponding buffer. The corresponding buffer must not be freed
separately. Intended to be used with <code class="docutils literal notranslate"><span class="pre">ssh_ptl_ctrl_packet_ops</span></code> as packet
operations.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-ENOMEM</span></code> if the allocation failed.</p>
<dl class="function">
<dt id="c.ssh_ctrl_packet_free">
void <code class="descname">ssh_ctrl_packet_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ctrl_packet_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Free packet allocated from control packet cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet to free.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_ptl_tx_wakeup_packet">
void <code class="descname">ssh_ptl_tx_wakeup_packet</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_tx_wakeup_packet" title="Permalink to this definition">¶</a></dt>
<dd><p>Wake up packet transmitter thread for new packet.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Wakes up the packet transmitter thread, notifying it that a new packet has
arrived and is ready for transfer. If the packet transport layer has been
shut down, calls to this function will be ignored.</p>
<dl class="function">
<dt id="c.ssh_ptl_tx_start">
int <code class="descname">ssh_ptl_tx_start</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_tx_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Start packet transmitter thread.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssh_ptl_tx_stop">
int <code class="descname">ssh_ptl_tx_stop</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_tx_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop packet transmitter thread.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssh_ptl_submit">
int <code class="descname">ssh_ptl_submit</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em>, struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_submit" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit a packet to the transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer to submit the packet to.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet to submit.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Submits a new packet to the transport layer, queuing it to be sent. This
function should not be used for re-submission.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if a packet field is invalid or
the packet has been canceled prior to submission, <code class="docutils literal notranslate"><span class="pre">-EALREADY</span></code> if the packet
has already been submitted, or <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> if the packet transport layer
has been shut down.</p>
<dl class="function">
<dt id="c.ssh_ptl_cancel">
void <code class="descname">ssh_ptl_cancel</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_cancel" title="Permalink to this definition">¶</a></dt>
<dd><p>Cancel a packet.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet to cancel.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Cancels a packet. There are no guarantees on when completion and release
callbacks will be called. This may occur during execution of this function
or may occur at any point later.</p>
<p>Note that it is not guaranteed that the packet will actually be canceled if
the packet is concurrently completed by another process. The only guarantee
of this function is that the packet will be completed (with success,
failure, or cancellation) and released from the transport layer in a
reasonable time-frame.</p>
<p>May be called before the packet has been submitted, in which case any later
packet submission fails.</p>
<dl class="function">
<dt id="c.ssh_ptl_rx_start">
int <code class="descname">ssh_ptl_rx_start</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_rx_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Start packet transport layer receiver thread.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssh_ptl_rx_stop">
int <code class="descname">ssh_ptl_rx_stop</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_rx_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop packet transport layer receiver thread.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssh_ptl_rx_rcvbuf">
int <code class="descname">ssh_ptl_rx_rcvbuf</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em>, const u8<em>&nbsp;*buf</em>, size_t<em>&nbsp;n</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_rx_rcvbuf" title="Permalink to this definition">¶</a></dt>
<dd><p>Push data from lower-layer transport to the packet layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">u8</span> <span class="pre">*buf</span></code></dt>
<dd>Pointer to the data to push to the layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">n</span></code></dt>
<dd>Size of the data to push to the layer, in bytes.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Pushes data from a lower-layer transport to the receiver fifo buffer of the
packet layer and notifies the receiver thread. Calls to this function are
ignored once the packet layer has been shut down.</p>
<p><strong>Return</strong></p>
<p>Returns the number of bytes transferred (positive or zero) on
success. Returns <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> if the packet layer has been shut down.</p>
<dl class="function">
<dt id="c.ssh_ptl_shutdown">
void <code class="descname">ssh_ptl_shutdown</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_shutdown" title="Permalink to this definition">¶</a></dt>
<dd><p>Shut down the packet transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Shuts down the packet transport layer, removing and canceling all queued
and pending packets. Packets canceled by this operation will be completed
with <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> as status. Receiver and transmitter threads will be
stopped.</p>
<p>As a result of this function, the transport layer will be marked as shut
down. Submission of packets after the transport layer has been shut down
will fail with <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code>.</p>
<dl class="function">
<dt id="c.ssh_ptl_init">
int <code class="descname">ssh_ptl_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em>, struct serdev_device<em>&nbsp;*serdev</em>, struct <a class="reference internal" href="#c.ssh_ptl_ops" title="ssh_ptl_ops">ssh_ptl_ops</a><em>&nbsp;*ops</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize packet transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">serdev_device</span> <span class="pre">*serdev</span></code></dt>
<dd>The underlying serial device, i.e. the lower-level transport.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl_ops</span> <span class="pre">*ops</span></code></dt>
<dd>Packet layer operations.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given packet transport layer. Transmitter and receiver
threads must be started separately via <a class="reference internal" href="#c.ssh_ptl_tx_start" title="ssh_ptl_tx_start"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_ptl_tx_start()</span></code></a> and
<a class="reference internal" href="#c.ssh_ptl_rx_start" title="ssh_ptl_rx_start"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_ptl_rx_start()</span></code></a>, after the packet-layer has been initialized and the
lower-level transport layer has been set up.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success and a nonzero error code on failure.</p>
<dl class="function">
<dt id="c.ssh_ptl_destroy">
void <code class="descname">ssh_ptl_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_ptl" title="ssh_ptl">ssh_ptl</a><em>&nbsp;*ptl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_ptl_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize packet transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_ptl</span> <span class="pre">*ptl</span></code></dt>
<dd>The packet transport layer to deinitialize.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Deinitializes the given packet transport layer and frees resources
associated with it. If receiver and/or transmitter threads have been
started, the layer must first be shut down via <a class="reference internal" href="#c.ssh_ptl_shutdown" title="ssh_ptl_shutdown"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_ptl_shutdown()</span></code></a> before
this function can be called.</p>
</div>
<div class="section" id="request-transport-layer">
<h2><a class="toc-backref" href="#id3">Request Transport Layer</a><a class="headerlink" href="#request-transport-layer" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.ssh_rtl_state_flags">
enum <code class="descname">ssh_rtl_state_flags</code><a class="headerlink" href="#c.ssh_rtl_state_flags" title="Permalink to this definition">¶</a></dt>
<dd><p>State-flags for <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span></code></a>.</p>
</dd></dl>

<p><strong>Constants</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">SSH_RTL_SF_SHUTDOWN_BIT</span></code></p>
<blockquote>
<div>Indicates that the request transport layer has been shut down or is
being shut down and should not accept any new requests.</div></blockquote>
<dl class="type">
<dt id="c.ssh_rtl_ops">
struct <code class="descname">ssh_rtl_ops</code><a class="headerlink" href="#c.ssh_rtl_ops" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback operations for request transport layer.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_rtl_ops {
  void (*handle_event)(struct ssh_rtl *rtl, const struct ssh_command *cmd, const struct ssam_span *data);
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">handle_event</span></code></dt>
<dd>Function called when a SSH event has been received. The
specified function takes the request layer, received command
struct, and corresponding payload as arguments. If the event
has no payload, the payload span is empty (not <code class="docutils literal notranslate"><span class="pre">NULL</span></code>).</dd>
</dl>
<dl class="type">
<dt id="c.ssh_rtl">
struct <code class="descname">ssh_rtl</code><a class="headerlink" href="#c.ssh_rtl" title="Permalink to this definition">¶</a></dt>
<dd><p>SSH request transport layer.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_rtl {
  struct ssh_ptl ptl;
  unsigned long state;
  struct {
    spinlock_t lock;
    struct list_head head;
  } queue;
  struct {
    spinlock_t lock;
    struct list_head head;
    atomic_t count;
  } pending;
  struct {
    struct work_struct work;
  } tx;
  struct {
    spinlock_t lock;
    ktime_t timeout;
    ktime_t expires;
    struct delayed_work reaper;
  } rtx_timeout;
  struct ssh_rtl_ops ops;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">ptl</span></code></dt>
<dd>Underlying packet transport layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">state</span></code></dt>
<dd>State(-flags) of the transport layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue</span></code></dt>
<dd>Request submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue.lock</span></code></dt>
<dd>Lock for modifying the request submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">queue.head</span></code></dt>
<dd>List-head of the request submission queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending</span></code></dt>
<dd>Set/list of pending requests.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.lock</span></code></dt>
<dd>Lock for modifying the request set.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.head</span></code></dt>
<dd>List-head of the pending set/list.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending.count</span></code></dt>
<dd>Number of currently pending requests.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx</span></code></dt>
<dd>Transmitter subsystem.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tx.work</span></code></dt>
<dd>Transmitter work item.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout</span></code></dt>
<dd>Retransmission timeout subsystem.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.lock</span></code></dt>
<dd>Lock for modifying the retransmission timeout reaper.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.timeout</span></code></dt>
<dd>Timeout interval for retransmission.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.expires</span></code></dt>
<dd>Time specifying when the reaper work is next scheduled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtx_timeout.reaper</span></code></dt>
<dd>Work performing timeout checks and subsequent actions.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ops</span></code></dt>
<dd>Request layer operations.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_rtl_get_device">
struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a> * <code class="descname">ssh_rtl_get_device</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_get_device" title="Permalink to this definition">¶</a></dt>
<dd><p>Get device associated with request transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the device on which the given request transport layer
builds upon.</p>
<dl class="function">
<dt id="c.ssh_request_rtl">
struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a> * <code class="descname">ssh_request_rtl</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_request" title="ssh_request">ssh_request</a><em>&nbsp;*rqst</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_request_rtl" title="Permalink to this definition">¶</a></dt>
<dd><p>Get request transport layer associated with request.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_request</span> <span class="pre">*rqst</span></code></dt>
<dd>The request to get the request transport layer reference for.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span></code></a> associated with the given SSH request.</p>
<dl class="function">
<dt id="c.ssh_rtl_should_drop_response">
bool <code class="descname">ssh_rtl_should_drop_response</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_should_drop_response" title="Permalink to this definition">¶</a></dt>
<dd><p>Error injection hook to drop request responses.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Useful to cause request transmission timeouts in the driver by dropping the
response to a request.</p>
<dl class="function">
<dt id="c.ssh_rtl_submit">
int <code class="descname">ssh_rtl_submit</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em>, struct <a class="reference internal" href="client-api.html#c.ssh_request" title="ssh_request">ssh_request</a><em>&nbsp;*rqst</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_submit" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit a request to the transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_request</span> <span class="pre">*rqst</span></code></dt>
<dd>The request to submit.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Submits a request to the transport layer. A single request may not be
submitted multiple times without reinitializing it.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if the request type is invalid or
the request has been canceled prior to submission, <code class="docutils literal notranslate"><span class="pre">-EALREADY</span></code> if the
request has already been submitted, or <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> in case the request
transport layer has been shut down.</p>
<dl class="function">
<dt id="c.ssh_rtl_cancel">
bool <code class="descname">ssh_rtl_cancel</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_request" title="ssh_request">ssh_request</a><em>&nbsp;*rqst</em>, bool<em>&nbsp;pending</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_cancel" title="Permalink to this definition">¶</a></dt>
<dd><p>Cancel request.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_request</span> <span class="pre">*rqst</span></code></dt>
<dd>The request to cancel.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bool</span> <span class="pre">pending</span></code></dt>
<dd>Whether to also cancel pending requests.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Cancels the given request. If <strong>pending</strong> is <code class="docutils literal notranslate"><span class="pre">false</span></code>, this will not cancel
pending requests, i.e. requests that have already been submitted to the
packet layer but not been completed yet. If <strong>pending</strong> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, this will
cancel the given request regardless of the state it is in.</p>
<p>If the request has been canceled by calling this function, both completion
and release callbacks of the request will be executed in a reasonable
time-frame. This may happen during execution of this function, however,
there is no guarantee for this. For example, a request currently
transmitting will be canceled/completed only after transmission has
completed, and the respective callbacks will be executed on the transmitter
thread, which may happen during, but also some time after execution of the
cancel function.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the given request has been canceled or completed,
either by this function or prior to calling this function, <code class="docutils literal notranslate"><span class="pre">false</span></code>
otherwise. If <strong>pending</strong> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, this function will always return <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<dl class="function">
<dt id="c.ssh_request_init">
int <code class="descname">ssh_request_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssh_request" title="ssh_request">ssh_request</a><em>&nbsp;*rqst</em>, enum <a class="reference internal" href="client-api.html#c.ssam_request_flags" title="ssam_request_flags">ssam_request_flags</a><em>&nbsp;flags</em>, const struct <a class="reference internal" href="client-api.html#c.ssh_request_ops" title="ssh_request_ops">ssh_request_ops</a><em>&nbsp;*ops</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_request_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize SSH request.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_request</span> <span class="pre">*rqst</span></code></dt>
<dd>The request to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">enum</span> <span class="pre">ssam_request_flags</span> <span class="pre">flags</span></code></dt>
<dd>Request flags, determining the type of the request.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_request_ops</span> <span class="pre">*ops</span></code></dt>
<dd>Request operations.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given SSH request and underlying packet. Sets the message
buffer pointer to <code class="docutils literal notranslate"><span class="pre">NULL</span></code> and the message buffer length to zero. This buffer
has to be set separately via <a class="reference internal" href="client-api.html#c.ssh_request_set_data" title="ssh_request_set_data"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_request_set_data()</span></code></a> before submission and
must contain a valid SSH request message.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if the given flags are invalid.</p>
<dl class="function">
<dt id="c.ssh_rtl_init">
int <code class="descname">ssh_rtl_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em>, struct serdev_device<em>&nbsp;*serdev</em>, const struct <a class="reference internal" href="#c.ssh_rtl_ops" title="ssh_rtl_ops">ssh_rtl_ops</a><em>&nbsp;*ops</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize request transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">serdev_device</span> <span class="pre">*serdev</span></code></dt>
<dd>The underlying serial device, i.e. the lower-level transport.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_rtl_ops</span> <span class="pre">*ops</span></code></dt>
<dd>Request transport layer operations.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given request transport layer and associated packet
transport layer. Transmitter and receiver threads must be started
separately via <a class="reference internal" href="#c.ssh_rtl_start" title="ssh_rtl_start"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_rtl_start()</span></code></a>, after the request-layer has been
initialized and the lower-level serial device layer has been set up.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success and a nonzero error code on failure.</p>
<dl class="function">
<dt id="c.ssh_rtl_destroy">
void <code class="descname">ssh_rtl_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize request transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer to deinitialize.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Deinitializes the given request transport layer and frees resources
associated with it. If receiver and/or transmitter threads have been
started, the layer must first be shut down via <a class="reference internal" href="#c.ssh_rtl_shutdown" title="ssh_rtl_shutdown"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssh_rtl_shutdown()</span></code></a> before
this function can be called.</p>
<dl class="function">
<dt id="c.ssh_rtl_start">
int <code class="descname">ssh_rtl_start</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Start request transmitter and receiver.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssh_rtl_flush">
int <code class="descname">ssh_rtl_flush</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em>, unsigned long<em>&nbsp;timeout</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_flush" title="Permalink to this definition">¶</a></dt>
<dd><p>Flush the request transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>request transport layer</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unsigned</span> <span class="pre">long</span> <span class="pre">timeout</span></code></dt>
<dd>timeout for the flush operation in jiffies</dd>
</dl>
<p><strong>Description</strong></p>
<p>Queue a special flush request and wait for its completion. This request
will be completed after all other currently queued and pending requests
have been completed. Instead of a normal data packet, this request submits
a special flush packet, meaning that upon completion, also the underlying
packet transport layer has been flushed.</p>
<p>Flushing the request layer guarantees that all previously submitted
requests have been fully completed before this call returns. Additionally,
flushing blocks execution of all later submitted requests until the flush
has been completed.</p>
<p>If the caller ensures that no new requests are submitted after a call to
this function, the request transport layer is guaranteed to have no
remaining requests when this call returns. The same guarantee does not hold
for the packet layer, on which control packets may still be queued after
this call.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-ETIMEDOUT</span></code> if the flush timed out and has
been canceled as a result of the timeout, or <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> if the packet
and/or request transport layer has been shut down before this call. May
also return <code class="docutils literal notranslate"><span class="pre">-EINTR</span></code> if the underlying packet transmission has been
interrupted.</p>
<dl class="function">
<dt id="c.ssh_rtl_shutdown">
void <code class="descname">ssh_rtl_shutdown</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rtl" title="ssh_rtl">ssh_rtl</a><em>&nbsp;*rtl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rtl_shutdown" title="Permalink to this definition">¶</a></dt>
<dd><p>Shut down request transport layer.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rtl</span> <span class="pre">*rtl</span></code></dt>
<dd>The request transport layer.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Shuts down the request transport layer, removing and canceling all queued
and pending requests. Requests canceled by this operation will be completed
with <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code> as status. Receiver and transmitter threads will be
stopped, the lower-level packet layer will be shutdown.</p>
<p>As a result of this function, the transport layer will be marked as shut
down. Submission of requests after the transport layer has been shut down
will fail with <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code>.</p>
</div>
<div class="section" id="controller">
<h2><a class="toc-backref" href="#id4">Controller</a><a class="headerlink" href="#controller" title="Permalink to this headline">¶</a></h2>
<dl class="type">
<dt id="c.ssh_seq_counter">
struct <code class="descname">ssh_seq_counter</code><a class="headerlink" href="#c.ssh_seq_counter" title="Permalink to this definition">¶</a></dt>
<dd><p>Safe counter for SSH sequence IDs.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_seq_counter {
  u8 value;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">value</span></code></dt>
<dd>The current counter value.</dd>
</dl>
<dl class="type">
<dt id="c.ssh_rqid_counter">
struct <code class="descname">ssh_rqid_counter</code><a class="headerlink" href="#c.ssh_rqid_counter" title="Permalink to this definition">¶</a></dt>
<dd><p>Safe counter for SSH request IDs.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_rqid_counter {
  u16 value;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">value</span></code></dt>
<dd>The current counter value.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_nf_head">
struct <code class="descname">ssam_nf_head</code><a class="headerlink" href="#c.ssam_nf_head" title="Permalink to this definition">¶</a></dt>
<dd><p>Notifier head for SSAM events.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_nf_head {
  struct srcu_struct srcu;
  struct list_head head;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">srcu</span></code></dt>
<dd>The SRCU struct for synchronization.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">head</span></code></dt>
<dd>List-head for notifier blocks registered under this head.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_nf">
struct <code class="descname">ssam_nf</code><a class="headerlink" href="#c.ssam_nf" title="Permalink to this definition">¶</a></dt>
<dd><p>Notifier callback- and activation-registry for SSAM events.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_nf {
  struct mutex lock;
  struct rb_root refcount;
  struct ssam_nf_head head[SSH_NUM_EVENTS];
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">lock</span></code></dt>
<dd>Lock guarding (de-)registration of notifier blocks. Note: This
lock does not need to be held for notifier calls, only
registration and deregistration.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">refcount</span></code></dt>
<dd>The root of the RB-tree used for reference-counting enabled
events/notifications.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">head</span></code></dt>
<dd>The list of notifier heads for event/notification callbacks.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_event_item">
struct <code class="descname">ssam_event_item</code><a class="headerlink" href="#c.ssam_event_item" title="Permalink to this definition">¶</a></dt>
<dd><p>Struct for event queuing and completion.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_event_item {
  struct list_head node;
  u16 rqid;
  struct {
    void (*free)(struct ssam_event_item *event);
  } ops;
  struct ssam_event event;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">node</span></code></dt>
<dd>The node in the queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rqid</span></code></dt>
<dd>The request ID of the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ops</span></code></dt>
<dd>Instance specific functions.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ops.free</span></code></dt>
<dd>Callback for freeing this event item.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event</span></code></dt>
<dd>Actual event data.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_event_queue">
struct <code class="descname">ssam_event_queue</code><a class="headerlink" href="#c.ssam_event_queue" title="Permalink to this definition">¶</a></dt>
<dd><p>Queue for completing received events.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_event_queue {
  struct ssam_cplt *cplt;
  spinlock_t lock;
  struct list_head head;
  struct work_struct work;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">cplt</span></code></dt>
<dd>Reference to the completion system on which this queue is active.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lock</span></code></dt>
<dd>The lock for any operation on the queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">head</span></code></dt>
<dd>The list-head of the queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">work</span></code></dt>
<dd>The <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">work_struct</span></code> performing completion work for this queue.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_event_target">
struct <code class="descname">ssam_event_target</code><a class="headerlink" href="#c.ssam_event_target" title="Permalink to this definition">¶</a></dt>
<dd><p>Set of queues for a single SSH target ID.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_event_target {
  struct ssam_event_queue queue[SSH_NUM_EVENTS];
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">queue</span></code></dt>
<dd>The array of queues, one queue per event ID.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_cplt">
struct <code class="descname">ssam_cplt</code><a class="headerlink" href="#c.ssam_cplt" title="Permalink to this definition">¶</a></dt>
<dd><p>SSAM event/async request completion system.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_cplt {
  struct device *dev;
  struct workqueue_struct *wq;
  struct {
    struct ssam_event_target target[SSH_NUM_TARGETS];
    struct ssam_nf notif;
  } event;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">dev</span></code></dt>
<dd>The device with which this system is associated. Only used
for logging.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">wq</span></code></dt>
<dd>The <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">workqueue_struct</span></code> on which all completion work
items are queued.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event</span></code></dt>
<dd>Event completion management.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event.target</span></code></dt>
<dd>Array of <a class="reference internal" href="#c.ssam_event_target" title="ssam_event_target"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_target</span></code></a>, one for each target.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">event.notif</span></code></dt>
<dd>Notifier callbacks and event activation reference counting.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_controller_state">
enum <code class="descname">ssam_controller_state</code><a class="headerlink" href="#c.ssam_controller_state" title="Permalink to this definition">¶</a></dt>
<dd><p>State values for <a class="reference internal" href="#c.ssam_controller" title="ssam_controller"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span></code></a>.</p>
</dd></dl>

<p><strong>Constants</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">SSAM_CONTROLLER_UNINITIALIZED</span></code></p>
<blockquote>
<div>The controller has not been initialized yet or has been deinitialized.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SSAM_CONTROLLER_INITIALIZED</span></code></p>
<blockquote>
<div>The controller is initialized, but has not been started yet.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SSAM_CONTROLLER_STARTED</span></code></p>
<blockquote>
<div>The controller has been started and is ready to use.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SSAM_CONTROLLER_STOPPED</span></code></p>
<blockquote>
<div>The controller has been stopped.</div></blockquote>
<p><code class="docutils literal notranslate"><span class="pre">SSAM_CONTROLLER_SUSPENDED</span></code></p>
<blockquote>
<div>The controller has been suspended.</div></blockquote>
<dl class="type">
<dt id="c.ssam_controller_caps">
struct <code class="descname">ssam_controller_caps</code><a class="headerlink" href="#c.ssam_controller_caps" title="Permalink to this definition">¶</a></dt>
<dd><p>Controller device capabilities.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_controller_caps {
  u32 ssh_power_profile;
  u32 ssh_buffer_size;
  u32 screen_on_sleep_idle_timeout;
  u32 screen_off_sleep_idle_timeout;
  u32 d3_closes_handle:1;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">ssh_power_profile</span></code></dt>
<dd>SSH power profile.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ssh_buffer_size</span></code></dt>
<dd>SSH driver UART buffer size.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">screen_on_sleep_idle_timeout</span></code></dt>
<dd>SAM UART screen-on sleep idle timeout.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">screen_off_sleep_idle_timeout</span></code></dt>
<dd>SAM UART screen-off sleep idle timeout.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">d3_closes_handle</span></code></dt>
<dd>SAM closes UART handle in D3.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Controller and SSH device capabilities found in ACPI.</p>
<dl class="type">
<dt id="c.ssam_controller">
struct <code class="descname">ssam_controller</code><a class="headerlink" href="#c.ssam_controller" title="Permalink to this definition">¶</a></dt>
<dd><p>SSAM controller device.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_controller {
  struct kref kref;
  struct rw_semaphore lock;
  enum ssam_controller_state state;
  struct ssh_rtl rtl;
  struct ssam_cplt cplt;
  struct {
    struct ssh_seq_counter seq;
    struct ssh_rqid_counter rqid;
  } counter;
  struct {
    int num;
    bool wakeup_enabled;
  } irq;
  struct ssam_controller_caps caps;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">kref</span></code></dt>
<dd>Reference count of the controller.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">lock</span></code></dt>
<dd>Main lock for the controller, used to guard state changes.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">state</span></code></dt>
<dd>Controller state.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">rtl</span></code></dt>
<dd>Request transport layer for SSH I/O.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cplt</span></code></dt>
<dd>Completion system for SSH/SSAM events and asynchronous requests.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">counter</span></code></dt>
<dd>Safe SSH message ID counters.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">counter.seq</span></code></dt>
<dd>Sequence ID counter.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">counter.rqid</span></code></dt>
<dd>Request ID counter.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irq</span></code></dt>
<dd>Wakeup IRQ resources.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irq.num</span></code></dt>
<dd>The wakeup IRQ number.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">irq.wakeup_enabled</span></code></dt>
<dd>Whether wakeup by IRQ is enabled during suspend.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">caps</span></code></dt>
<dd>The controller device capabilities.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_controller_receive_buf">
int <code class="descname">ssam_controller_receive_buf</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, const unsigned char<em>&nbsp;*buf</em>, size_t<em>&nbsp;n</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_receive_buf" title="Permalink to this definition">¶</a></dt>
<dd><p>Provide input-data to the controller.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">unsigned</span> <span class="pre">char</span> <span class="pre">*buf</span></code></dt>
<dd>The input buffer.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">n</span></code></dt>
<dd>The number of bytes in the input buffer.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Provide input data to be evaluated by the controller, which has been
received via the lower-level transport.</p>
<p><strong>Return</strong></p>
<p>Returns the number of bytes consumed, or, if the packet transport
layer of the controller has been shut down, <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code>.</p>
<dl class="function">
<dt id="c.ssam_controller_write_wakeup">
void <code class="descname">ssam_controller_write_wakeup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_write_wakeup" title="Permalink to this definition">¶</a></dt>
<dd><p>Notify the controller that the underlying device has space available for data to be written.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_seq_reset">
void <code class="descname">ssh_seq_reset</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_seq_counter" title="ssh_seq_counter">ssh_seq_counter</a><em>&nbsp;*c</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_seq_reset" title="Permalink to this definition">¶</a></dt>
<dd><p>Reset/initialize sequence ID counter.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_seq_counter</span> <span class="pre">*c</span></code></dt>
<dd>The counter to reset.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_seq_next">
u8 <code class="descname">ssh_seq_next</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_seq_counter" title="ssh_seq_counter">ssh_seq_counter</a><em>&nbsp;*c</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_seq_next" title="Permalink to this definition">¶</a></dt>
<dd><p>Get next sequence ID.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_seq_counter</span> <span class="pre">*c</span></code></dt>
<dd>The counter providing the sequence IDs.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the next sequence ID of the counter.</p>
<dl class="function">
<dt id="c.ssh_rqid_reset">
void <code class="descname">ssh_rqid_reset</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rqid_counter" title="ssh_rqid_counter">ssh_rqid_counter</a><em>&nbsp;*c</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rqid_reset" title="Permalink to this definition">¶</a></dt>
<dd><p>Reset/initialize request ID counter.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rqid_counter</span> <span class="pre">*c</span></code></dt>
<dd>The counter to reset.</dd>
</dl>
<dl class="function">
<dt id="c.ssh_rqid_next">
u16 <code class="descname">ssh_rqid_next</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssh_rqid_counter" title="ssh_rqid_counter">ssh_rqid_counter</a><em>&nbsp;*c</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssh_rqid_next" title="Permalink to this definition">¶</a></dt>
<dd><p>Get next request ID.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssh_rqid_counter</span> <span class="pre">*c</span></code></dt>
<dd>The counter providing the request IDs.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the next request ID of the counter, skipping any reserved
request IDs.</p>
<dl class="function">
<dt id="c.ssam_event_matches_notifier">
bool <code class="descname">ssam_event_matches_notifier</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssam_event_notifier" title="ssam_event_notifier">ssam_event_notifier</a><em>&nbsp;*n</em>, const struct <a class="reference internal" href="client-api.html#c.ssam_event" title="ssam_event">ssam_event</a><em>&nbsp;*event</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_matches_notifier" title="Permalink to this definition">¶</a></dt>
<dd><p>Test if an event matches a notifier.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_event_notifier</span> <span class="pre">*n</span></code></dt>
<dd>The event notifier to test against.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_event</span> <span class="pre">*event</span></code></dt>
<dd>The event to test.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the given event matches the given notifier
according to the rules set in the notifier’s event mask, <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<dl class="function">
<dt id="c.ssam_nfblk_call_chain">
int <code class="descname">ssam_nfblk_call_chain</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf_head" title="ssam_nf_head">ssam_nf_head</a><em>&nbsp;*nh</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event" title="ssam_event">ssam_event</a><em>&nbsp;*event</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nfblk_call_chain" title="Permalink to this definition">¶</a></dt>
<dd><p>Call event notifier callbacks of the given chain.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_head</span> <span class="pre">*nh</span></code></dt>
<dd>The notifier head for which the notifier callbacks should be called.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event</span> <span class="pre">*event</span></code></dt>
<dd>The event data provided to the callbacks.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Call all registered notifier callbacks in order of their priority until
either no notifier is left or a notifier returns a value with the
<code class="docutils literal notranslate"><span class="pre">SSAM_NOTIF_STOP</span></code> bit set. Note that this bit is automatically set via
<a class="reference internal" href="client-api.html#c.ssam_notifier_from_errno" title="ssam_notifier_from_errno"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_from_errno()</span></code></a> on any non-zero error value.</p>
<p><strong>Return</strong></p>
<p>Returns the notifier status value, which contains the notifier
status bits (<code class="docutils literal notranslate"><span class="pre">SSAM_NOTIF_HANDLED</span></code> and <code class="docutils literal notranslate"><span class="pre">SSAM_NOTIF_STOP</span></code>) as well as a
potential error value returned from the last executed notifier callback.
Use <a class="reference internal" href="client-api.html#c.ssam_notifier_to_errno" title="ssam_notifier_to_errno"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_to_errno()</span></code></a> to convert this value to the original error
value.</p>
<dl class="function">
<dt id="c.ssam_nfblk_insert">
int <code class="descname">ssam_nfblk_insert</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf_head" title="ssam_nf_head">ssam_nf_head</a><em>&nbsp;*nh</em>, struct <a class="reference internal" href="client-api.html#c.ssam_notifier_block" title="ssam_notifier_block">ssam_notifier_block</a><em>&nbsp;*nb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nfblk_insert" title="Permalink to this definition">¶</a></dt>
<dd><p>Insert a new notifier block into the given notifier list.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_head</span> <span class="pre">*nh</span></code></dt>
<dd>The notifier head into which the block should be inserted.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_notifier_block</span> <span class="pre">*nb</span></code></dt>
<dd>The notifier block to add.</dd>
</dl>
<p><strong>Note</strong></p>
<p>This function must be synchronized by the caller with respect to other
insert, find, and/or remove calls by holding <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf.lock</span></code>.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-EEXIST</span></code> if the notifier block has already
been registered.</p>
<dl class="function">
<dt id="c.ssam_nfblk_find">
bool <code class="descname">ssam_nfblk_find</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf_head" title="ssam_nf_head">ssam_nf_head</a><em>&nbsp;*nh</em>, struct <a class="reference internal" href="client-api.html#c.ssam_notifier_block" title="ssam_notifier_block">ssam_notifier_block</a><em>&nbsp;*nb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nfblk_find" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if a notifier block is registered on the given notifier head. list.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_head</span> <span class="pre">*nh</span></code></dt>
<dd>The notifier head on which to search.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_notifier_block</span> <span class="pre">*nb</span></code></dt>
<dd>The notifier block to search for.</dd>
</dl>
<p><strong>Note</strong></p>
<p>This function must be synchronized by the caller with respect to other
insert, find, and/or remove calls by holding <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf.lock</span></code>.</p>
<p><strong>Return</strong></p>
<p>Returns true if the given notifier block is registered on the given
notifier head, false otherwise.</p>
<dl class="function">
<dt id="c.ssam_nfblk_remove">
void <code class="descname">ssam_nfblk_remove</code><span class="sig-paren">(</span>struct <a class="reference internal" href="client-api.html#c.ssam_notifier_block" title="ssam_notifier_block">ssam_notifier_block</a><em>&nbsp;*nb</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nfblk_remove" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove a notifier block from its notifier list.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_notifier_block</span> <span class="pre">*nb</span></code></dt>
<dd>The notifier block to be removed.</dd>
</dl>
<p><strong>Note</strong></p>
<p>This function must be synchronized by the caller with respect to
other insert, find, and/or remove calls by holding <code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf.lock</span></code>.
Furthermore, the caller _must_ ensure SRCU synchronization by calling
<a class="reference internal" href="../../core-api/kernel-api.html#c.synchronize_srcu" title="synchronize_srcu"><code class="xref c c-func docutils literal notranslate"><span class="pre">synchronize_srcu()</span></code></a> with <code class="docutils literal notranslate"><span class="pre">nh-&gt;srcu</span></code> after leaving the critical section, to
ensure that the removed notifier block is not in use any more.</p>
<dl class="function">
<dt id="c.ssam_nf_head_init">
int <code class="descname">ssam_nf_head_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf_head" title="ssam_nf_head">ssam_nf_head</a><em>&nbsp;*nh</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_head_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the given notifier head.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_head</span> <span class="pre">*nh</span></code></dt>
<dd>The notifier head to initialize.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_nf_head_destroy">
void <code class="descname">ssam_nf_head_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf_head" title="ssam_nf_head">ssam_nf_head</a><em>&nbsp;*nh</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_head_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize the given notifier head.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_head</span> <span class="pre">*nh</span></code></dt>
<dd>The notifier head to deinitialize.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_nf_refcount_key">
struct <code class="descname">ssam_nf_refcount_key</code><a class="headerlink" href="#c.ssam_nf_refcount_key" title="Permalink to this definition">¶</a></dt>
<dd><p>Key used for event activation reference counting.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_nf_refcount_key {
  struct ssam_event_registry reg;
  struct ssam_event_id id;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">reg</span></code></dt>
<dd>The registry via which the event is enabled/disabled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">id</span></code></dt>
<dd>The ID uniquely describing the event.</dd>
</dl>
<dl class="type">
<dt id="c.ssam_nf_refcount_entry">
struct <code class="descname">ssam_nf_refcount_entry</code><a class="headerlink" href="#c.ssam_nf_refcount_entry" title="Permalink to this definition">¶</a></dt>
<dd><p>RB-tree entry for reference counting event activations.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssam_nf_refcount_entry {
  struct rb_node node;
  struct ssam_nf_refcount_key key;
  int refcount;
  u8 flags;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">node</span></code></dt>
<dd>The node of this entry in the rb-tree.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">key</span></code></dt>
<dd>The key of the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">refcount</span></code></dt>
<dd>The reference-count of the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt>
<dd>The flags used when enabling the event.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_nf_refcount_inc">
struct <a class="reference internal" href="#c.ssam_nf_refcount_entry" title="ssam_nf_refcount_entry">ssam_nf_refcount_entry</a> * <code class="descname">ssam_nf_refcount_inc</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_registry" title="ssam_event_registry">ssam_event_registry</a><em>&nbsp;reg</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_id" title="ssam_event_id">ssam_event_id</a><em>&nbsp;id</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_inc" title="Permalink to this definition">¶</a></dt>
<dd><p>Increment reference-/activation-count of the given event.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system reference.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_registry</span> <span class="pre">reg</span></code></dt>
<dd>The registry used to enable/disable the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_id</span> <span class="pre">id</span></code></dt>
<dd>The event ID.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Increments the reference-/activation-count associated with the specified
event type/ID, allocating a new entry for this event ID if necessary. A
newly allocated entry will have a refcount of one.</p>
<p><strong>Note</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">nf-&gt;lock</span></code> must be held when calling this function.</p>
<p><strong>Return</strong></p>
<p>Returns the refcount entry on success. Returns an error pointer
with <code class="docutils literal notranslate"><span class="pre">-ENOSPC</span></code> if there have already been <code class="docutils literal notranslate"><span class="pre">INT_MAX</span></code> events of the specified
ID and type registered, or <code class="docutils literal notranslate"><span class="pre">-ENOMEM</span></code> if the entry could not be allocated.</p>
<dl class="function">
<dt id="c.ssam_nf_refcount_dec">
struct <a class="reference internal" href="#c.ssam_nf_refcount_entry" title="ssam_nf_refcount_entry">ssam_nf_refcount_entry</a> * <code class="descname">ssam_nf_refcount_dec</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_registry" title="ssam_event_registry">ssam_event_registry</a><em>&nbsp;reg</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_id" title="ssam_event_id">ssam_event_id</a><em>&nbsp;id</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_dec" title="Permalink to this definition">¶</a></dt>
<dd><p>Decrement reference-/activation-count of the given event.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system reference.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_registry</span> <span class="pre">reg</span></code></dt>
<dd>The registry used to enable/disable the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_id</span> <span class="pre">id</span></code></dt>
<dd>The event ID.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Decrements the reference-/activation-count of the specified event,
returning its entry. If the returned entry has a refcount of zero, the
caller is responsible for freeing it using <a class="reference internal" href="../../core-api/mm-api.html#c.kfree" title="kfree"><code class="xref c c-func docutils literal notranslate"><span class="pre">kfree()</span></code></a>.</p>
<p><strong>Note</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">nf-&gt;lock</span></code> must be held when calling this function.</p>
<p><strong>Return</strong></p>
<p>Returns the refcount entry on success or <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if the entry has not
been found.</p>
<dl class="function">
<dt id="c.ssam_nf_refcount_dec_free">
void <code class="descname">ssam_nf_refcount_dec_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_registry" title="ssam_event_registry">ssam_event_registry</a><em>&nbsp;reg</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_id" title="ssam_event_id">ssam_event_id</a><em>&nbsp;id</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_dec_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Decrement reference-/activation-count of the given event and free its entry if the reference count reaches zero.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system reference.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_registry</span> <span class="pre">reg</span></code></dt>
<dd>The registry used to enable/disable the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_id</span> <span class="pre">id</span></code></dt>
<dd>The event ID.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Decrements the reference-/activation-count of the specified event, freeing
its entry if it reaches zero.</p>
<p><strong>Note</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">nf-&gt;lock</span></code> must be held when calling this function.</p>
<dl class="function">
<dt id="c.ssam_nf_refcount_empty">
bool <code class="descname">ssam_nf_refcount_empty</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_empty" title="Permalink to this definition">¶</a></dt>
<dd><p>Test if the notification system has any enabled/active events.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notification system.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_nf_call">
void <code class="descname">ssam_nf_call</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em>, struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a><em>&nbsp;*dev</em>, u16<em>&nbsp;rqid</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event" title="ssam_event">ssam_event</a><em>&nbsp;*event</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_call" title="Permalink to this definition">¶</a></dt>
<dd><p>Call notification callbacks for the provided event.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code></dt>
<dd>The associated device, only used for logging.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">rqid</span></code></dt>
<dd>The request ID of the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event</span> <span class="pre">*event</span></code></dt>
<dd>The event provided to the callbacks.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Execute registered callbacks in order of their priority until either no
callback is left or a callback returns a value with the <code class="docutils literal notranslate"><span class="pre">SSAM_NOTIF_STOP</span></code>
bit set. Note that this bit is set automatically when converting non-zero
error values via <a class="reference internal" href="client-api.html#c.ssam_notifier_from_errno" title="ssam_notifier_from_errno"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_from_errno()</span></code></a> to notifier values.</p>
<p>Also note that any callback that could handle an event should return a value
with bit <code class="docutils literal notranslate"><span class="pre">SSAM_NOTIF_HANDLED</span></code> set, indicating that the event does not go
unhandled/ignored. In case no registered callback could handle an event,
this function will emit a warning.</p>
<p>In case a callback failed, this function will emit an error message.</p>
<dl class="function">
<dt id="c.ssam_nf_init">
int <code class="descname">ssam_nf_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the notifier system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system to initialize.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_nf_destroy">
void <code class="descname">ssam_nf_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_nf" title="ssam_nf">ssam_nf</a><em>&nbsp;*nf</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize the notifier system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf</span> <span class="pre">*nf</span></code></dt>
<dd>The notifier system to deinitialize.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_event_item_cache_init">
int <code class="descname">ssam_event_item_cache_init</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_item_cache_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize the event item cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<dl class="function">
<dt id="c.ssam_event_item_cache_destroy">
void <code class="descname">ssam_event_item_cache_destroy</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_item_cache_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize the event item cache.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<dl class="function">
<dt id="c.ssam_event_item_free">
void <code class="descname">ssam_event_item_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_event_item" title="ssam_event_item">ssam_event_item</a><em>&nbsp;*item</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_item_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Free the provided event item.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_item</span> <span class="pre">*item</span></code></dt>
<dd>The event item to free.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_event_item_alloc">
struct <a class="reference internal" href="#c.ssam_event_item" title="ssam_event_item">ssam_event_item</a> * <code class="descname">ssam_event_item_alloc</code><span class="sig-paren">(</span>size_t<em>&nbsp;len</em>, <a class="reference internal" href="../../core-api/mm-api.html#c.gfp_t" title="gfp_t">gfp_t</a><em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_item_alloc" title="Permalink to this definition">¶</a></dt>
<dd><p>Allocate an event item with the given payload size.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">size_t</span> <span class="pre">len</span></code></dt>
<dd>The event payload length.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gfp_t</span> <span class="pre">flags</span></code></dt>
<dd>The flags used for allocation.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Allocate an event item with the given payload size, preferring allocation
from the event item cache if the payload is small enough (i.e. smaller than
<code class="docutils literal notranslate"><span class="pre">SSAM_EVENT_ITEM_CACHE_PAYLOAD_LEN</span></code>). Sets the item operations and payload
length values. The item free callback (<code class="docutils literal notranslate"><span class="pre">ops.free</span></code>) should not be
overwritten after this call.</p>
<p><strong>Return</strong></p>
<p>Returns the newly allocated event item.</p>
<dl class="function">
<dt id="c.ssam_event_queue_push">
void <code class="descname">ssam_event_queue_push</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_event_queue" title="ssam_event_queue">ssam_event_queue</a><em>&nbsp;*q</em>, struct <a class="reference internal" href="#c.ssam_event_item" title="ssam_event_item">ssam_event_item</a><em>&nbsp;*item</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_queue_push" title="Permalink to this definition">¶</a></dt>
<dd><p>Push an event item to the event queue.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_queue</span> <span class="pre">*q</span></code></dt>
<dd>The event queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_item</span> <span class="pre">*item</span></code></dt>
<dd>The item to add.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_event_queue_pop">
struct <a class="reference internal" href="#c.ssam_event_item" title="ssam_event_item">ssam_event_item</a> * <code class="descname">ssam_event_queue_pop</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_event_queue" title="ssam_event_queue">ssam_event_queue</a><em>&nbsp;*q</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_queue_pop" title="Permalink to this definition">¶</a></dt>
<dd><p>Pop the next event item from the event queue.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_queue</span> <span class="pre">*q</span></code></dt>
<dd>The event queue.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Returns and removes the next event item from the queue. Returns <code class="docutils literal notranslate"><span class="pre">NULL</span></code> If
there is no event item left.</p>
<dl class="function">
<dt id="c.ssam_event_queue_is_empty">
bool <code class="descname">ssam_event_queue_is_empty</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_event_queue" title="ssam_event_queue">ssam_event_queue</a><em>&nbsp;*q</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_queue_is_empty" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if the event queue is empty.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_queue</span> <span class="pre">*q</span></code></dt>
<dd>The event queue.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_cplt_get_event_queue">
struct <a class="reference internal" href="#c.ssam_event_queue" title="ssam_event_queue">ssam_event_queue</a> * <code class="descname">ssam_cplt_get_event_queue</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em>, u8<em>&nbsp;tid</em>, u16<em>&nbsp;rqid</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_get_event_queue" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the event queue for the given parameters.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system on which to look for the queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">tid</span></code></dt>
<dd>The target ID of the queue.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u16</span> <span class="pre">rqid</span></code></dt>
<dd>The request ID representing the event ID for which to get the queue.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the event queue corresponding to the event type described
by the given parameters. If the request ID does not represent an event,
this function returns <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. If the target ID is not supported, this
function will fall back to the default target ID (<code class="docutils literal notranslate"><span class="pre">tid</span> <span class="pre">=</span> <span class="pre">1</span></code>).</p>
<dl class="function">
<dt id="c.ssam_cplt_submit">
bool <code class="descname">ssam_cplt_submit</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em>, struct work_struct<em>&nbsp;*work</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_submit" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit a work item to the completion system workqueue.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">work_struct</span> <span class="pre">*work</span></code></dt>
<dd>The work item to submit.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_cplt_submit_event">
int <code class="descname">ssam_cplt_submit_event</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em>, struct <a class="reference internal" href="#c.ssam_event_item" title="ssam_event_item">ssam_event_item</a><em>&nbsp;*item</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_submit_event" title="Permalink to this definition">¶</a></dt>
<dd><p>Submit an event to the completion system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_item</span> <span class="pre">*item</span></code></dt>
<dd>The event item to submit.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Submits the event to the completion system by queuing it on the event item
queue and queuing the respective event queue work item on the completion
workqueue, which will eventually complete the event.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if there is no event queue that
can handle the given event item.</p>
<dl class="function">
<dt id="c.ssam_cplt_flush">
void <code class="descname">ssam_cplt_flush</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_flush" title="Permalink to this definition">¶</a></dt>
<dd><p>Flush the completion system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Flush the completion system by waiting until all currently submitted work
items have been completed.</p>
<p>This operation is only intended to, during normal operation prior to
shutdown, try to complete most events and requests to get them out of the
system while the system is still fully operational. It does not aim to
provide any guarantee that all of them have been handled.</p>
<p><strong>Note</strong></p>
<p>This function does not guarantee that all events will have been
handled once this call terminates. In case of a larger number of
to-be-completed events, the event queue work function may re-schedule its
work item, which this flush operation will ignore.</p>
<dl class="function">
<dt id="c.ssam_event_queue_init">
void <code class="descname">ssam_event_queue_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em>, struct <a class="reference internal" href="#c.ssam_event_queue" title="ssam_event_queue">ssam_event_queue</a><em>&nbsp;*evq</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_event_queue_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize an event queue.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system on which the queue resides.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_queue</span> <span class="pre">*evq</span></code></dt>
<dd>The event queue to initialize.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_cplt_init">
int <code class="descname">ssam_cplt_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em>, struct <a class="reference internal" href="../infrastructure.html#c.device" title="device">device</a><em>&nbsp;*dev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize completion system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">device</span> <span class="pre">*dev</span></code></dt>
<dd>The device used for logging.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_cplt_destroy">
void <code class="descname">ssam_cplt_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_cplt" title="ssam_cplt">ssam_cplt</a><em>&nbsp;*cplt</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_cplt_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Deinitialize the completion system.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_cplt</span> <span class="pre">*cplt</span></code></dt>
<dd>The completion system to deinitialize.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Deinitialize the given completion system and ensure that all pending, i.e.
yet-to-be-completed, event items and requests have been handled.</p>
<dl class="function">
<dt id="c.ssam_controller_lock">
void <code class="descname">ssam_controller_lock</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*c</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_lock" title="Permalink to this definition">¶</a></dt>
<dd><p>Acquire the main controller lock.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*c</span></code></dt>
<dd>The controller to lock.</dd>
</dl>
<p><strong>Description</strong></p>
<p>This lock must be held for any state transitions, including transition to
suspend/resumed states and during shutdown. See <a class="reference internal" href="client-api.html#c.ssam_controller_statelock" title="ssam_controller_statelock"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_statelock()</span></code></a>
for more details on controller locking.</p>
<p>See ssam_controller_unlock() for the corresponding unlock function.</p>
<dl class="function">
<dt id="c.ssam_controller_caps_load_from_acpi">
int <code class="descname">ssam_controller_caps_load_from_acpi</code><span class="sig-paren">(</span>acpi_handle<em>&nbsp;handle</em>, struct <a class="reference internal" href="#c.ssam_controller_caps" title="ssam_controller_caps">ssam_controller_caps</a><em>&nbsp;*caps</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_caps_load_from_acpi" title="Permalink to this definition">¶</a></dt>
<dd><p>Load controller capabilities from ACPI _DSM.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">acpi_handle</span> <span class="pre">handle</span></code></dt>
<dd>The handle of the ACPI controller/SSH device.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller_caps</span> <span class="pre">*caps</span></code></dt>
<dd>Where to store the capabilities in.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given controller capabilities with default values, then
checks and, if the respective _DSM functions are available, loads the
actual capabilities from the _DSM.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success, a negative error code on failure.</p>
<dl class="function">
<dt id="c.ssam_controller_init">
int <code class="descname">ssam_controller_init</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, struct serdev_device<em>&nbsp;*serdev</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize SSAM controller.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to initialize.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">serdev_device</span> <span class="pre">*serdev</span></code></dt>
<dd>The serial device representing the underlying data transport.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Initializes the given controller. Does neither start receiver nor
transmitter threads. After this call, the controller has to be hooked up to
the serdev core separately via <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">serdev_device_ops</span></code>, relaying calls to
<a class="reference internal" href="#c.ssam_controller_receive_buf" title="ssam_controller_receive_buf"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_receive_buf()</span></code></a> and <a class="reference internal" href="#c.ssam_controller_write_wakeup" title="ssam_controller_write_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_write_wakeup()</span></code></a>. Once the
controller has been hooked up, transmitter and receiver threads may be
started via <a class="reference internal" href="#c.ssam_controller_start" title="ssam_controller_start"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_start()</span></code></a>. These setup steps need to be completed
before controller can be used for requests.</p>
<dl class="function">
<dt id="c.ssam_controller_start">
int <code class="descname">ssam_controller_start</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_start" title="Permalink to this definition">¶</a></dt>
<dd><p>Start the receiver and transmitter threads of the controller.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<p><strong>Note</strong></p>
<p>When this function is called, the controller should be properly
hooked up to the serdev core via <code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">serdev_device_ops</span></code>. Please refer
to <a class="reference internal" href="#c.ssam_controller_init" title="ssam_controller_init"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_init()</span></code></a> for more details on controller initialization.</p>
<p><strong>Description</strong></p>
<p>This function must be called with the main controller lock held (i.e. by
calling <a class="reference internal" href="#c.ssam_controller_lock" title="ssam_controller_lock"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_lock()</span></code></a>).</p>
<dl class="function">
<dt id="c.ssam_controller_shutdown">
void <code class="descname">ssam_controller_shutdown</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_shutdown" title="Permalink to this definition">¶</a></dt>
<dd><p>Shut down the controller.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Shuts down the controller by flushing all pending requests and stopping the
transmitter and receiver threads. All requests submitted after this call
will fail with <code class="docutils literal notranslate"><span class="pre">-ESHUTDOWN</span></code>. While it is discouraged to do so, this function
is safe to use in parallel with ongoing request submission.</p>
<p>In the course of this shutdown procedure, all currently registered
notifiers will be unregistered. It is, however, strongly recommended to not
rely on this behavior, and instead the party registering the notifier
should unregister it before the controller gets shut down, e.g. via the
SSAM bus which guarantees client devices to be removed before a shutdown.</p>
<p>Note that events may still be pending after this call, but, due to the
notifiers being unregistered, these events will be dropped when the
controller is subsequently destroyed via <a class="reference internal" href="#c.ssam_controller_destroy" title="ssam_controller_destroy"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_destroy()</span></code></a>.</p>
<p>This function must be called with the main controller lock held (i.e. by
calling <a class="reference internal" href="#c.ssam_controller_lock" title="ssam_controller_lock"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_lock()</span></code></a>).</p>
<dl class="function">
<dt id="c.ssam_controller_destroy">
void <code class="descname">ssam_controller_destroy</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_destroy" title="Permalink to this definition">¶</a></dt>
<dd><p>Destroy the controller and free its resources.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Ensures that all resources associated with the controller get freed. This
function should only be called after the controller has been stopped via
<a class="reference internal" href="#c.ssam_controller_shutdown" title="ssam_controller_shutdown"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_shutdown()</span></code></a>. In general, this function should not be called
directly. The only valid place to call this function directly is during
initialization, before the controller has been fully initialized and passed
to other processes. This function is called automatically when the
reference count of the controller reaches zero.</p>
<p>This function must be called with the main controller lock held (i.e. by
calling <a class="reference internal" href="#c.ssam_controller_lock" title="ssam_controller_lock"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_lock()</span></code></a>).</p>
<dl class="function">
<dt id="c.ssam_controller_suspend">
int <code class="descname">ssam_controller_suspend</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_suspend" title="Permalink to this definition">¶</a></dt>
<dd><p>Suspend the controller.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to suspend.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Marks the controller as suspended. Note that display-off and D0-exit
notifications have to be sent manually before transitioning the controller
into the suspended state via this function.</p>
<p>See <a class="reference internal" href="#c.ssam_controller_resume" title="ssam_controller_resume"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_resume()</span></code></a> for the corresponding resume function.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if the controller is currently not in the
“started” state.</p>
<dl class="function">
<dt id="c.ssam_controller_resume">
int <code class="descname">ssam_controller_resume</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_controller_resume" title="Permalink to this definition">¶</a></dt>
<dd><p>Resume the controller from suspend.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to resume.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Resume the controller from the suspended state it was put into via
<a class="reference internal" href="#c.ssam_controller_suspend" title="ssam_controller_suspend"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_controller_suspend()</span></code></a>. This function does not issue display-on and
D0-entry notifications. If required, those have to be sent manually after
this call.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">-EINVAL</span></code> if the controller is currently not suspended.</p>
<dl class="type">
<dt id="c.ssh_notification_params">
struct <code class="descname">ssh_notification_params</code><a class="headerlink" href="#c.ssh_notification_params" title="Permalink to this definition">¶</a></dt>
<dd><p>Command payload to enable/disable SSH notifications.</p>
</dd></dl>

<p><strong>Definition</strong></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct ssh_notification_params {
  u8 target_category;
  u8 flags;
  __le16 request_id;
  u8 instance_id;
};
</pre></div>
</div>
<p><strong>Members</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">target_category</span></code></dt>
<dd>The target category for which notifications should be
enabled/disabled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">flags</span></code></dt>
<dd>Flags determining how notifications are being sent.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">request_id</span></code></dt>
<dd>The request ID that is used to send these notifications.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">instance_id</span></code></dt>
<dd>The specific instance in the given target category for
which notifications should be enabled.</dd>
</dl>
<dl class="function">
<dt id="c.ssam_ssh_event_enable">
int <code class="descname">ssam_ssh_event_enable</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_registry" title="ssam_event_registry">ssam_event_registry</a><em>&nbsp;reg</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_id" title="ssam_event_id">ssam_event_id</a><em>&nbsp;id</em>, u8<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ssh_event_enable" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable SSH event.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which to enable the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_registry</span> <span class="pre">reg</span></code></dt>
<dd>The event registry describing what request to use for enabling and
disabling the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_id</span> <span class="pre">id</span></code></dt>
<dd>The event identifier.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">flags</span></code></dt>
<dd>The event flags.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Enables the specified event on the EC. This function does not manage
reference counting of enabled events and is basically only a wrapper for
the raw EC request. If the specified event is already enabled, the EC will
ignore this request.</p>
<p><strong>Return</strong></p>
<p>Returns the status of the executed SAM request (zero on success and
negative on direct failure) or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if the request response indicates a
failure.</p>
<dl class="function">
<dt id="c.ssam_ssh_event_disable">
int <code class="descname">ssam_ssh_event_disable</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_registry" title="ssam_event_registry">ssam_event_registry</a><em>&nbsp;reg</em>, struct <a class="reference internal" href="client-api.html#c.ssam_event_id" title="ssam_event_id">ssam_event_id</a><em>&nbsp;id</em>, u8<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ssh_event_disable" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable SSH event.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which to disable the event.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_registry</span> <span class="pre">reg</span></code></dt>
<dd>The event registry describing what request to use for enabling and
disabling the event (must be same as used when enabling the event).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_event_id</span> <span class="pre">id</span></code></dt>
<dd>The event identifier.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">flags</span></code></dt>
<dd>The event flags (likely ignored for disabling of events).</dd>
</dl>
<p><strong>Description</strong></p>
<p>Disables the specified event on the EC. This function does not manage
reference counting of enabled events and is basically only a wrapper for
the raw EC request. If the specified event is already disabled, the EC will
ignore this request.</p>
<p><strong>Return</strong></p>
<p>Returns the status of the executed SAM request (zero on success and
negative on direct failure) or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if the request response indicates a
failure.</p>
<dl class="function">
<dt id="c.ssam_get_firmware_version">
int <code class="descname">ssam_get_firmware_version</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, u32<em>&nbsp;*version</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_get_firmware_version" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the SAM/EC firmware version.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u32</span> <span class="pre">*version</span></code></dt>
<dd>Where to store the version number.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns zero on success or the status of the executed SAM request
if that request failed.</p>
<dl class="function">
<dt id="c.ssam_ctrl_notif_display_off">
int <code class="descname">ssam_ctrl_notif_display_off</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ctrl_notif_display_off" title="Permalink to this definition">¶</a></dt>
<dd><p>Notify EC that the display has been turned off.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Notify the EC that the display has been turned off and the driver may enter
a lower-power state. This will prevent events from being sent directly.
Rather, the EC signals an event by pulling the wakeup GPIO high for as long
as there are pending events. The events then need to be manually released,
one by one, via the GPIO callback request. All pending events accumulated
during this state can also be released by issuing the display-on
notification, e.g. via <a class="reference internal" href="#c.ssam_ctrl_notif_display_on" title="ssam_ctrl_notif_display_on"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_on()</span></code></a>, which will also reset
the GPIO.</p>
<p>On some devices, specifically ones with an integrated keyboard, the keyboard
backlight will be turned off by this call.</p>
<p>This function will only send the display-off notification command if
display notifications are supported by the EC. Currently all known devices
support these notifications.</p>
<p>Use <a class="reference internal" href="#c.ssam_ctrl_notif_display_on" title="ssam_ctrl_notif_display_on"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_on()</span></code></a> to reverse the effects of this function.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or if no request has been executed, the
status of the executed SAM request if that request failed, or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if
an unexpected response has been received.</p>
<dl class="function">
<dt id="c.ssam_ctrl_notif_display_on">
int <code class="descname">ssam_ctrl_notif_display_on</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ctrl_notif_display_on" title="Permalink to this definition">¶</a></dt>
<dd><p>Notify EC that the display has been turned on.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Notify the EC that the display has been turned back on and the driver has
exited its lower-power state. This notification is the counterpart to the
display-off notification sent via <a class="reference internal" href="#c.ssam_ctrl_notif_display_off" title="ssam_ctrl_notif_display_off"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_off()</span></code></a> and will
reverse its effects, including resetting events to their default behavior.</p>
<p>This function will only send the display-on notification command if display
notifications are supported by the EC. Currently all known devices support
these notifications.</p>
<p>See <a class="reference internal" href="#c.ssam_ctrl_notif_display_off" title="ssam_ctrl_notif_display_off"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_off()</span></code></a> for more details.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or if no request has been executed, the
status of the executed SAM request if that request failed, or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if
an unexpected response has been received.</p>
<dl class="function">
<dt id="c.ssam_ctrl_notif_d0_exit">
int <code class="descname">ssam_ctrl_notif_d0_exit</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ctrl_notif_d0_exit" title="Permalink to this definition">¶</a></dt>
<dd><p>Notify EC that the driver/device exits the D0 power state.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller</dd>
</dl>
<p><strong>Description</strong></p>
<p>Notifies the EC that the driver prepares to exit the D0 power state in
favor of a lower-power state. Exact effects of this function related to the
EC are currently unknown.</p>
<p>This function will only send the D0-exit notification command if D0-state
notifications are supported by the EC. Only newer Surface generations
support these notifications.</p>
<p>Use <a class="reference internal" href="#c.ssam_ctrl_notif_d0_entry" title="ssam_ctrl_notif_d0_entry"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_d0_entry()</span></code></a> to reverse the effects of this function.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or if no request has been executed, the
status of the executed SAM request if that request failed, or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if
an unexpected response has been received.</p>
<dl class="function">
<dt id="c.ssam_ctrl_notif_d0_entry">
int <code class="descname">ssam_ctrl_notif_d0_entry</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_ctrl_notif_d0_entry" title="Permalink to this definition">¶</a></dt>
<dd><p>Notify EC that the driver/device enters the D0 power state.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller</dd>
</dl>
<p><strong>Description</strong></p>
<p>Notifies the EC that the driver has exited a lower-power state and entered
the D0 power state. Exact effects of this function related to the EC are
currently unknown.</p>
<p>This function will only send the D0-entry notification command if D0-state
notifications are supported by the EC. Only newer Surface generations
support these notifications.</p>
<p>See <a class="reference internal" href="#c.ssam_ctrl_notif_d0_exit" title="ssam_ctrl_notif_d0_exit"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_d0_exit()</span></code></a> for more details.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or if no request has been executed, the
status of the executed SAM request if that request failed, or <code class="docutils literal notranslate"><span class="pre">-EPROTO</span></code> if
an unexpected response has been received.</p>
<dl class="function">
<dt id="c.ssam_nf_refcount_enable">
int <code class="descname">ssam_nf_refcount_enable</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, struct <a class="reference internal" href="#c.ssam_nf_refcount_entry" title="ssam_nf_refcount_entry">ssam_nf_refcount_entry</a><em>&nbsp;*entry</em>, u8<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_enable" title="Permalink to this definition">¶</a></dt>
<dd><p>Enable event for reference count entry if it has not already been enabled.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to enable the event on.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_refcount_entry</span> <span class="pre">*entry</span></code></dt>
<dd>The reference count entry for the event to be enabled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">flags</span></code></dt>
<dd>The flags used for enabling the event on the EC.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Enable the event associated with the given reference count entry if the
reference count equals one, i.e. the event has not previously been enabled.
If the event has already been enabled (i.e. reference count not equal to
one), check that the flags used for enabling match and warn about this if
they do not.</p>
<p>This does not modify the reference count itself, which is done with
<a class="reference internal" href="#c.ssam_nf_refcount_inc" title="ssam_nf_refcount_inc"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_nf_refcount_inc()</span></code></a> / <a class="reference internal" href="#c.ssam_nf_refcount_dec" title="ssam_nf_refcount_dec"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_nf_refcount_dec()</span></code></a>.</p>
<p><strong>Note</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">nf-&gt;lock</span></code> must be held when calling this function.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success. If the event is enabled by this call,
returns the status of the event-enable EC command.</p>
<dl class="function">
<dt id="c.ssam_nf_refcount_disable_free">
int <code class="descname">ssam_nf_refcount_disable_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em>, struct <a class="reference internal" href="#c.ssam_nf_refcount_entry" title="ssam_nf_refcount_entry">ssam_nf_refcount_entry</a><em>&nbsp;*entry</em>, u8<em>&nbsp;flags</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_nf_refcount_disable_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable event for reference count entry if it is no longer in use and free the corresponding entry.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to disable the event on.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_nf_refcount_entry</span> <span class="pre">*entry</span></code></dt>
<dd>The reference count entry for the event to be disabled.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">u8</span> <span class="pre">flags</span></code></dt>
<dd>The flags used for enabling the event on the EC.</dd>
</dl>
<p><strong>Description</strong></p>
<p>If the reference count equals zero, i.e. the event is no longer requested by
any client, the event will be disabled and the corresponding reference count
entry freed. The reference count entry must not be used any more after a
call to this function.</p>
<p>Also checks if the flags used for disabling the event match the flags used
for enabling the event and warns if they do not (regardless of reference
count).</p>
<p>This does not modify the reference count itself, which is done with
<a class="reference internal" href="#c.ssam_nf_refcount_inc" title="ssam_nf_refcount_inc"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_nf_refcount_inc()</span></code></a> / <a class="reference internal" href="#c.ssam_nf_refcount_dec" title="ssam_nf_refcount_dec"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_nf_refcount_dec()</span></code></a>.</p>
<p><strong>Note</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">nf-&gt;lock</span></code> must be held when calling this function.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success. If the event is disabled by this call,
returns the status of the event-enable EC command.</p>
<dl class="function">
<dt id="c.ssam_notifier_disable_registered">
int <code class="descname">ssam_notifier_disable_registered</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_notifier_disable_registered" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable events for all registered notifiers.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which to disable the notifiers/events.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Disables events for all currently registered notifiers. In case of an error
(EC command failing), all previously disabled events will be restored and
the error code returned.</p>
<p>This function is intended to disable all events prior to hibernation entry.
See <a class="reference internal" href="#c.ssam_notifier_restore_registered" title="ssam_notifier_restore_registered"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_restore_registered()</span></code></a> to restore/re-enable all events
disabled with this function.</p>
<p>Note that this function will not disable events for notifiers registered
after calling this function. It should thus be made sure that no new
notifiers are going to be added after this call and before the corresponding
call to <a class="reference internal" href="#c.ssam_notifier_restore_registered" title="ssam_notifier_restore_registered"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_restore_registered()</span></code></a>.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success. In case of failure returns the error code
returned by the failed EC command to disable an event.</p>
<dl class="function">
<dt id="c.ssam_notifier_restore_registered">
void <code class="descname">ssam_notifier_restore_registered</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_notifier_restore_registered" title="Permalink to this definition">¶</a></dt>
<dd><p>Restore/re-enable events for all registered notifiers.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which to restore the notifiers/events.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Restores/re-enables all events for which notifiers have been registered on
the given controller. In case of a failure, the error is logged and the
function continues to try and enable the remaining events.</p>
<p>This function is intended to restore/re-enable all registered events after
hibernation. See <a class="reference internal" href="#c.ssam_notifier_disable_registered" title="ssam_notifier_disable_registered"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_notifier_disable_registered()</span></code></a> for the counter part
disabling the events and more details.</p>
<dl class="function">
<dt id="c.ssam_notifier_is_empty">
bool <code class="descname">ssam_notifier_is_empty</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_notifier_is_empty" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if there are any registered notifiers.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to check on.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if there are currently no notifiers registered on the
controller, <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<dl class="function">
<dt id="c.ssam_notifier_unregister_all">
void <code class="descname">ssam_notifier_unregister_all</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_notifier_unregister_all" title="Permalink to this definition">¶</a></dt>
<dd><p>Unregister all currently registered notifiers.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to unregister the notifiers on.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Unregisters all currently registered notifiers. This function is used to
ensure that all notifiers will be unregistered and associated
entries/resources freed when the controller is being shut down.</p>
<dl class="function">
<dt id="c.ssam_irq_setup">
int <code class="descname">ssam_irq_setup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_irq_setup" title="Permalink to this definition">¶</a></dt>
<dd><p>Set up SAM EC wakeup-GPIO interrupt.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which the IRQ should be set up.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Set up an IRQ for the wakeup-GPIO pin of the SAM EC. This IRQ can be used
to wake the device from a low power state.</p>
<p>Note that this IRQ can only be triggered while the EC is in the display-off
state. In this state, events are not sent to the host in the usual way.
Instead the wakeup-GPIO gets pulled to “high” as long as there are pending
events and these events need to be released one-by-one via the GPIO
callback request, either until there are no events left and the GPIO is
reset, or all at once by transitioning the EC out of the display-off state,
which will also clear the GPIO.</p>
<p>Not all events, however, should trigger a full system wakeup. Instead the
driver should, if necessary, inspect and forward each event to the
corresponding subsystem, which in turn should decide if the system needs to
be woken up. This logic has not been implemented yet, thus wakeup by this
IRQ should be disabled by default to avoid spurious wake-ups, caused, for
example, by the remaining battery percentage changing. Refer to comments in
this function and comments in the corresponding IRQ handler for more
details on how this should be implemented.</p>
<p>See also <a class="reference internal" href="#c.ssam_ctrl_notif_display_off" title="ssam_ctrl_notif_display_off"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_off()</span></code></a> and <a class="reference internal" href="#c.ssam_ctrl_notif_display_off" title="ssam_ctrl_notif_display_off"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_ctrl_notif_display_off()</span></code></a>
for functions to transition the EC into and out of the display-off state as
well as more details on it.</p>
<p>The IRQ is disabled by default and has to be enabled before it can wake up
the device from suspend via <a class="reference internal" href="#c.ssam_irq_arm_for_wakeup" title="ssam_irq_arm_for_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_arm_for_wakeup()</span></code></a>. On teardown, the IRQ
should be freed via <a class="reference internal" href="#c.ssam_irq_free" title="ssam_irq_free"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_free()</span></code></a>.</p>
<dl class="function">
<dt id="c.ssam_irq_free">
void <code class="descname">ssam_irq_free</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_irq_free" title="Permalink to this definition">¶</a></dt>
<dd><p>Free SAM EC wakeup-GPIO interrupt.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which the IRQ should be freed.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Free the wakeup-GPIO IRQ previously set-up via <a class="reference internal" href="#c.ssam_irq_setup" title="ssam_irq_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_setup()</span></code></a>.</p>
<dl class="function">
<dt id="c.ssam_irq_arm_for_wakeup">
int <code class="descname">ssam_irq_arm_for_wakeup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_irq_arm_for_wakeup" title="Permalink to this definition">¶</a></dt>
<dd><p>Arm the EC IRQ for wakeup, if enabled.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which the IRQ should be armed.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Sets up the IRQ so that it can be used to wake the device. Specifically,
this function enables the irq and then, if the device is allowed to wake up
the system, calls enable_irq_wake(). See <a class="reference internal" href="#c.ssam_irq_disarm_wakeup" title="ssam_irq_disarm_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_disarm_wakeup()</span></code></a> for the
corresponding function to disable the IRQ.</p>
<p>This function is intended to arm the IRQ before entering S2idle suspend.</p>
<p><strong>Note</strong></p>
<p>calls to <a class="reference internal" href="#c.ssam_irq_arm_for_wakeup" title="ssam_irq_arm_for_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_arm_for_wakeup()</span></code></a> and <a class="reference internal" href="#c.ssam_irq_disarm_wakeup" title="ssam_irq_disarm_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_disarm_wakeup()</span></code></a> must
be balanced.</p>
<dl class="function">
<dt id="c.ssam_irq_disarm_wakeup">
void <code class="descname">ssam_irq_disarm_wakeup</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_irq_disarm_wakeup" title="Permalink to this definition">¶</a></dt>
<dd><p>Disarm the wakeup IRQ.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller for which the IRQ should be disarmed.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Disarm the IRQ previously set up for wake via <a class="reference internal" href="#c.ssam_irq_arm_for_wakeup" title="ssam_irq_arm_for_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_arm_for_wakeup()</span></code></a>.</p>
<p>This function is intended to disarm the IRQ after exiting S2idle suspend.</p>
<p><strong>Note</strong></p>
<p>calls to <a class="reference internal" href="#c.ssam_irq_arm_for_wakeup" title="ssam_irq_arm_for_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_arm_for_wakeup()</span></code></a> and <a class="reference internal" href="#c.ssam_irq_disarm_wakeup" title="ssam_irq_disarm_wakeup"><code class="xref c c-func docutils literal notranslate"><span class="pre">ssam_irq_disarm_wakeup()</span></code></a> must
be balanced.</p>
</div>
<div class="section" id="client-device-bus">
<h2><a class="toc-backref" href="#id5">Client Device Bus</a><a class="headerlink" href="#client-device-bus" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="c.ssam_device_id_compatible">
bool <code class="descname">ssam_device_id_compatible</code><span class="sig-paren">(</span>const struct ssam_device_id<em>&nbsp;*id</em>, struct <a class="reference internal" href="client-api.html#c.ssam_device_uid" title="ssam_device_uid">ssam_device_uid</a><em>&nbsp;uid</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_device_id_compatible" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if a device ID matches a UID.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_device_id</span> <span class="pre">*id</span></code></dt>
<dd>The device ID as potential match.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_device_uid</span> <span class="pre">uid</span></code></dt>
<dd>The device UID matching against.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Check if the given ID is a match for the given UID, i.e. if a device with
the provided UID is compatible to the given ID following the match rules
described in its <code class="xref c c-type docutils literal notranslate"><span class="pre">ssam_device_id.match_flags</span></code> member.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the given UID is compatible to the match rule
described by the given ID, <code class="docutils literal notranslate"><span class="pre">false</span></code> otherwise.</p>
<dl class="function">
<dt id="c.ssam_device_id_is_null">
bool <code class="descname">ssam_device_id_is_null</code><span class="sig-paren">(</span>const struct ssam_device_id<em>&nbsp;*id</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_device_id_is_null" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if a device ID is null.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssam_device_id</span> <span class="pre">*id</span></code></dt>
<dd>The device ID to check.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Check if a given device ID is null, i.e. all zeros. Used to check for the
end of <code class="docutils literal notranslate"><span class="pre">MODULE_DEVICE_TABLE(ssam,</span> <span class="pre">...)</span></code> or similar lists.</p>
<p><strong>Return</strong></p>
<p>Returns <code class="docutils literal notranslate"><span class="pre">true</span></code> if the given ID represents a null ID, <code class="docutils literal notranslate"><span class="pre">false</span></code>
otherwise.</p>
<dl class="function">
<dt id="c.ssam_bus_register">
int <code class="descname">ssam_bus_register</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_bus_register" title="Permalink to this definition">¶</a></dt>
<dd><p>Register and set-up the SSAM client device bus.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<dl class="function">
<dt id="c.ssam_bus_unregister">
void <code class="descname">ssam_bus_unregister</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_bus_unregister" title="Permalink to this definition">¶</a></dt>
<dd><p>Unregister the SSAM client device bus.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
</div>
<div class="section" id="core">
<h2><a class="toc-backref" href="#id6">Core</a><a class="headerlink" href="#core" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="c.ssam_try_set_controller">
int <code class="descname">ssam_try_set_controller</code><span class="sig-paren">(</span>struct <a class="reference internal" href="#c.ssam_controller" title="ssam_controller">ssam_controller</a><em>&nbsp;*ctrl</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_try_set_controller" title="Permalink to this definition">¶</a></dt>
<dd><p>Try to set the main controller reference.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">ssam_controller</span> <span class="pre">*ctrl</span></code></dt>
<dd>The controller to which the reference should point.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Set the main controller reference to the given pointer if the reference
hasn’t been set already.</p>
<p><strong>Return</strong></p>
<p>Returns zero on success or <code class="docutils literal notranslate"><span class="pre">-EEXIST</span></code> if the reference has already
been set.</p>
<dl class="function">
<dt id="c.ssam_clear_controller">
void <code class="descname">ssam_clear_controller</code><span class="sig-paren">(</span>void<span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_clear_controller" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove/clear the main controller reference.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span></code></dt>
<dd>no arguments</dd>
</dl>
<p><strong>Description</strong></p>
<p>Clears the main controller reference, i.e. sets it to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. This function
should be called before the controller is shut down.</p>
</div>
<div class="section" id="trace-helpers">
<h2><a class="toc-backref" href="#id7">Trace Helpers</a><a class="headerlink" href="#trace-helpers" title="Permalink to this headline">¶</a></h2>
<dl class="function">
<dt id="c.ssam_trace_ptr_uid">
void <code class="descname">ssam_trace_ptr_uid</code><span class="sig-paren">(</span>const void<em>&nbsp;*ptr</em>, char<em>&nbsp;*uid_str</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_trace_ptr_uid" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert the pointer to a non-pointer UID string.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">void</span> <span class="pre">*ptr</span></code></dt>
<dd>The pointer to convert.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">char</span> <span class="pre">*uid_str</span></code></dt>
<dd>A buffer of length SSAM_PTR_UID_LEN where the UID will be stored.</dd>
</dl>
<p><strong>Description</strong></p>
<p>Converts the given pointer into a UID string that is safe to be shared
with userspace and logs, i.e. doesn’t give away the real memory location.</p>
<dl class="function">
<dt id="c.ssam_trace_get_packet_seq">
u16 <code class="descname">ssam_trace_get_packet_seq</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_trace_get_packet_seq" title="Permalink to this definition">¶</a></dt>
<dd><p>Read the packet’s sequence ID.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the packet’s sequence ID (SEQ) field if present, or
<code class="docutils literal notranslate"><span class="pre">SSAM_SEQ_NOT_APPLICABLE</span></code> if not (e.g. flush packet).</p>
<dl class="function">
<dt id="c.ssam_trace_get_request_id">
u32 <code class="descname">ssam_trace_get_request_id</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_trace_get_request_id" title="Permalink to this definition">¶</a></dt>
<dd><p>Read the packet’s request ID.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the packet’s request ID (RQID) field if the packet
represents a request with command data, or <code class="docutils literal notranslate"><span class="pre">SSAM_RQID_NOT_APPLICABLE</span></code> if not
(e.g. flush request, control packet).</p>
<dl class="function">
<dt id="c.ssam_trace_get_request_tc">
u32 <code class="descname">ssam_trace_get_request_tc</code><span class="sig-paren">(</span>const struct <a class="reference internal" href="client-api.html#c.ssh_packet" title="ssh_packet">ssh_packet</a><em>&nbsp;*p</em><span class="sig-paren">)</span><a class="headerlink" href="#c.ssam_trace_get_request_tc" title="Permalink to this definition">¶</a></dt>
<dd><p>Read the packet’s request target category.</p>
</dd></dl>

<p><strong>Parameters</strong></p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">struct</span> <span class="pre">ssh_packet</span> <span class="pre">*p</span></code></dt>
<dd>The packet.</dd>
</dl>
<p><strong>Return</strong></p>
<p>Returns the packet’s request target category (TC) field if the
packet represents a request with command data, or <code class="docutils literal notranslate"><span class="pre">SSAM_TC_NOT_APPLICABLE</span></code>
if not (e.g. flush request, control packet).</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../switchtec.html" class="btn btn-neutral float-right" title="Linux Switchtec Support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="internal.html" class="btn btn-neutral" title="Core Driver Internals" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>