

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>TODO list &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Linux GPU Driver Developer’s Guide" href="index.html"/>
        <link rel="next" title="GPU RFC Section" href="rfc/index.html"/>
        <link rel="prev" title="VGA Arbiter" href="vgaarbiter.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Linux GPU Driver Developer’s Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-internals.html">DRM Internals</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-mm.html">DRM Memory Management</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms.html">Kernel Mode Setting (KMS)</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-kms-helpers.html">Mode Setting Helper Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-uapi.html">Userland interfaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="driver-uapi.html">DRM Driver uAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="drm-client.html">Kernel clients</a></li>
<li class="toctree-l2"><a class="reference internal" href="drivers.html">GPU Driver Documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="backlight.html">Backlight support</a></li>
<li class="toctree-l2"><a class="reference internal" href="vga-switcheroo.html">VGA Switcheroo</a></li>
<li class="toctree-l2"><a class="reference internal" href="vgaarbiter.html">VGA Arbiter</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">TODO list</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#difficulty">Difficulty</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#subsystem-wide-refactorings">Subsystem-wide refactorings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remove-custom-dumb-map-offset-implementations">Remove custom dumb_map_offset implementations</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-existing-kms-drivers-to-atomic-modesetting">Convert existing KMS drivers to atomic modesetting</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-up-the-clipped-coordination-confusion-around-planes">Clean up the clipped coordination confusion around planes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#improve-plane-atomic-check-helpers">Improve plane atomic_check helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-early-atomic-drivers-to-async-commit-helpers">Convert early atomic drivers to async commit helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#fallout-from-atomic-kms">Fallout from atomic KMS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get-rid-of-dev-struct-mutex-from-gem-drivers">Get rid of dev-&gt;struct_mutex from GEM drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#move-buffer-object-locking-to-dma-resv-lock">Move Buffer Object Locking to dma_resv_lock()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-logging-to-drm-functions-with-drm-device-paramater">Convert logging to drm_* functions with drm_device paramater</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-drivers-to-use-simple-modeset-suspend-resume">Convert drivers to use simple modeset suspend/resume</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-drivers-to-use-drm-fbdev-generic-setup">Convert drivers to use drm_fbdev_generic_setup()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reimplement-functions-in-drm-fbdev-fb-ops-without-fbdev">Reimplement functions in drm_fbdev_fb_ops without fbdev</a></li>
<li class="toctree-l3"><a class="reference internal" href="#benchmark-and-optimize-blitting-and-format-conversion-function">Benchmark and optimize blitting and format-conversion function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#drm-framebuffer-funcs-and-drm-mode-config-funcs-fb-create-cleanup">drm_framebuffer_funcs and drm_mode_config_funcs.fb_create cleanup</a></li>
<li class="toctree-l3"><a class="reference internal" href="#generic-fbdev-defio-support">Generic fbdev defio support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#idr-init-base">idr_init_base()</a></li>
<li class="toctree-l3"><a class="reference internal" href="#struct-drm-gem-object-funcs">struct drm_gem_object_funcs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rename-cma-helpers-to-dma-helpers">Rename CMA helpers to DMA helpers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connector-register-unregister-fixes">connector register/unregister fixes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remove-load-unload-callbacks-from-all-non-driver-legacy-drivers">Remove load/unload callbacks from all non-DRIVER_LEGACY drivers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#replace-drm-detect-hdmi-monitor-with-drm-display-info-is-hdmi">Replace drm_detect_hdmi_monitor() with drm_display_info.is_hdmi</a></li>
<li class="toctree-l3"><a class="reference internal" href="#consolidate-custom-driver-modeset-properties">Consolidate custom driver modeset properties</a></li>
<li class="toctree-l3"><a class="reference internal" href="#use-struct-iosys-map-throughout-codebase">Use struct iosys_map throughout codebase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#review-all-drivers-for-setting-struct-drm-mode-config-max-width-max-height-correctly">Review all drivers for setting struct drm_mode_config.{max_width,max_height} correctly</a></li>
<li class="toctree-l3"><a class="reference internal" href="#request-memory-regions-in-all-drivers">Request memory regions in all drivers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#core-refactorings">Core refactorings</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#make-panic-handling-work">Make panic handling work</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-up-the-debugfs-support">Clean up the debugfs support</a></li>
<li class="toctree-l3"><a class="reference internal" href="#object-lifetime-fixes">Object lifetime fixes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remove-automatic-page-mapping-from-dma-buf-importing">Remove automatic page mapping from dma-buf importing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#better-testing">Better Testing</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#enable-trinity-for-drm">Enable trinity for DRM</a></li>
<li class="toctree-l3"><a class="reference internal" href="#make-kms-tests-in-i-g-t-generic">Make KMS tests in i-g-t generic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#extend-virtual-test-driver-vkms">Extend virtual test driver (VKMS)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#backlight-refactoring">Backlight Refactoring</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#driver-specific">Driver Specific</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#amd-dc-display-driver">AMD DC Display Driver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vmwgfx-replace-hashtable-with-linux-implementation">vmwgfx: Replace hashtable with Linux’ implementation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bootsplash">Bootsplash</a></li>
<li class="toctree-l4"><a class="reference internal" href="#outside-drm">Outside DRM</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#convert-fbdev-drivers-to-drm">Convert fbdev drivers to DRM</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="rfc/index.html">GPU RFC Section</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html">Unsorted Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../staging/index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Linux GPU Driver Developer’s Guide</a> &raquo;</li>
        
      <li>TODO list</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/gpu/todo.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="todo-list">
<span id="todo"></span><h1>TODO list<a class="headerlink" href="#todo-list" title="Permalink to this headline">¶</a></h1>
<p>This section contains a list of smaller janitorial tasks in the kernel DRM
graphics subsystem useful as newbie projects. Or for slow rainy days.</p>
<div class="section" id="difficulty">
<h2>Difficulty<a class="headerlink" href="#difficulty" title="Permalink to this headline">¶</a></h2>
<p>To make it easier task are categorized into different levels:</p>
<p>Starter: Good tasks to get started with the DRM subsystem.</p>
<p>Intermediate: Tasks which need some experience with working in the DRM
subsystem, or some specific GPU/display graphics knowledge. For debugging issue
it’s good to have the relevant hardware (or a virtual driver set up) available
for testing.</p>
<p>Advanced: Tricky tasks that need fairly good understanding of the DRM subsystem
and graphics topics. Generally need the relevant hardware for development and
testing.</p>
<p>Expert: Only attempt these if you’ve successfully completed some tricky
refactorings already and are an expert in the specific area</p>
<div class="section" id="subsystem-wide-refactorings">
<h3>Subsystem-wide refactorings<a class="headerlink" href="#subsystem-wide-refactorings" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="remove-custom-dumb-map-offset-implementations">
<h2>Remove custom dumb_map_offset implementations<a class="headerlink" href="#remove-custom-dumb-map-offset-implementations" title="Permalink to this headline">¶</a></h2>
<p>All GEM based drivers should be using <a class="reference internal" href="drm-mm.html#c.drm_gem_create_mmap_offset" title="drm_gem_create_mmap_offset"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_create_mmap_offset()</span></code></a> instead.
Audit each individual driver, make sure it’ll work with the generic
implementation (there’s lots of outdated locking leftovers in various
implementations), and then remove it.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="convert-existing-kms-drivers-to-atomic-modesetting">
<h2>Convert existing KMS drivers to atomic modesetting<a class="headerlink" href="#convert-existing-kms-drivers-to-atomic-modesetting" title="Permalink to this headline">¶</a></h2>
<p>3.19 has the atomic modeset interfaces and helpers, so drivers can now be
converted over. Modern compositors like Wayland or Surfaceflinger on Android
really want an atomic modeset interface, so this is all about the bright
future.</p>
<p>There is a conversion guide for atomic and all you need is a GPU for a
non-converted driver (again virtual HW drivers for KVM are still all
suitable).</p>
<p>As part of this drivers also need to convert to universal plane (which means
exposing primary &amp; cursor as proper plane objects). But that’s much easier to
do by directly using the new atomic helper driver callbacks.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="clean-up-the-clipped-coordination-confusion-around-planes">
<h2>Clean up the clipped coordination confusion around planes<a class="headerlink" href="#clean-up-the-clipped-coordination-confusion-around-planes" title="Permalink to this headline">¶</a></h2>
<p>We have a helper to get this right with drm_plane_helper_check_update(), but
it’s not consistently used. This should be fixed, preferrably in the atomic
helpers (and drivers then moved over to clipped coordinates). Probably the
helper should also be moved from drm_plane_helper.c to the atomic helpers, to
avoid confusion - the other helpers in that file are all deprecated legacy
helpers.</p>
<p>Contact: Ville Syrjälä, Daniel Vetter, driver maintainers</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="improve-plane-atomic-check-helpers">
<h2>Improve plane atomic_check helpers<a class="headerlink" href="#improve-plane-atomic-check-helpers" title="Permalink to this headline">¶</a></h2>
<p>Aside from the clipped coordinates right above there’s a few suboptimal things
with the current helpers:</p>
<ul class="simple">
<li>drm_plane_helper_funcs-&gt;atomic_check gets called for enabled or disabled
planes. At best this seems to confuse drivers, worst it means they blow up
when the plane is disabled without the CRTC. The only special handling is
resetting values in the plane state structures, which instead should be moved
into the drm_plane_funcs-&gt;atomic_duplicate_state functions.</li>
<li>Once that’s done, helpers could stop calling -&gt;atomic_check for disabled
planes.</li>
<li>Then we could go through all the drivers and remove the more-or-less confused
checks for plane_state-&gt;fb and plane_state-&gt;crtc.</li>
</ul>
<p>Contact: Daniel Vetter</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="convert-early-atomic-drivers-to-async-commit-helpers">
<h2>Convert early atomic drivers to async commit helpers<a class="headerlink" href="#convert-early-atomic-drivers-to-async-commit-helpers" title="Permalink to this headline">¶</a></h2>
<p>For the first year the atomic modeset helpers didn’t support asynchronous /
nonblocking commits, and every driver had to hand-roll them. This is fixed
now, but there’s still a pile of existing drivers that easily could be
converted over to the new infrastructure.</p>
<p>One issue with the helpers is that they require that drivers handle completion
events for atomic commits correctly. But fixing these bugs is good anyway.</p>
<p>Somewhat related is the legacy_cursor_update hack, which should be replaced with
the new atomic_async_check/commit functionality in the helpers in drivers that
still look at that flag.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="fallout-from-atomic-kms">
<h2>Fallout from atomic KMS<a class="headerlink" href="#fallout-from-atomic-kms" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">drm_atomic_helper.c</span></code> provides a batch of functions which implement legacy
IOCTLs on top of the new atomic driver interface. Which is really nice for
gradual conversion of drivers, but unfortunately the semantic mismatches are
a bit too severe. So there’s some follow-up work to adjust the function
interfaces to fix these issues:</p>
<ul>
<li><p class="first">atomic needs the lock acquire context. At the moment that’s passed around
implicitly with some horrible hacks, and it’s also allocate with
<code class="docutils literal notranslate"><span class="pre">GFP_NOFAIL</span></code> behind the scenes. All legacy paths need to start allocating
the acquire context explicitly on stack and then also pass it down into
drivers explicitly so that the legacy-on-atomic functions can use them.</p>
<p>Except for some driver code this is done. This task should be finished by
adding WARN_ON(!drm_drv_uses_atomic_modeset) in <a class="reference internal" href="drm-kms.html#c.drm_modeset_lock_all" title="drm_modeset_lock_all"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_modeset_lock_all()</span></code></a>.</p>
</li>
<li><p class="first">A bunch of the vtable hooks are now in the wrong place: DRM has a split
between core vfunc tables (named <code class="docutils literal notranslate"><span class="pre">drm_foo_funcs</span></code>), which are used to
implement the userspace ABI. And then there’s the optional hooks for the
helper libraries (name <code class="docutils literal notranslate"><span class="pre">drm_foo_helper_funcs</span></code>), which are purely for
internal use. Some of these hooks should be move from <code class="docutils literal notranslate"><span class="pre">_funcs</span></code> to
<code class="docutils literal notranslate"><span class="pre">_helper_funcs</span></code> since they are not part of the core ABI. There’s a
<code class="docutils literal notranslate"><span class="pre">FIXME</span></code> comment in the kerneldoc for each such case in <code class="docutils literal notranslate"><span class="pre">drm_crtc.h</span></code>.</p>
</li>
</ul>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="get-rid-of-dev-struct-mutex-from-gem-drivers">
<h2>Get rid of dev-&gt;struct_mutex from GEM drivers<a class="headerlink" href="#get-rid-of-dev-struct-mutex-from-gem-drivers" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">dev-&gt;struct_mutex</span></code> is the Big DRM Lock from legacy days and infested
everything. Nowadays in modern drivers the only bit where it’s mandatory is
serializing GEM buffer object destruction. Which unfortunately means drivers
have to keep track of that lock and either call <code class="docutils literal notranslate"><span class="pre">unreference</span></code> or
<code class="docutils literal notranslate"><span class="pre">unreference_locked</span></code> depending upon context.</p>
<p>Core GEM doesn’t have a need for <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> any more since kernel 4.8,
and there’s a GEM object <code class="docutils literal notranslate"><span class="pre">free</span></code> callback for any drivers which are
entirely <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> free.</p>
<p>For drivers that need <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code> it should be replaced with a driver-
private lock. The tricky part is the BO free functions, since those can’t
reliably take that lock any more. Instead state needs to be protected with
suitable subordinate locks or some cleanup work pushed to a worker thread. For
performance-critical drivers it might also be better to go with a more
fine-grained per-buffer object and per-context lockings scheme. Currently only
the <code class="docutils literal notranslate"><span class="pre">msm</span></code> and <cite>i915</cite> drivers use <code class="docutils literal notranslate"><span class="pre">struct_mutex</span></code>.</p>
<p>Contact: Daniel Vetter, respective driver maintainers</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="move-buffer-object-locking-to-dma-resv-lock">
<h2>Move Buffer Object Locking to dma_resv_lock()<a class="headerlink" href="#move-buffer-object-locking-to-dma-resv-lock" title="Permalink to this headline">¶</a></h2>
<p>Many drivers have their own per-object locking scheme, usually using
<a class="reference internal" href="../kernel-hacking/locking.html#c.mutex_lock" title="mutex_lock"><code class="xref c c-func docutils literal notranslate"><span class="pre">mutex_lock()</span></code></a>. This causes all kinds of trouble for buffer sharing, since
depending which driver is the exporter and importer, the locking hierarchy is
reversed.</p>
<p>To solve this we need one standard per-object locking mechanism, which is
<a class="reference internal" href="../driver-api/dma-buf.html#c.dma_resv_lock" title="dma_resv_lock"><code class="xref c c-func docutils literal notranslate"><span class="pre">dma_resv_lock()</span></code></a>. This lock needs to be called as the outermost lock, with all
other driver specific per-object locks removed. The problem is tha rolling out
the actual change to the locking contract is a flag day, due to <a class="reference internal" href="../driver-api/dma-buf.html#c.dma_buf" title="dma_buf"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">dma_buf</span></code></a>
buffer sharing.</p>
<p>Level: Expert</p>
</div>
<div class="section" id="convert-logging-to-drm-functions-with-drm-device-paramater">
<h2>Convert logging to drm_* functions with drm_device paramater<a class="headerlink" href="#convert-logging-to-drm-functions-with-drm-device-paramater" title="Permalink to this headline">¶</a></h2>
<p>For drivers which could have multiple instances, it is necessary to
differentiate between which is which in the logs. Since DRM_INFO/WARN/ERROR
don’t do this, drivers used dev_info/warn/err to make this differentiation. We
now have drm_* variants of the drm print functions, so we can start to convert
those drivers back to using drm-formatted specific log messages.</p>
<p>Before you start this conversion please contact the relevant maintainers to make
sure your work will be merged - not everyone agrees that the DRM dmesg macros
are better.</p>
<p>Contact: Sean Paul, Maintainer of the driver you plan to convert</p>
<p>Level: Starter</p>
</div>
<div class="section" id="convert-drivers-to-use-simple-modeset-suspend-resume">
<h2>Convert drivers to use simple modeset suspend/resume<a class="headerlink" href="#convert-drivers-to-use-simple-modeset-suspend-resume" title="Permalink to this headline">¶</a></h2>
<p>Most drivers (except i915 and nouveau) that use
drm_atomic_helper_suspend/resume() can probably be converted to use
drm_mode_config_helper_suspend/resume(). Also there’s still open-coded version
of the atomic suspend/resume code in older atomic modeset drivers.</p>
<p>Contact: Maintainer of the driver you plan to convert</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="convert-drivers-to-use-drm-fbdev-generic-setup">
<h2>Convert drivers to use drm_fbdev_generic_setup()<a class="headerlink" href="#convert-drivers-to-use-drm-fbdev-generic-setup" title="Permalink to this headline">¶</a></h2>
<p>Most drivers can use <a class="reference internal" href="drm-kms-helpers.html#c.drm_fbdev_generic_setup" title="drm_fbdev_generic_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_fbdev_generic_setup()</span></code></a>. Driver have to implement
atomic modesetting and GEM vmap support. Historically, generic fbdev emulation
expected the framebuffer in system memory or system-like memory. By employing
<a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a>, drivers with frambuffers in I/O memory can be supported
as well.</p>
<p>Contact: Maintainer of the driver you plan to convert</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="reimplement-functions-in-drm-fbdev-fb-ops-without-fbdev">
<h2>Reimplement functions in drm_fbdev_fb_ops without fbdev<a class="headerlink" href="#reimplement-functions-in-drm-fbdev-fb-ops-without-fbdev" title="Permalink to this headline">¶</a></h2>
<p>A number of callback functions in drm_fbdev_fb_ops could benefit from
being rewritten without dependencies on the fbdev module. Some of the
helpers could further benefit from using <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a> instead of
raw pointers.</p>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;, Daniel Vetter</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="benchmark-and-optimize-blitting-and-format-conversion-function">
<h2>Benchmark and optimize blitting and format-conversion function<a class="headerlink" href="#benchmark-and-optimize-blitting-and-format-conversion-function" title="Permalink to this headline">¶</a></h2>
<p>Drawing to dispay memory quickly is crucial for many applications’
performance.</p>
<p>On at least x86-64, sys_imageblit() is significantly slower than
cfb_imageblit(), even though both use the same blitting algorithm and
the latter is written for I/O memory. It turns out that cfb_imageblit()
uses movl instructions, while sys_imageblit apparently does not. This
seems to be a problem with gcc’s optimizer. DRM’s format-conversion
helpers might be subject to similar issues.</p>
<p>Benchmark and optimize fbdev’s sys_() helpers and DRM’s format-conversion
helpers. In cases that can be further optimized, maybe implement a different
algorithm. For micro-optimizations, use movl/movq instructions explicitly.
That might possibly require architecture-specific helpers (e.g., storel()
storeq()).</p>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="drm-framebuffer-funcs-and-drm-mode-config-funcs-fb-create-cleanup">
<h2>drm_framebuffer_funcs and drm_mode_config_funcs.fb_create cleanup<a class="headerlink" href="#drm-framebuffer-funcs-and-drm-mode-config-funcs-fb-create-cleanup" title="Permalink to this headline">¶</a></h2>
<p>A lot more drivers could be switched over to the drm_gem_framebuffer helpers.
Various hold-ups:</p>
<ul class="simple">
<li>Need to switch over to the generic dirty tracking code using
drm_atomic_helper_dirtyfb first (e.g. qxl).</li>
<li>Need to switch to <a class="reference internal" href="drm-kms-helpers.html#c.drm_fbdev_generic_setup" title="drm_fbdev_generic_setup"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_fbdev_generic_setup()</span></code></a>, otherwise a lot of the custom fb
setup code can’t be deleted.</li>
<li>Many drivers wrap <a class="reference internal" href="drm-kms-helpers.html#c.drm_gem_fb_create" title="drm_gem_fb_create"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_fb_create()</span></code></a> only to check for valid formats. For
atomic drivers we could check for valid formats by calling
drm_plane_check_pixel_format() against all planes, and pass if any plane
supports the format. For non-atomic that’s not possible since like the format
list for the primary plane is fake and we’d therefor reject valid formats.</li>
<li>Many drivers subclass drm_framebuffer, we’d need a embedding compatible
version of the varios drm_gem_fb_create functions. Maybe called
drm_gem_fb_create/_with_dirty/_with_funcs as needed.</li>
</ul>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="generic-fbdev-defio-support">
<h2>Generic fbdev defio support<a class="headerlink" href="#generic-fbdev-defio-support" title="Permalink to this headline">¶</a></h2>
<p>The defio support code in the fbdev core has some very specific requirements,
which means drivers need to have a special framebuffer for fbdev. The main
issue is that it uses some fields in struct page itself, which breaks shmem
gem objects (and other things). To support defio, affected drivers require
the use of a shadow buffer, which may add CPU and memory overhead.</p>
<p>Possible solution would be to write our own defio mmap code in the drm fbdev
emulation. It would need to fully wrap the existing mmap ops, forwarding
everything after it has done the write-protect/mkwrite trickery:</p>
<ul>
<li><p class="first">In the drm_fbdev_fb_mmap helper, if we need defio, change the
default page prots to write-protected with something like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>vma-&gt;vm_page_prot = pgprot_wrprotect(vma-&gt;vm_page_prot);
</pre></div>
</div>
</li>
<li><p class="first">Set the mkwrite and fsync callbacks with similar implementions to the core
fbdev defio stuff. These should all work on plain ptes, they don’t actually
require a struct page.  uff. These should all work on plain ptes, they don’t
actually require a struct page.</p>
</li>
<li><p class="first">Track the dirty pages in a separate structure (bitfield with one bit per page
should work) to avoid clobbering struct page.</p>
</li>
</ul>
<p>Might be good to also have some igt testcases for this.</p>
<p>Contact: Daniel Vetter, Noralf Tronnes</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="idr-init-base">
<h2>idr_init_base()<a class="headerlink" href="#idr-init-base" title="Permalink to this headline">¶</a></h2>
<p>DRM core&amp;drivers uses a lot of idr (integer lookup directories) for mapping
userspace IDs to internal objects, and in most places ID=0 means NULL and hence
is never used. Switching to <a class="reference internal" href="../core-api/idr.html#c.idr_init_base" title="idr_init_base"><code class="xref c c-func docutils literal notranslate"><span class="pre">idr_init_base()</span></code></a> for these would make the idr more
efficient.</p>
<p>Contact: Daniel Vetter</p>
<p>Level: Starter</p>
</div>
<div class="section" id="struct-drm-gem-object-funcs">
<h2>struct drm_gem_object_funcs<a class="headerlink" href="#struct-drm-gem-object-funcs" title="Permalink to this headline">¶</a></h2>
<p>GEM objects can now have a function table instead of having the callbacks on the
DRM driver struct. This is now the preferred way. Callbacks in drivers have been
converted, except for <a class="reference internal" href="drm-internals.html#c.drm_driver" title="drm_driver"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_driver</span></code></a>.gem_prime_mmap.</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="rename-cma-helpers-to-dma-helpers">
<h2>Rename CMA helpers to DMA helpers<a class="headerlink" href="#rename-cma-helpers-to-dma-helpers" title="Permalink to this headline">¶</a></h2>
<p>CMA (standing for contiguous memory allocator) is really a bit an accident of
what these were used for first, a much better name would be DMA helpers. In the
text these should even be called coherent DMA memory helpers (so maybe CDM, but
no one knows what that means) since underneath they just use dma_alloc_coherent.</p>
<p>Contact: Laurent Pinchart, Daniel Vetter</p>
<p>Level: Intermediate (mostly because it is a huge tasks without good partial
milestones, not technically itself that challenging)</p>
</div>
<div class="section" id="connector-register-unregister-fixes">
<h2>connector register/unregister fixes<a class="headerlink" href="#connector-register-unregister-fixes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>For most connectors it’s a no-op to call drm_connector_register/unregister
directly from driver code, drm_dev_register/unregister take care of this
already. We can remove all of them.</li>
<li>For dp drivers it’s a bit more a mess, since we need the connector to be
registered when calling drm_dp_aux_register. Fix this by instead calling
drm_dp_aux_init, and moving the actual registering into a late_register
callback as recommended in the kerneldoc.</li>
</ul>
<p>Level: Intermediate</p>
</div>
<div class="section" id="remove-load-unload-callbacks-from-all-non-driver-legacy-drivers">
<h2>Remove load/unload callbacks from all non-DRIVER_LEGACY drivers<a class="headerlink" href="#remove-load-unload-callbacks-from-all-non-driver-legacy-drivers" title="Permalink to this headline">¶</a></h2>
<p>The load/unload callbacks in struct &amp;drm_driver are very much midlayers, plus
for historical reasons they get the ordering wrong (and we can’t fix that)
between setting up the &amp;drm_driver structure and calling <a class="reference internal" href="drm-internals.html#c.drm_dev_register" title="drm_dev_register"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_dev_register()</span></code></a>.</p>
<ul class="simple">
<li>Rework drivers to no longer use the load/unload callbacks, directly coding the
load/unload sequence into the driver’s probe function.</li>
<li>Once all non-DRIVER_LEGACY drivers are converted, disallow the load/unload
callbacks for all modern drivers.</li>
</ul>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="replace-drm-detect-hdmi-monitor-with-drm-display-info-is-hdmi">
<h2>Replace drm_detect_hdmi_monitor() with drm_display_info.is_hdmi<a class="headerlink" href="#replace-drm-detect-hdmi-monitor-with-drm-display-info-is-hdmi" title="Permalink to this headline">¶</a></h2>
<p>Once EDID is parsed, the monitor HDMI support information is available through
drm_display_info.is_hdmi. Many drivers still call <a class="reference internal" href="drm-kms-helpers.html#c.drm_detect_hdmi_monitor" title="drm_detect_hdmi_monitor"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_detect_hdmi_monitor()</span></code></a> to
retrieve the same information, which is less efficient.</p>
<p>Audit each individual driver calling <a class="reference internal" href="drm-kms-helpers.html#c.drm_detect_hdmi_monitor" title="drm_detect_hdmi_monitor"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_detect_hdmi_monitor()</span></code></a> and switch to
drm_display_info.is_hdmi if applicable.</p>
<p>Contact: Laurent Pinchart, respective driver maintainers</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="consolidate-custom-driver-modeset-properties">
<h2>Consolidate custom driver modeset properties<a class="headerlink" href="#consolidate-custom-driver-modeset-properties" title="Permalink to this headline">¶</a></h2>
<p>Before atomic modeset took place, many drivers where creating their own
properties. Among other things, atomic brought the requirement that custom,
driver specific properties should not be used.</p>
<p>For this task, we aim to introduce core helpers or reuse the existing ones
if available:</p>
<p>A quick, unconfirmed, examples list.</p>
<p>Introduce core helpers:
- audio (amdgpu, intel, gma500, radeon)
- brightness, contrast, etc (armada, nouveau) - overlay only (?)
- broadcast rgb (gma500, intel)
- colorkey (armada, nouveau, rcar) - overlay only (?)
- dither (amdgpu, nouveau, radeon) - varies across drivers
- underscan family (amdgpu, radeon, nouveau)</p>
<p>Already in core:
- colorspace (sti)
- tv format names, enhancements (gma500, intel)
- tv overscan, margins, etc. (gma500, intel)
- zorder (omapdrm) - same as zpos (?)</p>
<p>Contact: Emil Velikov, respective driver maintainers</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="use-struct-iosys-map-throughout-codebase">
<h2>Use struct iosys_map throughout codebase<a class="headerlink" href="#use-struct-iosys-map-throughout-codebase" title="Permalink to this headline">¶</a></h2>
<p>Pointers to shared device memory are stored in <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a>. Each
instance knows whether it refers to system or I/O memory. Most of the DRM-wide
interface have been converted to use <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a>, but implementations
often still use raw pointers.</p>
<p>The task is to use <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a> where it makes sense.</p>
<ul class="simple">
<li>Memory managers should use <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a> for dma-buf-imported buffers.</li>
<li>TTM might benefit from using <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a> internally.</li>
<li>Framebuffer copying and blitting helpers should operate on <a class="reference internal" href="../driver-api/device-io.html#c.iosys_map" title="iosys_map"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">iosys_map</span></code></a>.</li>
</ul>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;, Christian König, Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="review-all-drivers-for-setting-struct-drm-mode-config-max-width-max-height-correctly">
<h2>Review all drivers for setting struct drm_mode_config.{max_width,max_height} correctly<a class="headerlink" href="#review-all-drivers-for-setting-struct-drm-mode-config-max-width-max-height-correctly" title="Permalink to this headline">¶</a></h2>
<p>The values in <a class="reference internal" href="drm-kms.html#c.drm_mode_config" title="drm_mode_config"><code class="xref c c-type docutils literal notranslate"><span class="pre">struct</span> <span class="pre">drm_mode_config</span></code></a>.{max_width,max_height} describe the
maximum supported framebuffer size. It’s the virtual screen size, but many
drivers treat it like limitations of the physical resolution.</p>
<p>The maximum width depends on the hardware’s maximum scanline pitch. The
maximum height depends on the amount of addressable video memory. Review all
drivers to initialize the fields to the correct values.</p>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="request-memory-regions-in-all-drivers">
<h2>Request memory regions in all drivers<a class="headerlink" href="#request-memory-regions-in-all-drivers" title="Permalink to this headline">¶</a></h2>
<p>Go through all drivers and add code to request the memory regions that the
driver uses. This requires adding calls to request_mem_region(),
<a class="reference internal" href="../driver-api/pci/pci.html#c.pci_request_region" title="pci_request_region"><code class="xref c c-func docutils literal notranslate"><span class="pre">pci_request_region()</span></code></a> or similar functions. Use helpers for managed cleanup
where possible.</p>
<p>Drivers are pretty bad at doing this and there used to be conflicts among
DRM and fbdev drivers. Still, it’s the correct thing to do.</p>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Level: Starter</p>
<div class="section" id="core-refactorings">
<h3>Core refactorings<a class="headerlink" href="#core-refactorings" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="make-panic-handling-work">
<h2>Make panic handling work<a class="headerlink" href="#make-panic-handling-work" title="Permalink to this headline">¶</a></h2>
<p>This is a really varied tasks with lots of little bits and pieces:</p>
<ul class="simple">
<li>The panic path can’t be tested currently, leading to constant breaking. The
main issue here is that panics can be triggered from hardirq contexts and
hence all panic related callback can run in hardirq context. It would be
awesome if we could test at least the fbdev helper code and driver code by
e.g. trigger calls through drm debugfs files. hardirq context could be
achieved by using an IPI to the local processor.</li>
<li>There’s a massive confusion of different panic handlers. DRM fbdev emulation
helpers had their own (long removed), but on top of that the fbcon code itself
also has one. We need to make sure that they stop fighting over each other.
This is worked around by checking <code class="docutils literal notranslate"><span class="pre">oops_in_progress</span></code> at various entry points
into the DRM fbdev emulation helpers. A much cleaner approach here would be to
switch fbcon to the <a class="reference external" href="https://lwn.net/Articles/800946/">threaded printk support</a>.</li>
<li><code class="docutils literal notranslate"><span class="pre">drm_can_sleep()</span></code> is a mess. It hides real bugs in normal operations and
isn’t a full solution for panic paths. We need to make sure that it only
returns true if there’s a panic going on for real, and fix up all the
fallout.</li>
<li>The panic handler must never sleep, which also means it can’t ever
<code class="docutils literal notranslate"><span class="pre">mutex_lock()</span></code>. Also it can’t grab any other lock unconditionally, not
even spinlocks (because NMI and hardirq can panic too). We need to either
make sure to not call such paths, or trylock everything. Really tricky.</li>
<li>A clean solution would be an entirely separate panic output support in KMS,
bypassing the current fbcon support. See <a class="reference external" href="https://lore.kernel.org/dri-devel/20190311174218.51899-1-noralf&#64;tronnes.org/">[PATCH v2 0/3] drm: Add panic handling</a>.</li>
<li>Encoding the actual oops and preceding dmesg in a QR might help with the
dread “important stuff scrolled away” problem. See <a class="reference external" href="https://lore.kernel.org/lkml/1446217392-11981-1-git-send-email-alexandru.murtaza&#64;intel.com/">[RFC][PATCH] Oops messages
transfer using QR codes</a>
for some example code that could be reused.</li>
</ul>
<p>Contact: Daniel Vetter</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="clean-up-the-debugfs-support">
<h2>Clean up the debugfs support<a class="headerlink" href="#clean-up-the-debugfs-support" title="Permalink to this headline">¶</a></h2>
<p>There’s a bunch of issues with it:</p>
<ul class="simple">
<li>The drm_info_list -&gt;show() function doesn’t even bother to cast to the drm
structure for you. This is lazy.</li>
<li>We probably want to have some support for debugfs files on crtc/connectors and
maybe other kms objects directly in core. There’s even drm_print support in
the funcs for these objects to dump kms state, so it’s all there. And then the
-&gt;show() functions should obviously give you a pointer to the right object.</li>
<li>The drm_info_list stuff is centered on drm_minor instead of drm_device. For
anything we want to print drm_device (or maybe drm_file) is the right thing.</li>
<li>The drm_driver-&gt;debugfs_init hooks we have is just an artifact of the old
midlayered load sequence. DRM debugfs should work more like sysfs, where you
can create properties/files for an object anytime you want, and the core
takes care of publishing/unpuplishing all the files at register/unregister
time. Drivers shouldn’t need to worry about these technicalities, and fixing
this (together with the drm_minor-&gt;drm_device move) would allow us to remove
debugfs_init.</li>
</ul>
<p>Previous RFC that hasn’t landed yet: <a class="reference external" href="https://lore.kernel.org/dri-devel/20200513114130.28641-2-wambui.karugax&#64;gmail.com/">https://lore.kernel.org/dri-devel/20200513114130.28641-2-wambui.karugax&#64;gmail.com/</a></p>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="object-lifetime-fixes">
<h2>Object lifetime fixes<a class="headerlink" href="#object-lifetime-fixes" title="Permalink to this headline">¶</a></h2>
<p>There’s two related issues here</p>
<ul class="simple">
<li>Cleanup up the various -&gt;destroy callbacks, which often are all the same
simple code.</li>
<li>Lots of drivers erroneously allocate DRM modeset objects using devm_kzalloc,
which results in use-after free issues on driver unload. This can be serious
trouble even for drivers for hardware integrated on the SoC due to
EPROBE_DEFERRED backoff.</li>
</ul>
<p>Both these problems can be solved by switching over to <a class="reference internal" href="drm-internals.html#c.drmm_kzalloc" title="drmm_kzalloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_kzalloc()</span></code></a>, and the
various convenience wrappers provided, e.g. <a class="reference internal" href="drm-kms.html#c.drmm_crtc_alloc_with_planes" title="drmm_crtc_alloc_with_planes"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_crtc_alloc_with_planes()</span></code></a>,
<a class="reference internal" href="drm-kms.html#c.drmm_universal_plane_alloc" title="drmm_universal_plane_alloc"><code class="xref c c-func docutils literal notranslate"><span class="pre">drmm_universal_plane_alloc()</span></code></a>, … and so on.</p>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
</div>
<div class="section" id="remove-automatic-page-mapping-from-dma-buf-importing">
<h2>Remove automatic page mapping from dma-buf importing<a class="headerlink" href="#remove-automatic-page-mapping-from-dma-buf-importing" title="Permalink to this headline">¶</a></h2>
<p>When importing dma-bufs, the dma-buf and PRIME frameworks automatically map
imported pages into the importer’s DMA area. <a class="reference internal" href="drm-mm.html#c.drm_gem_prime_fd_to_handle" title="drm_gem_prime_fd_to_handle"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_prime_fd_to_handle()</span></code></a> and
<a class="reference internal" href="drm-mm.html#c.drm_gem_prime_handle_to_fd" title="drm_gem_prime_handle_to_fd"><code class="xref c c-func docutils literal notranslate"><span class="pre">drm_gem_prime_handle_to_fd()</span></code></a> require that importers call dma_buf_attach()
even if they never do actual device DMA, but only CPU access through
dma_buf_vmap(). This is a problem for USB devices, which do not support DMA
operations.</p>
<p>To fix the issue, automatic page mappings should be removed from the
buffer-sharing code. Fixing this is a bit more involved, since the import/export
cache is also tied to &amp;drm_gem_object.import_attach. Meanwhile we paper over
this problem for USB devices by fishing out the USB host controller device, as
long as that supports DMA. Otherwise importing can still needlessly fail.</p>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;, Daniel Vetter</p>
<p>Level: Advanced</p>
<div class="section" id="better-testing">
<h3>Better Testing<a class="headerlink" href="#better-testing" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="enable-trinity-for-drm">
<h2>Enable trinity for DRM<a class="headerlink" href="#enable-trinity-for-drm" title="Permalink to this headline">¶</a></h2>
<p>And fix up the fallout. Should be really interesting …</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="make-kms-tests-in-i-g-t-generic">
<h2>Make KMS tests in i-g-t generic<a class="headerlink" href="#make-kms-tests-in-i-g-t-generic" title="Permalink to this headline">¶</a></h2>
<p>The i915 driver team maintains an extensive testsuite for the i915 DRM driver,
including tons of testcases for corner-cases in the modesetting API. It would
be awesome if those tests (at least the ones not relying on Intel-specific GEM
features) could be made to run on any KMS driver.</p>
<p>Basic work to run i-g-t tests on non-i915 is done, what’s now missing is mass-
converting things over. For modeset tests we also first need a bit of
infrastructure to use dumb buffers for untiled buffers, to be able to run all
the non-i915 specific modeset tests.</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="extend-virtual-test-driver-vkms">
<h2>Extend virtual test driver (VKMS)<a class="headerlink" href="#extend-virtual-test-driver-vkms" title="Permalink to this headline">¶</a></h2>
<p>See the documentation of <a class="reference internal" href="vkms.html#vkms"><span class="std std-ref">VKMS</span></a> for more details. This is an ideal
internship task, since it only requires a virtual machine and can be sized to
fit the available time.</p>
<p>Level: See details</p>
</div>
<div class="section" id="backlight-refactoring">
<h2>Backlight Refactoring<a class="headerlink" href="#backlight-refactoring" title="Permalink to this headline">¶</a></h2>
<p>Backlight drivers have a triple enable/disable state, which is a bit overkill.
Plan to fix this:</p>
<ol class="arabic simple">
<li>Roll out <a class="reference internal" href="backlight.html#c.backlight_enable" title="backlight_enable"><code class="xref c c-func docutils literal notranslate"><span class="pre">backlight_enable()</span></code></a> and <a class="reference internal" href="backlight.html#c.backlight_disable" title="backlight_disable"><code class="xref c c-func docutils literal notranslate"><span class="pre">backlight_disable()</span></code></a> helpers everywhere. This
has started already.</li>
<li>In all, only look at one of the three status bits set by the above helpers.</li>
<li>Remove the other two status bits.</li>
</ol>
<p>Contact: Daniel Vetter</p>
<p>Level: Intermediate</p>
<div class="section" id="driver-specific">
<h3>Driver Specific<a class="headerlink" href="#driver-specific" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="amd-dc-display-driver">
<h2>AMD DC Display Driver<a class="headerlink" href="#amd-dc-display-driver" title="Permalink to this headline">¶</a></h2>
<p>AMD DC is the display driver for AMD devices starting with Vega. There has been
a bunch of progress cleaning it up but there’s still plenty of work to be done.</p>
<p>See drivers/gpu/drm/amd/display/TODO for tasks.</p>
<p>Contact: Harry Wentland, Alex Deucher</p>
</div>
<div class="section" id="vmwgfx-replace-hashtable-with-linux-implementation">
<h2>vmwgfx: Replace hashtable with Linux’ implementation<a class="headerlink" href="#vmwgfx-replace-hashtable-with-linux-implementation" title="Permalink to this headline">¶</a></h2>
<p>The vmwgfx driver uses its own hashtable implementation. Replace the
code with Linux’ implementation and update the callers. It’s mostly a
refactoring task, but the interfaces are different.</p>
<p>Contact: Zack Rusin, Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Level: Intermediate</p>
<div class="section" id="bootsplash">
<h3>Bootsplash<a class="headerlink" href="#bootsplash" title="Permalink to this headline">¶</a></h3>
<p>There is support in place now for writing internal DRM clients making it
possible to pick up the bootsplash work that was rejected because it was written
for fbdev.</p>
<ul class="simple">
<li>[v6,8/8] drm/client: Hack: Add bootsplash example
<a class="reference external" href="https://patchwork.freedesktop.org/patch/306579/">https://patchwork.freedesktop.org/patch/306579/</a></li>
<li>[RFC PATCH v2 00/13] Kernel based bootsplash
<a class="reference external" href="https://lore.kernel.org/r/20171213194755.3409-1-mstaudt&#64;suse.de">https://lore.kernel.org/r/20171213194755.3409-1-mstaudt&#64;suse.de</a></li>
</ul>
<p>Contact: Sam Ravnborg</p>
<p>Level: Advanced</p>
</div>
<div class="section" id="outside-drm">
<h3>Outside DRM<a class="headerlink" href="#outside-drm" title="Permalink to this headline">¶</a></h3>
</div>
</div>
<div class="section" id="convert-fbdev-drivers-to-drm">
<h2>Convert fbdev drivers to DRM<a class="headerlink" href="#convert-fbdev-drivers-to-drm" title="Permalink to this headline">¶</a></h2>
<p>There are plenty of fbdev drivers for older hardware. Some hardware has
become obsolete, but some still provides good(-enough) framebuffers. The
drivers that are still useful should be converted to DRM and afterwards
removed from fbdev.</p>
<p>Very simple fbdev drivers can best be converted by starting with a new
DRM driver. Simple KMS helpers and SHMEM should be able to handle any
existing hardware. The new driver’s call-back functions are filled from
existing fbdev code.</p>
<p>More complex fbdev drivers can be refactored step-by-step into a DRM
driver with the help of the DRM fbconv helpers. [1] These helpers provide
the transition layer between the DRM core infrastructure and the fbdev
driver interface. Create a new DRM driver on top of the fbconv helpers,
copy over the fbdev driver, and hook it up to the DRM code. Examples for
several fbdev drivers are available at [1] and a tutorial of this process
available at [2]. The result is a primitive DRM driver that can run X11
and Weston.</p>
<blockquote>
<div><ul class="simple">
<li>[1] <a class="reference external" href="https://gitlab.freedesktop.org/tzimmermann/linux/tree/fbconv">https://gitlab.freedesktop.org/tzimmermann/linux/tree/fbconv</a></li>
<li>[2] <a class="reference external" href="https://gitlab.freedesktop.org/tzimmermann/linux/blob/fbconv/drivers/gpu/drm/drm_fbconv_helper.c">https://gitlab.freedesktop.org/tzimmermann/linux/blob/fbconv/drivers/gpu/drm/drm_fbconv_helper.c</a></li>
</ul>
</div></blockquote>
<p>Contact: Thomas Zimmermann &lt;<a class="reference external" href="mailto:tzimmermann&#37;&#52;&#48;suse&#46;de">tzimmermann<span>&#64;</span>suse<span>&#46;</span>de</a>&gt;</p>
<p>Level: Advanced</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="rfc/index.html" class="btn btn-neutral float-right" title="GPU RFC Section" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="vgaarbiter.html" class="btn btn-neutral" title="VGA Arbiter" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>