

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Static Keys &mdash; The Linux Kernel 5.18.0-rc1-torvalds+ documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/theme_rtd_colors.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="The Linux Kernel 5.18.0-rc1-torvalds+ documentation" href="../index.html"/>
        <link rel="up" title="Unsorted Documentation" href="index.html"/>
        <link rel="next" title="TEE subsystem" href="tee.html"/>
        <link rel="prev" title="Speculation" href="speculation.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> The Linux Kernel
          

          
          </a>

          
            
            
              <div class="version">
                5.18.0-rc2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../admin-guide/index.html">The Linux kernel user’s and administrator’s guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kbuild/index.html">Kernel Build System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../firmware-guide/index.html">The Linux kernel firmware guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../devicetree/index.html">Open Firmware and Devicetree</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../userspace-api/index.html">The Linux kernel user-space API guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../process/index.html">Working with the kernel development community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dev-tools/index.html">Development tools for the kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../doc-guide/index.html">How to write kernel documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../kernel-hacking/index.html">Kernel Hacking Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trace/index.html">Linux Tracing Technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maintainer/index.html">Kernel Maintainer Handbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fault-injection/index.html">fault-injection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../livepatch/index.html">Kernel Livepatching</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../driver-api/index.html">The Linux driver implementer’s API guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../core-api/index.html">Core API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../locking/index.html">locking</a></li>
<li class="toctree-l1"><a class="reference internal" href="../accounting/index.html">Accounting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../block/index.html">Block</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cdrom/index.html">cdrom</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cpu-freq/index.html">Linux CPUFreq - CPU frequency and voltage scaling code in the Linux(TM) kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ide/index.html">Integrated Drive Electronics (IDE)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fb/index.html">Frame Buffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fpga/index.html">fpga</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hid/index.html">Human Interface Devices (HID)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../i2c/index.html">I2C/SMBus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iio/index.html">Industrial I/O</a></li>
<li class="toctree-l1"><a class="reference internal" href="../isdn/index.html">ISDN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../infiniband/index.html">InfiniBand</a></li>
<li class="toctree-l1"><a class="reference internal" href="../leds/index.html">LEDs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../netlabel/index.html">NetLabel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/index.html">Linux Networking Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pcmcia/index.html">pcmcia</a></li>
<li class="toctree-l1"><a class="reference internal" href="../power/index.html">Power Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../target/index.html">TCM Virtual Device</a></li>
<li class="toctree-l1"><a class="reference internal" href="../timers/index.html">timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spi/index.html">Serial Peripheral Interface (SPI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../w1/index.html">1-Wire Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watchdog/index.html">Linux Watchdog Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../virt/index.html">Linux Virtualization Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../input/index.html">The Linux Input Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hwmon/index.html">Linux Hardware Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpu/index.html">Linux GPU Driver Developer’s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../security/index.html">Security Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sound/index.html">Linux Sound Subsystem Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../crypto/index.html">Linux Kernel Crypto API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../filesystems/index.html">Filesystems in the Linux kernel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vm/index.html">Linux Memory Management Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bpf/index.html">BPF Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usb/index.html">USB support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PCI/index.html">Linux PCI Bus Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scsi/index.html">Linux SCSI Subsystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc-devices/index.html">Assorted Miscellaneous Devices Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../scheduler/index.html">Linux Scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mhi/index.html">MHI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tty/index.html">TTY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../peci/index.html">Linux PECI Subsystem</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../asm-annotations.html">Assembler Annotations</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../arch.html">CPU Architectures</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Kernel tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Unsorted Documentation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="crc32.html">brief tutorial on CRC computation</a></li>
<li class="toctree-l2"><a class="reference internal" href="lzo.html">LZO stream format as understood by Linux’s LZO decompressor</a></li>
<li class="toctree-l2"><a class="reference internal" href="remoteproc.html">Remote Processor Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="rpmsg.html">Remote Processor Messaging (rpmsg) Framework</a></li>
<li class="toctree-l2"><a class="reference internal" href="speculation.html">Speculation</a></li>
<li class="toctree-l2"><a class="reference internal" href="speculation.html#mitigating-speculation-side-channels">Mitigating speculation side-channels</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Static Keys</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#abstract">Abstract</a></li>
<li class="toctree-l3"><a class="reference internal" href="#motivation">Motivation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solution">Solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#static-key-label-api-usage-and-examples">Static key label API, usage and examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tee.html">TEE subsystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="xz.html">XZ data compression in Linux</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#atomic-types">Atomic Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#atomic-bitops">Atomic bitops</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#memory-barriers">Memory Barriers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../watch_queue.html">General notification mechanism</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../translations/index.html">Translations</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">The Linux Kernel</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Unsorted Documentation</a> &raquo;</li>
        
      <li>Static Keys</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/staging/static-keys.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="static-keys">
<h1>Static Keys<a class="headerlink" href="#static-keys" title="Permalink to this headline">¶</a></h1>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>DEPRECATED API:</p>
<p>The use of ‘struct static_key’ directly, is now DEPRECATED. In addition
static_key_{true,false}() is also DEPRECATED. IE DO NOT use the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>struct static_key false = STATIC_KEY_INIT_FALSE;
struct static_key true = STATIC_KEY_INIT_TRUE;
static_key_true()
static_key_false()
</pre></div>
</div>
<p>The updated API replacements are:</p>
<div class="last highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_TRUE(key);
DEFINE_STATIC_KEY_FALSE(key);
DEFINE_STATIC_KEY_ARRAY_TRUE(keys, count);
DEFINE_STATIC_KEY_ARRAY_FALSE(keys, count);
static_branch_likely()
static_branch_unlikely()
</pre></div>
</div>
</div>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Static keys allows the inclusion of seldom used features in
performance-sensitive fast-path kernel code, via a GCC feature and a code
patching technique. A quick example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_FALSE(key);

...

if (static_branch_unlikely(&amp;key))
        do unlikely code
else
        do likely code

...
static_branch_enable(&amp;key);
...
static_branch_disable(&amp;key);
...
</pre></div>
</div>
<p>The static_branch_unlikely() branch will be generated into the code with as little
impact to the likely code path as possible.</p>
</div>
<div class="section" id="motivation">
<h2>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>Currently, tracepoints are implemented using a conditional branch. The
conditional check requires checking a global variable for each tracepoint.
Although the overhead of this check is small, it increases when the memory
cache comes under pressure (memory cache lines for these global variables may
be shared with other memory accesses). As we increase the number of tracepoints
in the kernel this overhead may become more of an issue. In addition,
tracepoints are often dormant (disabled) and provide no direct kernel
functionality. Thus, it is highly desirable to reduce their impact as much as
possible. Although tracepoints are the original motivation for this work, other
kernel code paths should be able to make use of the static keys facility.</p>
</div>
<div class="section" id="solution">
<h2>Solution<a class="headerlink" href="#solution" title="Permalink to this headline">¶</a></h2>
<p>gcc (v4.5) adds a new ‘asm goto’ statement that allows branching to a label:</p>
<p><a class="reference external" href="https://gcc.gnu.org/ml/gcc-patches/2009-07/msg01556.html">https://gcc.gnu.org/ml/gcc-patches/2009-07/msg01556.html</a></p>
<p>Using the ‘asm goto’, we can create branches that are either taken or not taken
by default, without the need to check memory. Then, at run-time, we can patch
the branch site to change the branch direction.</p>
<p>For example, if we have a simple branch that is disabled by default:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (static_branch_unlikely(&amp;key))
        printk(&quot;I am the true branch\n&quot;);
</pre></div>
</div>
<p>Thus, by default the ‘printk’ will not be emitted. And the code generated will
consist of a single atomic ‘no-op’ instruction (5 bytes on x86), in the
straight-line code path. When the branch is ‘flipped’, we will patch the
‘no-op’ in the straight-line codepath with a ‘jump’ instruction to the
out-of-line true branch. Thus, changing branch direction is expensive but
branch selection is basically ‘free’. That is the basic tradeoff of this
optimization.</p>
<p>This lowlevel patching mechanism is called ‘jump label patching’, and it gives
the basis for the static keys facility.</p>
</div>
<div class="section" id="static-key-label-api-usage-and-examples">
<h2>Static key label API, usage and examples<a class="headerlink" href="#static-key-label-api-usage-and-examples" title="Permalink to this headline">¶</a></h2>
<p>In order to make use of this optimization you must first define a key:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_TRUE(key);
</pre></div>
</div>
<p>or:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_FALSE(key);
</pre></div>
</div>
<p>The key must be global, that is, it can’t be allocated on the stack or dynamically
allocated at run-time.</p>
<p>The key is then used in code as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (static_branch_unlikely(&amp;key))
        do unlikely code
else
        do likely code
</pre></div>
</div>
<p>Or:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>if (static_branch_likely(&amp;key))
        do likely code
else
        do unlikely code
</pre></div>
</div>
<p>Keys defined via DEFINE_STATIC_KEY_TRUE(), or DEFINE_STATIC_KEY_FALSE, may
be used in either static_branch_likely() or static_branch_unlikely()
statements.</p>
<p>Branch(es) can be set true via:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static_branch_enable(&amp;key);
</pre></div>
</div>
<p>or false via:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static_branch_disable(&amp;key);
</pre></div>
</div>
<p>The branch(es) can then be switched via reference counts:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>static_branch_inc(&amp;key);
...
static_branch_dec(&amp;key);
</pre></div>
</div>
<p>Thus, ‘static_branch_inc()’ means ‘make the branch true’, and
‘static_branch_dec()’ means ‘make the branch false’ with appropriate
reference counting. For example, if the key is initialized true, a
static_branch_dec(), will switch the branch to false. And a subsequent
static_branch_inc(), will change the branch back to true. Likewise, if the
key is initialized false, a ‘static_branch_inc()’, will change the branch to
true. And then a ‘static_branch_dec()’, will again make the branch false.</p>
<p>The state and the reference count can be retrieved with ‘static_key_enabled()’
and ‘static_key_count()’.  In general, if you use these functions, they
should be protected with the same mutex used around the enable/disable
or increment/decrement function.</p>
<p>Note that switching branches results in some locks being taken,
particularly the CPU hotplug lock (in order to avoid races against
CPUs being brought in the kernel while the kernel is getting
patched). Calling the static key API from within a hotplug notifier is
thus a sure deadlock recipe. In order to still allow use of the
functionality, the following functions are provided:</p>
<blockquote>
<div>static_key_enable_cpuslocked()
static_key_disable_cpuslocked()
static_branch_enable_cpuslocked()
static_branch_disable_cpuslocked()</div></blockquote>
<p>These functions are <em>not</em> general purpose, and must only be used when
you really know that you’re in the above context, and no other.</p>
<p>Where an array of keys is required, it can be defined as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_ARRAY_TRUE(keys, count);
</pre></div>
</div>
<p>or:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>DEFINE_STATIC_KEY_ARRAY_FALSE(keys, count);
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li>Architecture level code patching interface, ‘jump labels’</li>
</ol>
<p>There are a few functions and macros that architectures must implement in order
to take advantage of this optimization. If there is no architecture support, we
simply fall back to a traditional, load, test, and jump sequence. Also, the
struct jump_entry table must be at least 4-byte aligned because the
static_key-&gt;entry field makes use of the two least significant bits.</p>
<ul class="simple">
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">select</span> <span class="pre">HAVE_ARCH_JUMP_LABEL</span></code>,</dt>
<dd>see: arch/x86/Kconfig</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">JUMP_LABEL_NOP_SIZE</span></code>,</dt>
<dd>see: arch/x86/include/asm/jump_label.h</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">__always_inline</span> <span class="pre">bool</span> <span class="pre">arch_static_branch(struct</span> <span class="pre">static_key</span> <span class="pre">*key,</span> <span class="pre">bool</span> <span class="pre">branch)</span></code>,</dt>
<dd>see: arch/x86/include/asm/jump_label.h</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">__always_inline</span> <span class="pre">bool</span> <span class="pre">arch_static_branch_jump(struct</span> <span class="pre">static_key</span> <span class="pre">*key,</span> <span class="pre">bool</span> <span class="pre">branch)</span></code>,</dt>
<dd>see: arch/x86/include/asm/jump_label.h</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">arch_jump_label_transform(struct</span> <span class="pre">jump_entry</span> <span class="pre">*entry,</span> <span class="pre">enum</span> <span class="pre">jump_label_type</span> <span class="pre">type)</span></code>,</dt>
<dd>see: arch/x86/kernel/jump_label.c</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">__init_or_module</span> <span class="pre">void</span> <span class="pre">arch_jump_label_transform_static(struct</span> <span class="pre">jump_entry</span> <span class="pre">*entry,</span> <span class="pre">enum</span> <span class="pre">jump_label_type</span> <span class="pre">type)</span></code>,</dt>
<dd>see: arch/x86/kernel/jump_label.c</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">jump_entry</span></code>,</dt>
<dd>see: arch/x86/include/asm/jump_label.h</dd>
</dl>
</li>
</ul>
<ol class="arabic simple" start="5">
<li>Static keys / jump label analysis, results (x86_64):</li>
</ol>
<p>As an example, let’s add the following branch to ‘getppid()’, such that the
system call now looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>SYSCALL_DEFINE0(getppid)
{
      int pid;

+     if (static_branch_unlikely(&amp;key))
+             printk(&quot;I am the true branch\n&quot;);

      rcu_read_lock();
      pid = task_tgid_vnr(rcu_dereference(current-&gt;real_parent));
      rcu_read_unlock();

      return pid;
}
</pre></div>
</div>
<p>The resulting instructions with jump labels generated by GCC is:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ffffffff81044290 &lt;sys_getppid&gt;:
ffffffff81044290:       55                      push   %rbp
ffffffff81044291:       48 89 e5                mov    %rsp,%rbp
ffffffff81044294:       e9 00 00 00 00          jmpq   ffffffff81044299 &lt;sys_getppid+0x9&gt;
ffffffff81044299:       65 48 8b 04 25 c0 b6    mov    %gs:0xb6c0,%rax
ffffffff810442a0:       00 00
ffffffff810442a2:       48 8b 80 80 02 00 00    mov    0x280(%rax),%rax
ffffffff810442a9:       48 8b 80 b0 02 00 00    mov    0x2b0(%rax),%rax
ffffffff810442b0:       48 8b b8 e8 02 00 00    mov    0x2e8(%rax),%rdi
ffffffff810442b7:       e8 f4 d9 00 00          callq  ffffffff81051cb0 &lt;pid_vnr&gt;
ffffffff810442bc:       5d                      pop    %rbp
ffffffff810442bd:       48 98                   cltq
ffffffff810442bf:       c3                      retq
ffffffff810442c0:       48 c7 c7 e3 54 98 81    mov    $0xffffffff819854e3,%rdi
ffffffff810442c7:       31 c0                   xor    %eax,%eax
ffffffff810442c9:       e8 71 13 6d 00          callq  ffffffff8171563f &lt;printk&gt;
ffffffff810442ce:       eb c9                   jmp    ffffffff81044299 &lt;sys_getppid+0x9&gt;
</pre></div>
</div>
<p>Without the jump label optimization it looks like:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>ffffffff810441f0 &lt;sys_getppid&gt;:
ffffffff810441f0:       8b 05 8a 52 d8 00       mov    0xd8528a(%rip),%eax        # ffffffff81dc9480 &lt;key&gt;
ffffffff810441f6:       55                      push   %rbp
ffffffff810441f7:       48 89 e5                mov    %rsp,%rbp
ffffffff810441fa:       85 c0                   test   %eax,%eax
ffffffff810441fc:       75 27                   jne    ffffffff81044225 &lt;sys_getppid+0x35&gt;
ffffffff810441fe:       65 48 8b 04 25 c0 b6    mov    %gs:0xb6c0,%rax
ffffffff81044205:       00 00
ffffffff81044207:       48 8b 80 80 02 00 00    mov    0x280(%rax),%rax
ffffffff8104420e:       48 8b 80 b0 02 00 00    mov    0x2b0(%rax),%rax
ffffffff81044215:       48 8b b8 e8 02 00 00    mov    0x2e8(%rax),%rdi
ffffffff8104421c:       e8 2f da 00 00          callq  ffffffff81051c50 &lt;pid_vnr&gt;
ffffffff81044221:       5d                      pop    %rbp
ffffffff81044222:       48 98                   cltq
ffffffff81044224:       c3                      retq
ffffffff81044225:       48 c7 c7 13 53 98 81    mov    $0xffffffff81985313,%rdi
ffffffff8104422c:       31 c0                   xor    %eax,%eax
ffffffff8104422e:       e8 60 0f 6d 00          callq  ffffffff81715193 &lt;printk&gt;
ffffffff81044233:       eb c9                   jmp    ffffffff810441fe &lt;sys_getppid+0xe&gt;
ffffffff81044235:       66 66 2e 0f 1f 84 00    data32 nopw %cs:0x0(%rax,%rax,1)
ffffffff8104423c:       00 00 00 00
</pre></div>
</div>
<p>Thus, the disable jump label case adds a ‘mov’, ‘test’ and ‘jne’ instruction
vs. the jump label case just has a ‘no-op’ or ‘jmp 0’. (The jmp 0, is patched
to a 5 byte atomic no-op instruction at boot-time.) Thus, the disabled jump
label case adds:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>6 (mov) + 2 (test) + 2 (jne) = 10 - 5 (5 byte jump 0) = 5 addition bytes.
</pre></div>
</div>
<p>If we then include the padding bytes, the jump label code saves, 16 total bytes
of instruction memory for this small function. In this case the non-jump label
function is 80 bytes long. Thus, we have saved 20% of the instruction
footprint. We can in fact improve this even further, since the 5-byte no-op
really can be a 2-byte no-op since we can reach the branch with a 2-byte jmp.
However, we have not yet implemented optimal no-op sizes (they are currently
hard-coded).</p>
<p>Since there are a number of static key API uses in the scheduler paths,
‘pipe-test’ (also known as ‘perf bench sched pipe’) can be used to show the
performance improvement. Testing done on 3.3.0-rc2:</p>
<p>jump label disabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Performance counter stats for &#39;bash -c /tmp/pipe-test&#39; (50 runs):

       855.700314 task-clock                #    0.534 CPUs utilized            ( +-  0.11% )
          200,003 context-switches          #    0.234 M/sec                    ( +-  0.00% )
                0 CPU-migrations            #    0.000 M/sec                    ( +- 39.58% )
              487 page-faults               #    0.001 M/sec                    ( +-  0.02% )
    1,474,374,262 cycles                    #    1.723 GHz                      ( +-  0.17% )
  &lt;not supported&gt; stalled-cycles-frontend
  &lt;not supported&gt; stalled-cycles-backend
    1,178,049,567 instructions              #    0.80  insns per cycle          ( +-  0.06% )
      208,368,926 branches                  #  243.507 M/sec                    ( +-  0.06% )
        5,569,188 branch-misses             #    2.67% of all branches          ( +-  0.54% )

      1.601607384 seconds time elapsed                                          ( +-  0.07% )
</pre></div>
</div>
<p>jump label enabled:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Performance counter stats for &#39;bash -c /tmp/pipe-test&#39; (50 runs):

       841.043185 task-clock                #    0.533 CPUs utilized            ( +-  0.12% )
          200,004 context-switches          #    0.238 M/sec                    ( +-  0.00% )
                0 CPU-migrations            #    0.000 M/sec                    ( +- 40.87% )
              487 page-faults               #    0.001 M/sec                    ( +-  0.05% )
    1,432,559,428 cycles                    #    1.703 GHz                      ( +-  0.18% )
  &lt;not supported&gt; stalled-cycles-frontend
  &lt;not supported&gt; stalled-cycles-backend
    1,175,363,994 instructions              #    0.82  insns per cycle          ( +-  0.04% )
      206,859,359 branches                  #  245.956 M/sec                    ( +-  0.04% )
        4,884,119 branch-misses             #    2.36% of all branches          ( +-  0.85% )

      1.579384366 seconds time elapsed
</pre></div>
</div>
<p>The percentage of saved branches is .7%, and we’ve saved 12% on
‘branch-misses’. This is where we would expect to get the most savings, since
this optimization is about reducing the number of branches. In addition, we’ve
saved .2% on instructions, and 2.8% on cycles and 1.4% on elapsed time.</p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tee.html" class="btn btn-neutral float-right" title="TEE subsystem" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="speculation.html" class="btn btn-neutral" title="Speculation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright The kernel development community.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'5.18.0-rc1-torvalds+',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>